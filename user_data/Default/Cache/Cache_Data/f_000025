import{c as i,j as e,H as ve,S as l,D as j,I as Z,Y as W,V as Je,h as Ae,aP as De,d as Re,e as Le,l as he,a1 as Fe,ag as Ze,K as ge,L as fe,q as et,s as He,v as ne,N as _e,x as qt,y as Gt,aQ as ie,f as je,m as Pe,n as Me,G as te,R as B,p as X,a4 as xe,a7 as me,a3 as Se,$ as $e,w as ce,P as Vt,U as Kt,O as zt,o as Ce,am as Qt,an as Xt,a2 as Ke,a5 as Ee,W as ue,X as pe,aR as Jt,aS as Zt}from"./index-DH9E0Dqq.js";import{S as Oe,F as We,B as Ue,P as tt,C as at,b as ze}from"./PaginationControl-CenqpxQH.js";import{af as ea,e as ta,ag as aa,ah as nt,c as st,ai as na,h as rt,T as Ie,O as lt,L as ye,A as it,aj as ot,a as Be,k as sa,F as Ye,o as qe,l as ct,I as Ge,n as ra,i as la,j as ia,C as oa,a6 as dt,d as ca,X as da,u as ua,D as Qe,_ as pa,$ as xa,a0 as ma,a2 as ut,a3 as ha,a7 as ga,q as fa,a4 as ja,a5 as Ca,V as ba}from"./AuditProvider-BfaT1Ozk.js";import{S as Sa,B as Te,d as ee}from"./DatePicker-DAUzD4hQ.js";import"./BasicInput-D0G2rzCO.js";import"./CardContent-Buvwad75.js";const pt=[{label:"因才網ID",value:"adlUserId"},{label:"老師姓名",value:"adlName"},{label:"學校名稱",value:"schoolName"}],xt=pt.map(o=>o.value),Xe=o=>xt.includes(o),Ia=({open:o,onClose:y,onAssignHandler:x})=>{const{sort:s,...v}=Ae,[b,m]=i.useState({searchText:"",currentField:xt[0]}),[k,w]=i.useState(),[F,O]=i.useState({...v,page:0}),{data:n}=ea(F),R=h=>{m(E=>({...E,searchText:h}))},d=h=>{m(E=>({...E,currentField:h}))},f=(h=!1)=>{const{searchText:E,currentField:D}=b;if(h){O(P=>(Object.keys(P).forEach(M=>{Xe(M)&&delete P[M]}),{...P,page:0}));return}O(P=>(Object.keys(P).forEach(M=>{Xe(M)&&delete P[M]}),{...P,[D]:E,page:0}))},H=(h,E)=>{O(D=>({...D,page:E-1}))},N=()=>{m(h=>({...h,searchText:""})),f(!0)},_=h=>{w(h)},$=()=>{k&&x(k==null?void 0:k.adlUserId)};return e.jsxs(ve,{open:o,fullScreen:!0,onClose:y,sx:{p:10},PaperProps:{sx:{p:2,px:5}},children:[e.jsxs(l,{flexDirection:"row",gap:3,mt:5,justifyContent:"center",children:[e.jsxs(l,{flexDirection:"row",gap:2,alignItems:"center",justifyContent:"center",children:[e.jsx(Oe,{value:b,options:pt,selectOnChange:d,inputOnChange:R,searchFuntion:f}),e.jsx(j,{label:"搜尋",onClick:()=>f(),btnColor:"BROWN"})]}),e.jsx(j,{label:"清除搜尋結果",fullWidth:!0,btnColor:"CANCEL_RED",onClick:N})]}),n&&e.jsxs(l,{children:[e.jsx(l,{flexDirection:"row",gap:5,flexWrap:"wrap",mt:5,sx:{border:`1px solid ${Z.BLACK}`,overflowY:"auto",height:450},p:3,alignItems:"flex-start",children:n.content.map((h,E)=>e.jsxs(l,{sx:{backgroundColor:(k==null?void 0:k.adlUserId)===h.adlUserId?Z.GREEN:Z.BTN_LATTE_GRAY,p:2,color:Z.WHITE,textAlign:"center",borderRadius:10,"&:hover":{backgroundColor:Z.GREEN,transition:"0.3s",cursor:"pointer"}},onClick:()=>_(h),children:[e.jsx(W,{sx:{fontSize:24},children:h.adlName}),e.jsx(W,{sx:{fontSize:20},children:h.schoolNameList})]},E))}),e.jsx(Je,{count:n.totalPages,page:n.pageable.pageNumber+1,onChange:H,color:"primary",sx:{mt:2,mx:"auto"}})]}),e.jsxs(l,{flexDirection:"row",sx:{ml:"auto",mt:"auto",gap:3},children:[e.jsx(j,{label:"關閉",btnColor:"CANCEL_RED",onClick:y}),e.jsx(j,{label:"指派",onClick:$})]})]})},mt=i.memo(({value:o,handleChange:y})=>{const x=ta.concat(De);return e.jsx(i.Fragment,{children:e.jsx(Sa,{label:"狀態",options:x,value:o.flag,onChange:y("flag")})})}),ht=[{label:"名稱",value:"contentName"},{label:"命題者姓名",value:"createTeacherAdlName"},{label:"審題者姓名",value:"auditTeacherAdlName"}],be=ht.map(o=>o.value),ya=o=>be.includes(o),Ta=()=>{const o=Re(),y=Le(),{setAlertOpen:x}=he(),s=Fe(),v=i.useMemo(()=>{const c=new URLSearchParams(y.search),g=c.get("adlUserId"),U=c.get("contentName"),z=c.get("createTeacherAdlName"),se=c.get("auditTeacherAdlName"),oe=c.get("updateTimeStart"),re=c.get("updateTimeEnd");return{type:2,flag:parseInt(c.get("flag")||"0",10),status:parseInt(c.get("status")||"0",10),page:parseInt(c.get("page")||"0",10),...g&&{adlUserId:g},...U&&{contentName:U},...z&&{createTeacherAdlName:z},...se&&{auditTeacherAdlName:se},...oe&&{updateTimeStart:parseInt(oe,10)},...re&&{updateTimeEnd:parseInt(re,10)},...Ae,sort:"updateTime,desc"}},[y.search]),b=i.useMemo(()=>{const c=Object.keys(v).find(g=>be.includes(g)&&v[g]!==void 0);return c?{searchText:v[c],currentField:c}:{searchText:"",currentField:be[0]}},[v]),[m,k]=i.useState(v),[w,F]=i.useState(b),[O,n]=i.useState([]),[R,d]=i.useState(!1),{mutate:f}=aa(L),H=()=>d(!0),N=()=>d(!1),[_,$]=i.useState(),{data:h,isSuccess:E,isLoading:D}=nt(m),P=i.useMemo(()=>E&&!!h.content.length,[E,h]),M=i.useCallback(c=>{o(`assignmentManage/${c}`)},[o]),G=c=>{O.includes(c)?n(g=>g.filter(U=>U!==c)):n(g=>[...g,c])},T=i.useCallback(c=>g=>{let U,z;if(typeof g=="number"||typeof g=="string"||typeof g=="boolean"?U=g:U=g.target.value,ya(c)){const oe={};be.forEach(re=>{re===c&&U?oe[re]=U:delete m[re]}),z={...m,...oe}}else z={...m,[c]:U};c!=="page"&&(z.page=0);const se=st(z);k(z),o(`?${se}`)},[o,m]),Y=i.useCallback((c,g)=>{T("page")(g-1),$(g)},[T]),u=c=>{F(g=>({...g,searchText:c.trim()}))},A=c=>{F(g=>({...g,currentField:c}))},t=()=>{const{currentField:c,searchText:g}=w;T(c)(g),$(1)},r=i.useCallback(()=>{_&&k(c=>({...c,page:Number(_)-1}))},[_,k]),C=c=>{const U={assignmentTypeAndContentIdDtoList:O.map(z=>({contentId:z,type:2})),adlUserId:c};f(U)};function L(){x({title:"指派成功",message:"已成功指派審題老師",open:!0}),s.invalidateQueries({queryKey:[na.AUDIT_SEARCH]}),n([]),N()}const q=(c,g)=>{g&&(c==="updateTimeStart"?T(c)(ee(g).startOf("day").valueOf()):c==="updateTimeEnd"?T(c)(ee(g).endOf("day").valueOf()):T(c)(ee(g).valueOf()))},V=[{title:"",dataField:"contentId",component:c=>e.jsx(l,{gap:2,flexDirection:"row",justifyContent:"center",children:e.jsx(j,{label:"觀看",btnColor:"TAB_BLUE",onClick:()=>M(c.contentId)})})},{title:"",dataField:"id",width:"10%",component:c=>e.jsx(at,{checked:O.includes(c.contentId),onChange:()=>G(c.contentId)})},{title:"類別",dataField:"type",width:"10%",component:()=>e.jsx(W,{variant:"h5",children:"題目"})},{title:"狀態",dataField:"flag",component:c=>{var g;return e.jsx(W,{variant:"h5",children:((g=De.find(U=>U.value===c.flag))==null?void 0:g.label)??"無"})}},{title:"名稱",dataField:"content"},{title:"審題者姓名",dataField:"teacherData",component:c=>{var g;return e.jsx(W,{variant:"h5",children:((g=c.teacherData)==null?void 0:g.name)??"無"})}},{title:"命題者姓名",dataField:"createTeacherAdlName"},{title:"建立時間",dataField:"createTime",width:"260px",component:c=>e.jsx(W,{variant:"h5",children:ee(c.createTime).format("YYYY-MM-DD HH:mm:ss")})},{title:"狀態更新時間",dataField:"updateTime",width:"260px",component:c=>e.jsx(W,{variant:"h5",children:ee(c.updateTime).format("YYYY-MM-DD HH:mm:ss")})}];return e.jsxs(l,{flex:1,gap:5,children:[e.jsxs(l,{gap:5,flexDirection:"row",alignItems:"center",justifyContent:{xs:"center",sm:"flex-start"},flexWrap:"wrap",px:3,children:[e.jsx(mt,{value:v,handleChange:T}),e.jsxs(Ze,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(ge,{width:"fit-content",p:"4px 16px",children:"狀態更新時間"}),e.jsx(Te,{value:m.updateTimeStart??null,onChange:c=>q("updateTimeStart",c)}),e.jsx(W,{variant:"h5",children:"至"}),e.jsx(Te,{value:m.updateTimeEnd??null,onChange:c=>q("updateTimeEnd",c)})]}),e.jsxs(l,{flexDirection:"row",gap:5,flexWrap:"wrap",justifyContent:{xs:"center",sm:"flex-start"},alignItems:"center",children:[e.jsx(Oe,{value:w,options:ht,selectOnChange:A,inputOnChange:u,searchFuntion:t}),e.jsx(j,{label:"搜尋",onClick:t,btnColor:"BROWN"})]})]}),D?e.jsx(fe,{}):e.jsx(l,{children:h&&e.jsx(We,{isVisible:P,children:e.jsxs(l,{p:.5,alignItems:"center",gap:5,children:[e.jsx(Ue,{columns:V,rows:h.content}),e.jsx(tt,{totalPages:h.totalPages,currentPage:h.pageable.pageNumber,inputPage:_??1,setInputPage:$,handlePageChange:Y,handlePageSearch:r})]})},JSON.stringify(m))}),e.jsx(j,{label:"指派審題老師",onClick:H,sx:{ml:"auto",mr:3}}),e.jsx(Ia,{onClose:N,open:R,onAssignHandler:C})]})},va=Ta,Aa=()=>{var F,O,n,R;const o=et(),[y,x]=i.useState([]),{data:s,isLoading:v}=rt({id:parseInt(o.id||"0",10)}),b=[{key:"任務名稱",value:(s==null?void 0:s.name)??""},{key:"主要學科",value:((F=s==null?void 0:s.mainSubject)==null?void 0:F.value)??""},{key:"次要學科",value:((O=s==null?void 0:s.subjectSet)==null?void 0:O.map(d=>d.value).join(", "))??""},{key:"課綱",value:(s==null?void 0:s.syllabus)??""},{key:"等級",value:(s==null?void 0:s.level)??""},{key:"地點",value:(s==null?void 0:s.area)??""},{key:"世紀",value:((n=s==null?void 0:s.century)==null?void 0:n.century)??""}],m=d=>{if(s!=null&&s.missionHintSet){const f=s.missionHintSet;if(f.length>d)return f[d].hint}return""},k=d=>{if(s!=null&&s.missionAdditionalHyperlinkSet){const f=s.missionAdditionalHyperlinkSet;if(f.length>d)return f[d]}return""},w=[{key:"線索文本",value:Ie((s==null?void 0:s.description)??"")},{key:"整體情境鷹架提示",value:m(0)},{key:"整體情境鷹架提示",value:m(1)},{key:"整體情境鷹架提示",value:m(2)},{key:"解答說明",value:(s==null?void 0:s.answerDescription)??""},{key:"多媒體補充資訊",value:k(0)},{key:"多媒體補充資訊",value:k(1)},{key:"編輯者註解",value:(s==null?void 0:s.note)??""}];return i.useEffect(()=>{var d;if(s&&((d=s.imagesSrc)!=null&&d.length)){const{picIds:f,imagesSrc:H}=s;x(H.map((N,_)=>({src:N,id:f[_].picId})))}},[s]),e.jsx(l,{width:"100%",p:3,children:v?e.jsx(fe,{}):e.jsxs(l,{gap:3,children:[e.jsxs(l,{flexDirection:"row",gap:4,children:[e.jsx(l,{flex:1,children:e.jsx(lt,{data:b})}),e.jsx(l,{flex:1,justifyContent:"center",alignItems:"center",gap:2,children:y.length>0?y==null?void 0:y.map(d=>e.jsx("img",{width:400,height:400,src:d.src,style:{marginLeft:"auto",marginRight:"auto"}},d.id)):e.jsx(ge,{children:"無多媒體圖片"})})]}),e.jsx(l,{flexDirection:"row",gap:4,flexWrap:"wrap",justifyContent:"space-around",children:w.map((d,f)=>typeof d.value=="string"?e.jsx(ye,{label:d.key,paperText:d.value},f):e.jsx(ye,{label:d.key,paperText:"",missionAdditionalHyperlinkSet:d.value},f))}),e.jsx(l,{flexDirection:"row",gap:4,flexWrap:"wrap",justifyContent:"space-around",children:(R=s==null?void 0:s.missionAnswerCardSet)==null?void 0:R.map((d,f)=>e.jsx(it,{keyWord:d.keyWord,cardId:d.cardId,hint:d.hint,isAudit:!0},f))}),e.jsx(l,{flexDirection:"row",gap:4,flexWrap:"wrap",justifyContent:"flex-start",children:s==null?void 0:s.cardSet.map((d,f)=>e.jsx(ot,{card:d},f))})]})})},Oa=Aa;function ka(){return e.jsxs(He,{children:[e.jsx(ne,{index:!0,element:e.jsx(va,{})}),e.jsx(ne,{path:"/assignmentManage/:id",element:e.jsx(Oa,{})}),e.jsx(ne,{path:"*",element:e.jsx(_e,{to:"/assignment",replace:!0})})]})}function ke(){const o=qt(),{createCardDialogOpen:y,updateCardDialogOpen:x,cardSelectDialogOpen:s,cardList:v,updateSelectedCard:b}=Gt(d=>d.auditMissionCard);return{createCardDialogOpen:y,setCreateCardDialogOpen:d=>{o(ie.actions.setCreateCardDialogOpen(d))},updateCardDialogOpen:x,setUpdateCardDialogOpen:d=>{o(ie.actions.setUpdateCardDialogOpen(d))},updateSelectedCard:b,setUpdateSelectedCard:d=>{d&&o(ie.actions.setUpdateCardDialogOpen(!0)),o(ie.actions.setUpdateSelectedCard(d))},cardSelectDialogOpen:s,setCardSelectDialogOpen:d=>{o(ie.actions.setCardSelectDialogOpen(d))},cardList:v,addNewCard:d=>{o(ie.actions.setCardList([...v,d]))},removeCard:d=>{o(ie.actions.setCardList(v.filter(f=>f.id!==d)))},setCardList:d=>{o(ie.actions.setCardList(d))}}}const wa=()=>{const{userInfo:o}=je(),{setAlertOpen:y}=he(),{cardSelectedImage:x,setCardSelectedImage:s,setSelectedType:v}=Pe(),{data:b}=Be(),{createCardDialogOpen:m,setCreateCardDialogOpen:k,addNewCard:w}=ke(),F=()=>{O(ct),s(null),v("MISSION"),k(!1)},{reset:O,control:n,setValue:R,unregister:d,handleSubmit:f,formState:{errors:H}}=Me(),{mutate:N}=sa(h),_=i.useMemo(()=>b?b.map(T=>({label:T.value,value:T.id})):[],[b]),$=i.useMemo(()=>o?o.schoolDtoList.map(T=>({label:T.schoolName,value:T.id})):[],[o]);function h(T){w(T),y({open:!0,title:"創建提示",message:"創建卡牌成功"}),F()}const E=T=>{if(!o)return;const{variant:Y,...u}=T;N({...u,flag:ce.IN_SCHOOL})},D=T=>{y({open:!0,title:"提示",message:"按下確認表示您已經確認所編輯的卡片內容文字與所上傳圖片沒有違反智慧財產權疑慮",onOk:()=>E(T)})},P=()=>{s(null),R("picId",0,{shouldValidate:!0})};i.useEffect(()=>{x&&R("picId",x.id,{shouldValidate:!0})},[x,R]),i.useEffect(()=>{v("CARD"),o&&R("schoolId",o.schoolDtoList[0].id)},[]);const M=()=>{const{fields:T,append:Y,remove:u}=Se({control:n,name:"additionalHyperlinkSet"}),A=()=>{Y({name:"",hyperlink:"",adl:!1})},t=r=>{u(r),d(`additionalHyperlinkSet.${r}`),R("additionalHyperlinkSet",T.filter((C,L)=>L!==r))};return e.jsxs(e.Fragment,{children:[T.map((r,C)=>e.jsxs(l,{flexDirection:"row",alignItems:"flex-start",gap:1,children:[e.jsx(B,{name:`additionalHyperlinkSet.${C}.name`,label:"連結名稱",variant:"control"}),e.jsx(B,{name:`additionalHyperlinkSet.${C}.hyperlink`,label:"連結",variant:"control"}),e.jsx(j,{label:"刪除",onClick:()=>t(C),btnColor:"CANCEL_RED"})]},r.id)),e.jsx(j,{label:"增加資訊",disabled:T.length>=1,onClick:A,btnColor:"BTN_LATTE_GRAY"})]})},G=()=>e.jsxs(e.Fragment,{children:[e.jsxs(l,{gap:2,flexDirection:"row",alignItems:"flex-start",children:[e.jsx(Ge,{title:"卡片圖片",name:"picId",alertText:"必填"}),(x==null?void 0:x.src)&&e.jsx(j,{label:"刪除",btnColor:"CANCEL_RED",onClick:P})]}),(x==null?void 0:x.src)&&e.jsx($e,{styleType:"formImage",src:x.src})]});return e.jsx(ve,{open:m,fullScreen:!0,onClose:F,sx:{p:6},PaperProps:{sx:{p:6}},children:e.jsx(l,{p:2,justifyContent:"center",alignItems:"center",width:"100%",children:e.jsxs(Ye,{onSubmit:f(D),sx:{mb:3},children:[e.jsxs(te,{container:!0,spacing:6,wrap:"wrap",children:[e.jsx(te,{item:!0,sm:12,lg:6,children:e.jsxs(l,{gap:1,children:[e.jsx(B,{name:"name",label:"卡片名稱",variant:"control",alertText:"字數限制：16字，不要用標點符號。(必填)"}),e.jsx(X,{name:"schoolId",label:"學校",options:$,type:"ONE",variant:"control",alertText:"必填"}),e.jsx(X,{name:"subjectId",label:"學科",options:_,type:"ONE",variant:"control",alertText:"必填"}),e.jsx(B,{name:"syllabus",label:"課綱",variant:"control"}),e.jsx(X,{name:"type",label:"類別",options:qe,type:"ONE",variant:"control",alertText:"必填"}),e.jsx(xe,{name:"description",label:"文字內容",rows:4,variant:"control",alertText:"24字內，含標點符號。(必填)"})]})}),e.jsx(te,{item:!0,sm:12,lg:6,children:e.jsxs(l,{gap:2,children:[e.jsx(G,{}),e.jsx(me,{labelSx:{flex:2},labelTitle:"因材網或外部資訊",alertTextList:["數量限制：一張1個連結。","1. 卡片上顯示的外部資訊按鈕(可點選跳出外部連結視窗作為線索)。","2. 同一題中至少每個類別的知識卡中要有兩張有外部連結。","3. 因材網的連結原則上每個題組有一張卡片有一個即可。","4. 建議使用具公信力、官方之參考內容，請避免如維基百科等具爭議性的網站來源。"]}),e.jsx(M,{}),e.jsx(xe,{name:"note",label:"編輯者註解",rows:8,variant:"control",alertText:"不會顯示在正式遊戲畫面，僅供命題者註記。"})]})})]}),e.jsxs(l,{flexDirection:"row",gap:3,justifyContent:"end",children:[e.jsx(j,{label:"儲存",type:"submit"}),e.jsx(j,{label:"取消",btnColor:"CANCEL_RED",onClick:()=>k(!1)})]})]})})})},Ea=()=>{const{userInfo:o}=je(),{setAlertOpen:y}=he(),{cardSelectedImage:x,setCardSelectedImage:s,setSelectedType:v}=Pe(),{updateSelectedCard:b,setUpdateCardDialogOpen:m,updateCardDialogOpen:k,setCardList:w,cardList:F}=ke(),{data:O}=Be(),{reset:n,control:R,setValue:d,unregister:f,handleSubmit:H,formState:{errors:N}}=Me(),{mutate:_}=ra(E),$=i.useMemo(()=>O?O.map(u=>({label:u.value,value:u.id})):[],[O]),h=i.useMemo(()=>o?o.schoolDtoList.map(u=>({label:u.schoolName,value:u.id})):[],[o]);function E(u){y({open:!0,title:"編輯提示",message:"編輯卡牌成功"}),w(F.map(A=>A.id===u.id?u:A)),D()}const D=()=>{n(ct),s(null),v("MISSION"),m(!1)},P=u=>{if(u.variant==="update"&&u.id&&o){const{variant:A,...t}=u;_({...t})}else y({open:!0,title:"編輯提示",message:"編輯卡牌缺少ID"})},M=u=>{y({open:!0,title:"提示",message:`請確認是否儲存卡片內容

按下確認表示您已經確認所編輯的卡片內容文字與所上傳圖片沒有違反智慧財產權疑慮`,onOk:()=>P(u)})},G=()=>{s(null),d("picId",0,{shouldValidate:!0})};i.useEffect(()=>{b&&(n({...b,subjectId:b.subjectId??0,variant:"update"}),s({id:b.picId,src:b.imageSrc}))},[b]),i.useEffect(()=>{x&&b&&x.id!=b.picId&&d("picId",x.id,{shouldValidate:!0})},[x]),i.useEffect(()=>{v("CARD"),o&&d("schoolId",o.schoolDtoList[0].id)},[]);const T=()=>{const{fields:u,append:A,remove:t}=Se({control:R,name:"additionalHyperlinkSet"}),r=()=>{A({name:"",hyperlink:"",adl:!1})},C=L=>{t(L),f(`additionalHyperlinkSet.${L}`),d("additionalHyperlinkSet",u.filter((q,V)=>V!==L))};return e.jsxs(e.Fragment,{children:[u.map((L,q)=>e.jsxs(l,{flexDirection:"row",alignItems:"flex-start",gap:1,children:[e.jsx(B,{name:`additionalHyperlinkSet.${q}.name`,label:"連結名稱",variant:"control"}),e.jsx(B,{name:`additionalHyperlinkSet.${q}.hyperlink`,label:"連結",variant:"control"}),e.jsx(j,{label:"刪除",onClick:()=>C(q),btnColor:"CANCEL_RED"})]},L.id)),e.jsx(j,{label:"增加資訊",disabled:u.length>=1,onClick:r,btnColor:"BTN_LATTE_GRAY"})]})},Y=()=>e.jsxs(e.Fragment,{children:[e.jsxs(l,{gap:2,flexDirection:"row",alignItems:"flex-start",children:[e.jsx(Ge,{title:"卡片圖片",name:"picId",alertText:"必填"}),(x==null?void 0:x.src)&&e.jsx(j,{label:"刪除",btnColor:"CANCEL_RED",onClick:G})]}),(x==null?void 0:x.src)&&e.jsx($e,{styleType:"formImage",src:x.src})]});return e.jsx(ve,{open:k,fullScreen:!0,onClose:D,sx:{p:4},PaperProps:{sx:{p:2}},children:e.jsx(l,{p:2,justifyContent:"center",alignItems:"center",width:"100%",children:e.jsxs(Ye,{onSubmit:H(M),children:[e.jsxs(te,{container:!0,spacing:6,wrap:"wrap",children:[e.jsx(te,{item:!0,sm:12,lg:6,children:e.jsxs(l,{gap:1,children:[e.jsx(B,{name:"name",label:"卡片名稱",variant:"control",alertText:"字數限制：16字，不要用標點符號。(必填)"}),e.jsx(X,{name:"schoolId",label:"學校",options:h,type:"ONE",variant:"control",alertText:"必填"}),e.jsx(X,{name:"subjectId",label:"學科",options:$,type:"ONE",variant:"control",alertText:"必填"}),e.jsx(B,{name:"syllabus",label:"課綱",variant:"control"}),e.jsx(X,{name:"type",label:"類別",options:qe,type:"ONE",variant:"control",alertText:"必填"}),e.jsx(xe,{name:"description",label:"文字內容",rows:4,variant:"control",alertText:"24字內，含標點符號。(必填)"})]})}),e.jsx(te,{item:!0,sm:12,lg:6,children:e.jsxs(l,{gap:2,children:[e.jsx(Y,{}),e.jsx(me,{labelSx:{flex:2},labelTitle:"因材網或外部資訊",alertTextList:["數量限制：一張1個連結。","1. 卡片上顯示的外部資訊按鈕(可點選跳出外部連結視窗作為線索)。","2. 同一題中至少每個類別的知識卡中要有兩張有外部連結。","3. 因材網的連結原則上每個題組有一張卡片有一個即可。","4. 建議使用具公信力、官方之參考內容，請避免如維基百科等具爭議性的網站來源。"]}),e.jsx(T,{}),e.jsx(xe,{name:"note",label:"編輯者註解",rows:8,variant:"control",alertText:"不會顯示在正式遊戲畫面，僅供命題者註記。"})]})})]}),e.jsxs(l,{flexDirection:"row",gap:3,justifyContent:"end",children:[e.jsx(j,{label:"儲存",type:"submit"}),e.jsx(j,{label:"取消",btnColor:"CANCEL_RED",onClick:()=>m(!1)})]})]})})})},gt=[{label:"知識卡名稱",value:"name"},{label:"知識卡內容",value:"description"},{label:"外部連結(名稱)",value:"hyperlinkName"}],Ne=gt.map(o=>o.value),Na=o=>Ne.includes(o),Da=i.memo(()=>{const{cardList:o,addNewCard:y,removeCard:x,cardSelectDialogOpen:s,setCardSelectDialogOpen:v}=ke(),{userInfo:b}=je(),[m,k]=i.useState({...Ae,subjectId:0,type:0,page:0,flag:5,onlySelf:!1}),[w,F]=i.useState(null),[O,n]=i.useState({searchText:"",currentField:Ne[0]}),[R,d]=i.useState(!1),{data:f,isSuccess:H,isLoading:N}=la(m),_=i.useMemo(()=>H&&!!f.content.length,[H,f]),$=i.useCallback(t=>r=>{let C,L;if(typeof r=="number"||typeof r=="string"||typeof r=="boolean"?C=r:C=r.target.value,Na(t)){const q={};Ne.forEach(V=>{V===t&&C?q[V]=C:delete m[V]}),L={...m,...q}}else L={...m,[t]:C};t!=="page"&&(L.page=0),k(L)},[m]),h=i.useCallback((t,r)=>{$("page")(r-1)},[$]),E=i.useCallback(t=>{F(t),d(!0)},[]),D=i.useCallback(()=>{d(!1),F(null)},[]),P=()=>{v(!1)},M=t=>o.some(r=>r.id===t),G=t=>{n(r=>({...r,searchText:t}))},T=t=>{n(r=>({...r,currentField:t}))},Y=t=>{$("onlySelf")(t)},u=()=>{const{currentField:t,searchText:r}=O;$(t)(r)},A=[{title:"",dataField:"id",component:t=>M(t.id)?e.jsx(j,{label:"移除",onClick:()=>x(t.id),btnColor:"CANCEL_RED",disabled:t.teacherData.name!=(b==null?void 0:b.adlName)&&t.flag==ce.IN_SCHOOL}):e.jsx(j,{label:"選擇",onClick:()=>y(t),disabled:t.teacherData.name!=(b==null?void 0:b.adlName)&&t.flag==ce.IN_SCHOOL})},{title:"卡片名稱",dataField:"name",width:"20%"},{title:"科目",dataField:"subjectId",component:t=>e.jsx(W,{variant:"h5",children:t.subject?t.subject.value:"無"})},{title:"知識卡類別",dataField:"type",component:t=>{var r;return e.jsx(W,{variant:"h5",children:((r=qe[t.type-1])==null?void 0:r.label)??"無"})}},{title:"校名",dataField:"schoolId",width:"20%",component:t=>e.jsx(W,{variant:"h5",children:t.school.schoolName})},{title:"出題者",dataField:"id",component:t=>e.jsx(W,{variant:"h5",children:t.teacherData.name})},{title:"狀態",dataField:"flag",component:t=>{var r;return e.jsx(W,{variant:"h5",children:(r=zt[t.flag-1])==null?void 0:r.label})}},{title:"編輯/檢視",dataField:"id",component:t=>e.jsx(j,{label:"檢視",onClick:()=>E(t),btnColor:"BTN_LATTE_GRAY"})}];return e.jsxs(i.Fragment,{children:[R&&w&&e.jsx(ia,{cardDetail:w,open:R,onClose:D}),e.jsxs(ve,{open:s,fullScreen:!0,onClose:P,sx:{p:4},PaperProps:{sx:{p:4}},children:[e.jsxs(Vt,{sx:{textAlign:"center",fontSize:36},id:"customized-dialog-title",children:["可選擇卡片列表",e.jsxs(l,{flexDirection:"row",gap:5,alignItems:"center",justifyContent:{xs:"center",sm:"flex-start"},flexWrap:"wrap",px:3,children:[e.jsx(oa,{handleChange:$,value:m,isSchoolAndPass:!0}),e.jsxs(l,{flexDirection:"row",gap:5,flexWrap:"wrap",justifyContent:{xs:"center",sm:"flex-start"},alignItems:"center",children:[e.jsx(Oe,{check:m.onlySelf,value:O,options:gt,selectOnChange:T,inputOnChange:G,checkBoxOnChange:Y,searchFuntion:u}),e.jsx(j,{label:"搜尋",onClick:u,btnColor:"BROWN"})]})]})]}),e.jsx(Kt,{dividers:!0,children:N?e.jsx(fe,{}):e.jsx(l,{children:f&&e.jsx(We,{isVisible:_,children:e.jsxs(l,{p:.5,alignItems:"center",gap:5,children:[e.jsx(Ue,{columns:A,rows:f.content}),e.jsx(Je,{count:f.totalPages,page:f.pageable.pageNumber+1,onChange:h,color:"primary"})]})},JSON.stringify(m))})}),e.jsx(j,{label:"關閉",color:"error",sx:{position:"absolute",top:5,right:5},onClick:P})]})]})}),ft=/\$\[\[([^\]]*)\]\]/g;function Ra(o){let y;do y=o,o=o.replace(ft,(x,s)=>s);while(y!==o);return o}function La(o){return o.replace(ft,(y,x)=>"$[["+Ra(x)+"]]")}const Fa=({missionDetail:o,editModeHandler:y})=>{const{setAlertOpen:x}=he(),{userInfo:s}=je(),v=Fe(),{mutate:b}=dt(jt),{data:m}=Be(),{data:k}=ca(),{data:w}=da(),{setFlag:F}=ua(),O=i.useRef(null),n=i.useRef(null),R=i.useRef(null),{setCreateCardDialogOpen:d,setCardSelectDialogOpen:f,cardList:H,setCardList:N,removeCard:_,setUpdateSelectedCard:$}=ke(),{missionSelectedImage:h,setMissionSelectedImage:E,setAllMissionSelectedImage:D,setDeleteMissionImage:P,setSelectedType:M}=Pe(),[G,T]=i.useState(!1),[Y,u]=i.useState(!1),A=i.useRef(null),{reset:t,control:r,setValue:C,trigger:L,handleSubmit:q,unregister:V,formState:{errors:c}}=Me(),g=Ce({control:r,name:"description"}),U=Ce({control:r,name:"mainSubjectId"}),z=Ce({control:r,name:"subjectIds"}),se=Ce({control:r,name:"missionAnswerCardSet"});i.useEffect(()=>{!Y&&se.length>0&&(C("missionAnswerCardSet",se),u(!0))},[se,Y]),i.useEffect(()=>{if(o){const{missionAnswerCardSet:a,picIds:p,imagesSrc:S,mainSubjectId:I,centuryId:K}=o,ae={...o,description:Ie(o.description),mainSubjectId:I??0,centuryId:K??0,cardIds:o.cardIds.map(Q=>({id:Q,type:0})),missionAnswerCardSet:a.map(({card:Q,id:de,...le})=>({...le,answerHint:le.hint,cardType:Q.type}))};N(o.cardSet),D(S.map((Q,de)=>({src:Q,id:p[de].picId}))),t({...ae,picIds:p.map(Q=>Q.picId),variant:"update"}),o.subjectIds.length>0&&T(!0)}},[o,t]);const oe=a=>{if(a.variant==="update"&&a.id&&s){const p={...a,cardIds:a.cardIds.map(S=>S.id),missionAnswerCardSet:a.missionAnswerCardSet.map(S=>({...S,hint:S.answerHint})),missionAdditionalHyperlinkSet:a.missionAdditionalHyperlinkSet.map((S,I)=>({...S,orderNum:I+1})),picIds:a.picIds.map((S,I)=>({picId:S,orderNum:I+1}))};b(p)}else x({open:!0,title:"編輯提示",message:"編輯任務缺少ID"})},re=a=>{x({open:!0,title:"提示",message:"按下確認表示您已經確認所編輯的任務內容文字與所上傳圖片沒有違反智慧財產權疑慮",onOk:()=>oe(a)})};function jt(a){v.invalidateQueries({queryKey:[ut.MISSION_ID(a.id)]}),x({open:!0,title:"編輯提示",message:"編輯任務成功"}),y()}const Ct=()=>m?m.filter(a=>a.value!="全科目").map(a=>({label:a.value,value:a.id})):[],bt=()=>m?m.filter(a=>a.value!=="全科目"&&a.id!==U).map(a=>({label:a.value,value:a.id})):[],St=()=>s?s.schoolDtoList.map(a=>({label:a.schoolName,value:a.id})):[],It=()=>k?k.map(a=>({label:a.century,value:a.id})):[],yt=()=>w?w.map(a=>({label:a,value:a})):[],Tt=()=>{T(!0)},vt=()=>{C("subjectIds",[]),T(!1)},At=()=>{M("CARD"),d(!0)},Ot=a=>{M("CARD"),$(a)},kt=()=>{f(!0)},wt=a=>{we(Ve(a)),_(a)};i.useEffect(()=>{if(h){const a=h.map(p=>p.id);C("picIds",a)}},[h,C]),i.useEffect(()=>{const a=H.map(p=>({id:p.id,type:p.type}));C("cardIds",a),J.forEach((p,S)=>{a.some(I=>I.id===p.cardId)||we(S)})},[H,C]),i.useEffect(()=>(M("MISSION"),F(ce.IN_SCHOOL),s&&C("schoolId",s.schoolDtoList[0].id),()=>{E(null),N([]),t(),V("missionAnswerCardSet")}),[]);const Et=()=>e.jsxs(i.Fragment,{children:[e.jsx(j,{label:"增加學科",disabled:G,onClick:Tt,btnColor:"BTN_LATTE_GRAY"}),G&&e.jsxs(l,{flexDirection:"row",gap:2,alignItems:"center",children:[e.jsx(X,{name:"subjectIds",label:"學科",options:bt(),type:"ONE",variant:"control",multiple:!0}),e.jsx(j,{label:"刪除",onClick:vt,btnColor:"CANCEL_RED"})]})]}),Nt=()=>{const{fields:a,append:p,remove:S}=Se({control:r,name:"missionAdditionalHyperlinkSet"}),I=()=>{p({name:"",hyperlink:"",adl:!1})};return e.jsx(Ee,{name:"missionAdditionalHyperlinkSet",control:r,render:()=>e.jsxs(i.Fragment,{children:[a.map((K,ae)=>e.jsxs(l,{flexDirection:"row",alignItems:"flex-start",gap:1,children:[e.jsx(B,{name:`missionAdditionalHyperlinkSet.${ae}.name`,label:"連結名稱",variant:"control"}),e.jsx(B,{name:`missionAdditionalHyperlinkSet.${ae}.hyperlink`,label:"連結",variant:"control"}),e.jsx(j,{label:"刪除",onClick:()=>S(ae),btnColor:"CANCEL_RED"})]},K.id)),e.jsx(j,{label:"增加資訊",onClick:I,btnColor:"BTN_LATTE_GRAY",disabled:a.length>=2})]})})},Dt=()=>{const a=()=>{E({src:"",id:0},h?h.length:0)},p=S=>{P(S)};return e.jsxs(l,{gap:2,children:[h==null?void 0:h.map((S,I)=>{var K;return e.jsxs(i.Fragment,{children:[e.jsxs(l,{flexDirection:"row",alignItems:"center",justifyContent:"space-around",width:"100%",gap:1,children:[e.jsx(Ge,{title:"多媒體圖片",name:"picIds",index:I}),e.jsx(j,{label:"刪除",btnColor:"CANCEL_RED",onClick:()=>p(I)})]}),((K=h[I])==null?void 0:K.src)&&e.jsx($e,{styleType:"formImage",src:h[I].src})]},`${S.id}_${I}`)}),e.jsx(j,{label:"增加多媒體圖片",btnColor:"BTN_LATTE_GRAY",onClick:a,disabled:h?h.length>=3:!1,maxWidth:200})]})},{fields:J,append:Rt,remove:Lt,move:Ft}=Se({control:r,name:"missionAnswerCardSet"}),Ht=async a=>{Rt({cardId:a.id,keyWord:"",answerHint:"",orderNum:J.length+1,cardType:a.type}),await L("cardIds")},Ve=a=>J.findIndex(p=>p.cardId===a),we=a=>{a!==-1&&Lt(a)},_t=a=>J.some(p=>p.cardId===a),Pt=a=>{const p=H.find(S=>S.id===a.cardId.cardId);return e.jsx(e.Fragment,{children:p&&e.jsx(Qe,{cardDetail:p})})},Mt=a=>{a.destination&&Ft(a.source.index,a.destination.index)},$t=()=>{J.forEach((a,p)=>{C(`missionAnswerCardSet.${p}.orderNum`,p+1)})},Wt=()=>{const a=A.current;if(!a)return;const p=a.selectionStart,S=a.selectionEnd;if(p===null||S===null||p===S)return;const I=g.slice(p,S);if(I.includes("$[[")&&I.trim().endsWith("$[[")||I.includes("]]")&&I.trim().startsWith("]]"))return;if(I.includes("]]")&&I.includes("$[[")){const le=I.indexOf("]]"),Yt=I.indexOf("$[[");if(le<Yt)return}const K=g.slice(0,p),ae=g.slice(S),Q=`${K}${"$[["+I+"]]"}${ae}`,de=La(Q);C("description",de),setTimeout(()=>{const le=p+4+I.length;a.selectionStart=a.selectionEnd=le},0)},Ut=()=>{const a=A.current;if(!a)return;const p=a.selectionStart,S=a.selectionEnd;if(p===null||S===null||p===S)return;const I=g.slice(p,S);if(I.startsWith("$[[")&&I.endsWith("]]")){const K=I.slice(3,-2),ae=g.slice(0,p),Q=g.slice(S),de=`${ae}${K}${Q}`;C("description",de),setTimeout(()=>{const le=p;a.selectionStart=a.selectionEnd=le},0)}};i.useEffect(()=>{if(U){const a=z.filter(p=>p!==U);C("subjectIds",a)}},[U]),i.useEffect(()=>{$t()},[J]);const Bt=a=>{Object.keys(a).length&&Object.keys(a).forEach(p=>{var S,I,K;p==="answerDescription"?(S=O.current)==null||S.scrollIntoView({behavior:"smooth"}):p==="cardIds"?(I=n.current)==null||I.scrollIntoView({behavior:"smooth"}):p==="missionAnswerCardSet"?(K=R.current)==null||K.scrollIntoView({behavior:"smooth"}):window.scrollTo({top:0,behavior:"smooth"})})};return e.jsxs(l,{p:2,justifyContent:"center",alignItems:"center",width:"100%",children:[e.jsxs(Ye,{onSubmit:q(re,Bt),children:[e.jsxs(l,{flexDirection:"row",ml:"auto",gap:3,children:[e.jsx(j,{label:"儲存",sx:{ml:"auto"},type:"submit"}),e.jsx(j,{label:"取消",onClick:y,sx:{ml:"auto"},btnColor:"CANCEL_RED"})]}),e.jsxs(te,{container:!0,spacing:6,wrap:"wrap",children:[e.jsx(te,{item:!0,sm:12,lg:6,children:e.jsxs(l,{gap:1,children:[e.jsx(B,{name:"name",label:"任務名稱",variant:"control",alertText:"字數限制：15字元(必填)"}),e.jsx(X,{name:"schoolId",label:"學校",options:St(),type:"ONE",variant:"control",alertText:"必填"}),e.jsx(X,{name:"mainSubjectId",label:"主要學科",options:Ct(),type:"ONE",variant:"control",alertText:"必填"}),e.jsx(Et,{}),e.jsx(B,{name:"syllabus",label:"課綱",variant:"control"}),e.jsx(X,{name:"level",label:"等級",options:yt(),type:"ONE",variant:"control",alertTextList:["1~12(小一至高三，1=小一，7=國一，10=高一，以此類推。","A：上學期期中考前","B：上學期期中考後","C：下學期期中考前","D：下學期期中考後","(必填)"]}),e.jsx(B,{name:"area",label:"地點",variant:"control",alertTextList:["1. 請輸入事件發生地點(大可為「臺灣」，小可為「台北市大安區學府里」)。","2. 請一半題目地點為台灣本土，一半為台灣之外的世界地區。","3. 若正確知識卡涉及任務地點，建議此格以較為模糊的方式描述。","(必填)"]}),e.jsx(X,{name:"centuryId",label:"世紀",options:It(),type:"ONE",variant:"control",alertTextList:["1. 西元前：請統一選「西元前」。","2. 西元後：請依照線索文本情境，選擇該世紀。","(必填)"]}),e.jsxs(l,{flexDirection:"row",alignItems:"center",justifyContent:"space-between",children:[e.jsx(me,{labelTitle:"線索文本",tooltipSx:{maxWidth:"1000px"},alertTextList:["※字數限制：","中文-300字內，含標點符號。","英文-200字內，含標點符號。","1. 整個線索文本的多張卡片中至少對應到1-2個關鍵字，以 ${{}} 標示。且至少有一張卡片需要對應到2個關鍵字。","2. 情境以第三人稱視角(攝影機視角)呈現，描述眼前看到、聽到的人事物。","3. 情境中不會直接出現人名、地名、建築名稱。起始可以用：'看到一個人在...' 或 '有一座鐵塔...'作為開頭。※若為社會科可酌情放寬使用地名，但請盡量避免直接使用人名。","4. 時間跨度不宜太長，如：那裡的士兵戰鬥了10年，因為情境看到的是當下發生的事情，故不會跨越10年。可調整為：有一個長者正在講述一個關於戰爭的故事，他說：「那裡的士兵戰鬥了10年」。","(必填)"]}),e.jsxs(l,{flexDirection:"row",alignItems:"center",gap:3,children:[e.jsx(j,{label:"新增為關鍵字",onClick:Wt}),e.jsx(j,{label:"移除關鍵字",btnColor:"CANCEL_RED",onClick:Ut})]})]}),e.jsxs(l,{ref:O,gap:3,children:[e.jsx(Qt,{ref:A,name:"description",rows:8}),e.jsx(xe,{name:"answerDescription",label:"解答說明",rows:4,variant:"control",alertText:"包含答案與解說，數學要有運算過程。總字數限定3000字 (必填)"})]})]})}),e.jsx(te,{item:!0,sm:12,lg:6,flexDirection:"column",children:e.jsxs(l,{gap:2,children:[e.jsx(xe,{name:"note",label:"編輯者註解",rows:13,variant:"control"}),e.jsx(me,{labelSx:{flex:2},labelTitle:"多媒體補充資訊",alertTextList:["1. 網址或圖片格式，網址最多2個，圖片最多3張。","2. 隨著題目本身補充的資訊內容、圖片、以及說明文字。"]}),e.jsx(Nt,{}),e.jsx(Dt,{}),e.jsx(B,{name:"missionHintSet.0.hint",label:"整體鷹架提示1",variant:"control",alertTextFlex:5,alertText:"針對整題的情境額外的提示，於發動特定戰寵卡時提供。每個鷹架提示限定25字 (必填)"}),e.jsx(B,{name:"missionHintSet.1.hint",label:"整體鷹架提示2",variant:"control",alertTextFlex:5,alertText:"針對整題的情境額外的提示，於發動特定戰寵卡時提供。每個鷹架提示限定25字 (必填)"}),e.jsx(B,{name:"missionHintSet.2.hint",label:"整體鷹架提示3",variant:"control",alertTextFlex:5,alertText:"針對整題的情境額外的提示，於發動特定戰寵卡時提供。每個鷹架提示限定25字 (必填)"}),e.jsx(l,{ref:n})]})})]}),e.jsxs(l,{flexDirection:"row",gap:3,alignItems:"center",children:[e.jsx(me,{labelTitle:"已選擇卡牌區",tooltipSx:{maxWidth:"500px"},alertTextList:["1. 數量限制：正確知識卡至少3張，最多6張。","2. 卡片總數: 8+(正確知識卡數)張。","(必填)"],placement:"top"}),e.jsx(j,{label:"選擇卡片",type:"button",onClick:kt}),e.jsx(j,{label:"創建卡片",type:"button",btnColor:"BTN_LATTE_GRAY",onClick:At}),e.jsx(Xt,{title:e.jsx("div",{style:{textAlign:"center",fontSize:"1rem"},children:["人物卡：特定歷史人物、當代人物、或情境故事中的角色","概念卡：原理、原則概念、包含社會科學與自然科學的各種概念","事件卡：特定歷史事件或故事情境中的事件","地點卡：特定地理位置、或情境故事中的場景與地點","時間卡：特定年代、日期、時間、世紀等時間或時間區間","數字卡：數值","現象卡：特定自然現象或社會現象或趨勢","符號卡：數學符號、單位符號、各種符號、包含語言符號","語文卡：中英語詞、修辭詞彙、成語諺語、詩詞歌賦等","物件卡：物體、工具、物品等具象的實物"].map((a,p)=>e.jsx("p",{children:a},p))}),componentsProps:{tooltip:{sx:{maxWidth:"1200px"}}},sx:{backgroundColor:Z.CURRY,color:Z.WHITE,p:1,borderRadius:2,fontWeight:800,letterSpacing:1,cursor:"pointer"},disableInteractive:!0,placement:"top",children:e.jsx(W,{children:"知識卡類別說明"})})]}),!!c.cardIds&&e.jsx(Ke,{sx:{textAlign:"center",color:Z.CANCEL_RED,fontSize:"1.5rem"},children:c.cardIds.message}),!!c.missionAnswerCardSet&&e.jsx(Ke,{sx:{textAlign:"center",color:Z.CANCEL_RED,fontSize:"1.5rem"},children:c.missionAnswerCardSet.message}),e.jsx(Ee,{name:"cardIds",control:r,render:()=>e.jsx(l,{gap:12,flexDirection:"row",flexWrap:"wrap",sx:{border:`1px solid ${Z.TAB_BG_GRAY}`,p:5,pb:10},children:H.map(a=>e.jsxs(l,{alignItems:"center",children:[e.jsx(at,{defaultChecked:J.some(p=>p.cardId===a.id),checked:J.some(p=>p.cardId===a.id),disabled:J.length>=6&&!_t(a.id),onChange:p=>{p.target.checked?Ht(a):we(Ve(a.id))}}),e.jsx(Qe,{cardDetail:a,selectCardClick:p=>Ot({...a,imageSrc:p}),onRemoveClick:()=>wt(a.id)})]},a.id))})}),e.jsx(Ee,{name:"missionAnswerCardSet",control:r,render:()=>e.jsx(te,{item:!0,sm:12,ref:R,children:e.jsx(l,{gap:3,children:e.jsx(pa,{onDragEnd:Mt,children:e.jsx(xa,{droppableId:"droppable",children:a=>e.jsxs(l,{ref:a.innerRef,...a.droppableProps,gap:3,children:[J.map((p,S)=>e.jsx(ma,{draggableId:p.id,index:S,children:I=>e.jsx(l,{ref:I.innerRef,...I.draggableProps,...I.dragHandleProps,children:e.jsxs(l,{flexDirection:"row",gap:3,sx:{border:"1px solid #aaa",p:3,bgcolor:"white"},children:[e.jsxs(l,{flex:2.5,gap:2,children:[e.jsx(B,{name:`missionAnswerCardSet.${S}.keyWord`,label:"卡片線索說明",variant:"control",alertTextFlex:7,alertText:"於置牌區顯示予玩家出牌引導。(必填)"}),e.jsx(l,{flexDirection:"row",gap:2,children:e.jsxs(ge,{children:["正確卡片",S+1]})})]}),e.jsx(l,{flex:1,alignItems:"center",gap:1,children:e.jsx(Pt,{cardId:p})}),e.jsx(l,{flex:2.5,gap:1,children:e.jsx(B,{name:`missionAnswerCardSet.${S}.answerHint`,label:"答案卡鷹架提示",variant:"control",alertTextFlex:7,alertText:"25字內，含標點符號。(必填)"})})]})})},p.id)),a.placeholder]})})})})})})]}),e.jsx(Da,{})]})},Ha=()=>{var M,G,T,Y;const{state:o}=Le(),y=Re(),{setAlertOpen:x}=he(),s=Fe(),v=et(),[b,m]=i.useState([]),[k,w]=i.useState(!1),[F,O]=i.useState(!1),{data:n,isLoading:R}=rt({id:parseInt(v.id||"0",10)}),{data:d}=ha({type:2,contentId:parseInt(v.id||"0",10)}),{mutate:f}=dt($),H=()=>{w(!k)},N=()=>{x({open:!0,title:"提示",message:"要將所有相關的內容（題目、題目之下的知識卡）都更新為已審核通過狀態嗎？",onOk:()=>_(ce.PASS)})},_=u=>{n&&f({...n,description:Ie(n.description),flag:u})};function $(u){s.invalidateQueries({queryKey:[ut.MISSION_ID(u.id)]}),x({open:!0,title:"編輯提示",message:"編輯任務成功"}),y("/audit/topicAudit")}const h=[{key:"任務名稱",value:(n==null?void 0:n.name)??""},{key:"主要學科",value:((M=n==null?void 0:n.mainSubject)==null?void 0:M.value)??""},{key:"次要學科",value:((G=n==null?void 0:n.subjectSet)==null?void 0:G.map(u=>u.value).join(", "))??""},{key:"課綱",value:(n==null?void 0:n.syllabus)??""},{key:"等級",value:(n==null?void 0:n.level)??""},{key:"地點",value:(n==null?void 0:n.area)??""},{key:"世紀",value:((T=n==null?void 0:n.century)==null?void 0:T.century)??""}],E=u=>{if(n!=null&&n.missionHintSet){const A=n.missionHintSet;if(A.length>u)return A[u].hint}return""},D=u=>{if(n!=null&&n.missionAdditionalHyperlinkSet){const A=n.missionAdditionalHyperlinkSet;if(A.length>u)return A[u]}return""},P=[{key:"線索文本",value:Ie((n==null?void 0:n.description)??"")},{key:"整體情境鷹架提示",value:E(0)},{key:"整體情境鷹架提示",value:E(1)},{key:"整體情境鷹架提示",value:E(2)},{key:"解答說明",value:(n==null?void 0:n.answerDescription)??""},{key:"多媒體補充資訊",value:D(0)},{key:"多媒體補充資訊",value:D(1)},{key:"編輯者註解",value:(n==null?void 0:n.note)??""}];return i.useEffect(()=>{var u;if(n&&((u=n.imagesSrc)!=null&&u.length)){const{picIds:A,imagesSrc:t}=n;m(t.map((r,C)=>({src:r,id:A[C].picId})))}},[n]),e.jsxs(l,{width:"100%",p:3,children:[k&&n?e.jsxs(l,{children:[e.jsx(ga,{children:e.jsx(Fa,{missionDetail:n,editModeHandler:H})}),e.jsxs(fa,{children:[e.jsx(wa,{}),e.jsx(Ea,{})]})]}):R?e.jsx(fe,{}):e.jsxs(l,{gap:3,children:[ue(pe.ROLE_PERMISSIONS_MODIFY_AUDIT)&&e.jsx(j,{label:"修改內容",onClick:H,sx:{mr:"auto"},btnColor:"BROWN"}),e.jsxs(l,{flexDirection:"row",gap:4,flexWrap:"wrap",children:[e.jsx(l,{flex:1,children:e.jsx(lt,{data:h})}),e.jsx(l,{flex:1,justifyContent:"center",alignItems:"center",gap:2,minWidth:400,children:b.length>0?b==null?void 0:b.map(u=>e.jsx("img",{width:400,src:u.src,style:{marginLeft:"auto",marginRight:"auto"}},u.id)):e.jsx(ge,{children:"無多媒體圖片"})})]}),e.jsx(l,{flexDirection:"row",gap:4,flexWrap:"wrap",justifyContent:"space-around",children:P.map((u,A)=>typeof u.value=="string"?e.jsx(ye,{label:u.key,paperText:u.value},A):e.jsx(ye,{label:u.key,paperText:"",missionAdditionalHyperlinkSet:u.value},A))}),e.jsx(l,{flexDirection:"row",gap:4,flexWrap:"wrap",justifyContent:"space-around",children:(Y=n==null?void 0:n.missionAnswerCardSet)==null?void 0:Y.map((u,A)=>e.jsx(it,{keyWord:u.keyWord,cardId:u.cardId,hint:u.hint,isAudit:!0},A))}),e.jsx(l,{flexDirection:"row",gap:4,flexWrap:"wrap",justifyContent:"flex-start",children:n==null?void 0:n.cardSet.map((u,A)=>e.jsx(ot,{card:u,notAnswer:!0},A))}),e.jsxs(l,{flexDirection:"row",gap:3,justifyContent:"end",children:[ue(pe.ROLE_PERMISSIONS_MODIFY_AUDIT)&&(n==null?void 0:n.flag)!==ce.PASS&&e.jsx(j,{label:"審查通過",type:"submit",sx:{alignSelf:"flex-end"},onClick:()=>N()}),ue(pe.ROLE_AUDITOR)?(n==null?void 0:n.flag)===ce.AUDITOR_REVIEW&&e.jsx(j,{label:"意見回覆",sx:{alignSelf:"flex-end"},btnColor:"BTN_LATTE_GRAY",onClick:()=>O(!0)}):e.jsx(j,{label:"意見回覆",sx:{alignSelf:"flex-end",position:"fixed",zIndex:10,top:"15%",right:30},btnColor:"RED",onClick:()=>O(!0)}),e.jsx(j,{label:"返回",sx:{alignSelf:"flex-end"},btnColor:"DRAWER_GRAY",onClick:()=>y(-1)})]})]}),e.jsx(ja,{children:e.jsx(Ca,{open:F,onClose:()=>{O(!1)},auditData:d,updateMissionAndCardFlag:_,flag:n==null?void 0:n.flag,topicAuditData:o.topicAuditData})})]})},_a=Ha,Pa=()=>{const o=Re(),y=Le(),{userInfo:x}=je(),s=t=>t?[{label:"名稱",value:"contentName"}]:[{label:"名稱",value:"contentName"},{label:"命題者姓名",value:"createTeacherAdlName"},{label:"審題者姓名",value:"auditTeacherAdlName"}],v=s(ue(pe.ROLE_AUDITOR)).map(t=>t.value),b=i.useCallback(t=>v.includes(t),[v]),m=i.useMemo(()=>{const t=new URLSearchParams(y.search),r=t.get("adlUserId"),C=t.get("contentName"),L=t.get("createTeacherAdlName"),q=t.get("auditTeacherAdlName"),V=t.get("updateTimeStart"),c=t.get("updateTimeEnd");return{type:2,flag:parseInt(t.get("flag")||"0",10),status:parseInt(t.get("status")||"0",10),page:parseInt(t.get("page")||"0",10),...r&&{adlUserId:r},...C&&{contentName:C},...L&&{createTeacherAdlName:L},...q&&{auditTeacherAdlName:q},...V&&{updateTimeStart:parseInt(V,10)},...c&&{updateTimeEnd:parseInt(c,10)},...Ae,sort:"updateTime,desc"}},[y.search]),k=i.useMemo(()=>{const t=Object.keys(m).find(r=>v.includes(r)&&m[r]!==void 0);return t?{searchText:m[t],currentField:t}:{searchText:"",currentField:v[0]}},[m,v]),[w,F]=i.useState(m),[O,n]=i.useState(k),[R,d]=i.useState(!1),[f,H]=i.useState(),{data:N,isSuccess:_,isLoading:$}=nt({...w,...ue(pe.ROLE_AUDITOR)&&{adlUserId:x==null?void 0:x.adlUserId}}),h=i.useMemo(()=>_&&!!N.content.length,[_,N]),E=i.useCallback(t=>{o(`auditManage/${t.contentId}`,{state:{topicAuditData:t}})},[o]),D=i.useCallback(t=>r=>{let C,L;if(typeof r=="number"||typeof r=="string"||typeof r=="boolean"?C=r:C=r.target.value,b(t)){const V={};v.forEach(c=>{c===t&&C?V[c]=C:delete w[c]}),L={...w,...V}}else L={...w,[t]:C};t!=="page"&&(L.page=0);const q=st(L);F(L),o(`?${q}`)},[o,w,v,b]),P=i.useCallback((t,r)=>{D("page")(r-1),H(r)},[D]),M=i.useCallback(()=>{f&&F(t=>({...t,page:Number(f)-1}))},[f,F]),G=t=>{n(r=>({...r,searchText:t.trim()}))},T=t=>{n(r=>({...r,currentField:t}))},Y=i.useCallback(()=>{const{currentField:t,searchText:r}=O;D(t)(r),H(1)},[D,O]),u=(t,r)=>{r&&(t==="updateTimeStart"?D(t)(ee(r).startOf("day").valueOf()):t==="updateTimeEnd"?D(t)(ee(r).endOf("day").valueOf()):D(t)(ee(r).valueOf()))},A=[{title:"",dataField:"contentId",component:t=>e.jsx(l,{gap:2,flexDirection:"row",justifyContent:"center",children:e.jsx(j,{label:Jt(Zt(),t.flag)?"審核":"觀看",btnColor:"TAB_BLUE",onClick:()=>E(t)})})},{title:"類別",dataField:"type",component:()=>e.jsx(W,{variant:"h5",children:"題目"})},{title:"狀態",dataField:"flag",component:t=>{var r;return e.jsx(W,{variant:"h5",children:((r=De.find(C=>C.value===t.flag))==null?void 0:r.label)??"無"})}},{title:"名稱",dataField:"content"},{title:"審題者姓名",dataField:"teacherData",component:t=>{var r;return e.jsx(W,{variant:"h5",children:((r=t.teacherData)==null?void 0:r.name)??"無"})}},{title:"命題者姓名",dataField:"createTeacherAdlName"},{title:"建立時間",dataField:"createTime",width:"260px",component:t=>e.jsx(W,{variant:"h5",children:ee(t.createTime).format("YYYY-MM-DD HH:mm:ss")})},{title:"狀態更新時間",dataField:"updateTime",width:"260px",component:t=>e.jsx(W,{variant:"h5",children:ee(t.updateTime).format("YYYY-MM-DD HH:mm:ss")})}];return e.jsxs(l,{flex:1,gap:5,children:[e.jsxs(l,{gap:5,flexDirection:"row",alignItems:"center",justifyContent:{xs:"center",sm:"flex-start"},flexWrap:"wrap",px:3,children:[e.jsx(mt,{value:m,handleChange:D}),e.jsxs(Ze,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(ge,{width:"fit-content",p:"4px 16px",children:"狀態更新時間"}),e.jsx(Te,{value:w.updateTimeStart??null,onChange:t=>u("updateTimeStart",t)}),e.jsx(W,{variant:"h5",children:"至"}),e.jsx(Te,{value:w.updateTimeEnd??null,onChange:t=>u("updateTimeEnd",t)})]}),e.jsxs(l,{flexDirection:"row",gap:5,flexWrap:"wrap",justifyContent:{xs:"center",sm:"flex-start"},alignItems:"center",children:[e.jsx(Oe,{value:O,options:s(ue(pe.ROLE_AUDITOR)),selectOnChange:T,inputOnChange:G,searchFuntion:Y}),e.jsx(j,{label:"搜尋",onClick:Y,btnColor:"BROWN"}),e.jsx(j,{label:"匯出 EXCEL",onClick:()=>d(!0),btnColor:"EXCEL"})]})]}),$?e.jsx(fe,{}):e.jsx(l,{children:N&&e.jsx(We,{isVisible:h,children:e.jsxs(l,{p:.5,alignItems:"center",gap:5,children:[e.jsx(Ue,{columns:A,rows:N.content}),e.jsx(tt,{totalPages:N.totalPages,currentPage:N.pageable.pageNumber,inputPage:f??1,setInputPage:H,handlePageChange:P,handlePageSearch:M})]})},JSON.stringify(w))}),e.jsx(ba,{open:R,setOpen:d,request:w,totalPages:(N==null?void 0:N.totalPages)||1,type:"TOPIC_AUDIT"})]})},Ma=Pa;function $a(){return e.jsxs(He,{children:[e.jsx(ne,{index:!0,element:e.jsx(Ma,{})}),e.jsx(ne,{path:"/auditManage/:id",element:e.jsx(_a,{})}),e.jsx(ne,{path:"*",element:e.jsx(_e,{to:"/topicAudit",replace:!0})})]})}function Va(){return e.jsxs(He,{children:[e.jsx(ne,{path:"/topicAudit/*",element:e.jsx(ze,{element:e.jsx($a,{}),permissionKey:"ROLE_PERMISSIONS_AUDIT"})}),e.jsx(ne,{path:"/assignment/*",element:e.jsx(ze,{element:e.jsx(ka,{}),permissionKey:"ROLE_PERMISSIONS_ASSIGNMENT_AUDIT"})}),e.jsx(ne,{path:"*",element:e.jsx(_e,{to:"/",replace:!0})})]})}export{Va as default};
