var jo=Object.defineProperty;var yo=(t,a,n)=>a in t?jo(t,a,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[a]=n;var be=(t,a,n)=>yo(t,typeof a!="symbol"?a+"":a,n);import{z as d,u as sn,j as e,F as rn,t as on,r as ln,A as Ye,g as Jt,Q as jt,a as Ue,b as rt,c as i,d as Me,e as Wt,f as xt,h as cn,S as o,D as v,L as Ge,i as fa,k as ba,l as _e,m as Rt,n as $e,o as Be,G as K,R as ie,p as je,q as Lt,s as Pt,v as xe,N as _t,w as me,x as Wa,y as Ya,B as pn,C as Co,E as Es,H as zt,I as $,J as Ua,T as qa,K as he,M as Er,O as Nn,P as Qt,U as dn,V as bn,W as St,X as tt,Y as z,Z as So,_ as qt,$ as Dt,a0 as Ir,a1 as yt,a2 as ht,a3 as It,a4 as ze,a5 as et,a6 as sa,a7 as Sn,a8 as Zs,a9 as Mt,aa as Va,ab as Eo,ac as Io,ad as To,ae as wo,af as La,ag as ke,ah as Jn,ai as Do,aj as Pn,ak as hs,al as is,am as Tr,an as un,ao as Ze,ap as Vt,aq as Is,ar as Ts,as as Mn,at as Kt,au as vo,av as wr,aw as ko,ax as Dr,ay as Ao,az as No,aA as Yn,aB as Un,aC as qn,aD as Vn,aE as Oo,aF as Ht,aG as vr,aH as wt,aI as Ro,aJ as Lo,aK as Po,aL as _o,aM as Mo,aN as Fo,aO as Bo}from"./index-DH9E0Dqq.js";import{S as vt,F as lt,B as Tt,P as Yt,C as On,a as kr,b as Ft}from"./PaginationControl-CenqpxQH.js";import{c as ut,F as it,I as $t,s as fn,u as at,O as ws,L as er,A as Ho,D as pa,a as ja,b as $o,d as Ds,e as vn,f as Go,g as Ar,h as Ka,i as Nr,C as Or,j as Rr,o as za,k as Wo,l as tr,m as Yo,n as Uo,p as qo,q as Lr,r as Vo,E as Rn,t as Ko,v as zo,w as Qo,x as Xo,y as Jo,z as Zo,B as el,G as tl,H as nl,J as al,K as Pr,S as vs,M as sl,N as rl,P as il,Q as ol,R as ll,T as Qa,U as os,V as Xa,W as cl,X as _r,Y as xs,Z as gt,_ as ks,$ as As,a0 as Ns,a1 as Mr,a2 as Fr,a3 as dl,a4 as ul,a5 as pl,a6 as ml,a7 as hl,a8 as Ja,a9 as xl,aa as gl,ab as fl,ac as bl,ad as jl,ae as yl}from"./AuditProvider-BfaT1Ozk.js";import{S as Ve,d as Ie,L as Cl,D as Sl,B as an}from"./DatePicker-DAUzD4hQ.js";import{C as Xt,a as Br}from"./CardContent-Buvwad75.js";import{A as El,q as Il,B as Tl,u as wl,a as Dl,b as Za,c as vl,d as kl,e as Al,f as gs,g as Kn,w as Os,h as Hr,i as $r,j as Nl,k as Ol,l as Gr,m as Wr,n as qe,o as Yr,p as Ur,r as Pa,s as Rl,t as Ll,v as Pl,x as _l,y as Ml,z as Fl,C as Bl,D as Hl,E as nr,F as ar,G as $l,H as zn,I as Qn,J as Gl,K as Wl,L as Yl,M as Ul,N as qr,O as Vr,P as Kr}from"./ArrowUpward-2KjtWO5g.js";import{B as Ut,a as Et}from"./BasicInput-D0G2rzCO.js";import{S as ql}from"./protocol-mjXn3Aw8.js";import{D as es,u as Vl,a as Rs,b as Kl,c as zl,S as Ql}from"./hook-4gwLvy6S.js";import{I as fs}from"./InputLabel-D5TVACTd.js";const Xl=d.intersection(d.object({name:d.string().min(1,"主旨必填").max(10,"主旨不可超過10字"),race:d.string().min(1),raceSound:d.string().min(1),lv:d.number().min(1),picId:d.number().min(1,"魔王全圖必填"),halfPicId:d.number().min(1,"魔王半身圖片必填"),spine:d.string().regex(/true|false/,"請選擇是否為Spine")}),d.discriminatedUnion("variant",[d.object({variant:d.literal("create")}),d.object({variant:d.literal("update"),id:d.number().min(1)})])),zr={variant:"create",name:"",race:"beast",raceSound:"獸",lv:1,picId:0,halfPicId:0,spine:"false"},Jl=({children:t})=>{const a=sn({mode:"all",resolver:on(Xl),defaultValues:zr});return e.jsxs(rn,{...a,children:[t,!1]})},Zl=Jl,ca=class ca{};ca.BOSS="/enemy",ca.BOSS_SEARCH="/enemy/search",ca.BOSS_ID=a=>`/enemy/${a}`;let kn=ca;async function ec(t,a){try{const n=ln(t),s=await Ye.get(kn.BOSS_SEARCH,{signal:a,params:n}),r=await Promise.all(s.data.data.content.map(async l=>{const c=await Jt({id:l.picId},a);return{...l,picUrl:c.src}}));return{...s.data.data,content:r}}catch(n){throw new Error(`getAllBoss, ${n}`)}}async function tc(t,a){try{const n=await Ye.get(kn.BOSS_ID(t),{signal:a}),s=await Promise.all([Jt({id:n.data.data.picId}),Jt({id:n.data.data.halfPicId})]);return{...n.data.data,picUrl:s[0].src,halfPicUrl:s[1].src}}catch(n){throw new Error(`getBossById, ${n}`)}}async function nc(t){try{return(await Ye.post(kn.BOSS,t)).data.data}catch(a){throw new Error(`postBossCreate, ${a}`)}}async function ac(t){try{return(await Ye.put(kn.BOSS_ID(t.id.toString()),t)).data.data}catch(a){throw new Error(`putBossUpdate, ${a}`)}}function sc(t){const a=jt(t);return Ue({queryKey:[kn.BOSS_SEARCH,a],queryFn:({signal:n})=>ec(t,n)})}function rc(t){return Ue({queryKey:[kn.BOSS_ID(t)],queryFn:({signal:a})=>tc(t,a)})}function ic(t){return rt({mutationFn:nc,onSuccess:t})}function oc(t){return rt({mutationFn:ac,onSuccess:t})}const la=[{label:"魔獸",value:"beast"},{label:"機械",value:"robot"},{label:"隕石",value:"rock"},{label:"時空之罪",value:"timeAndSpace"}],lc=["魔獸","機械","隕石","時空之罪"],cc={魔獸:["龍","獸","禽"],機械:["機械人","高階機械"],隕石:["巨人","石怪","水晶族"],時空之罪:["要塞","戰艦","海盜船"]},_n={beast:[{label:"龍",value:"dragon"},{label:"獸",value:"beast"},{label:"禽",value:"birds"}],robot:[{label:"機械人",value:"robot"},{label:"高階機械",value:"highRobot"}],rock:[{label:"巨人",value:"giant"},{label:"石怪",value:"stone"},{label:"水晶族",value:"crystal"}],timeAndSpace:[{label:"要塞",value:"fortress"},{label:"戰艦",value:"ship"},{label:"海盜船",value:"pirateShip"}]},Qr=(t,a)=>({init:`/audio/${t}/${a}_init.mp3`,death:`/audio/${t}/${a}_death.mp3`}),Xr=(t,a)=>{const n=`/video/${t}/${a}_1.mp4`,s=a==1?`/video/${t}/2_2.mp4`:`/video/${t}/${a}_2.mp4`;return console.log(n,s),[n,s]},Jr=[{label:"A Class",value:3},{label:"B Class",value:2},{label:"C Class",value:1}],dc=i.memo(({value:t,handleChange:a})=>{const n=t.race!="全選"?cc[t.race].map(s=>({label:s,value:s})):[];return e.jsxs(i.Fragment,{children:[e.jsx(Ve,{label:"種族",options:[{label:"全選",value:"全選"},...lc.map(s=>({label:s,value:s}))],value:t.race,onChange:a("race")}),e.jsx(Ve,{label:"音效類別",options:[{label:"全選",value:"全選"},...n],value:t.raceSound,onChange:a("raceSound")}),e.jsx(Ve,{label:"級別",options:[{label:"全部",value:0},{label:"A Class",value:3},{label:"B Class",value:2},{label:"C Class",value:1}],value:t.lv,onChange:a("lv")})]})}),Zr=[{label:"魔王名稱",value:"name"},{label:"最後修改者",value:"lastModifierAdlName"}],Sa=Zr.map(t=>t.value),uc=t=>Sa.includes(t),pc=()=>{const t=Me(),a=Wt(),{userInfo:n}=xt(),s=i.useMemo(()=>{const M=new URLSearchParams(a.search),Y=M.get("name"),U=M.get("lastModifierAdlName");return{race:M.get("race")||"全選",raceSound:M.get("raceSound")||"全選",lv:M.get("lv")?parseInt(M.get("lv")||"1",10):0,page:parseInt(M.get("page")||"0",10),creatorAdlUserId:M.get("creator")||"",...Y&&{name:Y},...U&&{lastModifierAdlName:U},...cn,size:5}},[a.search]),r=i.useMemo(()=>{const M=Object.keys(s).find(Y=>Sa.includes(Y)&&s[Y]!==void 0);return M?{searchText:s[M],currentField:M}:{searchText:"",currentField:Sa[0]}},[s]),[l,c]=i.useState(s),[g,m]=i.useState(r),[E,f]=i.useState(),{data:T,isSuccess:y,isLoading:D}=sc(l),S=i.useMemo(()=>y&&!!T,[y,T]),j=i.useCallback(()=>{t("create")},[t]),w=i.useCallback(M=>{t(`update/${M}`)},[t]),O=i.useCallback(M=>Y=>{let U,A;if(typeof Y=="number"||typeof Y=="string"||typeof Y=="boolean"?U=Y:U=Y.target.value,uc(M)){const x={};Sa.forEach(h=>{h===M&&U?x[h]=U:delete l[h]}),A={...l,...x}}else A={...l,[M]:U};M==="race"&&(A.raceSound="全選"),M!=="page"&&(A.page=0);const p=ut(ln(A));c(A),t(`?${p}`)},[t,l]),B=i.useCallback((M,Y)=>{O("page")(Y-1),f(Y)},[O]),k=i.useCallback(()=>{E&&c(M=>({...M,page:Number(E)-1}))},[E,c]),q=M=>{m(Y=>({...Y,searchText:M}))},H=M=>{m(Y=>({...Y,currentField:M}))},G=M=>{M?O("creatorAdlUserId")(n.adlUserId):O("creatorAdlUserId")("")},N=i.useCallback(()=>{const{currentField:M,searchText:Y}=g;O(M)(Y),f(1)},[O,g]),L=[{title:"操作",dataField:"id",width:"150px",component:M=>e.jsx(v,{label:"編輯",onClick:()=>w(M.id),btnColor:"TAB_BLUE"})},{title:"id",dataField:"id"},{title:"魔王圖片",dataField:"picUrl",width:"450px",component:M=>e.jsx("img",{src:M.picUrl,alt:"魔王圖片",width:300,height:300})},{title:"魔王名稱",dataField:"name"},{title:"種族",dataField:"race"},{title:"音效類別",dataField:"raceSound"},{title:"級別",dataField:"lv",component:M=>e.jsx(e.Fragment,{children:M.lv===3?"A Class":M.lv===2?"B Class":"C Class"})},{title:"修改次數",dataField:"updateCount",component:M=>e.jsx(e.Fragment,{children:M.updateCount})}];return e.jsxs(o,{flex:1,gap:5,children:[e.jsx(v,{label:"創建魔王",onClick:j,sx:{ml:"auto"},btnColor:"BLUE"}),e.jsx(o,{flexDirection:"row",gap:4,alignItems:"center",justifyContent:{xs:"center",sm:"flex-start"},flexWrap:"wrap",px:3,children:e.jsxs(o,{flexDirection:"row",gap:4,flexWrap:"wrap",justifyContent:{xs:"center",sm:"flex-start"},alignItems:"center",children:[e.jsx(dc,{value:l,handleChange:O}),e.jsx(vt,{check:!!l.creatorAdlUserId,value:g,options:Zr,selectOnChange:H,inputOnChange:q,searchFuntion:N,checkBoxOnChange:G}),e.jsx(v,{label:"搜尋",onClick:N,btnColor:"BROWN"})]})}),D?e.jsx(Ge,{}):e.jsx(o,{children:T&&e.jsx(lt,{isVisible:S,children:e.jsxs(o,{p:.5,alignItems:"center",gap:5,children:[e.jsx(Tt,{columns:L,rows:T.content}),e.jsx(Yt,{totalPages:T.totalPages,currentPage:T.pageable.pageNumber,inputPage:E??1,setInputPage:f,handlePageChange:B,handlePageSearch:k})]})},JSON.stringify(l))})]})},mc=pc;var Ls={},hc=ba;Object.defineProperty(Ls,"__esModule",{value:!0});var Fn=Ls.default=void 0,xc=hc(fa()),gc=e;Fn=Ls.default=(0,xc.default)((0,gc.jsx)("path",{d:"m10 16.5 6-4.5-6-4.5zM12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2m0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8"}),"PlayCircleOutline");var Ps={},fc=ba;Object.defineProperty(Ps,"__esModule",{value:!0});var ma=Ps.default=void 0,bc=fc(fa()),jc=e;ma=Ps.default=(0,bc.default)((0,jc.jsx)("path",{d:"M6 6h12v12H6z"}),"Stop");const Ot=t=>"https://dtgp-stage-web.aiv.com.tw/api".includes("dtgp-stage")?`/twa-admin/${t}`:t,yc=()=>{const t=Me(),{setAlertOpen:a}=_e(),{setSelectedType:n,setBossSelectedImage:s,setBossHalfSelectedImage:r,bossHalfSelectedImage:l,bossSelectedImage:c}=Rt(),g=i.useRef(null),m=i.useRef(null),[E,f]=i.useState(!1),[T,y]=i.useState(!1),{reset:D,control:S,setValue:j,handleSubmit:w}=$e(),O=Be({control:S,name:"race"}),B=Be({control:S,name:"raceSound"}),k=Be({control:S,name:"lv"}),q=_n[O],H=Qr(O,B),G=Xr(O,k),{mutate:N}=ic(U),L=A=>{var _,Z;const{variant:p,lv:x,spine:h,race:I,raceSound:P,...F}=A,u={...F,race:((_=la.find(C=>C.value===I))==null?void 0:_.label)||"",raceSound:((Z=_n[I].find(C=>C.value===P))==null?void 0:Z.label)||"",lv:x,spine:h==="true",atk:x===3?300:x===2?200:100};if(!u.race||!u.raceSound){a({open:!0,title:"提示",message:"請選擇種族和音效類別"});return}N(u)},M=A=>{a({open:!0,title:"提示",message:"請確認魔王創建資料是否有誤",onOk:()=>L(A)})},Y=A=>{A.current&&(A.current.paused?(A.current.play(),A.current.id==="audio1"?f(!0):y(!0)):(A.current.pause(),A.current.currentTime=0,A.current.id==="audio1"?f(!1):y(!1)))};function U(){a({open:!0,title:"提示",message:"魔王創建成功"}),t("/edit/bossEdit")}return i.useEffect(()=>(D(zr),n("ENEMY"),()=>{D(),s(null),r(null)}),[]),i.useEffect(()=>{j("raceSound",_n[O][0].value)},[O]),i.useEffect(()=>{c&&j("picId",c.id,{shouldValidate:!0})},[c]),i.useEffect(()=>{l&&j("halfPicId",l.id,{shouldValidate:!0})},[l]),e.jsxs(it,{onSubmit:w(M),sx:{gap:6},children:[e.jsxs(K,{container:!0,spacing:6,wrap:"wrap",children:[e.jsx(K,{item:!0,sm:12,lg:6,children:e.jsxs(o,{gap:2,children:[e.jsx(ie,{name:"name",label:"名稱",variant:"control",tooltipSx:{width:"200px"}}),e.jsx("p",{style:{color:"gray",marginTop:"-5px",marginLeft:"auto"},children:"(名稱字數限制為十個字以內)"}),e.jsx(je,{name:"race",label:"種族",options:la,type:"ONE",variant:"control"}),e.jsx(je,{name:"raceSound",label:"音效類別",options:q,type:"ONE",variant:"control"}),e.jsx(je,{name:"spine",label:"是否為Spine",options:[{value:"true",label:"是"},{value:"false",label:"否"}],type:"ONE",variant:"control",disabled:!0}),e.jsx("p",{style:{color:"gray"},children:"音效試聽"}),e.jsxs(o,{gap:6,flexDirection:"row",flexWrap:"wrap",sx:{mt:"-20px",ml:1},children:[e.jsxs(o,{gap:1,flexDirection:"row",flexWrap:"wrap",alignItems:"center",children:[E?e.jsx(ma,{sx:{width:"30px",height:"30px",cursor:"pointer",transition:"all 0.15s","&:hover":{color:"gray"}},onClick:()=>Y(g)}):e.jsx(Fn,{sx:{width:"30px",height:"30px",cursor:"pointer",transition:"all 0.15s","&:hover":{color:"gray"}},onClick:()=>Y(g)}),e.jsx("audio",{ref:g,id:"audio1",src:Ot(H.init),controls:!0,style:{display:"none"},onEnded:()=>f(!1)}),e.jsx("p",{style:{color:"gray"},children:"魔王登場音效"})]}),e.jsxs(o,{gap:1,flexDirection:"row",flexWrap:"wrap",alignItems:"center",children:[T?e.jsx(ma,{sx:{width:"30px",height:"30px",cursor:"pointer",transition:"all 0.15s","&:hover":{color:"gray"}},onClick:()=>Y(m)}):e.jsx(Fn,{sx:{width:"30px",height:"30px",cursor:"pointer",transition:"all 0.15s","&:hover":{color:"gray"}},onClick:()=>Y(m)}),e.jsx("audio",{ref:m,id:"audio2",src:Ot(H.death),controls:!0,style:{display:"none"},onEnded:()=>y(!1)}),e.jsx("p",{style:{color:"gray"},children:"魔王死亡音效"})]})]}),e.jsx(je,{name:"lv",label:"級別",options:Jr,type:"ONE",variant:"control",placement:"top",alertTextList:["攻擊力基礎值","A Class: 300","B Class: 200","C Class: 100"]}),e.jsx("p",{style:{color:"gray"},children:"特效展示"}),e.jsxs(o,{gap:4,flexDirection:"row",flexWrap:"wrap",children:[e.jsxs(o,{flexDirection:"column",flexWrap:"wrap",children:[e.jsx("p",{style:{color:"gray",marginTop:"-5px"},children:"1"}),e.jsx("video",{src:Ot(G[0]),autoPlay:!0,loop:!0,width:"420px",height:"236.25px",style:{objectFit:"contain"}})]}),e.jsxs(o,{flexDirection:"column",flexWrap:"wrap",children:[e.jsx("p",{style:{color:"gray",marginTop:"-5px"},children:"2"}),e.jsx("video",{src:Ot(G[1]),autoPlay:!0,loop:!0,width:"420px",height:"236.25px",style:{objectFit:"contain"}})]})]})]})}),e.jsx(K,{item:!0,sm:12,lg:6,children:e.jsxs(o,{gap:4,flexDirection:"row",alignItems:"flex-start",children:[e.jsxs(o,{gap:1,children:[e.jsx($t,{title:"魔王圖像_全圖",name:"picId",stackSx:{flexDirection:"column"},labelSx:{width:"100%"},selectBtnSx:{justifyContent:"space-around"},handleOpenUploadDialog:()=>n("ENEMY"),handleOpenSearchDialog:()=>n("ENEMY")}),c&&c.src?e.jsx("img",{src:c.src,alt:"",width:"300px",height:"300px",style:{objectFit:"cover",borderRadius:"30px",marginLeft:"auto",marginRight:"auto",marginTop:"20px"}}):e.jsx(Xt,{sx:{width:"300px",height:"300px",borderRadius:"30px",marginLeft:"auto",marginRight:"auto",marginTop:"20px",boxShadow:"2px 2px 2px 2px #00000020"}}),e.jsx("p",{style:{color:"#aaaaaa",marginLeft:"auto",marginRight:"auto",marginTop:"-5px"},children:"圖片尺寸需為 1450 * 1450"}),e.jsx("p",{style:{color:"gray",marginLeft:"auto",marginRight:"auto",marginTop:"-10px"},children:"魔王戰鬥中示意圖"}),e.jsxs(o,{sx:{position:"relative"},children:[e.jsx("img",{src:Ot("/image/game/BG_1920X1080.png"),alt:"",width:"420px",height:"236.25px",style:{objectFit:"cover",marginLeft:"auto",marginRight:"auto"}}),c&&c.src&&e.jsx("img",{src:c.src,alt:"",width:"158.5px",height:"158.5px",style:{objectFit:"cover",position:"absolute",top:0,left:"50%",transform:"translateX(-50%)"}})]})]}),e.jsxs(o,{gap:1,children:[e.jsx($t,{title:"魔王圖像_半身",name:"halfPicId",stackSx:{flexDirection:"column"},labelSx:{width:"100%"},selectBtnSx:{justifyContent:"space-around"},handleOpenUploadDialog:()=>n("ENEMY_HALF"),handleOpenSearchDialog:()=>n("ENEMY_HALF")}),l&&l.src?e.jsx("img",{src:l.src,alt:"",width:"300px",height:"300px",style:{objectFit:"contain",borderRadius:"30px",marginLeft:"auto",marginRight:"auto",marginTop:"20px"}}):e.jsx(Xt,{sx:{width:"300px",height:"300px",borderRadius:"30px",marginLeft:"auto",marginRight:"auto",marginTop:"20px",boxShadow:"2px 2px 2px 2px #00000020"}}),e.jsx("p",{style:{color:"#aaaaaa",marginLeft:"auto",marginRight:"auto",marginTop:"-5px"},children:"圖片尺寸需為 300 * 300"}),e.jsx("p",{style:{color:"gray",marginLeft:"auto",marginRight:"auto",marginTop:"-10px"},children:"魔王個人頁面意圖"}),e.jsxs(o,{sx:{position:"relative"},children:[e.jsx("img",{src:Ot("/image/game/Boss_Frame_300x300.png"),alt:"",width:"200px",height:"200px",style:{objectFit:"contain",marginLeft:"auto",marginRight:"auto",zIndex:1}}),e.jsx("img",{src:Ot("/image/game/Boss_S_Bg_300x300.png"),alt:"",width:"200px",height:"200px",style:{objectFit:"contain",position:"absolute",top:0,left:"50%",transform:"translateX(-50%)"}}),e.jsx("img",{src:Ot("/image/game/Boss_S_NameBg_300x50.png"),alt:"",width:"200px",height:"200px",style:{objectFit:"contain",position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, 8%)"}}),e.jsx("p",{style:{color:"white",fontSize:"20px",fontWeight:"bold",position:"absolute",top:"90%",left:"50%",transform:"translate(-45%, 0%)"},children:"魔王名稱"}),l&&l.src&&e.jsx("img",{src:l.src,alt:"",width:"200px",height:"200px",style:{objectFit:"cover",position:"absolute",top:0,left:"50px"}})]})]})]})})]}),e.jsx(v,{label:"送出",type:"submit",btnColor:"BTN_LATTE_GRAY",sx:{alignSelf:"flex-end"}})]})},Cc=yc,Sc=()=>{const{id:t}=Lt(),a=Me(),{setAlertOpen:n}=_e(),{setSelectedType:s,setBossSelectedImage:r,setBossHalfSelectedImage:l,bossHalfSelectedImage:c,bossSelectedImage:g}=Rt(),m=i.useRef(null),E=i.useRef(null),[f,T]=i.useState(!1),[y,D]=i.useState(!1),{reset:S,control:j,setValue:w,handleSubmit:O}=$e(),{data:B,isLoading:k,isError:q}=rc(t),H=Be({control:j,name:"race"}),G=Be({control:j,name:"raceSound"}),N=Be({control:j,name:"lv"}),L=_n[H],M=Qr(H,G),Y=Xr(H,N),{mutate:U}=oc(h),A=I=>{var se,X;const{variant:P,lv:F,spine:u,race:_,raceSound:Z,...C}=I,V={...C,race:((se=la.find(R=>R.value===_))==null?void 0:se.label)||"",raceSound:((X=_n[_].find(R=>R.value===Z))==null?void 0:X.label)||"",lv:F,spine:u==="true",atk:F===3?300:F===2?200:100};if(!V.race||!V.raceSound){n({open:!0,title:"提示",message:"請選擇種族和音效類別"});return}U({...V,id:parseInt(t,10)})},p=I=>{n({open:!0,title:"提示",message:"請確認魔王創建資料是否有誤",onOk:()=>A(I)})},x=I=>{I.current&&(I.current.paused?(I.current.play(),I.current.id==="audio1"?T(!0):D(!0)):(I.current.pause(),I.current.currentTime=0,I.current.id==="audio1"?T(!1):D(!1)))};function h(){n({open:!0,title:"提示",message:"魔王更新成功"}),a("/edit/bossEdit")}if(i.useEffect(()=>(s("ENEMY"),()=>{S(),r(null),l(null)}),[]),i.useEffect(()=>{var I,P;if(B){const{picId:F,halfPicId:u,picUrl:_,halfPicUrl:Z,spine:C,race:V,raceSound:se,...X}=B,R=(I=la.find(W=>W.label===V))==null?void 0:I.value,b=(P=_n[R].find(W=>W.label===se))==null?void 0:P.value;r({id:F,src:_}),l({id:u,src:Z}),S({...X,spine:C?"true":"false",race:R,raceSound:b,variant:"update"})}},[B]),i.useEffect(()=>{w("raceSound",_n[H][0].value)},[H]),i.useEffect(()=>{g&&w("picId",g.id,{shouldValidate:!0})},[g]),i.useEffect(()=>{c&&w("halfPicId",c.id,{shouldValidate:!0})},[c]),q){n({open:!0,title:"提示",message:"魔王資料獲取失敗"}),a(-1);return}return e.jsx(it,{onSubmit:O(p),sx:{gap:6},children:k?e.jsx(Ge,{}):e.jsxs(e.Fragment,{children:[e.jsxs(K,{container:!0,spacing:6,wrap:"wrap",children:[e.jsx(K,{item:!0,sm:12,lg:6,children:e.jsxs(o,{gap:2,children:[e.jsx(ie,{name:"name",label:"名稱",variant:"control",tooltipSx:{width:"200px"}}),e.jsx("p",{style:{color:"gray",marginTop:"-5px",marginLeft:"auto"},children:"(名稱字數限制為十個字以內)"}),e.jsx(je,{name:"race",label:"種族",options:la,type:"ONE",variant:"control"}),e.jsx(je,{name:"raceSound",label:"音效類別",options:L,type:"ONE",variant:"control"}),e.jsx(je,{name:"spine",label:"是否為Spine",options:[{value:"true",label:"是"},{value:"false",label:"否"}],type:"ONE",variant:"control",disabled:!0}),e.jsx("p",{style:{color:"gray"},children:"音效試聽"}),e.jsxs(o,{gap:6,flexDirection:"row",flexWrap:"wrap",sx:{mt:"-20px",ml:1},children:[e.jsxs(o,{gap:1,flexDirection:"row",flexWrap:"wrap",alignItems:"center",children:[f?e.jsx(ma,{sx:{width:"30px",height:"30px",cursor:"pointer",transition:"all 0.15s","&:hover":{color:"gray"}},onClick:()=>x(m)}):e.jsx(Fn,{sx:{width:"30px",height:"30px",cursor:"pointer",transition:"all 0.15s","&:hover":{color:"gray"}},onClick:()=>x(m)}),e.jsx("audio",{ref:m,id:"audio1",src:Ot(M.init),controls:!0,style:{display:"none"},onEnded:()=>T(!1)}),e.jsx("p",{style:{color:"gray"},children:"魔王登場音效"})]}),e.jsxs(o,{gap:1,flexDirection:"row",flexWrap:"wrap",alignItems:"center",children:[y?e.jsx(ma,{sx:{width:"30px",height:"30px",cursor:"pointer",transition:"all 0.15s","&:hover":{color:"gray"}},onClick:()=>x(E)}):e.jsx(Fn,{sx:{width:"30px",height:"30px",cursor:"pointer",transition:"all 0.15s","&:hover":{color:"gray"}},onClick:()=>x(E)}),e.jsx("audio",{ref:E,id:"audio2",src:Ot(M.death),controls:!0,style:{display:"none"},onEnded:()=>D(!1)}),e.jsx("p",{style:{color:"gray"},children:"魔王死亡音效"})]})]}),e.jsx(je,{name:"lv",label:"級別",options:Jr,type:"ONE",variant:"control",placement:"top",alertTextList:["攻擊力基礎值","A Class: 300","B Class: 200","C Class: 100"]}),e.jsx("p",{style:{color:"gray"},children:"特效展示"}),e.jsxs(o,{gap:4,flexDirection:"row",flexWrap:"wrap",children:[e.jsxs(o,{flexDirection:"column",flexWrap:"wrap",children:[e.jsx("p",{style:{color:"gray",marginTop:"-5px"},children:"1"}),e.jsx("video",{src:Ot(Y[0]),autoPlay:!0,loop:!0,width:"420px",height:"236.25px",style:{objectFit:"contain"}})]}),e.jsxs(o,{flexDirection:"column",flexWrap:"wrap",children:[e.jsx("p",{style:{color:"gray",marginTop:"-5px"},children:"2"}),e.jsx("video",{src:Ot(Y[1]),autoPlay:!0,loop:!0,width:"420px",height:"236.25px",style:{objectFit:"contain"}})]})]})]})}),e.jsx(K,{item:!0,sm:12,lg:6,children:e.jsxs(o,{gap:4,flexDirection:"row",alignItems:"flex-start",children:[e.jsxs(o,{gap:1,children:[e.jsx($t,{title:"魔王圖像_全圖",name:"picId",stackSx:{flexDirection:"column"},labelSx:{width:"100%"},selectBtnSx:{justifyContent:"space-around"},handleOpenUploadDialog:()=>s("ENEMY"),handleOpenSearchDialog:()=>s("ENEMY")}),g&&g.src?e.jsx("img",{src:g.src,alt:"",width:"300px",height:"300px",style:{objectFit:"cover",borderRadius:"30px",marginLeft:"auto",marginRight:"auto",marginTop:"20px"}}):e.jsx(Xt,{sx:{width:"300px",height:"300px",borderRadius:"30px",marginLeft:"auto",marginRight:"auto",marginTop:"20px",boxShadow:"2px 2px 2px 2px #00000020"}}),e.jsx("p",{style:{color:"#aaaaaa",marginLeft:"auto",marginRight:"auto",marginTop:"-5px"},children:"圖片尺寸需為 1450 * 1450"}),e.jsx("p",{style:{color:"gray",marginLeft:"auto",marginRight:"auto",marginTop:"-10px"},children:"魔王戰鬥中示意圖"}),e.jsxs(o,{sx:{position:"relative"},children:[e.jsx("img",{src:Ot("/image/game/BG_1920X1080.png"),alt:"",width:"420px",height:"236.25px",style:{objectFit:"cover",marginLeft:"auto",marginRight:"auto"}}),g&&g.src&&e.jsx("img",{src:g.src,alt:"",width:"158.5px",height:"158.5px",style:{objectFit:"cover",position:"absolute",top:0,left:"50%",transform:"translateX(-50%)"}})]})]}),e.jsxs(o,{gap:1,children:[e.jsx($t,{title:"魔王圖像_半身",name:"halfPicId",stackSx:{flexDirection:"column"},labelSx:{width:"100%"},selectBtnSx:{justifyContent:"space-around"},handleOpenUploadDialog:()=>s("ENEMY_HALF"),handleOpenSearchDialog:()=>s("ENEMY_HALF")}),c&&c.src?e.jsx("img",{src:c.src,alt:"",width:"300px",height:"300px",style:{objectFit:"contain",borderRadius:"30px",marginLeft:"auto",marginRight:"auto",marginTop:"20px"}}):e.jsx(Xt,{sx:{width:"300px",height:"300px",borderRadius:"30px",marginLeft:"auto",marginRight:"auto",marginTop:"20px",boxShadow:"2px 2px 2px 2px #00000020"}}),e.jsx("p",{style:{color:"#aaaaaa",marginLeft:"auto",marginRight:"auto",marginTop:"-5px"},children:"圖片尺寸需為 300 * 300"}),e.jsx("p",{style:{color:"gray",marginLeft:"auto",marginRight:"auto",marginTop:"-10px"},children:"魔王個人頁面示意圖"}),e.jsxs(o,{sx:{position:"relative"},children:[e.jsx("img",{src:Ot("/image/game/Boss_Frame_300x300.png"),alt:"",width:"200px",height:"200px",style:{objectFit:"contain",marginLeft:"auto",marginRight:"auto",zIndex:1}}),e.jsx("img",{src:Ot("/image/game/Boss_S_Bg_300x300.png"),alt:"",width:"200px",height:"200px",style:{objectFit:"contain",position:"absolute",top:0,left:"50%",transform:"translateX(-50%)"}}),e.jsx("img",{src:Ot("/image/game/Boss_S_NameBg_300x50.png"),alt:"",width:"200px",height:"200px",style:{objectFit:"contain",position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, 8%)"}}),e.jsx("p",{style:{color:"white",fontSize:"20px",fontWeight:"bold",position:"absolute",top:"90%",left:"50%",transform:"translate(-45%, 0%)"},children:"魔王名稱"}),c&&c.src&&e.jsx("img",{src:c.src,alt:"",width:"200px",height:"200px",style:{objectFit:"cover",position:"absolute",top:0,left:"50px"}})]})]})]})})]}),e.jsx(v,{label:"送出",type:"submit",btnColor:"BTN_LATTE_GRAY",sx:{alignSelf:"flex-end"}})]})})},Ec=Sc;function Ic(){return e.jsx(Zl,{children:e.jsxs(Pt,{children:[e.jsx(xe,{index:!0,element:e.jsx(mc,{})}),e.jsx(xe,{path:"/create",element:e.jsx(Cc,{})}),e.jsx(xe,{path:"/update/:id",element:e.jsx(Ec,{})}),e.jsx(xe,{path:"*",element:e.jsx(_t,{to:"/edit/bossEdit",replace:!0})})]})})}const Tc=t=>d.intersection(d.object({name:fn(t,1,"關卡名稱必填",10,"關卡名稱最多10個字"),description:fn(t,1,"關卡名稱必填",100,"關卡名稱最多100個字"),totalMinute:d.number().min(1,{message:"時間限制必填"}),note:d.union([d.string(),d.null()]),schoolId:d.number().min(1,{message:"學校ID必填"}),flag:d.nativeEnum(me),missionEnemyCampModeSet:d.array(d.object({missionId:d.number().min(1,{message:"任務必選"}),enemyId:d.number().min(1,{message:"敵人必選"}),isStagePic:d.boolean()})).min(1,{message:"任務必填"}),isPublish:d.boolean().nullable()}),d.discriminatedUnion("variant",[d.object({variant:d.literal("create")}),d.object({variant:d.literal("update"),id:d.number().min(1)})])),ei={variant:"create",name:"",description:"",note:"",schoolId:0,flag:me.PASS,totalMinute:15,missionEnemyCampModeSet:[{missionId:0,enemyId:0,isStagePic:!0},{missionId:0,enemyId:0,isStagePic:!1},{missionId:0,enemyId:0,isStagePic:!1},{missionId:0,enemyId:0,isStagePic:!1},{missionId:0,enemyId:0,isStagePic:!1}],isPublish:null},wc=({children:t})=>{const{flag:a}=at(),n=Tc(a),s=sn({mode:"all",resolver:on(n),defaultValues:ei});return e.jsxs(rn,{...s,children:[t,!1]})},Dc=wc;function Hn(){const t=Wa(),{missionDialogOpen:a,enemyDialogOpen:n,selectedMission:s,selectedEnemy:r,missionIndex:l,enemyIndex:c}=Ya(j=>j.missionEnemySet);return{missionDialogOpen:a,enemyDialogOpen:n,setMissionDialogOpen:(j,w)=>{t(pn.actions.setMissionDialogOpen({open:j,index:w}))},setEnemyDialogOpen:(j,w)=>{t(pn.actions.setEnemyDialogOpen({open:j,index:w}))},selectedEnemy:r,selectedMission:s,setSelectEnemy:j=>{if(!j){t(pn.actions.selectedEnemy(null));return}if(c!=null){const w=r?[...r]:Array.from({length:c+1});w[c]=j,t(pn.actions.selectedEnemy(w))}},setDeleteEnemy:j=>{if(r){const w=[...r];w.splice(j,1),t(pn.actions.selectedEnemy(w))}},setSelectMission:j=>{if(!j){t(pn.actions.selectedMission(null));return}if(l!=null){const w=s?[...s]:Array.from({length:l+1});w[l]=j,t(pn.actions.selectedMission(w))}},setDeleteMission:j=>{if(s){const w=[...s];w.splice(j,1),t(pn.actions.selectedMission(w))}},missionIndex:l,enemyIndex:c,setAllEnemy:j=>{t(pn.actions.selectedEnemy(j))},setAllMission:j=>{t(pn.actions.selectedMission(j))}}}function ti(){const t=Wa(),a=Ya(l=>l.subject.subjectOptions);return{setSubjectOptions:l=>{t(Co.actions.setSubjectOptions(l))},subjectOptions:a,getSubjectLabel:l=>a?a.filter(c=>l==c.id).map(c=>c.value).join(""):"",getSubjectLabels:l=>!a||!l?"":a.filter(c=>l.includes(c.id)).map(c=>c.value).join(", ")}}const vc=({missionDetail:t,open:a,onClose:n})=>{var E,f,T,y;const s=D=>D.replace(/\$\{\{(.*?)\}\}/g,"$[[$1]]"),r=Es((t==null?void 0:t.picIds.map(D=>({id:D.picId})))??[]),l=[{key:"任務名稱",value:(t==null?void 0:t.name)??""},{key:"主要學科",value:((E=t==null?void 0:t.mainSubject)==null?void 0:E.value)??""},{key:"學科",value:((f=t==null?void 0:t.subjectSet)==null?void 0:f.map(D=>D.value).join(", "))??""},{key:"課綱",value:(t==null?void 0:t.syllabus)??""},{key:"等級",value:(t==null?void 0:t.level)??""},{key:"地點",value:(t==null?void 0:t.area)??""},{key:"世紀",value:((T=t==null?void 0:t.century)==null?void 0:T.century)??""}],c=D=>{if(t!=null&&t.missionHintSet){const S=t.missionHintSet;if(S.length>D)return S[D].hint}return""},g=D=>{if(t!=null&&t.missionAdditionalHyperlinkSet){const S=t.missionAdditionalHyperlinkSet;if(S.length>D)return S[D]}return""},m=[{key:"線索文本",value:s((t==null?void 0:t.description)??"")},{key:"整體情境鷹架提示",value:c(0)},{key:"整體情境鷹架提示",value:c(1)},{key:"整體情境鷹架提示",value:c(2)},{key:"解答說明",value:(t==null?void 0:t.answerDescription)??""},{key:"多媒體補充資訊",value:g(0)},{key:"多媒體補充資訊",value:g(1)},{key:"編輯者註解",value:(t==null?void 0:t.note)??""}];return e.jsxs(zt,{open:a,fullScreen:!0,onClose:n,sx:{p:10},children:[e.jsx(v,{label:"關閉",sx:{position:"absolute",top:5,right:5,bgcolor:$.CANCEL_RED},onClick:n}),t?e.jsxs(o,{gap:3,p:3,children:[e.jsxs(o,{flexDirection:"row",gap:4,children:[e.jsx(o,{flex:1,children:e.jsx(ws,{data:l})}),e.jsx(o,{flex:1,justifyContent:"center",children:r==null?void 0:r.map(D=>{var S,j;return e.jsx("img",{width:400,height:400,src:(S=D.data)==null?void 0:S.src,style:{marginLeft:"auto",marginRight:"auto"}},(j=D.data)==null?void 0:j.id)})})]}),e.jsx(o,{flexDirection:"row",gap:4,flexWrap:"wrap",justifyContent:"space-around",children:m.map((D,S)=>typeof D.value=="string"?e.jsx(er,{label:D.key,paperText:D.value},S):e.jsx(er,{label:D.key,paperText:"",missionAdditionalHyperlinkSet:D.value},S))}),e.jsx(o,{flexDirection:"row",gap:4,flexWrap:"wrap",justifyContent:"space-around",children:(y=t==null?void 0:t.missionAnswerCardSet)==null?void 0:y.map((D,S)=>e.jsx(Ho,{keyWord:D.keyWord,cardId:D.cardId,hint:D.hint},S))}),e.jsx(o,{flexDirection:"row",flexWrap:"wrap",gap:2,children:t==null?void 0:t.cardSet.map((D,S)=>e.jsx(pa,{cardDetail:D},S))})]}):e.jsx(Ua,{type:"mission"})]})},ni=i.memo(vc),kc=i.memo(({sx:t,options:a,value:n,onChange:s})=>{const r=(l,c)=>{s(c)};return e.jsx(o,{spacing:2,sx:{...t,minWidth:"150px"},children:e.jsx(El,{sx:{color:"black",fontSize:"1rem",textAlign:"left"},freeSolo:!0,id:"free-solo-2-demo",disableClearable:!0,options:a.filter(l=>!!l),value:n,onChange:r,renderInput:l=>e.jsx(qa,{...l,InputProps:{...l.InputProps,type:"search",style:{padding:"3px"}}})})})}),Ac=({label:t,labalSx:a,stackSx:n,...s})=>e.jsxs(o,{flexDirection:"row",sx:{gap:.5,alignItems:"center",justifyContent:"center",...n},children:[e.jsx(he,{sx:{paddingRight:"1.5rem",paddingLeft:"1.5rem",...a},children:t}),e.jsx(kc,{...s})]}),Nc=({value:t,handleChange:a,isSelect:n})=>{const{data:s}=ja(),{data:r}=$o(),{data:l}=Ds(),c=i.useMemo(()=>vn.concat(Array.from({length:12},(T,y)=>({label:(y+1).toString(),value:y+1}))),[]),g=i.useMemo(()=>s?vn.concat(s.filter(T=>T.value!="全科目").map(T=>({label:T.value,value:T.id}))):[],[s]),m=i.useMemo(()=>r?Go.concat(r.map(T=>T)):[],[r]),E=i.useMemo(()=>l?vn.concat(l.map(T=>({label:T.century,value:T.id}))):[],[l]),f=i.useMemo(()=>n?Er:vn.concat(Nn),[n]);return e.jsxs(i.Fragment,{children:[e.jsx(Ve,{label:"年級",options:c,value:t.grade,onChange:a("grade")}),e.jsx(Ve,{label:"世紀",options:E,value:t.centuryId,onChange:a("centuryId")}),e.jsx(Ac,{label:"地點",options:m,onChange:T=>a("area")(T),value:t.area}),e.jsx(Ve,{label:"狀態",options:f,value:t.flag,onChange:a("flag")}),e.jsx(Ve,{label:"主要學科",options:g,value:t.subjectId,onChange:a("subjectId")})]})},ai=i.memo(Nc),si=[{label:"關鍵字",value:"keyword"},{label:"線索文本",value:"description"},{label:"任務名稱",value:"name"},{label:"關卡碼",value:"stageCode"},{label:"校名",value:"schoolName"},{label:"命題者",value:"author"}],bs=si.map(t=>t.value),Oc=t=>bs.includes(t),Rc=({isCampStage:t})=>{const[a,n]=i.useState({subjectId:0,grade:0,onlySelf:!1,centuryId:0,area:"全選",page:0,flag:t?5:2}),s={...a,...cn},{setMissionDialogOpen:r,missionDialogOpen:l,setSelectMission:c,selectedMission:g}=Hn(),{getSubjectLabels:m}=ti(),{userInfo:E}=xt(),[f,T]=i.useState({searchText:"",currentField:bs[0]}),[y,D]=i.useState(null),{data:S,isSuccess:j,isLoading:w}=Ar(s),[O,B]=i.useState(!1),[k,q]=i.useState(!1),H=i.useMemo(()=>j&&!!S.content.length,[j,S]),G=i.useCallback(()=>{B(!0)},[]),N=i.useCallback(()=>{B(!1)},[]),L=F=>u=>{let _,Z;if(typeof u=="number"||typeof u=="string"||typeof u=="boolean"?_=u:_=u.target.value,Oc(F)){const C={};bs.forEach(V=>{V===F&&_?C[V]=_:delete s[V]}),Z={...s,...C}}else Z={...s,[F]:_};F!=="page"&&(Z.page=0),n(Z)},M=(F,u)=>{n(_=>({..._,page:u-1}))},Y=()=>{q(!k)},U=()=>{r(!1,null)},A=F=>{D(F),G()},p=F=>{T(u=>({...u,searchText:F}))},x=F=>{T(u=>({...u,currentField:F}))},h=F=>{L("onlySelf")(F)},I=()=>{const{currentField:F,searchText:u}=f;L(F)(u)},P=[{title:"",dataField:"id",component:F=>E?e.jsx(v,{label:"選擇",onClick:()=>{c(F),U()},disabled:!(St(tt.ROLE_MANAGER)||St(tt.ROLE_ADMIN))&&F.teacherData.name!==E.adlName||!(St(tt.ROLE_MANAGER)||St(tt.ROLE_ADMIN))&&F.flag===me.PASS||!!(g&&g.some(u=>(u==null?void 0:u.id)===(F==null?void 0:F.id)))}):e.jsx(e.Fragment,{})},{title:"任務名稱",dataField:"name",width:"250px"},{title:"任務內容",dataField:"description",width:"250px",component:F=>{var u;return e.jsx(z,{variant:"h5",children:F.description?((u=F.description)==null?void 0:u.replace(/\${{([^{}]*)}}/g,"$1").slice(0,10))+"...":"無"})}},{title:"關卡碼",dataField:"id",width:"250px",component:F=>{const u=k?F.stageCodeList.join(" , "):F.stageCodeList.slice(0,3).join(" , ")+(F.stageCodeList.length>3?" ...":"");return e.jsxs(o,{flexDirection:"row",alignItems:"center",gap:3,children:[e.jsx(z,{variant:"h5",children:F.stageCodeList.length>0?u:"無"}),F.stageCodeList.length>3&&e.jsx(v,{onClick:Y,label:k?"-":"+"})]})}},{title:"等級",dataField:"level",width:"120px"},{title:"世紀",dataField:"century",width:"120px",component:F=>e.jsx(z,{variant:"h5",children:F.century?F.century.century:"無"})},{title:"地點",dataField:"area",width:"120px"},{title:"主要學科",dataField:"mainSubject",width:"150px",component:F=>e.jsx(z,{variant:"h5",children:F.mainSubject?F.mainSubject.value:"無"})},{title:"次要學科",dataField:"subjectIds",width:"200px",component:F=>e.jsx(z,{variant:"h5",children:F.subjectIds.length>0?m(F==null?void 0:F.subjectIds):"無"})},{title:"校名",dataField:"school",width:"300px",component:F=>e.jsx(z,{variant:"h5",children:F.school.schoolName})},{title:"創關者",dataField:"teacherData",width:"120px",component:F=>e.jsx(z,{variant:"h5",children:F.teacherData.name})},{title:"狀態",dataField:"flag",width:"150px",component:F=>e.jsx(z,{variant:"h5",children:Nn[F.flag-1].label})},{title:"編輯/檢視",dataField:"id",width:"150px",component:F=>e.jsx(v,{label:"檢視",onClick:()=>A(F),btnColor:"BTN_LATTE_GRAY"})}];return e.jsxs(i.Fragment,{children:[O&&y&&e.jsx(ni,{missionDetail:y,open:O,onClose:N}),e.jsxs(zt,{open:l,fullScreen:!0,onClose:U,sx:{p:4},PaperProps:{sx:{p:4}},children:[e.jsxs(Qt,{sx:{textAlign:"center",fontSize:36},id:"customized-dialog-title",children:["可選擇任務列表",e.jsxs(o,{flexDirection:"row",gap:5,alignItems:"center",justifyContent:{xs:"center",sm:"flex-start"},flexWrap:"wrap",px:3,children:[e.jsx(ai,{handleChange:L,value:s,isSelect:!0}),e.jsxs(o,{flexDirection:"row",gap:5,flexWrap:"wrap",justifyContent:{xs:"center",sm:"flex-start"},alignItems:"center",children:[e.jsx(vt,{check:a.onlySelf,value:f,options:si,selectOnChange:x,inputOnChange:p,checkBoxOnChange:h,searchFuntion:I}),e.jsx(v,{label:"搜尋",onClick:I,btnColor:"BROWN"})]})]})]}),e.jsx(dn,{dividers:!0,children:w?e.jsx(Ge,{}):e.jsx(o,{children:S&&e.jsx(lt,{isVisible:H,children:e.jsxs(o,{p:.5,alignItems:"center",gap:5,children:[e.jsx(Tt,{columns:P,rows:S.content}),e.jsx(bn,{count:S.totalPages,page:S.pageable.pageNumber+1,onChange:M,color:"primary"})]})},JSON.stringify(s))})}),e.jsx(v,{label:"關閉",color:"error",sx:{position:"absolute",top:5,right:5},onClick:U})]})]})},ri=i.memo(Rc),Dn=class Dn{static ENEMY_ID(a){return`/enemy/${a}`}};Dn.ENEMY_SEARCH="/enemy/search",Dn.ENEMY_ALL="/enemy/all",Dn.ENEMY_HP="/enemy/hp",Dn.ENEMY_LV="/enemy/lv",Dn.ENEMY_ATK="/enemy/atk",Dn.ENEMY_PIC="/enemy/pic";let Zt=Dn;async function Lc(t,a){try{return(await Ye.get(Zt.ENEMY_ID(t),{signal:a})).data.data}catch(n){throw new Error(`getEnemyById, ${n}`)}}async function Pc(t,a){try{const n=ln(t);return(await Ye.get(Zt.ENEMY_SEARCH,{signal:a,params:n})).data.data}catch(n){throw new Error(`getEnemyBySearch, ${n}`)}}async function _c(t){try{return(await Ye.get(Zt.ENEMY_LV,{signal:t})).data.data}catch(a){throw new Error(`getAllLv, ${a}`)}}async function Mc(t){try{return(await Ye.get(Zt.ENEMY_ATK,{signal:t})).data.data}catch(a){throw new Error(`getAllAtk, ${a}`)}}async function Fc(t){try{return(await Ye.get(Zt.ENEMY_PIC,{params:t})).data.data}catch(a){throw new Error(`getEnemyPic, ${a}`)}}function Bc(t){const a=jt(t);return Ue({queryKey:[Zt.ENEMY_SEARCH,a],queryFn:({signal:n})=>Pc(t,n)})}function ii(t){return Ue({queryKey:[Zt.ENEMY_ID(t.id)],queryFn:({signal:a})=>Lc(t.id,a),enabled:!!t.id})}function Hc(){var s,r;const t=So({queries:[{queryKey:[Zt.ENEMY_LV],queryFn:({signal:l})=>_c(l)},{queryKey:[Zt.ENEMY_ATK],queryFn:({signal:l})=>Mc(l)}]}),a=t.some(l=>l.isLoading);return{data:{lvOptions:vn.concat(((s=t[0].data)==null?void 0:s.map(l=>({value:l,label:l.toString()})))||[]),atkOptions:vn.concat(((r=t[1].data)==null?void 0:r.map(l=>({value:l,label:l.toString()})))||[])},isLoading:a}}function $c(t){return Ue({queryKey:[Zt.ENEMY_PIC,t],queryFn:()=>Fc(t)})}const Gc=({enemy:t})=>{const{data:a,isLoading:n}=qt({id:(t==null?void 0:t.picId)??0}),s=i.useMemo(()=>[{key:"名稱",value:t.name},{key:"攻擊力",value:t.atk},{key:"等級",value:t.lv}],[t]);return e.jsxs(K,{container:!0,alignItems:"center",spacing:4,wrap:"wrap",justifyContent:"center",children:[e.jsx(K,{item:!0,xs:12,md:6,children:n?e.jsx(Ua,{}):e.jsx(Dt,{width:250,height:250,src:(a==null?void 0:a.src)??""})}),e.jsx(K,{item:!0,xs:12,md:6,children:s.map((r,l)=>e.jsxs(o,{flexDirection:"row",alignItems:"center",children:[e.jsx(he,{p:"0.25rem",children:r.key}),e.jsx(he,{bgc:"#fff",p:"0.25rem",children:r.value})]},l))})]})},Wc=i.memo(Gc),Yc=()=>{const[t,a]=i.useState({lv:0,atk:0,page:0}),n={...t,...cn,name:""},{setEnemyDialogOpen:s,enemyDialogOpen:r,setSelectEnemy:l}=Hn(),{data:c,isSuccess:g}=Bc(n),{data:{lvOptions:m,atkOptions:E},isLoading:f}=Hc(),T=i.useMemo(()=>g&&!!c.content.length,[g,c]),y=w=>O=>{a(B=>({...B,[w]:O.target.value,page:0}))},D=(w,O)=>{a(B=>({...B,page:O-1}))},S=()=>{s(!1,null)},j=w=>{l(w),S()};return e.jsxs(zt,{open:r,fullScreen:!0,onClose:S,sx:{p:4},PaperProps:{sx:{p:4}},children:[e.jsxs(Qt,{sx:{textAlign:"center",fontSize:36},id:"customized-dialog-title",children:["可選擇敵人",f?e.jsx(Ge,{}):e.jsxs(o,{direction:"row",gap:7,px:3,my:3,flexWrap:"wrap",children:[e.jsx(Ve,{label:"LV",options:m,value:t.lv,onChange:y("lv")}),e.jsx(Ve,{label:"攻擊力",options:E,value:t.atk,onChange:y("atk")})]})]}),e.jsx(dn,{dividers:!0,children:c&&e.jsx(lt,{isVisible:T,children:e.jsxs(o,{justifyContent:"center",alignItems:"center",children:[e.jsx(o,{direction:"row",gap:4,flexWrap:"wrap",justifyContent:"space-between",my:2,width:"100%",children:c==null?void 0:c.content.map((w,O)=>e.jsxs(o,{width:{xs:"100%",lg:"45%"},direction:"row",gap:2,children:[e.jsx(v,{label:"選擇",sx:{maxHeight:200,my:"auto"},onClick:()=>j(w)}),e.jsx(Wc,{enemy:w},O)]},O))}),e.jsx(bn,{count:c.totalPages,page:c.pageable.pageNumber+1,onChange:D,color:"primary"})]})},JSON.stringify(n))}),e.jsx(v,{label:"關閉",color:"error",sx:{position:"absolute",top:5,right:5},onClick:S})]})},oi=Yc,Ga=class Ga{static CAMP_STAGE_ID(a){return`${this.CAMP_STAGE}/${a}`}static CAMP_STAGE_CHANGE_PUBLISH(a){return`${this.CAMP_STAGE_ID(a)}/change/publish`}};Ga.CAMP_STAGE="/stageCampMode",Ga.CAMP_STAGE_SEARCH="/stageCampMode/search";let jn=Ga;async function Uc(t,a){const n=ln(t);try{return(await Ye.get(jn.CAMP_STAGE_SEARCH,{signal:a,params:n})).data.data}catch(s){throw new Error(`getCampStageBySearch, ${s}`)}}async function qc(t,a){try{return(await Ye.get(jn.CAMP_STAGE_ID(t),{signal:a})).data.data}catch(n){throw new Error(`getCampStageById, ${n}`)}}async function Vc(t){try{const a=t.missionEnemyCampModeSet.map(r=>Ir(r)),n={...t,missionEnemyCampModeSet:a};return(await Ye.post(jn.CAMP_STAGE,n)).data.data}catch(a){throw new Error(`postCreateCampStage, ${a}`)}}async function Kc(t){try{const a=Ir(t);return(await Ye.put(jn.CAMP_STAGE_ID(a.id),a)).data.data}catch(a){throw new Error(`postUpdateCampStage, ${a}`)}}async function zc(t,a){try{return(await Ye.put(jn.CAMP_STAGE_CHANGE_PUBLISH(t),{isPublish:a})).data.data}catch(n){throw new Error(`putChangeCampStagePublish, ${n}`)}}function Qc(t){const a=jt(t);return Ue({queryKey:[jn.CAMP_STAGE_SEARCH,a],queryFn:({signal:n})=>Uc(t,n)})}function Xc(t){return Ue({queryKey:[jn.CAMP_STAGE_ID(t.id)],queryFn:({signal:a})=>qc(t.id,a),enabled:!!t.id})}function Jc(t){return rt({mutationFn:Vc,onSuccess:a=>{a&&t()}})}function Zc(t){return rt({mutationFn:Kc,onSuccess:a=>{a&&t(a.id)}})}function ed(t){return rt({mutationFn:({id:a,isPublish:n})=>zc(a,n),onSuccess:a=>{a&&t(a)}})}const li=i.memo(({sx:t,...a})=>e.jsx(qa,{rows:6,multiline:!0,sx:{width:"280px",color:"black",fontSize:"1rem",textAlign:"left","& input":{borderColor:"#2A5390",color:"black",fontSize:"1rem",fontWeight:500},"& .MuiOutlinedInput-root":{"& fieldset":{borderColor:"#ffffff"},"&:hover fieldset":{borderColor:"#ffffff"}},"& .MuiOutlinedInput-root.Mui-focused":{"& fieldset":{borderColor:"#ffffff"}},bgcolor:`${a.error?$.FORMIK_ERROR_RED:"#fff"}`,...t},...a,placeholder:a.error?a.errormessage:""})),td=({data:t,row:a=!0,sx:n,picId:s})=>{const{data:r}=qt({id:s??0});return e.jsxs(o,{flexDirection:a?"row":"column",alignItems:"center",gap:2,sx:n,children:[e.jsx(o,{flex:2.5,...!a&&{width:"100%"},children:t.map((l,c)=>e.jsxs(o,{flexDirection:"row",alignItems:"center",children:[e.jsx(he,{children:l.key}),e.jsx(he,{bgc:"#fff",children:l.value})]},c))}),e.jsx(Dt,{width:250,height:250,src:(r==null?void 0:r.src)??"",style:{marginTop:"auto",marginBottom:"auto",flex:1}})]})},nd=i.memo(td),ad=({index:t,item:a})=>{var f,T,y;const{setAlertOpen:n}=_e(),{data:s,isError:r}=Ka({id:a.missionId}),{data:l,isError:c}=ii({id:a.enemyId}),g=(l==null?void 0:l.picId)??0;if(r||c)return n({open:!0,title:"錯誤",message:"取得任務或敵人資料失敗"}),null;const m=[{key:"任務名稱",value:(s==null?void 0:s.name)||"無"},{key:"主要學科",value:((f=s==null?void 0:s.mainSubject)==null?void 0:f.value)||"無"},{key:"次要學科",value:((T=s==null?void 0:s.keyCompetenceSet)==null?void 0:T.map(D=>D.value).join(", "))||"無"},{key:"課綱",value:(s==null?void 0:s.syllabus)||"無"},{key:"等級",value:(s==null?void 0:s.level)||"無"},{key:"地點",value:(s==null?void 0:s.area)||"無"},{key:"世紀",value:((y=s==null?void 0:s.century)==null?void 0:y.century)||"無"}],E=[{key:"名稱",value:(l==null?void 0:l.name)||"無"},{key:"HP",value:(l==null?void 0:l.hp)||"無"},{key:"攻擊力",value:(l==null?void 0:l.atk)||"無"},{key:"等級",value:(l==null?void 0:l.lv)||"無"}];return e.jsxs(o,{flex:1,p:4,sx:{border:"1px solid #aaa"},gap:3,children:[e.jsxs(z,{variant:"h5",children:["任務",t+1]}),e.jsxs(o,{direction:"row",flex:1,gap:3,alignItems:"center",children:[e.jsx(o,{flex:3,children:e.jsx(ws,{data:m,fontSize:20})}),e.jsx(o,{flex:1,children:e.jsx(nd,{data:E,row:!1,sx:{width:"100%"},picId:g})})]})]})},sd=i.memo(ad),rd=({stage:t,open:a,onClose:n})=>{var r;const s=qt({id:(t==null?void 0:t.picId)||0});return e.jsxs(zt,{open:a,fullScreen:!0,onClose:n,sx:{p:3},children:[e.jsx(v,{label:"關閉",sx:{position:"absolute",top:5,right:5,bgcolor:$.CANCEL_RED},onClick:n}),e.jsx(Qt,{sx:{textAlign:"center",fontSize:36},id:"customized-dialog-title",children:"關卡總覽"}),t?e.jsx(dn,{dividers:!0,children:e.jsxs(o,{gap:3,children:[e.jsxs(o,{direction:"row",textAlign:"center",gap:4,children:[e.jsxs(o,{gap:2,children:[e.jsxs(o,{direction:"row",textAlign:"center",gap:4,children:[e.jsx(he,{children:t.name}),e.jsxs(he,{children:["關卡碼: ",t.stageCode]})]}),e.jsx(Dt,{width:700,height:400,src:((r=s==null?void 0:s.data)==null?void 0:r.src)??""})]}),e.jsxs(o,{flex:1,gap:5.5,children:[e.jsx(o,{direction:"row",children:e.jsxs(he,{flex:1,children:["限制時間 ",t.totalMinute," 分鐘"]})}),e.jsxs(o,{mb:"auto",children:[e.jsx(he,{children:"說明文字"}),e.jsx(li,{value:t.description,sx:{border:"1px solid #aaa",width:"100%"},disabled:!0})]})]})]}),e.jsx(o,{gap:3,children:t.missionEnemyCampModeSet.map((l,c)=>e.jsx(sd,{index:c,item:l},c))})]})}):e.jsx(Ua,{type:"card"})]})},id=i.memo(rd),ci=[{label:"關卡名稱",value:"stageName"},{label:"關卡碼",value:"stageCode"},{label:"任務名稱",value:"missionName"}],Ea=ci.map(t=>t.value),od=t=>Ea.includes(t),ld=()=>{const t=Me(),a=Wt(),n=yt(),{userInfo:s,permissions:r}=xt(),{setAlertOpen:l}=_e(),{mutate:c}=ed(L),g=i.useMemo(()=>r&&r.includes("ROLE_PERMISSIONS_MODIFY_PUBLISHED"),[r]),m=i.useMemo(()=>{const C=new URLSearchParams(a.search),V=C.get("stageName"),se=C.get("stageCode"),X=C.get("missionName");return{gameId:parseInt(C.get("gameId")||"0",10),flag:parseInt(C.get("flag")||"0",10),page:parseInt(C.get("page")||"0",10),onlySelf:C.get("onlySelf")==="true",...V&&{name:V},...se&&{stageCode:se},...X&&{missionName:X},...cn}},[a.search]),E=i.useMemo(()=>{const C=Object.keys(m).find(V=>Ea.includes(V)&&m[V]!==void 0);return C?{searchText:m[C],currentField:C}:{searchText:"",currentField:Ea[0]}},[m]),[f,T]=i.useState(m),[y,D]=i.useState(E),[S,j]=i.useState(null),[w,O]=i.useState(!1),[B,k]=i.useState(),{data:q,isSuccess:H,isLoading:G}=Qc(f),N=i.useMemo(()=>H&&!!q.content.length,[H,q]);function L(C){const V=jt(f);n.invalidateQueries({queryKey:[jn.CAMP_STAGE_SEARCH,V]}),l({open:!0,title:"更新提示",message:C.isPublish?"已成功上架":"已成功下架"})}const M=i.useCallback(C=>V=>{let se,X;if(typeof V=="number"||typeof V=="string"||typeof V=="boolean"?se=V:se=V.target.value,od(C)){const b={};Ea.forEach(W=>{W===C&&se?b[W]=se:delete f[W]}),X={...f,...b}}else X={...f,[C]:se};C!=="page"&&(X.page=0);const R=ut(X);T(X),t(`?${R}`)},[t,f]),Y=(C,V)=>{c({id:C,isPublish:V})},U=i.useCallback((C,V)=>{M("page")(V-1),k(V)},[M]),A=i.useCallback(()=>{B&&T(C=>({...C,page:Number(B)-1}))},[B,T]),p=()=>{t("createCampStage")},x=i.useCallback(C=>{t(`updateCampStage/${C}`)},[t]),h=i.useCallback(C=>{j(C),O(!0)},[]),I=i.useCallback(()=>{O(!1)},[]),P=C=>{D(V=>({...V,searchText:C}))},F=C=>{D(V=>({...V,currentField:C}))},u=C=>{M("onlySelf")(C)},_=i.useCallback(()=>{const{currentField:C,searchText:V}=y;M(C)(V),k(1)},[M,y]),Z=[{title:"編輯/檢視",dataField:"id",width:"150px",component:C=>e.jsxs(o,{gap:2,flexDirection:"row",justifyContent:"center",alignItems:"center",children:[s&&e.jsx(v,{label:"編輯",onClick:()=>x(C.id),btnColor:"TAB_BLUE",disabled:!g&&!(St(tt.ROLE_MANAGER)||St(tt.ROLE_ADMIN))&&(C.teacherData.name!==s.adlName||C.flag===me.DRAFT||C.flag===me.IN_SCHOOL)}),e.jsx(v,{label:"檢視",onClick:()=>h(C),btnColor:"BTN_LATTE_GRAY"})]})},...g?[{title:"上架/下架",dataField:"isPublish",width:"150px",component:C=>e.jsx(o,{gap:2,flexDirection:"row",justifyContent:"center",children:s&&C.isPublish!==null&&e.jsx(v,{label:C.isPublish?"下架":"上架",onClick:()=>Y(C.id,!C.isPublish),btnColor:C.isPublish?"CANCEL_RED":"GREEN"})})}]:[],{title:"陣營關卡名稱",dataField:"name",width:"250px"},{title:"關卡碼",dataField:"stageCode",width:"120px"},{title:"任務名稱",dataField:"missionEnemySet",width:"400px",component:C=>{var V,se;return e.jsx(z,{variant:"h5",children:((V=C.missionEnemyCampModeSet)==null?void 0:V.length)>0?(se=C.missionEnemyCampModeSet)==null?void 0:se.map(X=>X.mission.name).join(","):"無"})}},{title:"校名",dataField:"school",width:"300px",component:C=>e.jsx(z,{variant:"h5",children:C.school.schoolName})},{title:"命關者",dataField:"teacherData",width:"120px",component:C=>e.jsx(z,{variant:"h5",children:C.teacherData.name})},{title:"狀態",dataField:"flag",width:"150px",component:C=>e.jsx(z,{variant:"h5",children:Nn[C.flag-1].label})}];return e.jsxs(o,{flex:1,gap:5,children:[e.jsx(v,{label:"創建陣營關卡",onClick:p,sx:{ml:"auto"},btnColor:"BLUE"}),e.jsx(o,{flexDirection:"row",gap:5,alignItems:"center",justifyContent:{xs:"center",sm:"flex-start"},flexWrap:"wrap",px:3,children:e.jsxs(o,{flexDirection:"row",gap:5,flexWrap:"wrap",justifyContent:{xs:"center",sm:"flex-start"},alignItems:"center",children:[e.jsx(vt,{check:m.onlySelf,value:y,options:ci,selectOnChange:F,inputOnChange:P,checkBoxOnChange:u,searchFuntion:_}),e.jsx(v,{label:"搜尋",onClick:_,btnColor:"BROWN"})]})}),G?e.jsx(Ge,{}):e.jsx(o,{children:q&&e.jsx(lt,{isVisible:N,children:e.jsxs(o,{p:.5,alignItems:"center",gap:5,children:[e.jsx(Tt,{columns:Z,rows:q.content}),e.jsx(Yt,{totalPages:q.totalPages,currentPage:q.pageable.pageNumber,inputPage:B??1,setInputPage:k,handlePageChange:U,handlePageSearch:A})]})},JSON.stringify(f))}),w&&S&&e.jsx(id,{open:w,onClose:I,stage:S})]})},cd=ld,dd=({data:t,row:a=!0,sx:n,picId:s})=>{const{data:r}=qt({id:s??0});return e.jsxs(o,{flexDirection:a?"row":"column",alignItems:"center",gap:2,sx:n,children:[e.jsx(o,{flex:2.5,...!a&&{width:"100%"},children:t.map((l,c)=>e.jsxs(o,{flexDirection:"row",alignItems:"center",children:[e.jsx(he,{children:l.key}),e.jsx(he,{bgc:"#fff",children:l.value})]},c))}),e.jsx(Dt,{width:250,height:250,src:(r==null?void 0:r.src)??"",style:{marginTop:"auto",marginBottom:"auto",flex:1}})]})},di=i.memo(dd),ts=({onOpenMissionDialog:t,onOpenEnemyDialog:a,index:n,error:s})=>{var E,f,T,y,D;const{selectedEnemy:r,selectedMission:l}=Hn(),c=r?(E=r[n])==null?void 0:E.picId:0,g=i.useMemo(()=>{const S=r?r[n]:null;return S?[{key:"名稱",value:S.name},{key:"攻擊力",value:S.atk},{key:"等級",value:S.lv}]:null},[r,n]),m=i.useMemo(()=>{var j;const S=l&&l[n];return S?[{key:"學科",value:S.subjectName??S.mainSubject.value},{key:"level",value:S.level},{key:"世紀",value:((j=S==null?void 0:S.century)==null?void 0:j.century)||"(無)"},{key:"地點",value:S.area}]:null},[l,n]);return e.jsxs(K,{container:!0,spacing:4,children:[e.jsxs(K,{item:!0,xs:6,children:[e.jsxs(o,{direction:"row",justifyContent:"center",mb:2,children:[e.jsx(he,{width:"100%",children:l?(f=l[n])==null?void 0:f.name:"任務名"}),e.jsx(v,{label:"...",sx:{bgcolor:$.SELECT_YELLOW,color:"#000",opacity:.7,ml:.5},onClick:t})]}),m?e.jsx(o,{mt:7.5,children:m.map((S,j)=>e.jsxs(o,{flexDirection:"row",alignItems:"center",gap:1,children:[e.jsx(he,{children:S.key}),e.jsx(he,{bgc:"#fff",children:S.value})]},j))}):e.jsxs(o,{justifyContent:"center",alignItems:"center",mt:12.5,children:[e.jsx(he,{children:"尚未選擇任務"}),s?!!s.missionId&&e.jsx(ht,{sx:{textAlign:"center",color:$.CANCEL_RED,fontSize:"1rem"},children:(T=s.missionId)==null?void 0:T.message}):null]})]}),e.jsxs(K,{item:!0,xs:6,children:[e.jsxs(o,{direction:"row",justifyContent:"center",mb:2,children:[e.jsx(he,{width:"100%",children:r?(y=r[n])==null?void 0:y.name:"敵人名"}),e.jsx(v,{label:"...",sx:{bgcolor:$.SELECT_YELLOW,color:"#000",opacity:.7,ml:.5},onClick:a})]}),e.jsx(o,{direction:"row",justifyContent:"center",mb:2,gap:2,children:e.jsx(o,{flex:2,children:g?e.jsx(di,{data:g,picId:c}):e.jsxs(o,{justifyContent:"center",alignItems:"center",mt:10,children:[e.jsx(he,{children:"尚未選擇敵人"}),s?!!s.enemyId&&e.jsx(ht,{sx:{textAlign:"center",color:$.CANCEL_RED,fontSize:"1rem"},children:(D=s.enemyId)==null?void 0:D.message}):null]})})})]})]})},ud=()=>{const t=Me(),{setAlertOpen:a}=_e(),{userInfo:n}=xt(),{setEnemyDialogOpen:s,setMissionDialogOpen:r,selectedMission:l,setSelectMission:c,selectedEnemy:g,setDeleteMission:m,setDeleteEnemy:E,setSelectEnemy:f}=Hn(),{setFlag:T}=at(),{mutate:y}=Jc(M),[D,S]=i.useState(5),{reset:j,control:w,setValue:O,handleSubmit:B}=$e(),k=u=>{if(!n)return;const _=u.missionEnemyCampModeSet.map((V,se)=>({...V,orderNum:se+1})),{variant:Z,...C}={...u,missionEnemyCampModeSet:_};y(C)},q=u=>{u===me.PASS?O("isPublish",!0):O("isPublish",null),T(u),O("flag",u)},H=u=>{a({open:!0,title:"提示",message:"按下確認表示您已經確認所編輯的關卡內容文字與所上傳圖片沒有違反智慧財產權疑慮",onOk:()=>k(u)})},G=()=>n?n.schoolDtoList.map(u=>({label:u.schoolName,value:u.id})):[],N=()=>[15,20,25,30].map(u=>({label:`${u}分鐘`,value:u})),L=()=>Array.from({length:11},(u,_)=>_+5).map(u=>({label:`${u}個`,value:u}));function M(){a({open:!0,title:"創建提示",message:"編輯陣營關卡成功"}),t("/edit/campStageEdit")}const Y=u=>{r(!0,u)},U=u=>{s(!0,u)};i.useEffect(()=>(j(ei),n&&O("schoolId",n.schoolDtoList[0].id),()=>{j(),c(null),f(null)}),[]);const{fields:A,append:p,remove:x,replace:h}=It({control:w,name:"missionEnemyCampModeSet"}),I=u=>{x(u),m(u),E(u)};i.useEffect(()=>{console.log(l),l&&l.length===A.length&&l.map((u,_)=>{u!=null&&u.id&&O(`missionEnemyCampModeSet.${_}.missionId`,u.id)})},[l,O,A,x]),i.useEffect(()=>{g&&g.length===A.length&&g.map((u,_)=>{u!=null&&u.id&&O(`missionEnemyCampModeSet.${_}.enemyId`,u.id)})},[g,O,A,x]);const P=u=>{const _=Number(u.target.value);if(S(_),A.length<_)for(let Z=A.length;Z<_;Z++)p({missionId:0,enemyId:0,isStagePic:!1});A.length>_&&(A.forEach((Z,C)=>{C>=_&&I(C)}),h(A.map(Z=>{const{id:C,...V}=Z;return V}).slice(0,_)))},F=()=>e.jsx(o,{gap:5,children:A.map((u,_)=>e.jsx(et,{name:`missionEnemyCampModeSet.${_}`,control:w,render:({field:Z,fieldState:{error:C}})=>e.jsx(o,{sx:{borderTop:_!=0?"1px solid #000":"",pt:3},gap:2,children:e.jsx(o,{gap:2,flexDirection:"row",alignItems:"flex-start",children:e.jsx(ts,{...Z,error:C,onOpenEnemyDialog:()=>U(_),onOpenMissionDialog:()=>Y(_),index:_})},u.id)})},u.id))});return e.jsx(o,{p:2,justifyContent:"center",alignItems:"center",width:"100%",children:e.jsxs(it,{onSubmit:B(H),children:[e.jsxs(K,{container:!0,spacing:6,wrap:"wrap",children:[e.jsx(K,{item:!0,sm:12,lg:6,children:e.jsxs(o,{gap:2.5,children:[e.jsx(ie,{name:"name",label:"關卡名稱",variant:"control",alertText:"字數限制：10字元(必填)"}),e.jsx(je,{name:"schoolId",label:"學校",options:G(),type:"ONE",variant:"control",alertText:"必填"}),e.jsx(je,{name:"totalMinute",label:"時間限制",options:N(),type:"ONE",variant:"control",alertText:"必填"}),e.jsx(Ve,{label:"任務數量",onChange:P,value:D,options:L(),sx:{width:"100%"}})]})}),e.jsx(K,{item:!0,sm:12,lg:6,children:e.jsx(o,{gap:2,children:e.jsx(ze,{name:"description",label:"說明文字",rows:4,variant:"control"})})})]}),e.jsx(F,{}),e.jsx(ze,{name:"note",label:"編輯者註解",rows:2,variant:"control",stackSx:{mt:4.5,width:"50%"}}),e.jsxs(o,{flexDirection:"row",gap:3,justifyContent:"end",children:[(St(tt.ROLE_MANAGER)||St(tt.ROLE_ADMIN))&&e.jsx(v,{label:"全國發佈",type:"submit",sx:{alignSelf:"flex-end"},onClick:()=>q(me.PASS)}),e.jsx(v,{label:"儲存草稿",type:"submit",sx:{alignSelf:"flex-end"},btnColor:"DRAWER_GRAY",onClick:()=>q(me.DRAFT)})]})]})})},pd=ud,md=()=>{const t=Lt(),a=Me(),{userInfo:n}=xt(),{setAlertOpen:s}=_e(),{setEnemyDialogOpen:r,setMissionDialogOpen:l,selectedMission:c,setSelectMission:g,selectedEnemy:m,setDeleteMission:E,setDeleteEnemy:f,setSelectEnemy:T,setAllEnemy:y,setAllMission:D}=Hn(),{setFlag:S}=at(),{mutate:j}=Zc(I),[w,O]=i.useState(0),{data:B,isError:k,isLoading:q}=Xc({id:parseInt(t.id||"0",10)}),{reset:H,control:G,setValue:N,handleSubmit:L,formState:{errors:M}}=$e();console.log(M);const Y=()=>n?n.schoolDtoList.map(R=>({label:R.schoolName,value:R.id})):[],U=()=>[5,10,15,20,25,30].map(R=>({label:`${R}分鐘`,value:R})),A=()=>Array.from({length:11},(R,b)=>b+5).map(R=>({label:`${R}個`,value:R})),p=R=>{if(R.variant==="update"&&R.id&&n){const b=R.missionEnemyCampModeSet.map((ne,Q)=>({...ne,orderNum:Q+1})),{variant:W,...le}={...R,missionEnemyCampModeSet:b};j(le)}else s({open:!0,title:"編輯提示",message:"編輯關卡缺少ID"})},x=R=>{R===me.PASS?N("isPublish",!0):N("isPublish",null),S(R),N("flag",R)},h=R=>{s({open:!0,title:"提示",message:"按下確認表示您已經確認所編輯的關卡內容文字與所上傳圖片沒有違反智慧財產權疑慮",onOk:()=>p(R)})};function I(){s({open:!0,title:"編輯提示",message:"編輯陣營關卡成功"}),a("/edit/campStageEdit")}const P=R=>{l(!0,R)},F=R=>{r(!0,R)};i.useEffect(()=>{c&&c.map((R,b)=>{R!=null&&R.id&&N(`missionEnemyCampModeSet.${b}.missionId`,R.id)})},[c,N]),i.useEffect(()=>{m&&m.map((R,b)=>{R!=null&&R.id&&N(`missionEnemyCampModeSet.${b}.enemyId`,R.id)})},[m,N]),i.useEffect(()=>{if(k&&(s({open:!0,title:"取得關卡資料失敗"}),a("/edit/cardEdit")),B){const{missionEnemyCampModeSet:R,...b}=B,W=R.map(le=>({missionId:le.missionId,enemyId:le.enemyId,isStagePic:le.isStagePic}));O(R.length),H({...b,missionEnemyCampModeSet:[...W],variant:"update"}),D(R.map(le=>le.mission)),y(R.map(le=>le.enemy))}},[B,H,k]),i.useEffect(()=>(n&&N("schoolId",n.schoolDtoList[0].id),()=>{H(),g(null),T(null)}),[]);const{fields:u,append:_,remove:Z,replace:C}=It({control:G,name:"missionEnemyCampModeSet"}),V=R=>{Z(R),E(R),f(R)},se=R=>{const b=Number(R.target.value);if(O(b),u.length<b)for(let W=u.length;W<b;W++)_({missionId:0,enemyId:0,isStagePic:!1});u.length>b&&(u.forEach((W,le)=>{le>=b&&V(le)}),C(u.map(W=>{const{id:le,...ne}=W;return ne}).slice(0,b)))},X=()=>e.jsx(o,{gap:5,children:u.map((R,b)=>e.jsx(et,{name:`missionEnemyCampModeSet.${b}`,control:G,render:({field:W,fieldState:{error:le}})=>e.jsx(o,{sx:{borderTop:b!=0?"1px solid #000":"",pt:3},gap:2,children:e.jsx(o,{gap:2,flexDirection:"row",alignItems:"flex-start",children:e.jsx(ts,{...W,error:le,onOpenEnemyDialog:()=>F(b),onOpenMissionDialog:()=>P(b),index:b})})})},R.id))});return e.jsx(o,{p:2,justifyContent:"center",alignItems:"center",width:"100%",children:q||!B?e.jsx(Ge,{}):e.jsxs(it,{onSubmit:L(h),children:[e.jsxs(K,{container:!0,spacing:6,wrap:"wrap",children:[e.jsx(K,{item:!0,sm:12,lg:6,children:e.jsxs(o,{gap:2.5,children:[e.jsx(ie,{name:"name",label:"關卡名稱",variant:"control",alertText:"字數限制：10字元(必填)"}),e.jsx(je,{name:"schoolId",label:"學校",options:Y(),type:"ONE",variant:"control",alertText:"必填"}),e.jsx(je,{name:"totalMinute",label:"時間限制",options:U(),type:"ONE",variant:"control",alertText:"必填"}),e.jsx(Ve,{label:"任務數量",onChange:se,value:w,options:A(),sx:{width:"100%"}})]})}),e.jsx(K,{item:!0,sm:12,lg:6,children:e.jsx(o,{gap:2,children:e.jsx(ze,{name:"description",label:"說明文字",rows:4,variant:"control"})})})]}),e.jsx(X,{}),e.jsx(ze,{name:"note",label:"編輯者註解",rows:2,variant:"control",stackSx:{mt:4.5,width:"50%"}}),e.jsxs(o,{flexDirection:"row",gap:3,justifyContent:"end",children:[(St(tt.ROLE_MANAGER)||St(tt.ROLE_ADMIN))&&e.jsx(v,{label:"全國發佈",type:"submit",sx:{alignSelf:"flex-end"},onClick:()=>x(me.PASS)}),B.flag===me.DRAFT&&e.jsx(v,{label:"儲存草稿",type:"submit",sx:{alignSelf:"flex-end"},btnColor:"DRAWER_GRAY",onClick:()=>x(me.DRAFT)})]})]})})},hd=md;function xd(){return e.jsxs(Dc,{children:[e.jsxs(Pt,{children:[e.jsx(xe,{index:!0,element:e.jsx(cd,{})}),e.jsx(xe,{path:"/createCampStage",element:e.jsx(pd,{})}),e.jsx(xe,{path:"/updateCampStage/:id",element:e.jsx(hd,{})}),e.jsx(xe,{path:"*",element:e.jsx(_t,{to:"/edit/campStageEdit",replace:!0})})]}),e.jsx(ri,{isCampStage:!0}),e.jsx(oi,{})]})}const ui=[{label:"知識卡名稱",value:"name"},{label:"知識卡內容",value:"description"},{label:"外部連結(名稱)",value:"hyperlinkName"}],Ia=ui.map(t=>t.value),gd=t=>Ia.includes(t),fd=()=>{const t=Me(),a=Wt(),{userInfo:n,permissions:s,role:r}=xt(),l=i.useMemo(()=>s&&r===tt.ROLE_ADMIN,[s,r]),c=i.useMemo(()=>s&&r===tt.ROLE_MANAGER,[s,r]),g=i.useMemo(()=>{const u=new URLSearchParams(a.search),_=u.get("name"),Z=u.get("description"),C=u.get("hyperlinkName");return{subjectId:parseInt(u.get("subjectCode")||"0",10),type:parseInt(u.get("type")||"0",10),flag:parseInt(u.get("flag")||"0",10),page:parseInt(u.get("page")||"0",10),onlySelf:u.get("onlySelf")==="true",..._&&{name:_},...Z&&{description:Z},...C&&{hyperlinkName:C},...cn}},[a.search]),m=i.useMemo(()=>{const u=Object.keys(g).find(_=>Ia.includes(_)&&g[_]!==void 0);return u?{searchText:g[u],currentField:u}:{searchText:"",currentField:Ia[0]}},[g]),[E,f]=i.useState(g),[T,y]=i.useState(m),[D,S]=i.useState(null),[j,w]=i.useState(!1),[O,B]=i.useState(),{data:k,isSuccess:q,isLoading:H}=Nr(E),G=i.useMemo(()=>q&&!!k.content.length,[q,k]),N=i.useCallback(()=>{t("createCard")},[t]),L=i.useCallback(u=>{t(`updateCard/${u}`)},[t]),M=i.useCallback(u=>{S(u),w(!0)},[]),Y=i.useCallback(u=>_=>{let Z,C;if(typeof _=="number"||typeof _=="string"||typeof _=="boolean"?Z=_:Z=_.target.value,gd(u)){const se={};Ia.forEach(X=>{X===u&&Z?se[X]=Z:delete E[X]}),C={...E,...se}}else C={...E,[u]:Z};u!=="page"&&(C.page=0);const V=ut(C);f(C),t(`?${V}`)},[t,E]),U=i.useCallback((u,_)=>{Y("page")(_-1),B(_)},[Y]),A=i.useCallback(()=>{O&&f(u=>({...u,page:Number(O)-1}))},[O,f]),p=i.useCallback(()=>{w(!1)},[]),x=u=>{y(_=>({..._,searchText:u}))},h=u=>{y(_=>({..._,currentField:u}))},I=u=>{Y("onlySelf")(u)},P=()=>{const{currentField:u,searchText:_}=T;Y(u)(_),B(1)},F=[{title:"編輯/檢視",dataField:"id",component:u=>e.jsxs(o,{gap:2,flexDirection:"row",children:[n&&e.jsx(v,{label:"編輯",onClick:()=>L(u.id),btnColor:"TAB_BLUE",disabled:!l&&(c?!(u.flag===me.PASS||u.teacherData.name===n.adlName):!(u.flag!==me.PASS&&u.teacherData.name===n.adlName))}),e.jsx(v,{label:"檢視",onClick:()=>M(u),btnColor:"BTN_LATTE_GRAY"})]})},{title:"卡片名稱",dataField:"name",width:"20%"},{title:"科目",dataField:"subjectId",component:u=>e.jsx(z,{variant:"h5",children:u.subject?u.subject.value:"無"})},{title:"知識卡類別",dataField:"type",component:u=>{var _;return e.jsx(z,{variant:"h5",children:((_=za[(u==null?void 0:u.type)-1])==null?void 0:_.label)??"無"})}},{title:"校名",dataField:"schoolId",width:"20%",component:u=>e.jsx(z,{variant:"h5",children:u.school.schoolName})},{title:"出題者",dataField:"id",component:u=>e.jsx(z,{variant:"h5",children:u.teacherData.name})},{title:"狀態",dataField:"flag",component:u=>e.jsx(z,{variant:"h5",children:Nn[u.flag-1].label})}];return e.jsxs(o,{flex:1,gap:5,children:[e.jsx(v,{label:"創建卡片",onClick:N,sx:{ml:"auto"},btnColor:"BLUE"}),e.jsxs(o,{flexDirection:"row",gap:5,alignItems:"center",justifyContent:{xs:"center",sm:"flex-start"},flexWrap:"wrap",px:3,children:[e.jsx(Or,{handleChange:Y,value:E}),e.jsxs(o,{flexDirection:"row",gap:5,flexWrap:"wrap",justifyContent:{xs:"center",sm:"flex-start"},alignItems:"center",children:[e.jsx(vt,{check:g.onlySelf,value:T,options:ui,selectOnChange:h,inputOnChange:x,checkBoxOnChange:I,searchFuntion:P}),e.jsx(v,{label:"搜尋",onClick:P,btnColor:"BROWN"})]})]}),H?e.jsx(Ge,{}):e.jsx(o,{children:k&&e.jsx(lt,{isVisible:G,children:e.jsxs(o,{p:.5,alignItems:"center",gap:5,children:[e.jsx(Tt,{columns:F,rows:k.content}),e.jsx(Yt,{totalPages:k.totalPages,currentPage:k.pageable.pageNumber,inputPage:O??1,setInputPage:B,handlePageChange:U,handlePageSearch:A})]})},JSON.stringify(E))}),j&&D&&e.jsx(Rr,{cardDetail:D,open:j,onClose:p})]})},bd=fd;function ya(){const t=Wa(),{cardDialogOpen:a,cardSelectDialogOpen:n,cardList:s}=Ya(E=>E.missionCard);return{cardDialogOpen:a,setCardDialogOpen:E=>{t(sa.actions.setCardDialogOpen(E))},cardSelectDialogOpen:n,setCardSelectDialogOpen:E=>{t(sa.actions.setCardSelectDialogOpen(E))},cardList:s,addNewCard:E=>{t(sa.actions.setCardList([...s,E]))},removeCard:E=>{t(sa.actions.setCardList(s.filter(f=>f.id!==E)))},setCardList:E=>{t(sa.actions.setCardList(E))}}}const jd=({isOpenInMission:t})=>{const a=Me(),{userInfo:n}=xt(),{setAlertOpen:s}=_e(),{addNewCard:r,setCardDialogOpen:l}=ya(),{data:c}=ja(),{setFlag:g}=at(),{cardSelectedImage:m,setCardSelectedImage:E,setSelectedType:f}=Rt(),{mutate:T}=Wo(O),{reset:y,control:D,setValue:S,handleSubmit:j,formState:{errors:w}}=$e();function O(A){s({open:!0,title:"創建提示",message:"創建卡牌成功"}),t?(y(tr),B(),E(null),r(A)):a("/edit/cardEdit")}const B=()=>{n&&S("schoolId",n.schoolDtoList[0].id)},k=i.useMemo(()=>c?c.map(A=>({label:A.value,value:A.id})):[],[c]),q=i.useMemo(()=>n?n.schoolDtoList.map(A=>({label:A.schoolName,value:A.id})):[],[n]),H=A=>{if(!n)return;const{variant:p,...x}=A;T({...x})},G=A=>{g(A),S("flag",A)},N=A=>{s({open:!0,title:"提示",message:"按下確認表示您已經確認所編輯的卡片內容文字與所上傳圖片沒有違反智慧財產權疑慮",onOk:()=>H(A)})},L=()=>{E(null),S("picId",0,{shouldValidate:!0})},M=()=>{l(!1)};i.useEffect(()=>{m&&S("picId",m.id,{shouldValidate:!0})},[m,S]),i.useEffect(()=>(y(tr),f("CARD"),B(),()=>{t&&f("MISSION"),E(null),y()}),[]);const Y=()=>{const{fields:A,append:p,remove:x}=It({control:D,name:"additionalHyperlinkSet"}),h=()=>{p({name:"",hyperlink:"",adl:!1})};return e.jsxs(i.Fragment,{children:[A.map((I,P)=>e.jsxs(o,{flexDirection:"row",alignItems:"flex-start",gap:1,children:[e.jsx(ie,{name:`additionalHyperlinkSet.${P}.name`,label:"連結名稱",variant:"control"}),e.jsx(ie,{name:`additionalHyperlinkSet.${P}.hyperlink`,label:"連結",variant:"control"}),e.jsx(v,{label:"刪除",onClick:()=>x(P),btnColor:"CANCEL_RED"})]},I.id)),e.jsx(v,{label:"增加資訊",disabled:A.length>=1,onClick:h,btnColor:"BTN_LATTE_GRAY"})]})},U=()=>e.jsxs(i.Fragment,{children:[e.jsxs(o,{gap:2,flexDirection:"row",alignItems:"flex-start",children:[e.jsx($t,{title:"卡片圖片",name:"picId",alertText:"必填"}),(m==null?void 0:m.src)&&e.jsx(v,{label:"刪除",btnColor:"CANCEL_RED",onClick:L})]}),(m==null?void 0:m.src)&&e.jsx(Dt,{styleType:"formImage",src:m.src})]});return e.jsxs(o,{p:t?4:2,justifyContent:"center",alignItems:"center",width:"100%",children:[t&&e.jsx(v,{label:"關閉",btnColor:"CANCEL_RED",sx:{position:"absolute",top:5,right:5},onClick:M}),e.jsxs(it,{onSubmit:j(N),children:[e.jsxs(K,{container:!0,spacing:6,wrap:"wrap",children:[e.jsx(K,{item:!0,sm:12,lg:6,children:e.jsxs(o,{gap:1,children:[e.jsx(ie,{name:"name",label:"卡片名稱",variant:"control",alertText:"字數限制：16字，不要用標點符號。(必填)"}),e.jsx(je,{name:"schoolId",label:"學校",options:q,type:"ONE",variant:"control",alertText:"必填"}),e.jsx(je,{name:"subjectId",label:"學科",options:k,type:"ONE",variant:"control",alertText:"必填"}),e.jsx(ie,{name:"syllabus",label:"課綱",variant:"control"}),e.jsx(je,{name:"type",label:"類別",options:za,type:"ONE",variant:"control",alertText:"必填"}),e.jsx(ze,{name:"description",label:"文字內容",rows:4,variant:"control",alertText:"24字內，含標點符號。(必填)"})]})}),e.jsxs(K,{item:!0,sm:12,lg:6,children:[e.jsxs(o,{gap:2,mb:3,children:[e.jsx(U,{}),e.jsx(Sn,{labelSx:{flex:2},labelTitle:"因材網或外部資訊",alertTextList:["數量限制：一張1個連結。","1. 卡片上顯示的外部資訊按鈕(可點選跳出外部連結視窗作為線索)。","2. 同一題中至少每個類別的知識卡中要有兩張有外部連結。","3. 因材網的連結原則上每個題組有一張卡片有一個即可。","4. 建議使用具公信力、官方之參考內容，請避免如維基百科等具爭議性的網站來源。"]}),e.jsx(Y,{})]}),e.jsx(ze,{name:"note",label:"編輯者註解",rows:8,variant:"control",alertText:"不會顯示在正式遊戲畫面，僅供命題者註記。"})]})]}),e.jsxs(o,{flexDirection:"row",gap:3,justifyContent:"end",children:[e.jsx(v,{label:"校內發佈",type:"submit",sx:{alignSelf:"flex-end"},btnColor:"BTN_LATTE_GRAY",onClick:()=>G(me.IN_SCHOOL)}),!t&&e.jsx(v,{label:"儲存草稿",type:"submit",sx:{alignSelf:"flex-end"},btnColor:"DRAWER_GRAY",onClick:()=>G(me.DRAFT)})]})]})]})},pi=jd,yd=()=>{const t=Lt(),a=Me(),n=yt(),{userInfo:s}=xt(),{setAlertOpen:r}=_e(),{setFlag:l}=at(),{cardSelectedImage:c,setCardSelectedImage:g,setSelectedType:m}=Rt(),{data:E}=ja(),{reset:f,control:T,setValue:y,unregister:D,handleSubmit:S,formState:{errors:j}}=$e(),{data:w,isError:O,isLoading:B}=Yo({id:parseInt(t.id??"0",10)}),{mutate:k}=Uo(G),q=i.useMemo(()=>E?E.map(p=>({label:p.value,value:p.id})):[],[E]),H=i.useMemo(()=>s?s.schoolDtoList.map(p=>({label:p.schoolName,value:p.id})):[],[s]);function G(p){n.invalidateQueries({queryKey:[qo.CARD_ID(p.id)]}),r({open:!0,title:"編輯提示",message:"編輯卡牌成功"}),a("/edit/cardEdit")}const N=p=>{if(p.variant==="update"&&p.id&&s){const{variant:x,...h}=p;k({...h})}else r({open:!0,title:"編輯提示",message:"編輯卡牌缺少ID"})},L=p=>{l(p),y("flag",p)},M=p=>{r({open:!0,title:"提示",message:"按下確認表示您已經確認所編輯的卡片內容文字與所上傳圖片沒有違反智慧財產權疑慮",onOk:()=>N(p)})},Y=()=>{g(null),y("picId",0,{shouldValidate:!0})};i.useEffect(()=>{O&&(r({open:!0,title:"取得卡牌資料失敗"}),a("/edit/cardEdit")),w&&(f({...w,subjectId:w.subjectId??0,variant:"update"}),g({id:w.picId,src:w.imageSrc}))},[w,f,O]),i.useEffect(()=>{c&&w&&c.id!=w.picId&&y("picId",c.id,{shouldValidate:!0})},[c,y]),i.useEffect(()=>(m("CARD"),s&&y("schoolId",s.schoolDtoList[0].id),()=>{g(null),f()}),[]);const U=()=>{const{fields:p,append:x,remove:h}=It({control:T,name:"additionalHyperlinkSet"}),I=()=>{x({name:"",hyperlink:"",adl:!1})},P=F=>{h(F),D(`additionalHyperlinkSet.${F}`),y("additionalHyperlinkSet",p.filter((u,_)=>_!==F))};return e.jsxs(i.Fragment,{children:[p.map((F,u)=>e.jsxs(o,{flexDirection:"row",alignItems:"flex-start",gap:1,children:[e.jsx(ie,{name:`additionalHyperlinkSet.${u}.name`,label:"連結名稱",variant:"control"}),e.jsx(ie,{name:`additionalHyperlinkSet.${u}.hyperlink`,label:"連結",variant:"control"}),e.jsx(v,{label:"刪除",onClick:()=>P(u),btnColor:"CANCEL_RED"})]},F.id)),e.jsx(v,{label:"增加資訊",disabled:p.length>=1,onClick:I,btnColor:"BTN_LATTE_GRAY"})]})},A=()=>e.jsxs(i.Fragment,{children:[e.jsxs(o,{gap:2,flexDirection:"row",alignItems:"flex-start",children:[e.jsx($t,{title:"卡片圖片",name:"picId",alertText:"必填"}),(c==null?void 0:c.src)&&e.jsx(v,{label:"刪除",btnColor:"CANCEL_RED",onClick:Y})]}),(c==null?void 0:c.src)&&e.jsx(Dt,{styleType:"formImage",src:c.src})]});return e.jsx(o,{p:2,justifyContent:"center",alignItems:"center",width:"100%",children:B||!w?e.jsx(Ge,{}):e.jsxs(it,{onSubmit:S(M),children:[e.jsxs(K,{container:!0,spacing:6,wrap:"wrap",children:[e.jsx(K,{item:!0,sm:12,lg:6,children:e.jsxs(o,{gap:1,children:[e.jsx(ie,{name:"name",label:"卡片名稱",variant:"control",alertText:"字數限制：16字，不要用標點符號。(必填)"}),e.jsx(je,{name:"schoolId",label:"學校",options:H,type:"ONE",variant:"control",alertText:"必填"}),e.jsx(je,{name:"subjectId",label:"學科",options:q,type:"ONE",variant:"control",alertText:"必填"}),e.jsx(ie,{name:"syllabus",label:"課綱",variant:"control"}),e.jsx(je,{name:"type",label:"類別",options:za,type:"ONE",variant:"control",alertText:"必填"}),e.jsx(ze,{name:"description",label:"文字內容",rows:4,variant:"control",alertText:"24字內，含標點符號。(必填)"})]})}),e.jsx(K,{item:!0,sm:12,lg:6,children:e.jsxs(o,{gap:2,children:[e.jsx(A,{}),e.jsx(Sn,{labelSx:{flex:2},labelTitle:"因材網或外部資訊",alertTextList:["數量限制：一張1個連結。","1. 卡片上顯示的外部資訊按鈕(可點選跳出外部連結視窗作為線索)。","2. 同一題中至少每個類別的知識卡中要有兩張有外部連結。","3. 因材網的連結原則上每個題組有一張卡片有一個即可。","4. 建議使用具公信力、官方之參考內容，請避免如維基百科等具爭議性的網站來源。"]}),e.jsx(U,{}),e.jsx(ze,{name:"note",label:"編輯者註解",rows:8,variant:"control",alertText:"不會顯示在正式遊戲畫面，僅供命題者註記。"})]})})]}),e.jsxs(o,{flexDirection:"row",gap:3,justifyContent:"end",children:[w.flag===me.PASS?e.jsx(v,{label:"儲存",type:"submit",sx:{alignSelf:"flex-end"},btnColor:"BTN_LATTE_GRAY",onClick:()=>L(me.PASS)}):e.jsx(v,{label:"校內發佈",type:"submit",sx:{alignSelf:"flex-end"},btnColor:"BTN_LATTE_GRAY",onClick:()=>L(me.IN_SCHOOL)}),w.flag===me.DRAFT&&e.jsx(v,{label:"儲存草稿",type:"submit",sx:{alignSelf:"flex-end"},btnColor:"DRAWER_GRAY",onClick:()=>L(me.DRAFT)})]})]})})},Cd=yd;function Sd(){return e.jsx(Lr,{children:e.jsxs(Pt,{children:[e.jsx(xe,{index:!0,element:e.jsx(bd,{})}),e.jsx(xe,{path:"/createCard",element:e.jsx(pi,{})}),e.jsx(xe,{path:"/updateCard/:id",element:e.jsx(Cd,{})}),e.jsx(xe,{path:"*",element:e.jsx(_t,{to:"/edit/cardEdit",replace:!0})})]})})}var Ct=(t=>(t.DRAFT="DRAFT",t.COMPLETE="COMPLETE",t.UNSTARTED="UNSTARTED",t.ONGOING="ONGOING",t.FINISHED="FINISHED",t))(Ct||{});const mi=[{label:"草稿",value:"DRAFT"},{label:"編輯完成",value:"COMPLETE"},{label:"未開始",value:"UNSTARTED"},{label:"進行中",value:"ONGOING"},{label:"已結束",value:"FINISHED"}];var Je=(t=>(t.NORMAL="NORMAL",t.CONTEST="CONTEST",t.PROPAGATION="PROPAGATION",t))(Je||{});const _s=[{label:"一般",value:"NORMAL"},{label:"競賽",value:"CONTEST"}],Ed=[{label:"一般",value:"NORMAL"},{label:"競賽",value:"CONTEST"},{label:"宣導",value:"PROPAGATION"}],hi=t=>d.object({range:d.boolean(),name:fn(t,1,"活動名稱必填",9,"活動名稱最多9個字"),description:fn(t,1,"文字內容必填"),startTime:d.date(),picId:d.union([d.number().optional(),d.null()]),endTime:d.date(),hyperlinkName:d.string().optional(),hyperlink:d.string().optional(),schoolId:d.number().min(1,{message:"學校ID必填"}),note:d.union([d.string().optional(),d.null()]),syllabus:d.union([d.string().optional(),d.null()]),stageIds:Vo(t,d.number(),0,"關卡必選"),point:d.union([d.number().optional(),d.null()]),energy:d.union([d.number().optional(),d.null()]),aiChip:d.union([d.number().optional(),d.null()]),status:Zs(Ct),type:Zs(Je),conditionSet:d.array(d.object({variable:d.string().min(1),relationalOperator:d.string().min(1),argument:d.number().min(1)})).optional(),contestEventRewardSet:d.array(d.object({from:d.number().min(1),to:d.number().min(1),point:d.union([d.number().optional(),d.null()]),energy:d.union([d.number().optional(),d.null()]),aiChip:d.union([d.number().optional(),d.null()]),eventId:d.union([d.number().optional(),d.null()]),petId:d.union([d.number().optional(),d.null()])})).optional()}),Id=t=>hi(t).refine(a=>a.hyperlinkName||a.hyperlink?a.hyperlinkName:!0,{message:"如果填寫了超連結名稱或外部超連結，則外部超連結必填",path:["hyperlinkName"]}).refine(a=>a.hyperlinkName||a.hyperlink?a.hyperlink:!0,{message:"如果填寫了超連結名稱或外部超連結，則超連結名稱必填",path:["hyperlink"]}).refine(a=>!(a.endTime.getTime()-a.startTime.getTime()<60*60*24),{message:"活動時間需大於一天",path:["endTime"]}).refine(a=>a.type===Je.PROPAGATION?!0:a.stageIds.length>0,{message:"關卡必選",path:["stageIds"]}),Td=d.intersection(Id(me.IN_SCHOOL),d.discriminatedUnion("variant",[d.object({variant:d.literal("create")}),d.object({variant:d.literal("update"),id:d.number().min(1)})])),wd=d.intersection(hi(me.DRAFT),d.discriminatedUnion("variant",[d.object({variant:d.literal("create")}),d.object({variant:d.literal("update"),id:d.number().min(1)})])),Dd=t=>t===me.DRAFT?wd:Td,xi={variant:"create",name:"",description:"",picId:null,syllabus:"",note:"",schoolId:0,hyperlinkName:"",hyperlink:"",point:void 0,energy:void 0,aiChip:void 0,conditionSet:void 0,stageIds:[],startTime:new Date,endTime:Ie().add(1,"day").toDate(),range:!0,status:Ct.COMPLETE,type:Je.CONTEST},vd=({children:t})=>{const{flag:a}=at(),n=Dd(a),s=sn({mode:"all",resolver:on(n),defaultValues:xi});return e.jsxs(rn,{...s,children:[t,!1]})},kd=vd;var En=(t=>(t.DRAFT="DRAFT",t.UNPUBLISH="UNPUBLISH",t))(En||{});const gi={DRAFT:"草稿",UNPUBLISH:"未發佈"};var Te=(t=>(t.ALL="全體",t.GROUP="指定群組",t.PLAYER="指定玩家",t))(Te||{}),ft=(t=>(t.DEFAULT="DEFAULT",t.NORMAL="NORMAL",t.CONTEST_EVENT_REWARD="CONTEST_EVENT_REWARD",t.NORMAL_EVENT_REWARD="NORMAL_EVENT_REWARD",t))(ft||{});const fi={DEFAULT:"預設",NORMAL:"一般",CONTEST_EVENT_REWARD:"競賽活動",NORMAL_EVENT_REWARD:"一般活動"},bi=[{label:"預設",value:"DEFAULT"},{label:"一般",value:"NORMAL"},{label:"競賽活動",value:"CONTEST_EVENT_REWARD"},{label:"一般活動",value:"NORMAL_EVENT_REWARD"}];var ji=(t=>(t.ALL="exp0",t.NATIONAL="exp10",t.ENGLISH="exp20",t.MATH="exp30",t.SCIENCE="exp40",t.SOCIAL="exp50",t))(ji||{});const yi=[{label:"無",value:""},{label:"全科",value:"exp0"},{label:"國文",value:"exp10"},{label:"英文",value:"exp20"},{label:"數學",value:"exp30"},{label:"自然",value:"exp40"},{label:"社會",value:"exp50"}],mn=class mn{static MAIL_ID(a){return`${this.MAIL}/${a}`}static MAIL_TEMPLATE_ID(a){return`${this.MAIL_TEMPLATE}/${a}`}};mn.MAIL="/mail",mn.MAIL_SEARCH=`${mn.MAIL}/search`,mn.PLAYER_INFO_SEARCH_PAGE="/player/playerInfo/search",mn.EDU_SYSTEM_PAGE="/school/educationalSystem/page",mn.MAIL_TEMPLATE="/mailTemplate",mn.MAIL_TEMPLATE_SEARCH="/mailTemplate/search",mn.MAIL_TEMPLATE_CODE="/mailTemplate/replacementCode";let Pe=mn;async function Ad(t){try{return(await Ye.put(Pe.MAIL_ID(t.id),t)).data.data}catch(a){Mt(a,Pe.MAIL_ID(t.id))}}async function Nd(t){try{return(await Ye.post(Pe.MAIL,t)).data.data}catch(a){Mt(a,Pe.MAIL)}}async function Od(t,a){try{return(await Ye.get(Pe.EDU_SYSTEM_PAGE,{params:a,signal:t})).data.data}catch(n){Mt(n,Pe.EDU_SYSTEM_PAGE)}}async function Rd(t,a){try{return(await Ye.get(Pe.PLAYER_INFO_SEARCH_PAGE,{params:a,signal:t})).data.data}catch(n){Mt(n,Pe.PLAYER_INFO_SEARCH_PAGE)}}async function Ld(t,a){try{const n=ln(a);return(await Ye.get(Pe.MAIL_SEARCH,{params:n,signal:t})).data.data}catch(n){Mt(n,Pe.MAIL_SEARCH)}}async function Pd(t,a){try{const n=await Ye.get(Pe.MAIL_ID(t),{signal:a});let s=[];if(n.data.data.mailTargetName===Te.GROUP){const r=new Set;n.data.data.mailGroupDtoList.forEach(c=>{r.add(c.schoolName)}),s=(await Ye.get(ql.SCHOOL_BATCH_GRADE_LIST+"?"+Il.stringify({schoolNameList:Array.from(r)},{arrayFormat:"repeat"}),{signal:a})).data.data}return{...n.data.data,schoolGradeList:s}}catch(n){Mt(n,Pe.MAIL_ID(t))}}async function _d(t,a){try{return(await Ye.get(Pe.MAIL_TEMPLATE,{params:a,signal:t})).data.data}catch(n){Mt(n,Pe.MAIL_TEMPLATE)}}async function Md(t,a){const n=ln(a);try{return(await Ye.get(Pe.MAIL_TEMPLATE_SEARCH,{params:n,signal:t})).data.data}catch(s){Mt(s,Pe.MAIL_TEMPLATE_SEARCH)}}async function Fd(t,a){try{return(await Ye.get(Pe.MAIL_TEMPLATE_ID(t),{signal:a})).data.data}catch(n){Mt(n,Pe.MAIL_TEMPLATE_ID(t))}}async function Bd(t){try{return(await Ye.delete(Pe.MAIL_ID(t))).data.data}catch(a){Mt(a,Pe.MAIL_ID(t))}}async function Hd(t){try{return(await Ye.delete(Pe.MAIL_TEMPLATE_ID(t))).data.data}catch(a){Mt(a,Pe.MAIL_TEMPLATE_ID(t))}}async function $d(t){try{return(await Ye.post(Pe.MAIL_TEMPLATE,t)).data.data}catch(a){Mt(a,Pe.MAIL_TEMPLATE)}}async function Gd(t){try{return(await Ye.put(Pe.MAIL_TEMPLATE_ID(t.id),t)).data.data}catch(a){Mt(a,Pe.MAIL_TEMPLATE_ID(t.id))}}async function Wd(t){try{return(await Ye.get(Pe.MAIL_TEMPLATE_CODE,{signal:t})).data.data}catch(a){Mt(a,Pe.MAIL_TEMPLATE_CODE)}}function Yd(t,a){return rt({mutationFn:Ad,onSuccess:n=>{if(n)t(n.id);else throw new Error("usePutUpdateMail error")},onError:n=>{a(n.message)}})}function Ci(t,a){const n=jt(a);return Ue({queryKey:[Pe.EDU_SYSTEM_PAGE,n],queryFn:({signal:s})=>Od(s,a),enabled:t===Te.GROUP})}function Si(t,a){const n=jt(a);return Ue({queryKey:[Pe.PLAYER_INFO_SEARCH_PAGE,n],queryFn:({signal:s})=>Rd(s,a),enabled:t===Te.PLAYER})}function Ud(t,a){return rt({mutationFn:Nd,onSuccess:t,onError:n=>{a(n.message)}})}function qd(t){const a=jt(t);return Ue({queryKey:[Pe.MAIL_SEARCH,a],queryFn:({signal:n})=>Ld(n,t)})}function Vd(t){return Ue({queryKey:[Pe.MAIL_ID(t)],queryFn:({signal:a})=>Pd(t,a),enabled:!!t})}function Kd(t){return rt({mutationFn:Bd,onSuccess:t})}function ns(t){const a=jt(t);return Ue({queryKey:[Pe.MAIL_TEMPLATE,a],queryFn:({signal:n})=>_d(n,t)})}function zd(t){const a=jt(t);return Ue({queryKey:[Pe.MAIL_TEMPLATE,a],queryFn:({signal:n})=>Md(n,t)})}function Qd(t){return Ue({queryKey:[Pe.MAIL_TEMPLATE,t.id],queryFn:({signal:a})=>Fd(t.id,a),enabled:!!t.id})}function Xd(t){return rt({mutationFn:Hd,onSuccess:t})}function Ei(t,a){return rt({mutationFn:$d,onSuccess:n=>{t(n.id)},onError:n=>{a(n.message)}})}function Jd(t,a){return rt({mutationFn:Gd,onSuccess:n=>{t(n.id)},onError:n=>{a(n.message)}})}function as(){return Ue({queryKey:[Pe.MAIL_TEMPLATE_CODE],queryFn:({signal:t})=>Wd(t)})}const Zd=Va(zt)(({theme:t})=>({"& .MuiDialogContent-root":{padding:t.spacing(1)},"& .MuiDialogActions-root":{padding:t.spacing(1)},maxWidth:960,maxHeight:600,margin:"auto"})),ss=({request:t,open:a,onClose:n,setSelectedMailTemplate:s})=>{const r=yt(),{setAlertOpen:l}=_e(),[c,g]=i.useState(""),{mutate:m}=Ei(f,T),E=()=>{m({templateName:c,isDefault:!1,content:JSON.parse(t.content),mailType:t.mailType})};function f(y){const D=jt({mailType:t.mailType});r.invalidateQueries({queryKey:[Pe.MAIL_TEMPLATE,D]}),s==null||s(y),n()}function T(y){l({open:!0,title:"提示",message:y})}return e.jsxs(Zd,{onClose:n,"aria-labelledby":"customized-dialog-title",fullScreen:!0,open:a,sx:{padding:20},PaperProps:{sx:{borderRadius:10,flexDirection:"column",justifyContent:"space-between",height:"100%",px:5,py:4}},children:[e.jsx(Qt,{sx:{textAlign:"center",fontSize:42},id:"customized-dialog-title",children:"請輸入模板名稱"}),e.jsx(o,{sx:{mt:"-30px"},children:e.jsx(Ut,{value:c,onChange:y=>g(y.target.value),sx:{bgcolor:"#aaa",border:"1px solid #333"}})}),e.jsxs(o,{sx:{display:"flex",flexDirection:"row",gap:4,justifyContent:"center"},children:[e.jsx(v,{label:"取消",btnColor:"CANCEL_RED",sx:{width:200},onClick:n}),e.jsx(v,{label:"確定",sx:{width:200},onClick:E})]})]})};function we(t){const a=Object.prototype.toString.call(t);return t instanceof Date||typeof t=="object"&&a==="[object Date]"?new t.constructor(+t):typeof t=="number"||a==="[object Number]"||typeof t=="string"||a==="[object String]"?new Date(t):new Date(NaN)}function Xe(t,a){return t instanceof Date?new t.constructor(a):new Date(a)}function ha(t,a){const n=we(t);return isNaN(a)?Xe(t,NaN):(a&&n.setDate(n.getDate()+a),n)}function Ms(t,a){const n=+we(t);return Xe(t,n+a)}function eu(t,a){return Ms(t,a*1e3)}const Ii=6048e5,tu=864e5,Ti=6e4,wi=36e5,nu=1e3;function au(t,a){return Ms(t,a*Ti)}function su(t,a){return Ms(t,a*wi)}function ru(t,a){const n=a*7;return ha(t,n)}function Di(t,a){const n=we(t);if(isNaN(a))return Xe(t,NaN);if(!a)return n;const s=n.getDate(),r=Xe(t,n.getTime());r.setMonth(n.getMonth()+a+1,0);const l=r.getDate();return s>=l?r:(n.setFullYear(r.getFullYear(),r.getMonth(),s),n)}function iu(t,a){return Di(t,a*12)}function sr(t){const a=we(t);return a.setHours(23,59,59,999),a}let ou={};function $n(){return ou}function lu(t,a){var g,m,E,f;const n=$n(),s=(a==null?void 0:a.weekStartsOn)??((m=(g=a==null?void 0:a.locale)==null?void 0:g.options)==null?void 0:m.weekStartsOn)??n.weekStartsOn??((f=(E=n.locale)==null?void 0:E.options)==null?void 0:f.weekStartsOn)??0,r=we(t),l=r.getDay(),c=(l<s?-7:0)+6-(l-s);return r.setDate(r.getDate()+c),r.setHours(23,59,59,999),r}function rr(t){const a=we(t),n=a.getFullYear();return a.setFullYear(n+1,0,0),a.setHours(23,59,59,999),a}const cu={lessThanXSeconds:{one:"less than a second",other:"less than {{count}} seconds"},xSeconds:{one:"1 second",other:"{{count}} seconds"},halfAMinute:"half a minute",lessThanXMinutes:{one:"less than a minute",other:"less than {{count}} minutes"},xMinutes:{one:"1 minute",other:"{{count}} minutes"},aboutXHours:{one:"about 1 hour",other:"about {{count}} hours"},xHours:{one:"1 hour",other:"{{count}} hours"},xDays:{one:"1 day",other:"{{count}} days"},aboutXWeeks:{one:"about 1 week",other:"about {{count}} weeks"},xWeeks:{one:"1 week",other:"{{count}} weeks"},aboutXMonths:{one:"about 1 month",other:"about {{count}} months"},xMonths:{one:"1 month",other:"{{count}} months"},aboutXYears:{one:"about 1 year",other:"about {{count}} years"},xYears:{one:"1 year",other:"{{count}} years"},overXYears:{one:"over 1 year",other:"over {{count}} years"},almostXYears:{one:"almost 1 year",other:"almost {{count}} years"}},du=(t,a,n)=>{let s;const r=cu[t];return typeof r=="string"?s=r:a===1?s=r.one:s=r.other.replace("{{count}}",a.toString()),n!=null&&n.addSuffix?n.comparison&&n.comparison>0?"in "+s:s+" ago":s};function ls(t){return(a={})=>{const n=a.width?String(a.width):t.defaultWidth;return t.formats[n]||t.formats[t.defaultWidth]}}const uu={full:"EEEE, MMMM do, y",long:"MMMM do, y",medium:"MMM d, y",short:"MM/dd/yyyy"},pu={full:"h:mm:ss a zzzz",long:"h:mm:ss a z",medium:"h:mm:ss a",short:"h:mm a"},mu={full:"{{date}} 'at' {{time}}",long:"{{date}} 'at' {{time}}",medium:"{{date}}, {{time}}",short:"{{date}}, {{time}}"},hu={date:ls({formats:uu,defaultWidth:"full"}),time:ls({formats:pu,defaultWidth:"full"}),dateTime:ls({formats:mu,defaultWidth:"full"})},xu={lastWeek:"'last' eeee 'at' p",yesterday:"'yesterday at' p",today:"'today at' p",tomorrow:"'tomorrow at' p",nextWeek:"eeee 'at' p",other:"P"},gu=(t,a,n,s)=>xu[t];function ra(t){return(a,n)=>{const s=n!=null&&n.context?String(n.context):"standalone";let r;if(s==="formatting"&&t.formattingValues){const c=t.defaultFormattingWidth||t.defaultWidth,g=n!=null&&n.width?String(n.width):c;r=t.formattingValues[g]||t.formattingValues[c]}else{const c=t.defaultWidth,g=n!=null&&n.width?String(n.width):t.defaultWidth;r=t.values[g]||t.values[c]}const l=t.argumentCallback?t.argumentCallback(a):a;return r[l]}}const fu={narrow:["B","A"],abbreviated:["BC","AD"],wide:["Before Christ","Anno Domini"]},bu={narrow:["1","2","3","4"],abbreviated:["Q1","Q2","Q3","Q4"],wide:["1st quarter","2nd quarter","3rd quarter","4th quarter"]},ju={narrow:["J","F","M","A","M","J","J","A","S","O","N","D"],abbreviated:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],wide:["January","February","March","April","May","June","July","August","September","October","November","December"]},yu={narrow:["S","M","T","W","T","F","S"],short:["Su","Mo","Tu","We","Th","Fr","Sa"],abbreviated:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],wide:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"]},Cu={narrow:{am:"a",pm:"p",midnight:"mi",noon:"n",morning:"morning",afternoon:"afternoon",evening:"evening",night:"night"},abbreviated:{am:"AM",pm:"PM",midnight:"midnight",noon:"noon",morning:"morning",afternoon:"afternoon",evening:"evening",night:"night"},wide:{am:"a.m.",pm:"p.m.",midnight:"midnight",noon:"noon",morning:"morning",afternoon:"afternoon",evening:"evening",night:"night"}},Su={narrow:{am:"a",pm:"p",midnight:"mi",noon:"n",morning:"in the morning",afternoon:"in the afternoon",evening:"in the evening",night:"at night"},abbreviated:{am:"AM",pm:"PM",midnight:"midnight",noon:"noon",morning:"in the morning",afternoon:"in the afternoon",evening:"in the evening",night:"at night"},wide:{am:"a.m.",pm:"p.m.",midnight:"midnight",noon:"noon",morning:"in the morning",afternoon:"in the afternoon",evening:"in the evening",night:"at night"}},Eu=(t,a)=>{const n=Number(t),s=n%100;if(s>20||s<10)switch(s%10){case 1:return n+"st";case 2:return n+"nd";case 3:return n+"rd"}return n+"th"},Iu={ordinalNumber:Eu,era:ra({values:fu,defaultWidth:"wide"}),quarter:ra({values:bu,defaultWidth:"wide",argumentCallback:t=>t-1}),month:ra({values:ju,defaultWidth:"wide"}),day:ra({values:yu,defaultWidth:"wide"}),dayPeriod:ra({values:Cu,defaultWidth:"wide",formattingValues:Su,defaultFormattingWidth:"wide"})};function ia(t){return(a,n={})=>{const s=n.width,r=s&&t.matchPatterns[s]||t.matchPatterns[t.defaultMatchWidth],l=a.match(r);if(!l)return null;const c=l[0],g=s&&t.parsePatterns[s]||t.parsePatterns[t.defaultParseWidth],m=Array.isArray(g)?wu(g,T=>T.test(c)):Tu(g,T=>T.test(c));let E;E=t.valueCallback?t.valueCallback(m):m,E=n.valueCallback?n.valueCallback(E):E;const f=a.slice(c.length);return{value:E,rest:f}}}function Tu(t,a){for(const n in t)if(Object.prototype.hasOwnProperty.call(t,n)&&a(t[n]))return n}function wu(t,a){for(let n=0;n<t.length;n++)if(a(t[n]))return n}function Du(t){return(a,n={})=>{const s=a.match(t.matchPattern);if(!s)return null;const r=s[0],l=a.match(t.parsePattern);if(!l)return null;let c=t.valueCallback?t.valueCallback(l[0]):l[0];c=n.valueCallback?n.valueCallback(c):c;const g=a.slice(r.length);return{value:c,rest:g}}}const vu=/^(\d+)(th|st|nd|rd)?/i,ku=/\d+/i,Au={narrow:/^(b|a)/i,abbreviated:/^(b\.?\s?c\.?|b\.?\s?c\.?\s?e\.?|a\.?\s?d\.?|c\.?\s?e\.?)/i,wide:/^(before christ|before common era|anno domini|common era)/i},Nu={any:[/^b/i,/^(a|c)/i]},Ou={narrow:/^[1234]/i,abbreviated:/^q[1234]/i,wide:/^[1234](th|st|nd|rd)? quarter/i},Ru={any:[/1/i,/2/i,/3/i,/4/i]},Lu={narrow:/^[jfmasond]/i,abbreviated:/^(jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec)/i,wide:/^(january|february|march|april|may|june|july|august|september|october|november|december)/i},Pu={narrow:[/^j/i,/^f/i,/^m/i,/^a/i,/^m/i,/^j/i,/^j/i,/^a/i,/^s/i,/^o/i,/^n/i,/^d/i],any:[/^ja/i,/^f/i,/^mar/i,/^ap/i,/^may/i,/^jun/i,/^jul/i,/^au/i,/^s/i,/^o/i,/^n/i,/^d/i]},_u={narrow:/^[smtwf]/i,short:/^(su|mo|tu|we|th|fr|sa)/i,abbreviated:/^(sun|mon|tue|wed|thu|fri|sat)/i,wide:/^(sunday|monday|tuesday|wednesday|thursday|friday|saturday)/i},Mu={narrow:[/^s/i,/^m/i,/^t/i,/^w/i,/^t/i,/^f/i,/^s/i],any:[/^su/i,/^m/i,/^tu/i,/^w/i,/^th/i,/^f/i,/^sa/i]},Fu={narrow:/^(a|p|mi|n|(in the|at) (morning|afternoon|evening|night))/i,any:/^([ap]\.?\s?m\.?|midnight|noon|(in the|at) (morning|afternoon|evening|night))/i},Bu={any:{am:/^a/i,pm:/^p/i,midnight:/^mi/i,noon:/^no/i,morning:/morning/i,afternoon:/afternoon/i,evening:/evening/i,night:/night/i}},Hu={ordinalNumber:Du({matchPattern:vu,parsePattern:ku,valueCallback:t=>parseInt(t,10)}),era:ia({matchPatterns:Au,defaultMatchWidth:"wide",parsePatterns:Nu,defaultParseWidth:"any"}),quarter:ia({matchPatterns:Ou,defaultMatchWidth:"wide",parsePatterns:Ru,defaultParseWidth:"any",valueCallback:t=>t+1}),month:ia({matchPatterns:Lu,defaultMatchWidth:"wide",parsePatterns:Pu,defaultParseWidth:"any"}),day:ia({matchPatterns:_u,defaultMatchWidth:"wide",parsePatterns:Mu,defaultParseWidth:"any"}),dayPeriod:ia({matchPatterns:Fu,defaultMatchWidth:"any",parsePatterns:Bu,defaultParseWidth:"any"})},Fs={code:"en-US",formatDistance:du,formatLong:hu,formatRelative:gu,localize:Iu,match:Hu,options:{weekStartsOn:0,firstWeekContainsDate:1}};function xa(t){const a=we(t);return a.setHours(0,0,0,0),a}function _a(t){const a=we(t),n=new Date(Date.UTC(a.getFullYear(),a.getMonth(),a.getDate(),a.getHours(),a.getMinutes(),a.getSeconds(),a.getMilliseconds()));return n.setUTCFullYear(a.getFullYear()),+t-+n}function $u(t,a){const n=xa(t),s=xa(a),r=+n-_a(n),l=+s-_a(s);return Math.round((r-l)/tu)}function vi(t){const a=we(t),n=Xe(t,0);return n.setFullYear(a.getFullYear(),0,1),n.setHours(0,0,0,0),n}function Gu(t){const a=we(t);return $u(a,vi(a))+1}function In(t,a){var g,m,E,f;const n=$n(),s=(a==null?void 0:a.weekStartsOn)??((m=(g=a==null?void 0:a.locale)==null?void 0:g.options)==null?void 0:m.weekStartsOn)??n.weekStartsOn??((f=(E=n.locale)==null?void 0:E.options)==null?void 0:f.weekStartsOn)??0,r=we(t),l=r.getDay(),c=(l<s?7:0)+l-s;return r.setDate(r.getDate()-c),r.setHours(0,0,0,0),r}function Zn(t){return In(t,{weekStartsOn:1})}function ki(t){const a=we(t),n=a.getFullYear(),s=Xe(t,0);s.setFullYear(n+1,0,4),s.setHours(0,0,0,0);const r=Zn(s),l=Xe(t,0);l.setFullYear(n,0,4),l.setHours(0,0,0,0);const c=Zn(l);return a.getTime()>=r.getTime()?n+1:a.getTime()>=c.getTime()?n:n-1}function Wu(t){const a=ki(t),n=Xe(t,0);return n.setFullYear(a,0,4),n.setHours(0,0,0,0),Zn(n)}function Ai(t){const a=we(t),n=+Zn(a)-+Wu(a);return Math.round(n/Ii)+1}function Bs(t,a){var f,T,y,D;const n=we(t),s=n.getFullYear(),r=$n(),l=(a==null?void 0:a.firstWeekContainsDate)??((T=(f=a==null?void 0:a.locale)==null?void 0:f.options)==null?void 0:T.firstWeekContainsDate)??r.firstWeekContainsDate??((D=(y=r.locale)==null?void 0:y.options)==null?void 0:D.firstWeekContainsDate)??1,c=Xe(t,0);c.setFullYear(s+1,0,l),c.setHours(0,0,0,0);const g=In(c,a),m=Xe(t,0);m.setFullYear(s,0,l),m.setHours(0,0,0,0);const E=In(m,a);return n.getTime()>=g.getTime()?s+1:n.getTime()>=E.getTime()?s:s-1}function Yu(t,a){var g,m,E,f;const n=$n(),s=(a==null?void 0:a.firstWeekContainsDate)??((m=(g=a==null?void 0:a.locale)==null?void 0:g.options)==null?void 0:m.firstWeekContainsDate)??n.firstWeekContainsDate??((f=(E=n.locale)==null?void 0:E.options)==null?void 0:f.firstWeekContainsDate)??1,r=Bs(t,a),l=Xe(t,0);return l.setFullYear(r,0,s),l.setHours(0,0,0,0),In(l,a)}function Hs(t,a){const n=we(t),s=+In(n,a)-+Yu(n,a);return Math.round(s/Ii)+1}function Qe(t,a){const n=t<0?"-":"",s=Math.abs(t).toString().padStart(a,"0");return n+s}const wn={y(t,a){const n=t.getFullYear(),s=n>0?n:1-n;return Qe(a==="yy"?s%100:s,a.length)},M(t,a){const n=t.getMonth();return a==="M"?String(n+1):Qe(n+1,2)},d(t,a){return Qe(t.getDate(),a.length)},a(t,a){const n=t.getHours()/12>=1?"pm":"am";switch(a){case"a":case"aa":return n.toUpperCase();case"aaa":return n;case"aaaaa":return n[0];case"aaaa":default:return n==="am"?"a.m.":"p.m."}},h(t,a){return Qe(t.getHours()%12||12,a.length)},H(t,a){return Qe(t.getHours(),a.length)},m(t,a){return Qe(t.getMinutes(),a.length)},s(t,a){return Qe(t.getSeconds(),a.length)},S(t,a){const n=a.length,s=t.getMilliseconds(),r=Math.trunc(s*Math.pow(10,n-3));return Qe(r,a.length)}},Wn={am:"am",pm:"pm",midnight:"midnight",noon:"noon",morning:"morning",afternoon:"afternoon",evening:"evening",night:"night"},ir={G:function(t,a,n){const s=t.getFullYear()>0?1:0;switch(a){case"G":case"GG":case"GGG":return n.era(s,{width:"abbreviated"});case"GGGGG":return n.era(s,{width:"narrow"});case"GGGG":default:return n.era(s,{width:"wide"})}},y:function(t,a,n){if(a==="yo"){const s=t.getFullYear(),r=s>0?s:1-s;return n.ordinalNumber(r,{unit:"year"})}return wn.y(t,a)},Y:function(t,a,n,s){const r=Bs(t,s),l=r>0?r:1-r;if(a==="YY"){const c=l%100;return Qe(c,2)}return a==="Yo"?n.ordinalNumber(l,{unit:"year"}):Qe(l,a.length)},R:function(t,a){const n=ki(t);return Qe(n,a.length)},u:function(t,a){const n=t.getFullYear();return Qe(n,a.length)},Q:function(t,a,n){const s=Math.ceil((t.getMonth()+1)/3);switch(a){case"Q":return String(s);case"QQ":return Qe(s,2);case"Qo":return n.ordinalNumber(s,{unit:"quarter"});case"QQQ":return n.quarter(s,{width:"abbreviated",context:"formatting"});case"QQQQQ":return n.quarter(s,{width:"narrow",context:"formatting"});case"QQQQ":default:return n.quarter(s,{width:"wide",context:"formatting"})}},q:function(t,a,n){const s=Math.ceil((t.getMonth()+1)/3);switch(a){case"q":return String(s);case"qq":return Qe(s,2);case"qo":return n.ordinalNumber(s,{unit:"quarter"});case"qqq":return n.quarter(s,{width:"abbreviated",context:"standalone"});case"qqqqq":return n.quarter(s,{width:"narrow",context:"standalone"});case"qqqq":default:return n.quarter(s,{width:"wide",context:"standalone"})}},M:function(t,a,n){const s=t.getMonth();switch(a){case"M":case"MM":return wn.M(t,a);case"Mo":return n.ordinalNumber(s+1,{unit:"month"});case"MMM":return n.month(s,{width:"abbreviated",context:"formatting"});case"MMMMM":return n.month(s,{width:"narrow",context:"formatting"});case"MMMM":default:return n.month(s,{width:"wide",context:"formatting"})}},L:function(t,a,n){const s=t.getMonth();switch(a){case"L":return String(s+1);case"LL":return Qe(s+1,2);case"Lo":return n.ordinalNumber(s+1,{unit:"month"});case"LLL":return n.month(s,{width:"abbreviated",context:"standalone"});case"LLLLL":return n.month(s,{width:"narrow",context:"standalone"});case"LLLL":default:return n.month(s,{width:"wide",context:"standalone"})}},w:function(t,a,n,s){const r=Hs(t,s);return a==="wo"?n.ordinalNumber(r,{unit:"week"}):Qe(r,a.length)},I:function(t,a,n){const s=Ai(t);return a==="Io"?n.ordinalNumber(s,{unit:"week"}):Qe(s,a.length)},d:function(t,a,n){return a==="do"?n.ordinalNumber(t.getDate(),{unit:"date"}):wn.d(t,a)},D:function(t,a,n){const s=Gu(t);return a==="Do"?n.ordinalNumber(s,{unit:"dayOfYear"}):Qe(s,a.length)},E:function(t,a,n){const s=t.getDay();switch(a){case"E":case"EE":case"EEE":return n.day(s,{width:"abbreviated",context:"formatting"});case"EEEEE":return n.day(s,{width:"narrow",context:"formatting"});case"EEEEEE":return n.day(s,{width:"short",context:"formatting"});case"EEEE":default:return n.day(s,{width:"wide",context:"formatting"})}},e:function(t,a,n,s){const r=t.getDay(),l=(r-s.weekStartsOn+8)%7||7;switch(a){case"e":return String(l);case"ee":return Qe(l,2);case"eo":return n.ordinalNumber(l,{unit:"day"});case"eee":return n.day(r,{width:"abbreviated",context:"formatting"});case"eeeee":return n.day(r,{width:"narrow",context:"formatting"});case"eeeeee":return n.day(r,{width:"short",context:"formatting"});case"eeee":default:return n.day(r,{width:"wide",context:"formatting"})}},c:function(t,a,n,s){const r=t.getDay(),l=(r-s.weekStartsOn+8)%7||7;switch(a){case"c":return String(l);case"cc":return Qe(l,a.length);case"co":return n.ordinalNumber(l,{unit:"day"});case"ccc":return n.day(r,{width:"abbreviated",context:"standalone"});case"ccccc":return n.day(r,{width:"narrow",context:"standalone"});case"cccccc":return n.day(r,{width:"short",context:"standalone"});case"cccc":default:return n.day(r,{width:"wide",context:"standalone"})}},i:function(t,a,n){const s=t.getDay(),r=s===0?7:s;switch(a){case"i":return String(r);case"ii":return Qe(r,a.length);case"io":return n.ordinalNumber(r,{unit:"day"});case"iii":return n.day(s,{width:"abbreviated",context:"formatting"});case"iiiii":return n.day(s,{width:"narrow",context:"formatting"});case"iiiiii":return n.day(s,{width:"short",context:"formatting"});case"iiii":default:return n.day(s,{width:"wide",context:"formatting"})}},a:function(t,a,n){const r=t.getHours()/12>=1?"pm":"am";switch(a){case"a":case"aa":return n.dayPeriod(r,{width:"abbreviated",context:"formatting"});case"aaa":return n.dayPeriod(r,{width:"abbreviated",context:"formatting"}).toLowerCase();case"aaaaa":return n.dayPeriod(r,{width:"narrow",context:"formatting"});case"aaaa":default:return n.dayPeriod(r,{width:"wide",context:"formatting"})}},b:function(t,a,n){const s=t.getHours();let r;switch(s===12?r=Wn.noon:s===0?r=Wn.midnight:r=s/12>=1?"pm":"am",a){case"b":case"bb":return n.dayPeriod(r,{width:"abbreviated",context:"formatting"});case"bbb":return n.dayPeriod(r,{width:"abbreviated",context:"formatting"}).toLowerCase();case"bbbbb":return n.dayPeriod(r,{width:"narrow",context:"formatting"});case"bbbb":default:return n.dayPeriod(r,{width:"wide",context:"formatting"})}},B:function(t,a,n){const s=t.getHours();let r;switch(s>=17?r=Wn.evening:s>=12?r=Wn.afternoon:s>=4?r=Wn.morning:r=Wn.night,a){case"B":case"BB":case"BBB":return n.dayPeriod(r,{width:"abbreviated",context:"formatting"});case"BBBBB":return n.dayPeriod(r,{width:"narrow",context:"formatting"});case"BBBB":default:return n.dayPeriod(r,{width:"wide",context:"formatting"})}},h:function(t,a,n){if(a==="ho"){let s=t.getHours()%12;return s===0&&(s=12),n.ordinalNumber(s,{unit:"hour"})}return wn.h(t,a)},H:function(t,a,n){return a==="Ho"?n.ordinalNumber(t.getHours(),{unit:"hour"}):wn.H(t,a)},K:function(t,a,n){const s=t.getHours()%12;return a==="Ko"?n.ordinalNumber(s,{unit:"hour"}):Qe(s,a.length)},k:function(t,a,n){let s=t.getHours();return s===0&&(s=24),a==="ko"?n.ordinalNumber(s,{unit:"hour"}):Qe(s,a.length)},m:function(t,a,n){return a==="mo"?n.ordinalNumber(t.getMinutes(),{unit:"minute"}):wn.m(t,a)},s:function(t,a,n){return a==="so"?n.ordinalNumber(t.getSeconds(),{unit:"second"}):wn.s(t,a)},S:function(t,a){return wn.S(t,a)},X:function(t,a,n){const s=t.getTimezoneOffset();if(s===0)return"Z";switch(a){case"X":return lr(s);case"XXXX":case"XX":return Ln(s);case"XXXXX":case"XXX":default:return Ln(s,":")}},x:function(t,a,n){const s=t.getTimezoneOffset();switch(a){case"x":return lr(s);case"xxxx":case"xx":return Ln(s);case"xxxxx":case"xxx":default:return Ln(s,":")}},O:function(t,a,n){const s=t.getTimezoneOffset();switch(a){case"O":case"OO":case"OOO":return"GMT"+or(s,":");case"OOOO":default:return"GMT"+Ln(s,":")}},z:function(t,a,n){const s=t.getTimezoneOffset();switch(a){case"z":case"zz":case"zzz":return"GMT"+or(s,":");case"zzzz":default:return"GMT"+Ln(s,":")}},t:function(t,a,n){const s=Math.trunc(t.getTime()/1e3);return Qe(s,a.length)},T:function(t,a,n){const s=t.getTime();return Qe(s,a.length)}};function or(t,a=""){const n=t>0?"-":"+",s=Math.abs(t),r=Math.trunc(s/60),l=s%60;return l===0?n+String(r):n+String(r)+a+Qe(l,2)}function lr(t,a){return t%60===0?(t>0?"-":"+")+Qe(Math.abs(t)/60,2):Ln(t,a)}function Ln(t,a=""){const n=t>0?"-":"+",s=Math.abs(t),r=Qe(Math.trunc(s/60),2),l=Qe(s%60,2);return n+r+a+l}const cr=(t,a)=>{switch(t){case"P":return a.date({width:"short"});case"PP":return a.date({width:"medium"});case"PPP":return a.date({width:"long"});case"PPPP":default:return a.date({width:"full"})}},Ni=(t,a)=>{switch(t){case"p":return a.time({width:"short"});case"pp":return a.time({width:"medium"});case"ppp":return a.time({width:"long"});case"pppp":default:return a.time({width:"full"})}},Uu=(t,a)=>{const n=t.match(/(P+)(p+)?/)||[],s=n[1],r=n[2];if(!r)return cr(t,a);let l;switch(s){case"P":l=a.dateTime({width:"short"});break;case"PP":l=a.dateTime({width:"medium"});break;case"PPP":l=a.dateTime({width:"long"});break;case"PPPP":default:l=a.dateTime({width:"full"});break}return l.replace("{{date}}",cr(s,a)).replace("{{time}}",Ni(r,a))},ga={p:Ni,P:Uu},qu=/^D+$/,Vu=/^Y+$/,Ku=["D","DD","YY","YYYY"];function Oi(t){return qu.test(t)}function Ri(t){return Vu.test(t)}function js(t,a,n){const s=zu(t,a,n);if(console.warn(s),Ku.includes(t))throw new RangeError(s)}function zu(t,a,n){const s=t[0]==="Y"?"years":"days of the month";return`Use \`${t.toLowerCase()}\` instead of \`${t}\` (in \`${a}\`) for formatting ${s} to the input \`${n}\`; see: https://github.com/date-fns/date-fns/blob/master/docs/unicodeTokens.md`}function Qu(t){return t instanceof Date||typeof t=="object"&&Object.prototype.toString.call(t)==="[object Date]"}function Li(t){if(!Qu(t)&&typeof t!="number")return!1;const a=we(t);return!isNaN(Number(a))}const Xu=/[yYQqMLwIdDecihHKkms]o|(\w)\1*|''|'(''|[^'])+('|$)|./g,Ju=/P+p+|P+|p+|''|'(''|[^'])+('|$)|./g,Zu=/^'([^]*?)'?$/,ep=/''/g,tp=/[a-zA-Z]/;function np(t,a,n){var f,T,y,D,S,j,w,O;const s=$n(),r=(n==null?void 0:n.locale)??s.locale??Fs,l=(n==null?void 0:n.firstWeekContainsDate)??((T=(f=n==null?void 0:n.locale)==null?void 0:f.options)==null?void 0:T.firstWeekContainsDate)??s.firstWeekContainsDate??((D=(y=s.locale)==null?void 0:y.options)==null?void 0:D.firstWeekContainsDate)??1,c=(n==null?void 0:n.weekStartsOn)??((j=(S=n==null?void 0:n.locale)==null?void 0:S.options)==null?void 0:j.weekStartsOn)??s.weekStartsOn??((O=(w=s.locale)==null?void 0:w.options)==null?void 0:O.weekStartsOn)??0,g=we(t);if(!Li(g))throw new RangeError("Invalid time value");let m=a.match(Ju).map(B=>{const k=B[0];if(k==="p"||k==="P"){const q=ga[k];return q(B,r.formatLong)}return B}).join("").match(Xu).map(B=>{if(B==="''")return{isToken:!1,value:"'"};const k=B[0];if(k==="'")return{isToken:!1,value:ap(B)};if(ir[k])return{isToken:!0,value:B};if(k.match(tp))throw new RangeError("Format string contains an unescaped latin alphabet character `"+k+"`");return{isToken:!1,value:B}});r.localize.preprocessor&&(m=r.localize.preprocessor(g,m));const E={firstWeekContainsDate:l,weekStartsOn:c,locale:r};return m.map(B=>{if(!B.isToken)return B.value;const k=B.value;(!(n!=null&&n.useAdditionalWeekYearTokens)&&Ri(k)||!(n!=null&&n.useAdditionalDayOfYearTokens)&&Oi(k))&&js(k,a,String(t));const q=ir[k[0]];return q(g,k,r.localize,E)}).join("")}function ap(t){const a=t.match(Zu);return a?a[1].replace(ep,"'"):t}function sp(t){return we(t).getDate()}function Pi(t){const a=we(t),n=a.getFullYear(),s=a.getMonth(),r=Xe(t,0);return r.setFullYear(n,s+1,0),r.setHours(0,0,0,0),r.getDate()}function rp(t){return we(t).getHours()}function ip(t){return we(t).getMinutes()}function op(t){return we(t).getMonth()}function lp(t){return we(t).getSeconds()}function cp(t){return we(t).getMilliseconds()}function dp(t){return we(t).getFullYear()}function cs(t,a){const n=we(t),s=we(a);return n.getTime()>s.getTime()}function ds(t,a){const n=we(t),s=we(a);return+n<+s}function up(t,a){const n=we(t),s=we(a);return+n==+s}function pp(t,a){const n=xa(t),s=xa(a);return+n==+s}function mp(t,a){const n=we(t),s=we(a);return n.getFullYear()===s.getFullYear()}function hp(t,a){const n=we(t),s=we(a);return n.getFullYear()===s.getFullYear()&&n.getMonth()===s.getMonth()}function dr(t){const a=we(t);return a.setMinutes(0,0,0),a}function xp(t,a){const n=dr(t),s=dr(a);return+n==+s}function gp(){return Object.assign({},$n())}function fp(t,a){const n=a instanceof Date?Xe(a,0):new a(0);return n.setFullYear(t.getFullYear(),t.getMonth(),t.getDate()),n.setHours(t.getHours(),t.getMinutes(),t.getSeconds(),t.getMilliseconds()),n}const bp=10;class _i{constructor(){be(this,"subPriority",0)}validate(a,n){return!0}}class jp extends _i{constructor(a,n,s,r,l){super(),this.value=a,this.validateValue=n,this.setValue=s,this.priority=r,l&&(this.subPriority=l)}validate(a,n){return this.validateValue(a,this.value,n)}set(a,n,s){return this.setValue(a,n,this.value,s)}}class yp extends _i{constructor(){super(...arguments);be(this,"priority",bp);be(this,"subPriority",-1)}set(n,s){return s.timestampIsSet?n:Xe(n,fp(n,Date))}}class Ke{run(a,n,s,r){const l=this.parse(a,n,s,r);return l?{setter:new jp(l.value,this.validate,this.set,this.priority,this.subPriority),rest:l.rest}:null}validate(a,n,s){return!0}}class Cp extends Ke{constructor(){super(...arguments);be(this,"priority",140);be(this,"incompatibleTokens",["R","u","t","T"])}parse(n,s,r){switch(s){case"G":case"GG":case"GGG":return r.era(n,{width:"abbreviated"})||r.era(n,{width:"narrow"});case"GGGGG":return r.era(n,{width:"narrow"});case"GGGG":default:return r.era(n,{width:"wide"})||r.era(n,{width:"abbreviated"})||r.era(n,{width:"narrow"})}}set(n,s,r){return s.era=r,n.setFullYear(r,0,1),n.setHours(0,0,0,0),n}}const pt={month:/^(1[0-2]|0?\d)/,date:/^(3[0-1]|[0-2]?\d)/,dayOfYear:/^(36[0-6]|3[0-5]\d|[0-2]?\d?\d)/,week:/^(5[0-3]|[0-4]?\d)/,hour23h:/^(2[0-3]|[0-1]?\d)/,hour24h:/^(2[0-4]|[0-1]?\d)/,hour11h:/^(1[0-1]|0?\d)/,hour12h:/^(1[0-2]|0?\d)/,minute:/^[0-5]?\d/,second:/^[0-5]?\d/,singleDigit:/^\d/,twoDigits:/^\d{1,2}/,threeDigits:/^\d{1,3}/,fourDigits:/^\d{1,4}/,anyDigitsSigned:/^-?\d+/,singleDigitSigned:/^-?\d/,twoDigitsSigned:/^-?\d{1,2}/,threeDigitsSigned:/^-?\d{1,3}/,fourDigitsSigned:/^-?\d{1,4}/},xn={basicOptionalMinutes:/^([+-])(\d{2})(\d{2})?|Z/,basic:/^([+-])(\d{2})(\d{2})|Z/,basicOptionalSeconds:/^([+-])(\d{2})(\d{2})((\d{2}))?|Z/,extended:/^([+-])(\d{2}):(\d{2})|Z/,extendedOptionalSeconds:/^([+-])(\d{2}):(\d{2})(:(\d{2}))?|Z/};function mt(t,a){return t&&{value:a(t.value),rest:t.rest}}function ot(t,a){const n=a.match(t);return n?{value:parseInt(n[0],10),rest:a.slice(n[0].length)}:null}function gn(t,a){const n=a.match(t);if(!n)return null;if(n[0]==="Z")return{value:0,rest:a.slice(1)};const s=n[1]==="+"?1:-1,r=n[2]?parseInt(n[2],10):0,l=n[3]?parseInt(n[3],10):0,c=n[5]?parseInt(n[5],10):0;return{value:s*(r*wi+l*Ti+c*nu),rest:a.slice(n[0].length)}}function Mi(t){return ot(pt.anyDigitsSigned,t)}function ct(t,a){switch(t){case 1:return ot(pt.singleDigit,a);case 2:return ot(pt.twoDigits,a);case 3:return ot(pt.threeDigits,a);case 4:return ot(pt.fourDigits,a);default:return ot(new RegExp("^\\d{1,"+t+"}"),a)}}function Ma(t,a){switch(t){case 1:return ot(pt.singleDigitSigned,a);case 2:return ot(pt.twoDigitsSigned,a);case 3:return ot(pt.threeDigitsSigned,a);case 4:return ot(pt.fourDigitsSigned,a);default:return ot(new RegExp("^-?\\d{1,"+t+"}"),a)}}function $s(t){switch(t){case"morning":return 4;case"evening":return 17;case"pm":case"noon":case"afternoon":return 12;case"am":case"midnight":case"night":default:return 0}}function Fi(t,a){const n=a>0,s=n?a:1-a;let r;if(s<=50)r=t||100;else{const l=s+50,c=Math.trunc(l/100)*100,g=t>=l%100;r=t+c-(g?100:0)}return n?r:1-r}function Bi(t){return t%400===0||t%4===0&&t%100!==0}class Sp extends Ke{constructor(){super(...arguments);be(this,"priority",130);be(this,"incompatibleTokens",["Y","R","u","w","I","i","e","c","t","T"])}parse(n,s,r){const l=c=>({year:c,isTwoDigitYear:s==="yy"});switch(s){case"y":return mt(ct(4,n),l);case"yo":return mt(r.ordinalNumber(n,{unit:"year"}),l);default:return mt(ct(s.length,n),l)}}validate(n,s){return s.isTwoDigitYear||s.year>0}set(n,s,r){const l=n.getFullYear();if(r.isTwoDigitYear){const g=Fi(r.year,l);return n.setFullYear(g,0,1),n.setHours(0,0,0,0),n}const c=!("era"in s)||s.era===1?r.year:1-r.year;return n.setFullYear(c,0,1),n.setHours(0,0,0,0),n}}class Ep extends Ke{constructor(){super(...arguments);be(this,"priority",130);be(this,"incompatibleTokens",["y","R","u","Q","q","M","L","I","d","D","i","t","T"])}parse(n,s,r){const l=c=>({year:c,isTwoDigitYear:s==="YY"});switch(s){case"Y":return mt(ct(4,n),l);case"Yo":return mt(r.ordinalNumber(n,{unit:"year"}),l);default:return mt(ct(s.length,n),l)}}validate(n,s){return s.isTwoDigitYear||s.year>0}set(n,s,r,l){const c=Bs(n,l);if(r.isTwoDigitYear){const m=Fi(r.year,c);return n.setFullYear(m,0,l.firstWeekContainsDate),n.setHours(0,0,0,0),In(n,l)}const g=!("era"in s)||s.era===1?r.year:1-r.year;return n.setFullYear(g,0,l.firstWeekContainsDate),n.setHours(0,0,0,0),In(n,l)}}class Ip extends Ke{constructor(){super(...arguments);be(this,"priority",130);be(this,"incompatibleTokens",["G","y","Y","u","Q","q","M","L","w","d","D","e","c","t","T"])}parse(n,s){return Ma(s==="R"?4:s.length,n)}set(n,s,r){const l=Xe(n,0);return l.setFullYear(r,0,4),l.setHours(0,0,0,0),Zn(l)}}class Tp extends Ke{constructor(){super(...arguments);be(this,"priority",130);be(this,"incompatibleTokens",["G","y","Y","R","w","I","i","e","c","t","T"])}parse(n,s){return Ma(s==="u"?4:s.length,n)}set(n,s,r){return n.setFullYear(r,0,1),n.setHours(0,0,0,0),n}}class wp extends Ke{constructor(){super(...arguments);be(this,"priority",120);be(this,"incompatibleTokens",["Y","R","q","M","L","w","I","d","D","i","e","c","t","T"])}parse(n,s,r){switch(s){case"Q":case"QQ":return ct(s.length,n);case"Qo":return r.ordinalNumber(n,{unit:"quarter"});case"QQQ":return r.quarter(n,{width:"abbreviated",context:"formatting"})||r.quarter(n,{width:"narrow",context:"formatting"});case"QQQQQ":return r.quarter(n,{width:"narrow",context:"formatting"});case"QQQQ":default:return r.quarter(n,{width:"wide",context:"formatting"})||r.quarter(n,{width:"abbreviated",context:"formatting"})||r.quarter(n,{width:"narrow",context:"formatting"})}}validate(n,s){return s>=1&&s<=4}set(n,s,r){return n.setMonth((r-1)*3,1),n.setHours(0,0,0,0),n}}class Dp extends Ke{constructor(){super(...arguments);be(this,"priority",120);be(this,"incompatibleTokens",["Y","R","Q","M","L","w","I","d","D","i","e","c","t","T"])}parse(n,s,r){switch(s){case"q":case"qq":return ct(s.length,n);case"qo":return r.ordinalNumber(n,{unit:"quarter"});case"qqq":return r.quarter(n,{width:"abbreviated",context:"standalone"})||r.quarter(n,{width:"narrow",context:"standalone"});case"qqqqq":return r.quarter(n,{width:"narrow",context:"standalone"});case"qqqq":default:return r.quarter(n,{width:"wide",context:"standalone"})||r.quarter(n,{width:"abbreviated",context:"standalone"})||r.quarter(n,{width:"narrow",context:"standalone"})}}validate(n,s){return s>=1&&s<=4}set(n,s,r){return n.setMonth((r-1)*3,1),n.setHours(0,0,0,0),n}}class vp extends Ke{constructor(){super(...arguments);be(this,"incompatibleTokens",["Y","R","q","Q","L","w","I","D","i","e","c","t","T"]);be(this,"priority",110)}parse(n,s,r){const l=c=>c-1;switch(s){case"M":return mt(ot(pt.month,n),l);case"MM":return mt(ct(2,n),l);case"Mo":return mt(r.ordinalNumber(n,{unit:"month"}),l);case"MMM":return r.month(n,{width:"abbreviated",context:"formatting"})||r.month(n,{width:"narrow",context:"formatting"});case"MMMMM":return r.month(n,{width:"narrow",context:"formatting"});case"MMMM":default:return r.month(n,{width:"wide",context:"formatting"})||r.month(n,{width:"abbreviated",context:"formatting"})||r.month(n,{width:"narrow",context:"formatting"})}}validate(n,s){return s>=0&&s<=11}set(n,s,r){return n.setMonth(r,1),n.setHours(0,0,0,0),n}}class kp extends Ke{constructor(){super(...arguments);be(this,"priority",110);be(this,"incompatibleTokens",["Y","R","q","Q","M","w","I","D","i","e","c","t","T"])}parse(n,s,r){const l=c=>c-1;switch(s){case"L":return mt(ot(pt.month,n),l);case"LL":return mt(ct(2,n),l);case"Lo":return mt(r.ordinalNumber(n,{unit:"month"}),l);case"LLL":return r.month(n,{width:"abbreviated",context:"standalone"})||r.month(n,{width:"narrow",context:"standalone"});case"LLLLL":return r.month(n,{width:"narrow",context:"standalone"});case"LLLL":default:return r.month(n,{width:"wide",context:"standalone"})||r.month(n,{width:"abbreviated",context:"standalone"})||r.month(n,{width:"narrow",context:"standalone"})}}validate(n,s){return s>=0&&s<=11}set(n,s,r){return n.setMonth(r,1),n.setHours(0,0,0,0),n}}function Ap(t,a,n){const s=we(t),r=Hs(s,n)-a;return s.setDate(s.getDate()-r*7),s}class Np extends Ke{constructor(){super(...arguments);be(this,"priority",100);be(this,"incompatibleTokens",["y","R","u","q","Q","M","L","I","d","D","i","t","T"])}parse(n,s,r){switch(s){case"w":return ot(pt.week,n);case"wo":return r.ordinalNumber(n,{unit:"week"});default:return ct(s.length,n)}}validate(n,s){return s>=1&&s<=53}set(n,s,r,l){return In(Ap(n,r,l),l)}}function Op(t,a){const n=we(t),s=Ai(n)-a;return n.setDate(n.getDate()-s*7),n}class Rp extends Ke{constructor(){super(...arguments);be(this,"priority",100);be(this,"incompatibleTokens",["y","Y","u","q","Q","M","L","w","d","D","e","c","t","T"])}parse(n,s,r){switch(s){case"I":return ot(pt.week,n);case"Io":return r.ordinalNumber(n,{unit:"week"});default:return ct(s.length,n)}}validate(n,s){return s>=1&&s<=53}set(n,s,r){return Zn(Op(n,r))}}const Lp=[31,28,31,30,31,30,31,31,30,31,30,31],Pp=[31,29,31,30,31,30,31,31,30,31,30,31];class _p extends Ke{constructor(){super(...arguments);be(this,"priority",90);be(this,"subPriority",1);be(this,"incompatibleTokens",["Y","R","q","Q","w","I","D","i","e","c","t","T"])}parse(n,s,r){switch(s){case"d":return ot(pt.date,n);case"do":return r.ordinalNumber(n,{unit:"date"});default:return ct(s.length,n)}}validate(n,s){const r=n.getFullYear(),l=Bi(r),c=n.getMonth();return l?s>=1&&s<=Pp[c]:s>=1&&s<=Lp[c]}set(n,s,r){return n.setDate(r),n.setHours(0,0,0,0),n}}class Mp extends Ke{constructor(){super(...arguments);be(this,"priority",90);be(this,"subpriority",1);be(this,"incompatibleTokens",["Y","R","q","Q","M","L","w","I","d","E","i","e","c","t","T"])}parse(n,s,r){switch(s){case"D":case"DD":return ot(pt.dayOfYear,n);case"Do":return r.ordinalNumber(n,{unit:"date"});default:return ct(s.length,n)}}validate(n,s){const r=n.getFullYear();return Bi(r)?s>=1&&s<=366:s>=1&&s<=365}set(n,s,r){return n.setMonth(0,r),n.setHours(0,0,0,0),n}}function Gs(t,a,n){var T,y,D,S;const s=$n(),r=(n==null?void 0:n.weekStartsOn)??((y=(T=n==null?void 0:n.locale)==null?void 0:T.options)==null?void 0:y.weekStartsOn)??s.weekStartsOn??((S=(D=s.locale)==null?void 0:D.options)==null?void 0:S.weekStartsOn)??0,l=we(t),c=l.getDay(),m=(a%7+7)%7,E=7-r,f=a<0||a>6?a-(c+E)%7:(m+E)%7-(c+E)%7;return ha(l,f)}class Fp extends Ke{constructor(){super(...arguments);be(this,"priority",90);be(this,"incompatibleTokens",["D","i","e","c","t","T"])}parse(n,s,r){switch(s){case"E":case"EE":case"EEE":return r.day(n,{width:"abbreviated",context:"formatting"})||r.day(n,{width:"short",context:"formatting"})||r.day(n,{width:"narrow",context:"formatting"});case"EEEEE":return r.day(n,{width:"narrow",context:"formatting"});case"EEEEEE":return r.day(n,{width:"short",context:"formatting"})||r.day(n,{width:"narrow",context:"formatting"});case"EEEE":default:return r.day(n,{width:"wide",context:"formatting"})||r.day(n,{width:"abbreviated",context:"formatting"})||r.day(n,{width:"short",context:"formatting"})||r.day(n,{width:"narrow",context:"formatting"})}}validate(n,s){return s>=0&&s<=6}set(n,s,r,l){return n=Gs(n,r,l),n.setHours(0,0,0,0),n}}class Bp extends Ke{constructor(){super(...arguments);be(this,"priority",90);be(this,"incompatibleTokens",["y","R","u","q","Q","M","L","I","d","D","E","i","c","t","T"])}parse(n,s,r,l){const c=g=>{const m=Math.floor((g-1)/7)*7;return(g+l.weekStartsOn+6)%7+m};switch(s){case"e":case"ee":return mt(ct(s.length,n),c);case"eo":return mt(r.ordinalNumber(n,{unit:"day"}),c);case"eee":return r.day(n,{width:"abbreviated",context:"formatting"})||r.day(n,{width:"short",context:"formatting"})||r.day(n,{width:"narrow",context:"formatting"});case"eeeee":return r.day(n,{width:"narrow",context:"formatting"});case"eeeeee":return r.day(n,{width:"short",context:"formatting"})||r.day(n,{width:"narrow",context:"formatting"});case"eeee":default:return r.day(n,{width:"wide",context:"formatting"})||r.day(n,{width:"abbreviated",context:"formatting"})||r.day(n,{width:"short",context:"formatting"})||r.day(n,{width:"narrow",context:"formatting"})}}validate(n,s){return s>=0&&s<=6}set(n,s,r,l){return n=Gs(n,r,l),n.setHours(0,0,0,0),n}}class Hp extends Ke{constructor(){super(...arguments);be(this,"priority",90);be(this,"incompatibleTokens",["y","R","u","q","Q","M","L","I","d","D","E","i","e","t","T"])}parse(n,s,r,l){const c=g=>{const m=Math.floor((g-1)/7)*7;return(g+l.weekStartsOn+6)%7+m};switch(s){case"c":case"cc":return mt(ct(s.length,n),c);case"co":return mt(r.ordinalNumber(n,{unit:"day"}),c);case"ccc":return r.day(n,{width:"abbreviated",context:"standalone"})||r.day(n,{width:"short",context:"standalone"})||r.day(n,{width:"narrow",context:"standalone"});case"ccccc":return r.day(n,{width:"narrow",context:"standalone"});case"cccccc":return r.day(n,{width:"short",context:"standalone"})||r.day(n,{width:"narrow",context:"standalone"});case"cccc":default:return r.day(n,{width:"wide",context:"standalone"})||r.day(n,{width:"abbreviated",context:"standalone"})||r.day(n,{width:"short",context:"standalone"})||r.day(n,{width:"narrow",context:"standalone"})}}validate(n,s){return s>=0&&s<=6}set(n,s,r,l){return n=Gs(n,r,l),n.setHours(0,0,0,0),n}}function $p(t){let n=we(t).getDay();return n===0&&(n=7),n}function Gp(t,a){const n=we(t),s=$p(n),r=a-s;return ha(n,r)}class Wp extends Ke{constructor(){super(...arguments);be(this,"priority",90);be(this,"incompatibleTokens",["y","Y","u","q","Q","M","L","w","d","D","E","e","c","t","T"])}parse(n,s,r){const l=c=>c===0?7:c;switch(s){case"i":case"ii":return ct(s.length,n);case"io":return r.ordinalNumber(n,{unit:"day"});case"iii":return mt(r.day(n,{width:"abbreviated",context:"formatting"})||r.day(n,{width:"short",context:"formatting"})||r.day(n,{width:"narrow",context:"formatting"}),l);case"iiiii":return mt(r.day(n,{width:"narrow",context:"formatting"}),l);case"iiiiii":return mt(r.day(n,{width:"short",context:"formatting"})||r.day(n,{width:"narrow",context:"formatting"}),l);case"iiii":default:return mt(r.day(n,{width:"wide",context:"formatting"})||r.day(n,{width:"abbreviated",context:"formatting"})||r.day(n,{width:"short",context:"formatting"})||r.day(n,{width:"narrow",context:"formatting"}),l)}}validate(n,s){return s>=1&&s<=7}set(n,s,r){return n=Gp(n,r),n.setHours(0,0,0,0),n}}class Yp extends Ke{constructor(){super(...arguments);be(this,"priority",80);be(this,"incompatibleTokens",["b","B","H","k","t","T"])}parse(n,s,r){switch(s){case"a":case"aa":case"aaa":return r.dayPeriod(n,{width:"abbreviated",context:"formatting"})||r.dayPeriod(n,{width:"narrow",context:"formatting"});case"aaaaa":return r.dayPeriod(n,{width:"narrow",context:"formatting"});case"aaaa":default:return r.dayPeriod(n,{width:"wide",context:"formatting"})||r.dayPeriod(n,{width:"abbreviated",context:"formatting"})||r.dayPeriod(n,{width:"narrow",context:"formatting"})}}set(n,s,r){return n.setHours($s(r),0,0,0),n}}class Up extends Ke{constructor(){super(...arguments);be(this,"priority",80);be(this,"incompatibleTokens",["a","B","H","k","t","T"])}parse(n,s,r){switch(s){case"b":case"bb":case"bbb":return r.dayPeriod(n,{width:"abbreviated",context:"formatting"})||r.dayPeriod(n,{width:"narrow",context:"formatting"});case"bbbbb":return r.dayPeriod(n,{width:"narrow",context:"formatting"});case"bbbb":default:return r.dayPeriod(n,{width:"wide",context:"formatting"})||r.dayPeriod(n,{width:"abbreviated",context:"formatting"})||r.dayPeriod(n,{width:"narrow",context:"formatting"})}}set(n,s,r){return n.setHours($s(r),0,0,0),n}}class qp extends Ke{constructor(){super(...arguments);be(this,"priority",80);be(this,"incompatibleTokens",["a","b","t","T"])}parse(n,s,r){switch(s){case"B":case"BB":case"BBB":return r.dayPeriod(n,{width:"abbreviated",context:"formatting"})||r.dayPeriod(n,{width:"narrow",context:"formatting"});case"BBBBB":return r.dayPeriod(n,{width:"narrow",context:"formatting"});case"BBBB":default:return r.dayPeriod(n,{width:"wide",context:"formatting"})||r.dayPeriod(n,{width:"abbreviated",context:"formatting"})||r.dayPeriod(n,{width:"narrow",context:"formatting"})}}set(n,s,r){return n.setHours($s(r),0,0,0),n}}class Vp extends Ke{constructor(){super(...arguments);be(this,"priority",70);be(this,"incompatibleTokens",["H","K","k","t","T"])}parse(n,s,r){switch(s){case"h":return ot(pt.hour12h,n);case"ho":return r.ordinalNumber(n,{unit:"hour"});default:return ct(s.length,n)}}validate(n,s){return s>=1&&s<=12}set(n,s,r){const l=n.getHours()>=12;return l&&r<12?n.setHours(r+12,0,0,0):!l&&r===12?n.setHours(0,0,0,0):n.setHours(r,0,0,0),n}}class Kp extends Ke{constructor(){super(...arguments);be(this,"priority",70);be(this,"incompatibleTokens",["a","b","h","K","k","t","T"])}parse(n,s,r){switch(s){case"H":return ot(pt.hour23h,n);case"Ho":return r.ordinalNumber(n,{unit:"hour"});default:return ct(s.length,n)}}validate(n,s){return s>=0&&s<=23}set(n,s,r){return n.setHours(r,0,0,0),n}}class zp extends Ke{constructor(){super(...arguments);be(this,"priority",70);be(this,"incompatibleTokens",["h","H","k","t","T"])}parse(n,s,r){switch(s){case"K":return ot(pt.hour11h,n);case"Ko":return r.ordinalNumber(n,{unit:"hour"});default:return ct(s.length,n)}}validate(n,s){return s>=0&&s<=11}set(n,s,r){return n.getHours()>=12&&r<12?n.setHours(r+12,0,0,0):n.setHours(r,0,0,0),n}}class Qp extends Ke{constructor(){super(...arguments);be(this,"priority",70);be(this,"incompatibleTokens",["a","b","h","H","K","t","T"])}parse(n,s,r){switch(s){case"k":return ot(pt.hour24h,n);case"ko":return r.ordinalNumber(n,{unit:"hour"});default:return ct(s.length,n)}}validate(n,s){return s>=1&&s<=24}set(n,s,r){const l=r<=24?r%24:r;return n.setHours(l,0,0,0),n}}class Xp extends Ke{constructor(){super(...arguments);be(this,"priority",60);be(this,"incompatibleTokens",["t","T"])}parse(n,s,r){switch(s){case"m":return ot(pt.minute,n);case"mo":return r.ordinalNumber(n,{unit:"minute"});default:return ct(s.length,n)}}validate(n,s){return s>=0&&s<=59}set(n,s,r){return n.setMinutes(r,0,0),n}}class Jp extends Ke{constructor(){super(...arguments);be(this,"priority",50);be(this,"incompatibleTokens",["t","T"])}parse(n,s,r){switch(s){case"s":return ot(pt.second,n);case"so":return r.ordinalNumber(n,{unit:"second"});default:return ct(s.length,n)}}validate(n,s){return s>=0&&s<=59}set(n,s,r){return n.setSeconds(r,0),n}}class Zp extends Ke{constructor(){super(...arguments);be(this,"priority",30);be(this,"incompatibleTokens",["t","T"])}parse(n,s){const r=l=>Math.trunc(l*Math.pow(10,-s.length+3));return mt(ct(s.length,n),r)}set(n,s,r){return n.setMilliseconds(r),n}}class em extends Ke{constructor(){super(...arguments);be(this,"priority",10);be(this,"incompatibleTokens",["t","T","x"])}parse(n,s){switch(s){case"X":return gn(xn.basicOptionalMinutes,n);case"XX":return gn(xn.basic,n);case"XXXX":return gn(xn.basicOptionalSeconds,n);case"XXXXX":return gn(xn.extendedOptionalSeconds,n);case"XXX":default:return gn(xn.extended,n)}}set(n,s,r){return s.timestampIsSet?n:Xe(n,n.getTime()-_a(n)-r)}}class tm extends Ke{constructor(){super(...arguments);be(this,"priority",10);be(this,"incompatibleTokens",["t","T","X"])}parse(n,s){switch(s){case"x":return gn(xn.basicOptionalMinutes,n);case"xx":return gn(xn.basic,n);case"xxxx":return gn(xn.basicOptionalSeconds,n);case"xxxxx":return gn(xn.extendedOptionalSeconds,n);case"xxx":default:return gn(xn.extended,n)}}set(n,s,r){return s.timestampIsSet?n:Xe(n,n.getTime()-_a(n)-r)}}class nm extends Ke{constructor(){super(...arguments);be(this,"priority",40);be(this,"incompatibleTokens","*")}parse(n){return Mi(n)}set(n,s,r){return[Xe(n,r*1e3),{timestampIsSet:!0}]}}class am extends Ke{constructor(){super(...arguments);be(this,"priority",20);be(this,"incompatibleTokens","*")}parse(n){return Mi(n)}set(n,s,r){return[Xe(n,r),{timestampIsSet:!0}]}}const sm={G:new Cp,y:new Sp,Y:new Ep,R:new Ip,u:new Tp,Q:new wp,q:new Dp,M:new vp,L:new kp,w:new Np,I:new Rp,d:new _p,D:new Mp,E:new Fp,e:new Bp,c:new Hp,i:new Wp,a:new Yp,b:new Up,B:new qp,h:new Vp,H:new Kp,K:new zp,k:new Qp,m:new Xp,s:new Jp,S:new Zp,X:new em,x:new tm,t:new nm,T:new am},rm=/[yYQqMLwIdDecihHKkms]o|(\w)\1*|''|'(''|[^'])+('|$)|./g,im=/P+p+|P+|p+|''|'(''|[^'])+('|$)|./g,om=/^'([^]*?)'?$/,lm=/''/g,cm=/\S/,dm=/[a-zA-Z]/;function um(t,a,n,s){var j,w,O,B,k,q,H,G;const r=gp(),l=(s==null?void 0:s.locale)??r.locale??Fs,c=(s==null?void 0:s.firstWeekContainsDate)??((w=(j=s==null?void 0:s.locale)==null?void 0:j.options)==null?void 0:w.firstWeekContainsDate)??r.firstWeekContainsDate??((B=(O=r.locale)==null?void 0:O.options)==null?void 0:B.firstWeekContainsDate)??1,g=(s==null?void 0:s.weekStartsOn)??((q=(k=s==null?void 0:s.locale)==null?void 0:k.options)==null?void 0:q.weekStartsOn)??r.weekStartsOn??((G=(H=r.locale)==null?void 0:H.options)==null?void 0:G.weekStartsOn)??0;if(a==="")return t===""?we(n):Xe(n,NaN);const m={firstWeekContainsDate:c,weekStartsOn:g,locale:l},E=[new yp],f=a.match(im).map(N=>{const L=N[0];if(L in ga){const M=ga[L];return M(N,l.formatLong)}return N}).join("").match(rm),T=[];for(let N of f){!(s!=null&&s.useAdditionalWeekYearTokens)&&Ri(N)&&js(N,a,t),!(s!=null&&s.useAdditionalDayOfYearTokens)&&Oi(N)&&js(N,a,t);const L=N[0],M=sm[L];if(M){const{incompatibleTokens:Y}=M;if(Array.isArray(Y)){const A=T.find(p=>Y.includes(p.token)||p.token===L);if(A)throw new RangeError(`The format string mustn't contain \`${A.fullToken}\` and \`${N}\` at the same time`)}else if(M.incompatibleTokens==="*"&&T.length>0)throw new RangeError(`The format string mustn't contain \`${N}\` and any other token at the same time`);T.push({token:L,fullToken:N});const U=M.run(t,N,l.match,m);if(!U)return Xe(n,NaN);E.push(U.setter),t=U.rest}else{if(L.match(dm))throw new RangeError("Format string contains an unescaped latin alphabet character `"+L+"`");if(N==="''"?N="'":L==="'"&&(N=pm(N)),t.indexOf(N)===0)t=t.slice(N.length);else return Xe(n,NaN)}}if(t.length>0&&cm.test(t))return Xe(n,NaN);const y=E.map(N=>N.priority).sort((N,L)=>L-N).filter((N,L,M)=>M.indexOf(N)===L).map(N=>E.filter(L=>L.priority===N).sort((L,M)=>M.subPriority-L.subPriority)).map(N=>N[0]);let D=we(n);if(isNaN(D.getTime()))return Xe(n,NaN);const S={};for(const N of y){if(!N.validate(D,m))return Xe(n,NaN);const L=N.set(D,S,m);Array.isArray(L)?(D=L[0],Object.assign(S,L[1])):D=L}return Xe(n,D)}function pm(t){return t.match(om)[1].replace(lm,"'")}function mm(t,a){const n=we(t);return n.setDate(a),n}function hm(t,a){const n=we(t);return n.setHours(a),n}function xm(t,a){const n=we(t);return n.setMinutes(a),n}function gm(t,a){const n=we(t),s=n.getFullYear(),r=n.getDate(),l=Xe(t,0);l.setFullYear(s,a,15),l.setHours(0,0,0,0);const c=Pi(l);return n.setMonth(a,Math.min(r,c)),n}function fm(t,a){const n=we(t);return n.setSeconds(a),n}function bm(t,a){const n=we(t);return n.setMilliseconds(a),n}function jm(t,a){const n=we(t);return isNaN(+n)?Xe(t,NaN):(n.setFullYear(a),n)}function ym(t){const a=we(t);return a.setDate(1),a.setHours(0,0,0,0),a}function Cm(t){const a=we(t),n=a.getMonth();return a.setFullYear(a.getFullYear(),n+1,0),a.setHours(23,59,59,999),a}function Sm(t,a){const n=+we(t),[s,r]=[+we(a.start),+we(a.end)].sort((l,c)=>l-c);return n>=s&&n<=r}const Em={y:{sectionType:"year",contentType:"digit",maxLength:4},yy:"year",yyy:{sectionType:"year",contentType:"digit",maxLength:4},yyyy:"year",M:{sectionType:"month",contentType:"digit",maxLength:2},MM:"month",MMMM:{sectionType:"month",contentType:"letter"},MMM:{sectionType:"month",contentType:"letter"},L:{sectionType:"month",contentType:"digit",maxLength:2},LL:"month",LLL:{sectionType:"month",contentType:"letter"},LLLL:{sectionType:"month",contentType:"letter"},d:{sectionType:"day",contentType:"digit",maxLength:2},dd:"day",do:{sectionType:"day",contentType:"digit-with-letter"},E:{sectionType:"weekDay",contentType:"letter"},EE:{sectionType:"weekDay",contentType:"letter"},EEE:{sectionType:"weekDay",contentType:"letter"},EEEE:{sectionType:"weekDay",contentType:"letter"},EEEEE:{sectionType:"weekDay",contentType:"letter"},i:{sectionType:"weekDay",contentType:"digit",maxLength:1},ii:"weekDay",iii:{sectionType:"weekDay",contentType:"letter"},iiii:{sectionType:"weekDay",contentType:"letter"},e:{sectionType:"weekDay",contentType:"digit",maxLength:1},ee:"weekDay",eee:{sectionType:"weekDay",contentType:"letter"},eeee:{sectionType:"weekDay",contentType:"letter"},eeeee:{sectionType:"weekDay",contentType:"letter"},eeeeee:{sectionType:"weekDay",contentType:"letter"},c:{sectionType:"weekDay",contentType:"digit",maxLength:1},cc:"weekDay",ccc:{sectionType:"weekDay",contentType:"letter"},cccc:{sectionType:"weekDay",contentType:"letter"},ccccc:{sectionType:"weekDay",contentType:"letter"},cccccc:{sectionType:"weekDay",contentType:"letter"},a:"meridiem",aa:"meridiem",aaa:"meridiem",H:{sectionType:"hours",contentType:"digit",maxLength:2},HH:"hours",h:{sectionType:"hours",contentType:"digit",maxLength:2},hh:"hours",m:{sectionType:"minutes",contentType:"digit",maxLength:2},mm:"minutes",s:{sectionType:"seconds",contentType:"digit",maxLength:2},ss:"seconds"},Im={year:"yyyy",month:"LLLL",monthShort:"MMM",dayOfMonth:"d",dayOfMonthFull:"do",weekday:"EEEE",weekdayShort:"EEEEEE",hours24h:"HH",hours12h:"hh",meridiem:"aa",minutes:"mm",seconds:"ss",fullDate:"PP",keyboardDate:"P",shortDate:"MMM d",normalDate:"d MMMM",normalDateWithWeekday:"EEE, MMM d",fullTime:"p",fullTime12h:"hh:mm aa",fullTime24h:"HH:mm",keyboardDateTime:"P p",keyboardDateTime12h:"P hh:mm aa",keyboardDateTime24h:"P HH:mm"};class Tm{constructor(a){this.isMUIAdapter=!0,this.isTimezoneCompatible=!1,this.lib=void 0,this.locale=void 0,this.formats=void 0,this.formatTokenMap=Em,this.escapedCharacters={start:"'",end:"'"},this.longFormatters=void 0,this.date=c=>typeof c>"u"?new Date:c===null?null:new Date(c),this.getInvalidDate=()=>new Date("Invalid Date"),this.getTimezone=()=>"default",this.setTimezone=c=>c,this.toJsDate=c=>c,this.getCurrentLocaleCode=()=>{var c;return((c=this.locale)==null?void 0:c.code)||"en-US"},this.is12HourCycleInCurrentLocale=()=>this.locale?/a/.test(this.locale.formatLong.time({width:"short"})):!0,this.expandFormat=c=>{const g=/P+p+|P+|p+|''|'(''|[^'])+('|$)|./g;return c.match(g).map(m=>{const E=m[0];if(E==="p"||E==="P"){const f=this.longFormatters[E];return f(m,this.locale.formatLong)}return m}).join("")},this.formatNumber=c=>c,this.getDayOfWeek=c=>c.getDay()+1;const{locale:n,formats:s,longFormatters:r,lib:l}=a;this.locale=n,this.formats=Eo({},Im,s),this.longFormatters=r,this.lib=l||"date-fns"}}class wm extends Tm{constructor({locale:a,formats:n}={}){if(typeof ha!="function")throw new Error(["MUI: The `date-fns` package v2.x is not compatible with this adapter.","Please, install v3.x of the package or use the `AdapterDateFns` instead."].join(`
`));if(!ga)throw new Error("MUI: The minimum supported `date-fns` package version compatible with this adapter is `3.2.x`.");super({locale:a??Fs,formats:n,longFormatters:ga}),this.parse=(s,r)=>s===""?null:um(s,r,new Date,{locale:this.locale}),this.isValid=s=>s==null?!1:Li(s),this.format=(s,r)=>this.formatByString(s,this.formats[r]),this.formatByString=(s,r)=>np(s,r,{locale:this.locale}),this.isEqual=(s,r)=>s===null&&r===null?!0:s===null||r===null?!1:up(s,r),this.isSameYear=(s,r)=>mp(s,r),this.isSameMonth=(s,r)=>hp(s,r),this.isSameDay=(s,r)=>pp(s,r),this.isSameHour=(s,r)=>xp(s,r),this.isAfter=(s,r)=>cs(s,r),this.isAfterYear=(s,r)=>cs(s,rr(r)),this.isAfterDay=(s,r)=>cs(s,sr(r)),this.isBefore=(s,r)=>ds(s,r),this.isBeforeYear=(s,r)=>ds(s,this.startOfYear(r)),this.isBeforeDay=(s,r)=>ds(s,this.startOfDay(r)),this.isWithinRange=(s,[r,l])=>Sm(s,{start:r,end:l}),this.startOfYear=s=>vi(s),this.startOfMonth=s=>ym(s),this.startOfWeek=s=>In(s,{locale:this.locale}),this.startOfDay=s=>xa(s),this.endOfYear=s=>rr(s),this.endOfMonth=s=>Cm(s),this.endOfWeek=s=>lu(s,{locale:this.locale}),this.endOfDay=s=>sr(s),this.addYears=(s,r)=>iu(s,r),this.addMonths=(s,r)=>Di(s,r),this.addWeeks=(s,r)=>ru(s,r),this.addDays=(s,r)=>ha(s,r),this.addHours=(s,r)=>su(s,r),this.addMinutes=(s,r)=>au(s,r),this.addSeconds=(s,r)=>eu(s,r),this.getYear=s=>dp(s),this.getMonth=s=>op(s),this.getDate=s=>sp(s),this.getHours=s=>rp(s),this.getMinutes=s=>ip(s),this.getSeconds=s=>lp(s),this.getMilliseconds=s=>cp(s),this.setYear=(s,r)=>jm(s,r),this.setMonth=(s,r)=>gm(s,r),this.setDate=(s,r)=>mm(s,r),this.setHours=(s,r)=>hm(s,r),this.setMinutes=(s,r)=>xm(s,r),this.setSeconds=(s,r)=>fm(s,r),this.setMilliseconds=(s,r)=>bm(s,r),this.getDaysInMonth=s=>Pi(s),this.getWeekArray=s=>{const r=this.startOfWeek(this.startOfMonth(s)),l=this.endOfWeek(this.endOfMonth(s));let c=0,g=r;const m=[];for(;this.isBefore(g,l);){const E=Math.floor(c/7);m[E]=m[E]||[],m[E].push(g),g=this.addDays(g,1),c+=1}return m},this.getWeekNumber=s=>Hs(s,{locale:this.locale}),this.getYearRange=([s,r])=>{const l=this.startOfYear(s),c=this.endOfYear(r),g=[];let m=l;for(;this.isBefore(m,c);)g.push(m),m=this.addYears(m,1);return g}}}function Dm({name:t,format:a="yyyy/MM/dd",disabled:n=!1,minDate:s,onChange:r}){const{control:l}=$e(),c=i.useMemo(()=>{if(s)return typeof s=="number"?new Date(s):s},[s]);return e.jsx(et,{control:l,name:t,render:({field:g,fieldState:{error:m}})=>e.jsx(Cl,{dateAdapter:wm,children:e.jsxs(o,{children:[e.jsx(Sl,{...g,format:a,disabled:n,minDate:c,views:a.includes("HH")?["year","month","day","hours"]:["year","month","day"],sx:{width:"100%","& .MuiOutlinedInput-root":{maxHeight:"38px",borderRadius:"8px",bgcolor:$.WHITE}},onChange:E=>{g.onChange(E),r==null||r(E)}}),!!m&&e.jsx(ht,{sx:{textAlign:"center",color:$.CANCEL_RED},children:m.message})]})})})}const Gt=({label:t,labelSx:a,stackSx:n,variant:s,alertText:r,...l})=>e.jsxs(o,{flexDirection:"row",sx:{gap:1,width:"100%",alignItems:"flex-start",...n},children:[r?e.jsx(Sn,{labelTitle:t,alertText:r}):e.jsx(he,{sx:a,children:t}),s==="control"?e.jsx(Dm,{...l}):e.jsx(e.Fragment,{})]});function vm(t){return rt({mutationFn:zo,onSuccess:t,onError:a=>{const n=a.message.split("Details: ")[1];console.log(n)}})}function km(t){return rt({mutationFn:Qo,onSuccess:a=>{if(a)t(a.id);else throw new Error("usePutUpdateEvent error")}})}function Am(t){const a=jt(t);return Ue({queryKey:[Rn.EVENT_SEARCH,a],queryFn:({signal:n})=>el(t,n),refetchOnWindowFocus:!1})}function Nm(t){return Ue({queryKey:[Rn.EVENT_ID(t.id)],queryFn:({signal:a})=>Ko(t.id,a),enabled:!!t.id,refetchOnWindowFocus:!1})}function Om(t){return rt({mutationFn:Xo,onSuccess:t})}function Rm(){return Ue({queryKey:[Rn.EVENT_CONDITION_OPTION],queryFn:({signal:t})=>tl(t),refetchOnWindowFocus:!1})}function Lm(t){return Ue({queryKey:[Rn.EVENT_RANKING,t],queryFn:({signal:a})=>nl(t,a),refetchOnWindowFocus:!1})}function ta(){return Ue({queryKey:[Rn.EVENT_PET],queryFn:({signal:t})=>al(t),refetchOnWindowFocus:!1})}function Pm(t){return Ue({queryKey:[Rn.EVENT_STATISTICS_ID(t)],queryFn:()=>Jo(t)})}function _m(){return rt({mutationFn:t=>Zo(t)})}const Bt={flex:1},Mm=({petOptionData:t,onClick:a})=>{const{setAlertOpen:n}=_e(),s=i.useMemo(()=>t?[{label:"無",value:-1},...t.map(O=>({label:O.name,value:O.id}))]:Pr,[t]),[r,l]=i.useState(!1),[c,g]=i.useState(""),[m,E]=i.useState({from:"",to:""}),[f,T]=i.useState({id:"",petId:0,petName:"",point:"",energy:"",aiChip:""}),y=O=>{g(O.target.value)},D=(O,B)=>{E(k=>({...k,[B]:O.target.value}))},S=(O,B)=>{var k;if(T(q=>({...q,[B]:O.target.value})),B==="petId"){const q=(k=s.find(H=>H.value===O.target.value))==null?void 0:k.label;T(H=>({...H,petName:q}))}},j=()=>{g(""),E({from:"",to:""}),l(!r)},w=()=>{if(r){if(!m.from||!m.to){n({open:!0,message:"請輸入名次區間"});return}}else if(!c){n({open:!0,message:"請輸入名次"});return}const O={...f,rankType:r?"range":"simple",...!r&&{rankNumber:c},...r&&{from:m.from,to:m.to},id:r?`${m.from}~${m.to}`:c};T({id:"",petId:0,petName:"",point:"",energy:"",aiChip:""}),g(""),E({from:"",to:""}),a(O)};return e.jsxs(o,{mt:2,justifyContent:"center",children:[e.jsxs(o,{flexDirection:"row",children:[e.jsx(he,{sx:{width:{lg:"20%",xs:"100%"}},children:"名次是否為區間"}),e.jsx(On,{checked:r,onChange:j})]}),e.jsxs(o,{mt:2,gap:2,flexDirection:"row",alignItems:"center",flexWrap:"wrap",children:[e.jsx(o,{flex:2,minWidth:"400px",children:r?e.jsxs(o,{flexDirection:"row",gap:1,alignItems:"center",children:[e.jsx(he,{sx:Bt,children:"名次從"}),e.jsx(Ut,{sx:Bt,onChange:O=>D(O,"from"),value:m.from}),e.jsx(he,{sx:Bt,children:"~"}),e.jsx(Ut,{sx:Bt,onChange:O=>D(O,"to"),value:m.to})]}):e.jsxs(o,{flexDirection:"row",gap:1,children:[e.jsx(he,{sx:Bt,children:"名次"}),e.jsx(Ut,{sx:Bt,onChange:y,value:c})]})}),e.jsxs(o,{gap:1,flexDirection:"row",alignItems:"center",flex:1,minWidth:"250px",children:[e.jsx(he,{sx:Bt,children:"能量"}),e.jsx(Ut,{sx:Bt,onChange:O=>S(O,"energy"),value:f.energy,type:"number"})]}),e.jsxs(o,{gap:1,flexDirection:"row",alignItems:"center",flex:1,minWidth:"250px",children:[e.jsx(he,{sx:Bt,children:"積分"}),e.jsx(Ut,{sx:Bt,onChange:O=>S(O,"point"),value:f.point,type:"number"})]}),e.jsxs(o,{gap:1,flexDirection:"row",alignItems:"center",flex:1,minWidth:"250px",children:[e.jsx(he,{sx:Bt,children:"AI晶片"}),e.jsx(Ut,{sx:Bt,onChange:O=>S(O,"aiChip"),value:f.aiChip,type:"number"})]}),e.jsxs(o,{gap:1,flexDirection:"row",alignItems:"center",flex:1,minWidth:"300px",children:[e.jsx(he,{sx:Bt,children:"戰寵"}),e.jsx(Et,{options:s,value:f.petId||-1,onChange:O=>S(O,"petId")})]}),e.jsx(v,{label:"新增名次",fullWidth:!0,sx:Bt,onClick:w})]})]})},Fm=i.memo(({award:t})=>{const a=n=>n.rankType==="simple"?e.jsx(he,{width:"100%",children:n.rankNumber}):e.jsx(he,{width:"100%",children:`${n.from} ~ ${n.to}`});return e.jsxs(o,{flexDirection:"row",alignItems:"center",width:"100%",gap:3,children:[e.jsx(o,{flex:1,children:a(t)}),e.jsxs(o,{flex:2,flexDirection:"row",alignItems:"center",gap:2,children:[e.jsx(he,{children:"能量"}),e.jsx(Ut,{value:t.energy,disabled:!0})]}),e.jsxs(o,{flex:2,flexDirection:"row",alignItems:"center",gap:2,children:[e.jsx(he,{children:"積分"}),e.jsx(Ut,{value:t.point,disabled:!0})]}),e.jsxs(o,{flex:2,flexDirection:"row",alignItems:"center",gap:2,children:[e.jsx(he,{children:"AI晶片"}),e.jsx(Ut,{value:t.aiChip,disabled:!0})]}),e.jsxs(o,{flex:2,flexDirection:"row",alignItems:"center",gap:2,children:[e.jsx(he,{children:"戰寵"}),e.jsx(Ut,{value:t.petName||"無",disabled:!0})]})]})}),Bm=({onChange:t,award:a})=>{var y;const{data:n}=Rm(),[s,r]=i.useState(0),[l,c]=i.useState(""),[g,m]=i.useState(""),E=(n==null?void 0:n.map(D=>({label:D.variableName,value:D.conditionVariable})))||[],f=D=>{var j;if(!n)return;r(D.target.value);const S=(j=n.find(w=>w.conditionVariable===D.target.value))==null?void 0:j.relationalOperator;c(S||""),t({...a,awardTitle:D.target.value,symbols:S||""})},T=D=>{m(D.target.value),t({...a,inputValue:D.target.value})};return i.useEffect(()=>{var D;r(a.awardTitle),c(((D=n==null?void 0:n.find(S=>S.conditionVariable===a.awardTitle))==null?void 0:D.relationalOperator)||""),m(a.inputValue)},[a]),e.jsxs(i.Fragment,{children:[e.jsx(Et,{value:s,onChange:f,options:[...Pr,...E],sx:{textAlign:"center",flex:1}}),e.jsx(Ut,{disabled:!0,value:l,sx:{flex:1,"& .MuiInputBase-input":{padding:"0.6rem",textAlign:"center"}}}),e.jsx(Ut,{onChange:T,value:g,sx:{flex:1,"& .MuiInputBase-input":{padding:"0.6rem"}}}),e.jsx(z,{variant:"h6",sx:{textAlign:"center"},children:((y=n==null?void 0:n.find(D=>D.conditionVariable===a.awardTitle))==null?void 0:y.unit)??""})]})},Hi=({mode:t,awardList:a,setAwardList:n,contestAwardList:s,setContestAwardList:r,petOptionData:l})=>{const{setAlertOpen:c}=_e(),[g,m]=i.useState([]),E=i.useCallback(()=>{n(j=>[...j,{awardTitle:"",symbols:"",inputValue:"",id:a.length+1}])},[a,n]),f=i.useCallback(j=>{n(w=>w.map(O=>O.id===j.id?j:O))},[n]),T=i.useCallback(j=>{n(w=>w.filter(O=>O.id!==j.id))},[n]),y=i.useCallback(j=>{if(j.rankType==="simple"){if(g.includes(j.rankNumber))return!0;m(w=>[...w,j.rankNumber])}if(j.rankType==="range"){for(let w=Number(j.from);w<=Number(j.to);w++)if(g.includes(w.toString()))return!0;m(w=>[...w,...Array.from({length:Number(j.to)-Number(j.from)+1},(O,B)=>(Number(j.from)+B).toString())])}},[g]),D=i.useCallback(j=>{if(y(j)){c({open:!0,title:"錯誤",message:"該名次已存在"});return}r(w=>[...w,j].sort((B,k)=>B.rankType==="simple"&&k.rankType==="simple"?Number(B.rankNumber)-Number(k.rankNumber):B.rankType==="range"&&k.rankType==="range"?Number(B.from)-Number(k.from):B.rankType==="simple"&&k.rankType==="range"?Number(B.rankNumber)-Number(k.from):B.rankType==="range"&&k.rankType==="simple"?Number(B.from)-Number(k.rankNumber):0))},[y,c,r]),S=i.useCallback(j=>{r(w=>w.filter(O=>O.id!==j.id)),m(w=>w.filter(O=>{if(j.rankType==="simple")return O!==j.rankNumber;if(j.rankType==="range")return!Array.from({length:Number(j.to)-Number(j.from)+1},(B,k)=>(Number(j.from)+k).toString()).includes(O)}))},[r]);return e.jsx(o,{sx:{height:t==Je.CONTEST?"350px":"250px",overflowY:"auto",border:`2px solid ${$.DARK_GRAY}`,p:2,boxShadow:`1px 1px 3px 3px ${$.GRAY}`},children:t==Je.CONTEST?e.jsxs(i.Fragment,{children:[e.jsx(Mm,{onClick:D,petOptionData:l}),e.jsx(o,{mt:2,gap:2,children:s.map((j,w)=>e.jsxs(o,{flexDirection:"row",width:"100%",alignItems:"center",gap:2,mt:3,children:[e.jsx(Fm,{award:j}),e.jsx(v,{label:"-",btnColor:"CANCEL_RED",onClick:()=>S(j)})]},`${j.energy}_${w}`))})]}):e.jsxs(i.Fragment,{children:[e.jsx(v,{label:"新增條件",fullWidth:!0,onClick:E,disabled:a.length>=1}),e.jsx(o,{mt:2,gap:2,children:a.map(j=>e.jsxs(o,{flexDirection:"row",width:"100%",alignItems:"center",gap:2,children:[e.jsx(Bm,{onChange:f,award:j}),e.jsx(v,{label:"-",btnColor:"CANCEL_RED",onClick:()=>T(j)})]},j.id))})]})})};function $i(t){const a=jt(t);return Ue({queryKey:[vs.STAGE_SEARCH,a],queryFn:({signal:n})=>ll(t,n)})}function Hm(t){return Ue({queryKey:[vs.STAGE_ID(t.id)],queryFn:({signal:a})=>sl(t.id,a),enabled:!!t.id})}function $m(t){return rt({mutationFn:rl,onSuccess:a=>{a&&t()}})}function Gm(t){return rt({mutationFn:il,onSuccess:a=>{a&&t(a.id)}})}function Wm(t){return rt({mutationFn:({id:a,isPublish:n})=>ol(a,n),onSuccess:a=>{a&&t(a)}})}const Ym=({index:t,item:a})=>{var f,T,y;const{setAlertOpen:n}=_e(),{data:s,isError:r}=Ka({id:a.missionId}),{data:l,isError:c}=ii({id:a.enemyId}),g=(l==null?void 0:l.picId)??0;if(r||c)return n({open:!0,title:"錯誤",message:"取得任務或敵人資料失敗"}),null;const m=[{key:"任務名稱",value:(s==null?void 0:s.name)||"無"},{key:"主要學科",value:((f=s==null?void 0:s.mainSubject)==null?void 0:f.value)||"無"},{key:"次要學科",value:((T=s==null?void 0:s.keyCompetenceSet)==null?void 0:T.map(D=>D.value).join(", "))||"無"},{key:"課綱",value:(s==null?void 0:s.syllabus)||"無"},{key:"等級",value:(s==null?void 0:s.level)||"無"},{key:"地點",value:(s==null?void 0:s.area)||"無"},{key:"世紀",value:((y=s==null?void 0:s.century)==null?void 0:y.century)||"無"}],E=[{key:"名稱",value:(l==null?void 0:l.name)||"無"},{key:"HP",value:(l==null?void 0:l.hp)||"無"},{key:"攻擊力",value:(l==null?void 0:l.atk)||"無"},{key:"等級",value:(l==null?void 0:l.lv)||"無"}];return e.jsxs(o,{flex:1,p:4,sx:{border:"1px solid #aaa"},gap:3,children:[e.jsxs(z,{variant:"h5",children:["任務",t+1]}),e.jsxs(o,{direction:"row",flex:1,gap:3,alignItems:"center",children:[e.jsx(o,{flex:3,children:e.jsx(ws,{data:m,fontSize:20})}),e.jsx(o,{flex:1,children:e.jsx(di,{data:E,row:!1,sx:{width:"100%"},picId:g})})]})]})},Um=i.memo(Ym),qm=({stage:t,open:a,onClose:n})=>{var r;const s=qt({id:(t==null?void 0:t.picId)||0});return e.jsxs(zt,{open:a,fullScreen:!0,onClose:n,sx:{p:3},children:[e.jsx(v,{label:"關閉",sx:{position:"absolute",top:5,right:5,bgcolor:$.CANCEL_RED},onClick:n}),e.jsx(Qt,{sx:{textAlign:"center",fontSize:36},id:"customized-dialog-title",children:"關卡總覽"}),t?e.jsx(dn,{dividers:!0,children:e.jsxs(o,{gap:3,children:[e.jsxs(o,{direction:"row",textAlign:"center",gap:4,children:[e.jsxs(o,{gap:2,children:[e.jsxs(o,{direction:"row",textAlign:"center",gap:4,children:[e.jsx(he,{children:t.name}),e.jsxs(he,{children:["關卡碼: ",t.stageCode]})]}),e.jsx(Dt,{width:700,height:400,src:((r=s==null?void 0:s.data)==null?void 0:r.src)??""})]}),e.jsxs(o,{flex:1,gap:5.5,children:[e.jsxs(o,{direction:"row",children:[e.jsx(he,{flex:1,children:"所屬遊戲"}),e.jsx(he,{flex:2,sx:{bgcolor:"#fff"},children:t==null?void 0:t.game.name})]}),e.jsxs(o,{my:"auto",children:[e.jsx(he,{children:"說明文字"}),e.jsx(li,{value:t.description,sx:{border:"1px solid #aaa",width:"100%"},disabled:!0})]})]})]}),e.jsx(o,{gap:3,children:t.missionEnemySet.map((l,c)=>e.jsx(Um,{index:c,item:l},c))})]})}):e.jsx(Ua,{type:"card"})]})},Gi=i.memo(qm),Js=class Js{};Js.GAME_ALL="/game/all";let Fa=Js;async function Vm(t){try{return(await Ye.get(Fa.GAME_ALL,{signal:t})).data.data}catch(a){throw new Error(`getAllGame, ${a}`)}}function Ws(){return Ue({queryKey:[Fa.GAME_ALL],queryFn:({signal:t})=>Vm(t)})}const Wi=i.memo(({value:t,handleChange:a,isSchoolAndPass:n,range:s})=>{const{data:r}=Ws(),l=()=>r?vn.concat(r.map(g=>({label:g.name,value:g.id}))):[],c=i.useMemo(()=>n?Er:vn.concat(Io),[n]);return e.jsxs(i.Fragment,{children:[e.jsx(Ve,{label:"篇章",options:l(),value:t.gameId,onChange:a("gameId")}),e.jsx(Ve,{label:"狀態",options:s!=null?s?To:wo:c,value:t.flag,onChange:a("flag")})]})}),Yi=[{label:"關卡名稱",value:"stageName"},{label:"關卡碼",value:"stageCode"},{label:"任務名稱",value:"missionName"}],ys=Yi.map(t=>t.value),Km=t=>ys.includes(t),Ys=({open:t,closeFn:a,selectFn:n,deleteFn:s,stageList:r,range:l,missionCount:c})=>{const[g,m]=i.useState({gameId:0,page:0,flag:l?2:5,onlySelf:!1,missionCount:c||void 0}),E={...g,...cn},{userInfo:f}=xt(),{data:T,isSuccess:y,isLoading:D}=$i(E),[S,j]=i.useState({searchText:"",currentField:ys[0]}),[w,O]=i.useState(null),[B,k]=i.useState(!1),q=i.useMemo(()=>y&&!!T.content.length,[y,T]),H=i.useCallback(()=>{k(!0)},[]),G=i.useCallback(()=>{k(!1)},[]),N=i.useCallback(h=>{O(h),H()},[H]),L=h=>I=>{let P,F;if(typeof I=="string"||typeof I=="number"||typeof I=="boolean"?P=I:P=I.target.value,Km(h)){const u={};ys.forEach(_=>{_===h&&P!==void 0&&P!==null?u[_]=P:delete E[_]}),F={...E,...u}}else F={...E,[h]:P};h!=="page"&&(F.page=0),m(u=>({...u,...F,missionCount:u.missionCount}))},M=h=>{j(I=>({...I,searchText:h}))},Y=h=>{j(I=>({...I,currentField:h}))},U=h=>{L("onlySelf")(h)},A=()=>{const{currentField:h,searchText:I}=S;L(h)(I)},p=(h,I)=>{m(P=>({...P,page:I-1}))},x=[{title:"",dataField:"id",component:h=>r.every(I=>I.id!==h.id)?f?e.jsx(v,{label:"選擇",onClick:()=>n(h),disabled:!St(tt.ROLE_PERMISSIONS_PUBLISHED_EVENT)&&h.teacherData.name!==f.adlName}):e.jsx(e.Fragment,{}):e.jsx(v,{label:"刪除",onClick:()=>s(h.id),btnColor:"CANCEL_RED"})},{title:"關卡名稱",dataField:"name",width:"350px"},{title:"篇章",dataField:"game",width:"200px",component:h=>{var I;return e.jsx(z,{variant:"h5",children:((I=h.game)==null?void 0:I.name)??"無"})}},{title:"關卡碼",dataField:"stageCode",width:"120px"},{title:"任務名稱",dataField:"missionEnemySet",width:"300px",component:h=>e.jsx(z,{variant:"h5",children:h.missionEnemySet.length>0?h.missionEnemySet.map(I=>I.mission.name).join(","):"無"})},{title:"校名",dataField:"school",width:"300px",component:h=>e.jsx(z,{variant:"h5",children:h.school.schoolName})},{title:"命關者",dataField:"teacherData",width:"120px",component:h=>e.jsx(z,{variant:"h5",children:h.teacherData.name})},{title:"狀態",dataField:"flag",width:"150px",component:h=>e.jsx(z,{variant:"h5",children:Nn[h.flag-1].label})},{title:"編輯/檢視",dataField:"id",width:"150px",component:h=>e.jsx(v,{label:"檢視",onClick:()=>N(h),btnColor:"BTN_LATTE_GRAY"})}];return e.jsxs(i.Fragment,{children:[B&&w&&e.jsx(Gi,{stage:w,open:B,onClose:G}),e.jsxs(zt,{open:t,fullScreen:!0,onClose:a,sx:{p:4},PaperProps:{sx:{p:4}},children:[e.jsxs(Qt,{sx:{textAlign:"center",fontSize:36},id:"customized-dialog-title",children:["可選擇關卡列表",e.jsxs(o,{flexDirection:"row",gap:3,my:2,flexWrap:"wrap",children:[e.jsx(Wi,{handleChange:L,value:E,isSchoolAndPass:!0,range:l}),e.jsxs(o,{flexDirection:"row",gap:5,flexWrap:"wrap",justifyContent:{xs:"center",sm:"flex-start"},alignItems:"center",children:[e.jsx(vt,{check:g.onlySelf,value:S,options:Yi,selectOnChange:Y,inputOnChange:M,checkBoxOnChange:U,searchFuntion:A}),e.jsx(v,{label:"搜尋",onClick:A,btnColor:"BROWN"})]})]})]}),e.jsx(dn,{dividers:!0,children:e.jsx(o,{children:D?e.jsx(Ge,{}):e.jsx(o,{children:T&&e.jsx(lt,{isVisible:q,children:e.jsxs(o,{p:.5,alignItems:"center",gap:5,children:[e.jsx(Tt,{columns:x,rows:T.content}),e.jsx(bn,{count:T.totalPages,page:T.pageable.pageNumber+1,onChange:p,color:"primary"})]})},JSON.stringify(E))})})}),e.jsx(v,{label:"關閉",color:"error",sx:{position:"absolute",top:5,right:5},onClick:a})]})]})},zm=i.memo(({stage:t,handleDelete:a})=>e.jsxs(o,{flexDirection:"row",width:{md:"48%",xs:"40%"},alignItems:"center",gap:2,children:[e.jsx(he,{width:"100%",children:t.name}),e.jsx(v,{label:"-",btnColor:"CANCEL_RED",onClick:()=>a(t.id)})]})),Ui=({stageHandler:t,initValue:a,range:n})=>{const[s,r]=i.useState(!1),[l,c]=i.useState([]),g=()=>{r(!0)},m=T=>{c(y=>{const D=y.filter(S=>S.id!==T);return t(D.map(S=>S.id)),D})},E=T=>{c(y=>{const D=[...y,T];return t(D.map(S=>S.id)),D})},f=()=>{r(!1)};return i.useEffect(()=>{a&&a.length>0&&(c(a),t(a.map(T=>T.id)))},[a]),i.useEffect(()=>{c([]),t([])},[n]),i.useEffect(()=>{l&&l.length>0&&(c(l),t(l.map(T=>T.id)))},[s]),e.jsxs(o,{sx:{height:"250px",overflowY:"auto",border:`2px solid ${$.DARK_GRAY}`,p:2,boxShadow:`1px 1px 3px 3px ${$.GRAY}`,gap:3},children:[e.jsx(v,{label:"新增關卡",fullWidth:!0,onClick:g}),e.jsx(o,{flexDirection:"row",width:"100%",alignItems:"center",gap:2,flexWrap:"wrap",children:l.map(T=>e.jsx(zm,{stage:T,handleDelete:m},T.id))}),s&&e.jsx(Ys,{selectFn:E,closeFn:f,open:s,stageList:l,deleteFn:m,range:n})]})},Qm=[{label:"獎勵",value:"reward"},{label:"宣導",value:"propaganda"}],Xm=()=>{const t=Me(),{userInfo:a}=xt(),{setAlertOpen:n}=_e(),{setFlag:s}=at(),{mutate:r}=vm(h),{eventSelectedImage:l,setEventSelectedImage:c,setSelectedType:g}=Rt(),{reset:m,control:E,setValue:f,handleSubmit:T,formState:{errors:y}}=$e(),D=Be({control:E,name:"range"}),S=Be({control:E,name:"type"}),j=i.useRef(null),[w,O]=i.useState("reward"),[B,k]=i.useState([]),[q,H]=i.useState([]),[G,N]=i.useState(0),[L,M]=i.useState(!1),{data:Y}=ta(),{data:U}=as(),{data:A}=ns({mailType:S==Je.CONTEST?ft.CONTEST_EVENT_REWARD:ft.NORMAL_EVENT_REWARD}),p=R=>{const b=R.target.value;O(b),b==="propaganda"?f("type",Je.PROPAGATION):f("type",Je.NORMAL)},x=()=>a?a.schoolDtoList.map(R=>({label:R.schoolName,value:R.id})):[];function h(){n({open:!0,title:"創建提示",message:"創建活動成功"}),t("/edit/eventEdit")}const I=({startTime:R,endTime:b,...W})=>{if(!a)return;let le={...W};if(!W.range)if(W.type==Je.NORMAL){const ne=B.map(Q=>({variable:Q.awardTitle,relationalOperator:Q.symbols,argument:Number(Q.inputValue)}));le={...le,conditionSet:ne}}else if(W.type==Je.CONTEST){const ne=q.map(Q=>Q.rankType==="simple"?{point:Number(Q.point),energy:Number(Q.energy),from:Number(Q.rankNumber),to:Number(Q.rankNumber),...Q.petId&&{petId:Number(Q.petId)}}:{point:Number(Q.point),energy:Number(Q.energy),from:Number(Q.from),to:Number(Q.to),...Q.petId&&{petId:Number(Q.petId)}});le={...le,contestEventRewardSet:ne.flat(1/0)}}else{const{point:ne,energy:Q,...pe}=le;le={...pe}}r({...le,startTime:Ie(R).startOf("day").valueOf(),endTime:Ie(b).endOf("day").valueOf(),mailContent:se()})},P=R=>{R===Ct.DRAFT?(s(me.DRAFT),f("status",Ct.DRAFT)):(s(me.IN_SCHOOL),f("status",Ct.COMPLETE))},F=()=>St(tt.ROLE_PERMISSIONS_PUBLISHED_EVENT)?[{label:"校內",value:!0},{label:"全國",value:!1}]:[{label:"校內",value:!0}],u=R=>{n({open:!0,title:"提示",message:"按下確認表示您已經確認所編輯的活動內容文字與所上傳圖片沒有違反智慧財產權疑慮",onOk:()=>I(R)})},_=R=>{f("stageIds",R)},Z=()=>{c(null),f("picId",null,{shouldValidate:!0})},C=()=>e.jsxs(i.Fragment,{children:[e.jsxs(o,{gap:2,flexDirection:"row",alignItems:"flex-start",children:[e.jsx($t,{title:"活動圖片",name:"picId"}),(l==null?void 0:l.src)&&e.jsx(v,{label:"刪除",btnColor:"CANCEL_RED",onClick:Z})]}),(l==null?void 0:l.src)&&e.jsx(Dt,{styleType:"formImage",src:l.src})]}),V=R=>{if(j.current){let b;const W=/\$\{\{([^}]+)\}\}/g;b=R.replace(W,le=>`<button disabled style="color: #444;" contenteditable="false">${Qa(le)}</button>`),b=b.split(`
`).join("<br>"),j.current.innerHTML=b}};i.useEffect(()=>{D?(f("type",Je.CONTEST),O("reward"),f("stageIds",[])):f("type",Je.NORMAL)},[D]),i.useEffect(()=>{l&&f("picId",l.id,{shouldValidate:!0})},[l,f]),i.useEffect(()=>{j.current&&(j.current.innerHTML="")},[S]),i.useEffect(()=>{var R,b,W;A&&A.length>0&&!((R=j.current)!=null&&R.innerHTML)&&(N(((b=A.find(le=>le.isDefault))==null?void 0:b.id)||A[0].id),V(((W=A.find(le=>le.isDefault))==null?void 0:W.content)||A[0].content))},[A]),i.useEffect(()=>(m(xi),g("EVENT"),a&&(k([]),H([]),f("schoolId",a.schoolDtoList[0].id)),()=>{m(),k([]),H([]),c(null)}),[]);const se=()=>{if(!j.current)return"";const R=document.createElement("div");R.innerHTML=j.current.innerHTML;const b=R.getElementsByTagName("button");Array.from(b).forEach(le=>{var Q;const ne=document.createTextNode(le.innerText);(Q=le.parentNode)==null||Q.replaceChild(ne,le)});const W=R.innerHTML.replace(/<div[^>]*>/gi,"###NEWLINE###").replace(/<\/div>/gi,"").replace(/<br\s*\/?>/gi,"###NEWLINE###").replace(/&nbsp;/g," ").replace(/(<([^>]+)>)/gi,"").replace(/###NEWLINE###/g,`
`).replace(/\n\s*\n/g,`
`).trim();return JSON.stringify(W)},X=R=>{const b=window.getSelection();if(!b||!b.rangeCount)return;const W=b.getRangeAt(0),le=j.current;if(!le||!le.contains(W.commonAncestorContainer))return;const ne=document.createElement("button");ne.style.color="#444",ne.disabled=!0,ne.innerText=R,ne.setAttribute("contenteditable","false"),W.insertNode(ne),W.setStartAfter(ne),W.collapse(!0),b.removeAllRanges(),b.addRange(W)};return e.jsxs(it,{onSubmit:T(u),sx:{gap:5},children:[e.jsxs(o,{flexDirection:"row",justifyContent:"center",alignItems:"center",width:"100%",gap:3,children:[e.jsx(o,{flexDirection:"row",gap:3,flex:.3,children:e.jsx(La,{name:"range",options:F(),type:"ONE"})}),e.jsx(o,{flex:1})]}),e.jsxs(K,{container:!0,spacing:6,wrap:"wrap",children:[e.jsx(K,{item:!0,sm:12,lg:6,children:e.jsxs(o,{gap:1,children:[e.jsx(ie,{name:"name",label:"活動名稱",variant:"control",alertText:"字數限制：9字元 (必填)"}),e.jsx(je,{name:"schoolId",label:"學校",options:x(),type:"ONE",variant:"control",alertText:"必填"}),e.jsx(Gt,{name:"startTime",label:"開始時間",variant:"control"}),e.jsx(Gt,{name:"endTime",label:"結束時間",variant:"control"}),e.jsx(ie,{name:"syllabus",label:"課綱",variant:"control"}),D?null:e.jsxs(o,{my:2,gap:1,children:[e.jsx(Et,{options:Qm,value:w,onChange:p,sx:{width:"70%",textAlign:"center"}}),S==Je.NORMAL&&w!="propaganda"?e.jsxs(i.Fragment,{children:[e.jsx(ie,{name:"point",label:"積分",variant:"control",type:"number"}),e.jsx(ie,{name:"energy",label:"能量",variant:"control",type:"number"}),e.jsx(ie,{name:"aiChip",label:"AI晶片",variant:"control",type:"number"})]}):null]}),w=="reward"?e.jsx(et,{control:E,name:"stageIds",render:({field:R,fieldState:{error:b}})=>e.jsxs(o,{my:2,gap:1,...R,children:[e.jsxs(o,{flexDirection:"row",alignItems:"cemter",gap:6,children:[e.jsx(he,{children:"活動關卡設定"}),!!b&&e.jsx(ht,{sx:{textAlign:"center",color:$.CANCEL_RED,my:"auto",fontSize:"2rem"},children:b.message})]}),e.jsx(Ui,{stageHandler:_,range:D})]})}):null]})}),e.jsx(K,{item:!0,sm:12,lg:6,children:e.jsxs(o,{gap:2,children:[e.jsx(ze,{name:"description",label:"活動說明",rows:4,variant:"control"}),!D&&e.jsx(C,{}),e.jsxs(o,{my:2,gap:1,children:[e.jsx(he,{children:"活動外部資訊"}),e.jsxs(o,{flexDirection:"row",alignItems:"flex-start",gap:1,children:[e.jsx(ie,{name:"hyperlinkName",label:"連結名稱",variant:"control"}),e.jsx(ie,{name:"hyperlink",label:"連結",variant:"control"})]})]}),e.jsx(ze,{name:"note",label:"編輯者註解",rows:4,variant:"control"})]})})]}),D||w=="propaganda"?null:e.jsxs(o,{my:2,gap:1,width:"100%",children:[e.jsxs(o,{gap:1,flexDirection:"row",children:[e.jsx(he,{children:"領獎條件"}),e.jsx(o,{flex:1,children:e.jsx(La,{name:"type",options:_s,type:"ONE"})}),e.jsx(o,{flex:1})]}),e.jsx(Hi,{mode:S,awardList:B,petOptionData:Y||[],setAwardList:k,contestAwardList:q,setContestAwardList:H})]}),!D&&w!="propaganda"&&e.jsxs(o,{my:2,gap:1,width:"100%",children:[e.jsxs(o,{gap:1,flexDirection:"row",children:[e.jsx(he,{children:"獎勵信件模板"}),e.jsx(o,{flexDirection:"row",gap:1,children:A&&e.jsx(Et,{options:A.map(R=>({label:R.templateName,value:R.id})),value:G,onChange:R=>{var b;N(R.target.value),V(((b=A.find(W=>W.id==R.target.value))==null?void 0:b.content)||"")},sx:{width:"100%"}})})]}),e.jsx(o,{gap:1,flexDirection:"row",children:e.jsx(he,{children:"玩家信件呈現內容"})}),e.jsx(o,{gap:1,flexDirection:"row",alignItems:"flex-end",children:e.jsx("div",{ref:j,contentEditable:!0,style:{minHeight:"200px",border:"1px solid #ccc",padding:"8px",marginTop:"8px",width:"80%"}})}),e.jsxs(o,{direction:"row",spacing:1,justifyContent:"space-between",width:"80%",children:[U&&e.jsx(o,{direction:"row",spacing:1,children:U.map(R=>e.jsx(v,{label:R.name,onClick:()=>X(R.code),sx:{cursor:"pointer","&:hover":{backgroundColor:$.DARK_BLUE}}},R.code))}),e.jsx(v,{label:"儲存為新模板",btnColor:"GREEN",onClick:()=>M(!0)})]})]}),e.jsxs(o,{flexDirection:"row",gap:3,justifyContent:"end",children:[e.jsx(v,{label:"儲存草稿",type:"submit",sx:{alignSelf:"flex-end"},onClick:()=>P(Ct.DRAFT)}),D?e.jsx(v,{label:"校內發佈",type:"submit",btnColor:"BTN_LATTE_GRAY",sx:{alignSelf:"flex-end"},onClick:()=>P(Ct.COMPLETE)}):e.jsx(v,{label:"發佈全國活動",type:"submit",btnColor:"BTN_LATTE_GRAY",sx:{alignSelf:"flex-end"},onClick:()=>P(Ct.COMPLETE)})]}),e.jsx(ss,{request:{content:se(),mailType:S==Je.NORMAL?ft.NORMAL_EVENT_REWARD:ft.CONTEST_EVENT_REWARD},open:L,onClose:()=>M(!1),setSelectedMailTemplate:N})]})},Jm=Xm,Zm=i.memo(({value:t,handleChange:a})=>{const n=i.useMemo(()=>[...os,{label:"校內",value:"true"},{label:"全國",value:"false"}],[]),s=(c,g)=>{a(g)({target:{value:c}})},r=i.useMemo(()=>[...os,..._s],[]),l=i.useMemo(()=>[...os,...mi],[]);return e.jsxs(i.Fragment,{children:[e.jsx(Ve,{label:"範圍",options:n,value:t.range,onChange:a("range")}),e.jsx(Ve,{label:"類別",options:r,value:t.type,onChange:a("type")}),e.jsx(Ve,{label:"狀態",options:l,value:t.status,onChange:a("status")}),e.jsxs(o,{flexDirection:"row",alignItems:"center",gap:2,children:[e.jsx(es,{label:"活動時間",value:t.startTime,onChange:c=>s(c,"startTime")}),e.jsx(z,{variant:"h6",children:"至"}),e.jsx(an,{value:t.endTime,onChange:c=>s(c,"endTime")})]})]})}),eh=({eventDetail:t,open:a,onClose:n})=>{const{role:s}=xt(),[r,l]=i.useState(!1),{data:c,isSuccess:g,isLoading:m}=Lm(t.id),{data:E,isSuccess:f}=Pm(t.id),{mutate:T}=_m(),y=async()=>{l(!0);try{await T({eventId:t.id})}catch(j){console.error(j)}finally{l(!1)}},D=i.useMemo(()=>g&&!!c.ranks.length,[g,c]),S=[{title:"名次",dataField:"rankNum",width:"100px"},{title:"玩家暱稱",dataField:"nickName",width:"250px"},...s===tt.ROLE_ADMIN?[{title:"玩家姓名",dataField:"adlName",width:"250px",component:j=>e.jsx(z,{variant:"h5",children:j==null?void 0:j.adlName})}]:[],{title:"學校名稱",dataField:"schoolName",width:"400px"},{title:"活動積分",dataField:"totalPoints",width:"200px"},...t.isReward!=null?[{title:"獎勵",dataField:"point",width:"400px",component:j=>e.jsx(z,{variant:"h5",children:j.point||j.energy||j.petName?[j.point&&`積分：${j.point}`,j.energy&&`能量：${j.energy}`,j.petName&&`戰寵：${j.petName}`].filter(Boolean).join("、"):"-"})}]:[]];return e.jsxs(zt,{open:a,fullScreen:!0,onClose:n,sx:{p:3},children:[e.jsx(v,{label:"關閉",btnColor:"CANCEL_RED",sx:{position:"absolute",top:5,right:5},onClick:n}),e.jsx(Qt,{sx:{textAlign:"center",fontSize:36},id:"customized-dialog-title",children:`${t.name}-活動排行榜`}),e.jsxs(dn,{children:[e.jsxs(o,{gap:2,children:[f&&e.jsx(ke,{sx:{display:"flex",flexDirection:"row",justifyContent:"center",gap:4},children:[{label:"參與總人次",value:E==null?void 0:E.logCount},{label:"參與總人數",value:E==null?void 0:E.playerCount},{label:"參與總校數",value:E==null?void 0:E.schoolCount}].map(({label:j,value:w})=>e.jsxs(o,{sx:{p:2,border:"1px solid #ccc",borderRadius:2,minWidth:"fit-content",gap:1},children:[e.jsx(z,{sx:{color:$.DARK_GRAY,fontSize:"1.25rem",fontWeight:"500",letterSpacing:"4px"},children:j}),e.jsx(z,{sx:{fontSize:"2rem",fontWeight:"bold",textAlign:"center"},children:w})]}))}),e.jsx(v,{label:r?"匯出中...":"匯出排行榜",onClick:y,btnColor:"EXCEL",sx:{alignSelf:"flex-end"},disabled:r})]}),m?e.jsx(Ge,{}):e.jsx(o,{mt:1,mb:5,children:c&&e.jsx(lt,{isVisible:D,children:e.jsx(o,{p:.5,alignItems:"center",gap:5,children:e.jsx(Tt,{stickyHeader:!0,columns:S,rows:c.ranks})})})})]})]})},qi=[{label:"活動名稱",value:"name"},{label:"校名",value:"schoolName"},{label:"主辦人",value:"teacherName"},{label:"關卡名稱",value:"stageName"}],Ta=qi.map(t=>t.value),th=t=>Ta.includes(t),nh=()=>{const t=Me(),a=Wt(),n=yt(),{setAlertOpen:s}=_e(),{userInfo:r,permissions:l}=xt(),c=i.useMemo(()=>l&&l.includes("ROLE_PERMISSIONS_MODIFY_PUBLISHED"),[l]),g=i.useCallback(R=>!(R.teacherData.name===(r==null?void 0:r.adlName)||c)||!c&&[Ct.FINISHED,Ct.ONGOING].includes(R.status),[r==null?void 0:r.adlName,c]),m=i.useMemo(()=>{const R=new URLSearchParams(a.search),b=R.get("name"),W=R.get("time"),le=R.get("range");return{type:R.get("type")||"全選",status:R.get("status")||"全選",range:le&&le!=="false"||"全選",page:parseInt(R.get("page")||"0",10),startTime:W?parseInt(W,10):null,endTime:W?parseInt(W,10):null,onlySelf:R.get("onlySelf")==="true",...b&&{name:b},...cn}},[a.search]),E=i.useMemo(()=>{const R=Object.keys(m).find(b=>Ta.includes(b)&&m[b]!==void 0);return R?{searchText:m[R],currentField:R}:{searchText:"",currentField:Ta[0]}},[m]),[f,T]=i.useState(m),[y,D]=i.useState(E),[S,j]=i.useState(null),[w,O]=i.useState(!1),[B,k]=i.useState(!1),[q,H]=i.useState(),{data:G,isSuccess:N,isLoading:L}=Am(f),{mutate:M}=Om(x),Y=i.useMemo(()=>N&&!!G.content.length,[N,G]),U=i.useCallback(()=>{t("createEvent")},[t]),A=i.useCallback(R=>{t(`updateEvent/${R}`)},[t]),p=i.useCallback(R=>b=>{let W,le;if(typeof b=="number"||typeof b=="string"||typeof b=="boolean"?W=b:W=b.target.value,th(R)){const Q={};Ta.forEach(pe=>{pe===R&&W?Q[pe]=W:delete f[pe]}),le={...f,...Q}}else le={...f,[R]:W};R!=="page"&&(le.page=0);const ne=ut(ln(le));T(le),t(`?${ne}`)},[t,f]);function x(){const R=jt(f);n.invalidateQueries({queryKey:[Rn.EVENT_SEARCH,R]}),p("page")(0),s({open:!0,title:"提示",message:"刪除成功"})}const h=R=>{M(R)},I=R=>{s({open:!0,title:"提示",message:`確認要刪除活動: ${R.name}`,onOk:()=>h(R.id)})},P=i.useCallback((R,b)=>{p("page")(b-1),H(b)},[p]),F=i.useCallback(()=>{q&&T(R=>({...R,page:Number(q)-1}))},[q,T]),u=R=>{D(b=>({...b,searchText:R}))},_=R=>{D(b=>({...b,currentField:R}))},Z=R=>{p("onlySelf")(R)},C=i.useCallback(()=>{const{currentField:R,searchText:b}=y;p(R)(b),H(1)},[p,y]),V=()=>{O(!1),j(null)},se=R=>{O(!0),j(R)},X=[{title:"編輯/檢視",dataField:"id",width:"300px",component:R=>e.jsxs(o,{gap:2,flexDirection:"row",justifyContent:"center",children:[r&&e.jsx(v,{label:"編輯",onClick:()=>A(R.id),btnColor:"TAB_BLUE",disabled:g(R)}),r&&e.jsx(v,{label:"刪除",btnColor:"CANCEL_RED",onClick:()=>I(R),disabled:g(R)}),e.jsx(v,{label:"排行榜",onClick:()=>se(R),btnColor:"BTN_LATTE_GRAY",fullWidth:!0,disabled:R.type===Je.PROPAGATION})]})},{title:"獎勵是否發送",dataField:"id",width:"125px",component:R=>R.isReward!=null?e.jsx(z,{variant:"h5",children:R.isReward?"已發送":"未發送"}):e.jsx(z,{variant:"h5",children:"--"})},{title:"範圍",dataField:"range",width:"100px",component:R=>e.jsx(z,{variant:"h5",children:R.range?"校內":"全國"})},{title:"類別",dataField:"type",width:"100px",component:R=>{var b;return e.jsx(z,{variant:"h5",children:((b=Ed.find(W=>W.value==R.type))==null?void 0:b.label)??"無"})}},{title:"狀態",dataField:"status",width:"110px",component:R=>{var b;return e.jsx(z,{variant:"h5",children:((b=mi.find(W=>W.value==R.status))==null?void 0:b.label)??"無"})}},{title:"活動名稱",dataField:"name",width:"150px"},{title:"校名",dataField:"school",width:"250px",component:R=>e.jsx(z,{variant:"h5",children:R.school.schoolName})},{title:"主辦人",dataField:"teacherData",width:"150px",component:R=>e.jsx(z,{variant:"h5",children:R.teacherData.name})},{title:"活動時間",dataField:"startTime",width:"300px",component:R=>e.jsx(z,{variant:"h5",children:`${Ie(R.startTime).format("YYYY/MM/DD")} ~ ${Ie(R.endTime).format("YYYY/MM/DD")}`})},{title:"包含關卡",dataField:"startTime",width:"240px",component:R=>e.jsx(i.Fragment,{children:R.stageSet.length?R.stageSet.map((b,W)=>e.jsxs(z,{variant:"h5",children:[W+1,". ",b.name]})):e.jsx(z,{variant:"h5",children:"--"})})}];return e.jsxs(o,{flex:1,gap:5,children:[e.jsx(v,{label:"創建活動",onClick:U,sx:{ml:"auto"},btnColor:"BLUE"}),e.jsxs(o,{flexDirection:"row",gap:4,alignItems:"center",justifyContent:{xs:"center",sm:"flex-start"},flexWrap:"wrap",px:3,children:[e.jsx(Zm,{handleChange:p,value:f}),e.jsxs(o,{flexDirection:"row",gap:4,flexWrap:"wrap",justifyContent:{xs:"center",sm:"flex-start"},alignItems:"center",children:[e.jsx(vt,{check:f.onlySelf,value:y,options:qi,selectOnChange:_,inputOnChange:u,checkBoxOnChange:Z,searchFuntion:C}),e.jsx(v,{label:"搜尋",onClick:C,btnColor:"BROWN"}),e.jsx(v,{label:"匯出 Excel",onClick:()=>k(!0),btnColor:"EXCEL"})]})]}),L?e.jsx(Ge,{}):e.jsx(o,{children:G&&e.jsx(lt,{isVisible:Y,children:e.jsxs(o,{p:.5,alignItems:"center",gap:5,children:[e.jsx(Tt,{columns:X,rows:G.content}),e.jsx(Yt,{totalPages:G.totalPages,currentPage:G.pageable.pageNumber,inputPage:q??1,setInputPage:H,handlePageChange:P,handlePageSearch:F})]})},JSON.stringify(f))}),S&&e.jsx(eh,{open:w,eventDetail:S,onClose:V}),e.jsx(Xa,{open:B,setOpen:k,request:f,totalPages:(G==null?void 0:G.totalPages)||1,type:"EVENT"})]})},ah=nh,sh=()=>{const t=Lt(),a=Me(),{userInfo:n}=xt(),{setFlag:s}=at(),r=yt(),{setAlertOpen:l}=_e(),{data:c,isError:g,isLoading:m}=Nm({id:parseInt(t.id)}),{mutate:E}=km(se),{eventSelectedImage:f,setEventSelectedImage:T,setSelectedType:y}=Rt(),{reset:D,control:S,setValue:j,handleSubmit:w,formState:{errors:O}}=$e(),B=Be({control:S,name:"range"}),k=Be({control:S,name:"type"}),q=i.useRef(!0),H=i.useRef(null),[G,N]=i.useState([]),[L,M]=i.useState("reward"),[Y,U]=i.useState([]),[A,p]=i.useState([]),[x,h]=i.useState(0),[I,P]=i.useState(!1),{data:F}=ta(),{data:u}=as(),{data:_}=ns({mailType:k==Je.CONTEST?ft.CONTEST_EVENT_REWARD:ft.NORMAL_EVENT_REWARD}),Z=i.useMemo(()=>{const ue=Ie(),Se=Ie(c==null?void 0:c.startTime);return ue.isAfter(Se)},[c]),C=ue=>{const Se=ue.target.value;M(Se),Se==="propaganda"?j("type",Je.PROPAGATION):j("type",Je.NORMAL)},V=()=>n?n.schoolDtoList.map(ue=>({label:ue.schoolName,value:ue.id})):[];function se(ue){r.invalidateQueries({queryKey:[Rn.EVENT_ID(ue)]}),l({open:!0,title:"創建提示",message:"創建活動成功"}),a("/edit/eventEdit")}const X=({startTime:ue,endTime:Se,...Ae})=>{if(Ae.variant==="update"&&Ae.id){const{variant:Ee,...We}=Ae;let He={...We};if(!Ae.range)if(Ae.type==Je.NORMAL){const Fe=Y.map(J=>({variable:J.awardTitle,relationalOperator:J.symbols,argument:Number(J.inputValue)}));He={...He,conditionSet:Fe}}else if(Ae.type==Je.CONTEST){const Fe=A.map(J=>J.rankType==="simple"?{point:Number(J.point),energy:Number(J.energy),from:Number(J.rankNumber),to:Number(J.rankNumber),...J.petId&&{petId:Number(J.petId)}}:{point:Number(J.point),energy:Number(J.energy),from:Number(J.from),to:Number(J.to),...J.petId&&{petId:Number(J.petId)}});He={...He,contestEventRewardSet:Fe.flat(1/0)}}else{const{point:Fe,energy:J,...oe}=He;He={...oe}}E({...He,startTime:Ie(ue).startOf("day").valueOf(),endTime:Ie(Se).endOf("day").valueOf(),mailContent:ee()})}else l({open:!0,title:"編輯提示",message:"編輯活動缺少ID"})},R=ue=>{ue===Ct.DRAFT?(s(me.DRAFT),j("status",Ct.DRAFT)):(s(me.IN_SCHOOL),j("status",Ct.COMPLETE))},b=ue=>{l({open:!0,title:"提示",message:"按下確認表示您已經確認所編輯的活動內容文字與所上傳圖片沒有違反智慧財產權疑慮",onOk:()=>X(ue)})},W=()=>St(tt.ROLE_MANAGER)||St(tt.ROLE_ADMIN)?[{label:"校內",value:!0},{label:"全國",value:!1}]:[{label:"校內",value:!0}],le=[{label:"獎勵",value:"reward"},{label:"宣導",value:"propaganda"}];i.useEffect(()=>{f&&j("picId",f.id,{shouldValidate:!0})},[f,j]);const ne=ue=>{j("stageIds",ue,{shouldValidate:!0})};i.useEffect(()=>{q.current||(B?(j("type",Je.CONTEST),M("reward"),j("stageIds",[])):j("type",Je.NORMAL))},[B]),i.useEffect(()=>{H.current&&(H.current.innerHTML="")},[k]),i.useEffect(()=>{var ue;if(g&&(l({open:!0,title:"取得活動失敗"}),a("/edit/eventEdit")),c){const{contestEventRewardSet:Se,conditionSet:Ae,mailContent:Ee,type:We,...He}=c;We==Je.PROPAGATION&&M("propaganda");const Fe=setTimeout(()=>{H.current&&Ee&&pe(Ee,!0),N(c.stageSet)},0),J={...He,startTime:new Date(c.startTime),endTime:new Date(c.endTime)};return c.picId&&T({id:c.picId,src:c.imageSrc}),D({...J,variant:"update",type:We}),!c.range&&c.contestEventRewardSet&&(c.type==Je.NORMAL?(ue=c.conditionSet)==null||ue.forEach((oe,Ne)=>{U(te=>{var ge;return[...te,{id:Ne+1,awardTitle:oe.variable||"",symbols:oe.relationalOperator||"",inputValue:((ge=oe.argument)==null?void 0:ge.toString())||""}]})}):c.contestEventRewardSet.sort((oe,Ne)=>oe.from-Ne.from).forEach(oe=>{oe.from==oe.to?p(Ne=>{var te,ge,Oe,De,ae;return[...Ne,{id:(te=oe.from)==null?void 0:te.toString(),point:((ge=oe.point)==null?void 0:ge.toString())||"",energy:((Oe=oe.energy)==null?void 0:Oe.toString())||"",aiChip:((De=oe.aiChip)==null?void 0:De.toString())||"",rankType:"simple",rankNumber:oe.from.toString(),petId:oe.petId||void 0,petName:((ae=oe.pet)==null?void 0:ae.name)||""}]}):p(Ne=>{var te,ge,Oe,De;return[...Ne,{id:`${oe.from}~${oe.to}`,point:((te=oe.point)==null?void 0:te.toString())||"",energy:((ge=oe.energy)==null?void 0:ge.toString())||"",aiChip:((Oe=oe.aiChip)==null?void 0:Oe.toString())||"",rankType:"range",from:oe.from.toString(),to:oe.to.toString(),petId:oe.petId||void 0,petName:((De=oe.pet)==null?void 0:De.name)||""}]})})),()=>clearTimeout(Fe)}},[c]);const Q=()=>{T(null),j("picId",null,{shouldValidate:!0})},pe=(ue,Se=!1)=>{if(H.current){let Ae;const Ee=Se?JSON.parse(ue):ue,We=/\$\{\{([^}]+)\}\}/g;Ae=Ee.replace(We,He=>`<button disabled style="color: #444;" contenteditable="false">${Qa(He)}</button>`),Ae=Ae.split(`
`).join("<br>"),H.current.innerHTML=Ae}},ee=()=>{if(!H.current)return"";const ue=document.createElement("div");ue.innerHTML=H.current.innerHTML;const Se=ue.getElementsByTagName("button");Array.from(Se).forEach(Ee=>{var He;const We=document.createTextNode(Ee.innerText);(He=Ee.parentNode)==null||He.replaceChild(We,Ee)});const Ae=ue.innerHTML.replace(/<div[^>]*>/gi,"###NEWLINE###").replace(/<\/div>/gi,"").replace(/<br\s*\/?>/gi,"###NEWLINE###").replace(/&nbsp;/g," ").replace(/(<([^>]+)>)/gi,"").replace(/###NEWLINE###/g,`
`).replace(/\n\s*\n/g,`
`).trim();return JSON.stringify(Ae)},de=ue=>{const Se=window.getSelection();if(!Se||!Se.rangeCount)return;const Ae=Se.getRangeAt(0),Ee=H.current;if(!Ee||!Ee.contains(Ae.commonAncestorContainer))return;const We=document.createElement("button");We.style.color="#444",We.disabled=!0,We.innerText=ue,We.setAttribute("contenteditable","false"),Ae.insertNode(We),Ae.setStartAfter(We),Ae.collapse(!0),Se.removeAllRanges(),Se.addRange(Ae)},Ce=()=>e.jsxs(i.Fragment,{children:[e.jsxs(o,{gap:2,flexDirection:"row",alignItems:"flex-start",children:[e.jsx($t,{title:"活動圖片",name:"picId"}),(f==null?void 0:f.src)&&e.jsx(v,{label:"刪除",btnColor:"CANCEL_RED",onClick:Q})]}),(f==null?void 0:f.src)&&e.jsx(Dt,{styleType:"formImage",src:f.src})]});return i.useEffect(()=>(n&&(y("EVENT"),U([]),p([]),j("schoolId",n.schoolDtoList[0].id)),()=>{D(),T(null),U([]),p([])}),[]),e.jsx(o,{p:2,justifyContent:"center",alignItems:"center",width:"100%",children:m?e.jsx(Ge,{}):e.jsxs(it,{onSubmit:w(b),sx:{gap:5},children:[e.jsxs(o,{flexDirection:"row",justifyContent:"center",alignItems:"center",width:"100%",gap:3,children:[e.jsx(o,{flexDirection:"row",gap:3,flex:.3,children:e.jsx(La,{name:"range",options:W(),type:"ONE"})}),e.jsx(o,{flex:1})]}),e.jsxs(K,{container:!0,spacing:6,wrap:"wrap",children:[e.jsx(K,{item:!0,sm:12,lg:6,children:e.jsxs(o,{gap:1,children:[e.jsx(ie,{name:"name",label:"活動名稱",variant:"control",alertText:"字數限制：9字元 (必填)"}),e.jsx(je,{name:"schoolId",label:"學校",options:V(),type:"ONE",variant:"control",alertText:"必填"}),e.jsx(Gt,{name:"startTime",label:"開始時間",variant:"control",disabled:Z}),e.jsx(Gt,{name:"endTime",label:"結束時間",variant:"control",minDate:c==null?void 0:c.endTime}),e.jsx(ie,{name:"syllabus",label:"課綱",variant:"control"}),B?null:e.jsxs(o,{my:2,gap:1,children:[e.jsx(Et,{options:le,value:L,onChange:C,sx:{width:"70%",textAlign:"center"}}),k==Je.NORMAL&&L!="propaganda"?e.jsxs(i.Fragment,{children:[e.jsx(ie,{name:"point",label:"積分",variant:"control",type:"number"}),e.jsx(ie,{name:"energy",label:"能量",variant:"control",type:"number"}),e.jsx(ie,{name:"aiChip",label:"AI晶片",variant:"control",type:"number"})]}):null]}),L=="reward"?e.jsx(et,{control:S,name:"stageIds",render:({field:ue,fieldState:{error:Se}})=>e.jsxs(o,{my:2,gap:1,...ue,children:[e.jsxs(o,{flexDirection:"row",alignItems:"cemter",gap:6,children:[e.jsx(he,{children:"活動關卡設定"}),!!Se&&e.jsx(ht,{sx:{textAlign:"center",color:$.CANCEL_RED,my:"auto"},children:Se.message})]}),e.jsx(Ui,{stageHandler:ne,initValue:G,range:B})]})}):null]})}),e.jsx(K,{item:!0,sm:12,lg:6,children:e.jsxs(o,{gap:2,children:[e.jsx(ze,{name:"description",label:"活動說明",rows:4,variant:"control"}),!B&&e.jsx(Ce,{}),e.jsxs(o,{my:2,gap:1,children:[e.jsx(he,{children:"活動外部資訊"}),e.jsxs(o,{flexDirection:"row",alignItems:"flex-start",gap:1,children:[e.jsx(ie,{name:"hyperlinkName",label:"連結名稱",variant:"control"}),e.jsx(ie,{name:"hyperlink",label:"連結",variant:"control"})]})]}),e.jsx(ze,{name:"note",label:"編輯者註解",rows:4,variant:"control"})]})})]}),B||L=="propaganda"?null:e.jsxs(o,{my:2,gap:1,width:"100%",children:[e.jsxs(o,{gap:1,flexDirection:"row",children:[e.jsx(he,{children:"領獎條件"}),e.jsx(o,{flex:1,children:e.jsx(La,{name:"type",options:_s,type:"ONE"})}),e.jsx(o,{flex:1})]}),e.jsx(Hi,{mode:k,awardList:Y,setAwardList:U,petOptionData:F||[],contestAwardList:A,setContestAwardList:p})]}),!B&&L!="propaganda"&&e.jsxs(o,{my:2,gap:1,width:"100%",children:[e.jsxs(o,{gap:1,flexDirection:"row",children:[e.jsx(he,{children:"獎勵信件模板"}),e.jsx(o,{flexDirection:"row",gap:1,children:_&&e.jsx(Et,{options:[{templateName:"無",id:0},..._].map(ue=>({label:ue.templateName,value:ue.id})),value:x,onChange:ue=>{var Se;h(ue.target.value),pe(((Se=_.find(Ae=>Ae.id==ue.target.value))==null?void 0:Se.content)||"")},sx:{width:"100%"}})})]}),e.jsx(o,{gap:1,flexDirection:"row",children:e.jsx(he,{children:"玩家信件呈現內容"})}),e.jsx(o,{gap:1,flexDirection:"row",alignItems:"flex-end",children:e.jsx("div",{ref:H,contentEditable:!0,style:{minHeight:"200px",border:"1px solid #ccc",padding:"8px",marginTop:"8px",width:"80%"}})}),e.jsxs(o,{direction:"row",spacing:1,justifyContent:"space-between",width:"80%",children:[u&&e.jsx(o,{direction:"row",spacing:1,children:u.map(ue=>e.jsx(v,{label:ue.name,onClick:()=>de(ue.code),sx:{cursor:"pointer","&:hover":{backgroundColor:$.DARK_BLUE}}},ue.code))}),e.jsx(v,{label:"儲存為新模板",btnColor:"GREEN",onClick:()=>P(!0)})]})]}),e.jsxs(o,{flexDirection:"row",gap:3,justifyContent:"end",children:[(c==null?void 0:c.status)===Ct.DRAFT&&e.jsx(v,{label:"儲存草稿",type:"submit",sx:{alignSelf:"flex-end"},onClick:()=>R(Ct.DRAFT)}),B?e.jsx(v,{label:"校內發佈",type:"submit",btnColor:"BTN_LATTE_GRAY",sx:{alignSelf:"flex-end"},onClick:()=>R(Ct.COMPLETE)}):e.jsx(v,{label:"發佈全國活動",type:"submit",btnColor:"BTN_LATTE_GRAY",sx:{alignSelf:"flex-end"},onClick:()=>R(Ct.COMPLETE)})]}),e.jsx(ss,{request:{content:ee(),mailType:k==Je.NORMAL?ft.NORMAL_EVENT_REWARD:ft.CONTEST_EVENT_REWARD},open:I,onClose:()=>P(!1),setSelectedMailTemplate:h})]})})},rh=sh;function ih(){return e.jsx(kd,{children:e.jsxs(Pt,{children:[e.jsx(xe,{index:!0,element:e.jsx(ah,{})}),e.jsx(xe,{path:"/createEvent",element:e.jsx(Jm,{})}),e.jsx(xe,{path:"/updateEvent/:id",element:e.jsx(rh,{})}),e.jsx(xe,{path:"*",element:e.jsx(_t,{to:"/edit/eventEdit",replace:!0})})]})})}const oh=t=>d.intersection(d.object({subtitle:fn(t,1,"主旨必填",16,"主旨不可超過16字"),content:fn(t,1,"文字內容必填"),sentTime:d.date(),energy:d.union([d.number().optional(),d.null()]),point:d.union([d.number().optional(),d.null()]),aiChip:d.union([d.number().optional(),d.null()]),expBookFieldName:d.union([d.nativeEnum(ji).optional(),d.null()]),expBookCount:d.union([d.number().optional(),d.null()]),petId:d.union([d.number(),d.literal(-1)]),mailTargetName:fn(t,1,"傳送群組對象必填"),mailGroupDtoList:d.union([d.array(d.object({educationalSystemName:d.string().min(1),schoolName:d.union([d.string(),d.null()]),grade:d.array(d.number()).nullable(),gradeList:d.array(d.number()).nullable()})),d.null()]),playerIdList:d.array(d.object({playerDataId:d.number().min(1),nickName:d.string().min(1),adlName:d.string().min(1),schoolName:d.array(d.string()),adlUserId:d.string().min(1)})).optional(),flag:d.nativeEnum(En),type:d.literal("NORMAL")}),d.discriminatedUnion("variant",[d.object({variant:d.literal("create")}),d.object({variant:d.literal("update"),id:d.number().min(1)})])),Ba={variant:"create",subtitle:"",content:"",sentTime:new Date,mailTargetName:Te.ALL,flag:En.DRAFT,energy:null,point:null,aiChip:null,petId:-1,expBookFieldName:null,expBookCount:null,mailGroupDtoList:[],playerIdList:[],type:"NORMAL"},lh=({children:t})=>{const{flag:a}=at(),n=oh(a),s=sn({mode:"all",resolver:on(n),defaultValues:Ba});return e.jsxs(rn,{...s,children:[t,!1]})},ch=lh;function Xn(t,a){const[n,s]=i.useState(t);return i.useEffect(()=>{const r=setTimeout(()=>{s(t)},a);return()=>{clearTimeout(r)}},[t,a]),n}const ur=["高中","國中","國小"],dh=["全體","指定群組","指定玩家"],uh=()=>{const t=Me(),{setAlertOpen:a}=_e(),{setFlag:n,flag:s}=at(),{reset:r,control:l,setValue:c,handleSubmit:g}=$e(),m=Be({control:l,name:"mailTargetName"}),E=Be({control:l,name:"playerIdList"}),f=Be({control:l,name:"petId"}),T=Be({control:l,name:"content"}),y=Be({control:l,name:"expBookFieldName"}),[D,S]=i.useState(""),[j,w]=i.useState(""),[O,B]=i.useState(""),[k,q]=i.useState(0),[H,G]=i.useState(0),[N,L]=i.useState(!1),[M,Y]=i.useState(ur.reduce((J,oe)=>({...J,[oe]:!1}),{})),[U,A]=i.useState({educationalSystemName:"高中",schoolName:"",page:0,size:15}),[p,x]=i.useState({schoolName:"",nickName:"",page:0,size:20}),h=Xn(D,350),I=Xn(j,350),P=Xn(O,350),{data:F,isSuccess:u}=Ci(m,{...U,schoolName:h}),{data:_,isSuccess:Z}=Si(m,{...p,nickName:P,schoolName:I}),{data:C}=ns({mailType:ft.NORMAL}),V=i.useMemo(()=>u&&!!F.content.length,[u,F]),se=i.useMemo(()=>Z&&!!_.content.length,[Z,_]),{data:X}=ta(),{mutate:R}=Ud(Ae,Ee),b=i.useMemo(()=>f?X==null?void 0:X.find(J=>J.id===f):null,[f,X]),{fields:W,append:le,remove:ne}=It({control:l,name:"mailGroupDtoList"}),Q=(J,oe)=>{A(Ne=>({...Ne,page:oe-1}))},pe=(J,oe)=>{x(Ne=>({...Ne,page:oe-1}))},ee=J=>{J?c("expBookFieldName",J):(c("expBookFieldName",null),c("expBookCount",null))},de=J=>{let oe;const Ne=Ie(J.sentTime).format("YYYY-MM-DDTHH")+":"+k.toString().padStart(2,"0")+":00.000+08:00",te={energy:J.energy?Number(J.energy):null,point:J.point?Number(J.point):null},ge={expBookFieldName:J.expBookFieldName??null,expBookCount:J.expBookCount??null};if(J.mailTargetName===Te.ALL){const{mailGroupDtoList:Oe,playerIdList:De,variant:ae,...ce}=J;oe={...ce,sentTime:Ne,...te,...ge}}else if(J.mailTargetName===Te.GROUP){const{playerIdList:Oe,mailGroupDtoList:De,variant:ae,expBookFieldName:ce,expBookCount:ye,...Re}=J;if(!De){a({open:!0,title:"提示",message:"請選擇學校"});return}const kt=De.map(({educationalSystemName:At,schoolName:bt,grade:nt})=>({educationalSystemName:At,schoolName:bt,grade:!nt||nt&&nt.includes(0)?null:nt})).flatMap(({educationalSystemName:At,schoolName:bt,grade:nt})=>nt?nt.map(st=>({educationalSystemName:At,schoolName:bt,grade:st})):[{educationalSystemName:At,schoolName:bt,grade:null}]);oe={...Re,mailGroupDtoList:kt.flat(),sentTime:Ne,...te,...ge}}else{const{mailGroupDtoList:Oe,playerIdList:De,variant:ae,...ce}=J;oe={...ce,playerIdList:De==null?void 0:De.map(ye=>ye.playerDataId),sentTime:Ne,...te,...ge}}R({...oe,petId:oe.petId&&oe.petId>0?oe.petId:null})},Ce=J=>{a({open:!0,title:"提示",message:s===me.DRAFT?`信件將會儲存為草稿
請確認是否要送出`:`信件送出即時生效
請確認是否要送出`,onOk:()=>de(J)})},ue=J=>{J.schoolName?W.some(oe=>oe.schoolName===J.schoolName)?ne(W.findIndex(oe=>oe.schoolName===J.schoolName)):le({educationalSystemName:U.educationalSystemName,schoolName:J.schoolName,grade:[0],gradeList:J.gradeList}):Y(oe=>{const Ne=M[U.educationalSystemName];return Ne?ne(W.findIndex(te=>!te.schoolName&&te.educationalSystemName==U.educationalSystemName)):(le({educationalSystemName:U.educationalSystemName,schoolName:"",grade:null,gradeList:null}),W.forEach(te=>{te.educationalSystemName==U.educationalSystemName&&ne(W.findIndex(ge=>ge.educationalSystemName==U.educationalSystemName))})),{...oe,[U.educationalSystemName]:!Ne}})},Se=J=>{J===me.DRAFT?(n(me.DRAFT),c("flag",En.DRAFT)):(n(me.PASS),c("flag",En.UNPUBLISH))};function Ae(){a({open:!0,title:"提示",message:"信件創建成功"}),t("/edit/mailEdit")}function Ee(J){a({open:!0,title:"信件創建失敗",message:J})}i.useEffect(()=>{var J;C&&C.length>0&&!H&&(G(((J=C.find(oe=>oe.isDefault))==null?void 0:J.id)||C[0].id),setTimeout(()=>{var oe;c("content",((oe=C.find(Ne=>Ne.isDefault))==null?void 0:oe.content)||C[0].content)},100))},[C]),i.useEffect(()=>(r(Ba),()=>{r()}),[]);const We=({index:J})=>{const oe=te=>{ne(te),M[W[te].educationalSystemName]&&Y(ge=>({...ge,[W[te].educationalSystemName]:!M[W[te].educationalSystemName]}))},Ne=i.useMemo(()=>{var te;return((te=W[J].gradeList)==null?void 0:te.map(ge=>({label:ge.toString(),value:ge})))||[]},[J]);return e.jsxs(Xt,{sx:{padding:"1.5rem",border:"1px solid #ccc",borderRadius:"1rem",minWidth:"525px",gap:2,display:"flex",flexDirection:"column"},children:[e.jsx(ie,{name:`mailGroupDtoList.${J}.educationalSystemName`,label:"學制",variant:"control",disabled:!0}),e.jsx(ie,{name:`mailGroupDtoList.${J}.schoolName`,label:"學校",variant:"control",disabled:!0}),W[J].schoolName&&e.jsx(je,{name:`mailGroupDtoList.${J}.grade`,label:"年級",options:Ne,type:"ALL",variant:"control",multiple:!0}),e.jsx(v,{btnColor:"CANCEL_RED",label:"刪除",sx:{alignSelf:"flex-end"},onClick:()=>oe(J)})]},J)},He=({item:J,isShowArea:oe})=>{const Ne=i.useMemo(()=>E&&E.some(Oe=>Oe.playerDataId===J.playerDataId),[J.playerDataId]),te=i.useMemo(()=>({transition:"all 0.15s ease-in-out",border:"1px solid #aaa","&:hover":{transform:"scale(1.05) translateY(-5px)",boxShadow:"0 0 10px 0 rgba(0, 0, 0, 0.2)"},backgroundColor:!oe&&Ne?"#ccc":"white"}),[Ne,oe]),ge=()=>{E&&Ne?c("playerIdList",E.filter(Oe=>Oe.playerDataId!==J.playerDataId)):E?c("playerIdList",[...E,J]):c("playerIdList",[J])};return e.jsx(Xt,{sx:te,onClick:ge,children:e.jsxs(Br,{sx:{padding:"1rem"},children:[e.jsxs(o,{flexDirection:"row",gap:1,alignItems:"flex-end",children:[e.jsx(z,{sx:{fontSize:"1rem",color:"gray"},children:"暱稱: "}),e.jsx(z,{sx:{fontSize:"1.2rem",fontWeight:"bold",color:"black"},children:J.nickName})]}),e.jsxs(o,{flexDirection:"row",gap:1,alignItems:"flex-end",children:[e.jsx(z,{sx:{fontSize:"1rem",color:"gray"},children:"學校: "}),e.jsx(z,{sx:{fontSize:"1.2rem",fontWeight:"bold",color:"black"},children:J.schoolName[0]})]})]})},J.playerDataId)},Fe=J=>b?J.map(oe=>{let Ne="";switch(oe){case"name":Ne="名稱";break;case"race":Ne="種族";break;case"skillDescription":Ne="描述";break;default:Ne="未知";break}return e.jsxs(o,{flexDirection:oe=="skillDescription"?"column":"row",gap:1,alignItems:oe=="skillDescription"?"flex-start":"center",justifyContent:"center",children:[e.jsxs(z,{sx:{fontSize:"1rem",fontWeight:"bold",color:"#555"},children:[Ne,":"]}),e.jsx(z,{sx:{fontSize:"1.2rem",fontWeight:"bold",color:"black"},children:b[oe]})]})}):null;return e.jsxs(it,{onSubmit:g(Ce),children:[e.jsx(ie,{name:"subtitle",label:"標題",variant:"control"}),e.jsxs(o,{position:"relative",gap:1,children:[C&&e.jsx(Et,{options:C.map(J=>({label:J.templateName,value:J.id})),value:H,onChange:J=>{var oe;G(J.target.value),c("content",((oe=C.find(Ne=>Ne.id==J.target.value))==null?void 0:oe.content)||"")},sx:{width:"50%",position:"absolute",top:0,right:0}}),e.jsx(ze,{name:"content",label:"信件內容",rows:10,variant:"control"}),e.jsx(v,{label:"儲存為新模板",btnColor:"GREEN",onClick:()=>L(!0),sx:{position:"absolute",bottom:5,right:5,zIndex:10}})]}),e.jsxs(o,{flexDirection:"row",gap:3,children:[e.jsxs(o,{flexDirection:"column",flex:1,gap:2,children:[e.jsxs(o,{flexDirection:"row",gap:3,children:[e.jsx(Gt,{name:"sentTime",label:"發送時間",variant:"control",format:"yyyy/MM/dd HH"}),e.jsx(Et,{options:[{label:"0分",value:0},{label:"30分",value:30}],value:k,onChange:J=>q(J.target.value)})]}),e.jsx(je,{name:"mailTargetName",label:"發送對象",options:dh.map(J=>({label:J,value:J})),type:"ONE",variant:"control",labelSx:{width:"100%"}}),e.jsxs(o,{flexDirection:"column",flex:1,gap:1,mt:3,children:[e.jsx(ie,{name:"energy",label:"能量",variant:"control",labelSx:{width:"100%"},type:"number"}),e.jsx(ie,{name:"point",label:"積分",variant:"control",labelSx:{width:"100%"},type:"number"}),e.jsx(ie,{name:"aiChip",label:"AI晶片",variant:"control",labelSx:{width:"100%"},type:"number"}),e.jsx(je,{name:"expBookFieldName",label:"經驗書",options:yi,type:"ONE",variant:"control",labelSx:{width:"100%"},onChange:J=>ee(J.target.value)}),y&&e.jsx(ie,{name:"expBookCount",label:"經驗書數量",variant:"control",labelSx:{width:"100%"},type:"number"}),e.jsx(je,{name:"petId",label:"戰寵",options:[{label:"無",value:-1},...(X==null?void 0:X.map(J=>({label:J.name,value:J.id})))||[]],type:"ONE",variant:"control",labelSx:{width:"100%"}}),b&&e.jsx(lt,{isVisible:!!b,children:e.jsxs(o,{flexDirection:"row",gap:1,alignItems:"center",mt:2,children:[e.jsx(o,{flexDirection:"column",gap:1,alignItems:"flex-start",justifyContent:"center",flex:1,children:Fe(["name","race","skillDescription"])}),e.jsx("img",{src:b.petImageSrc,alt:"pet",width:"200px",height:"200px",style:{flex:1,objectFit:"contain",borderRadius:"1rem",border:"1px solid #ccc",padding:"3px",marginLeft:"auto",marginRight:"auto"}})]})},JSON.stringify(b))]})]}),e.jsx(o,{flexDirection:"column",flex:1.5,children:m!==Te.ALL&&m!==void 0&&e.jsxs(o,{flexDirection:"column",flex:1,gap:5,children:[e.jsx(z,{sx:{fontSize:"1.4rem",fontWeight:"bold",mt:1,mb:2},children:"搜尋條件:"}),e.jsxs(o,{flexDirection:"row",gap:1,flex:1,alignItems:"flex-start",justifyContent:"flex-start",mt:-4,children:[m===Te.GROUP&&e.jsx(Ve,{label:"學制",options:ur.map(J=>({label:J,value:J})),value:U.educationalSystemName,onChange:J=>A(oe=>({...oe,educationalSystemName:J.target.value})),stackSx:{width:"100%",justifyContent:"flex-start"}}),e.jsx(Jn,{label:"學校名稱",value:m===Te.GROUP?D:j,onChange:J=>m===Te.GROUP?S(J.target.value.trim()):w(J.target.value.trim())}),m===Te.PLAYER&&e.jsx(Jn,{label:"遊戲暱稱",value:O,onChange:J=>B(J.target.value.trim())})]}),e.jsxs(Xt,{sx:{padding:"1rem",height:"200px",overflow:"auto",border:"1px solid #ccc",borderRadius:"1rem",minHeight:"400px"},children:[e.jsxs(z,{sx:{fontSize:"1.4rem",fontWeight:"bold",mt:1,mb:5},children:["搜尋到的",m===Te.GROUP?Te.GROUP:Te.PLAYER,": "]}),e.jsx(lt,{isVisible:m===Te.GROUP?V:se,children:e.jsxs(o,{flexDirection:"column",gap:2,alignItems:"center",justifyContent:"center",children:[e.jsxs(o,{flexDirection:"row",gap:2,flexWrap:"wrap",flex:1,children:[m===Te.GROUP&&e.jsx(v,{label:`${U.educationalSystemName}全部`,sx:M[U.educationalSystemName]?{backgroundColor:"gray"}:{transition:"all 0.15s ease-in-out","&:hover":{transform:"scale(1.05) translateY(-5px)"}},onClick:()=>ue({id:0,adlSchoolCode:0,schoolName:"",gradeList:[]})}),m===Te.GROUP&&F&&(F==null?void 0:F.content.length)>0?F.content.map((J,oe)=>e.jsx(v,{label:J.schoolName,disabled:!!M[U.educationalSystemName],sx:M[U.educationalSystemName]?{backgroundColor:"gray"}:W.some(Ne=>Ne.schoolName===J.schoolName)?{backgroundColor:"gray"}:{transition:"all 0.15s ease-in-out","&:hover":{transform:"scale(1.05) translateY(-5px)"}},onClick:()=>ue(J)},oe)):m===Te.PLAYER&&_&&(_==null?void 0:_.content.length)>0?_.content.map((J,oe)=>e.jsx(He,{item:J},oe)):null]}),e.jsxs(o,{flexDirection:"row",alignItems:"flex-end",flex:1,children:[m===Te.GROUP&&F&&e.jsx(bn,{count:F.totalPages,page:F.pageable.pageNumber+1,onChange:Q,color:"primary"}),m===Te.PLAYER&&_&&e.jsx(bn,{count:_.totalPages,page:_.pageable.pageNumber+1,onChange:pe,color:"primary"})]})]})},m===Te.GROUP?JSON.stringify(F):JSON.stringify(_))]})]})})]}),m!==Te.ALL&&e.jsxs(Xt,{sx:{padding:"2rem",border:"1px solid #ccc",borderRadius:"1rem",minHeight:"300px"},children:[e.jsxs(z,{sx:{fontSize:"1.4rem",fontWeight:"bold"},children:["已選擇",m===Te.GROUP?Te.GROUP:Te.PLAYER,": "]}),e.jsxs(o,{flexDirection:"row",gap:m===Te.GROUP?8:3,flexWrap:"wrap",mt:2,ml:2,children:[m===Te.GROUP&&W.length>0&&W.map((J,oe)=>e.jsx(We,{index:oe})),m===Te.PLAYER&&E&&E.length>0&&E.map((J,oe)=>e.jsx(He,{item:J,isShowArea:!0},oe))]})]}),e.jsxs(o,{flexDirection:"row",gap:3,justifyContent:"end",children:[e.jsx(v,{label:"儲存草稿",type:"submit",sx:{alignSelf:"flex-end"},onClick:()=>Se(me.DRAFT)}),e.jsx(v,{label:"送出",type:"submit",btnColor:"BTN_LATTE_GRAY",sx:{alignSelf:"flex-end"},onClick:()=>Se(me.PASS)})]}),e.jsx(ss,{request:{content:JSON.stringify(T),mailType:ft.NORMAL},open:N,onClose:()=>L(!1),setSelectedMailTemplate:G})]})},ph=uh,mh=i.memo(({value:t,handleChange:a})=>{const n=(s,r)=>{a(r)({target:{value:s}})};return e.jsxs(i.Fragment,{children:[e.jsx(Ve,{label:"狀態",options:Object.values(En).map(s=>({label:gi[s],value:s})),value:t.flag,onChange:a("flag")}),e.jsx(Ve,{label:"對象",options:Object.values(Te).map(s=>({label:s,value:s})),value:t.mailTargetName,onChange:a("mailTargetName")}),e.jsx(Ve,{label:"有無獎勵",options:[{label:"全選",value:"全選"},{label:"有",value:"1"},{label:"無",value:"0"}],value:t.hasReward,onChange:a("hasReward")}),e.jsxs(o,{flexDirection:"row",alignItems:"center",gap:2,children:[e.jsx(es,{label:"發送時間",value:Ie(t.sentTimeStart).toDate().getTime(),onChange:s=>n(s,"sentTimeStart")}),e.jsx(z,{variant:"h6",children:"至"}),e.jsx(an,{value:Ie(t.sentTimeEnd).toDate().getTime(),onChange:s=>n(s,"sentTimeEnd")})]})]})}),Vi=[{label:"主旨",value:"subtitle"},{label:"信件內容",value:"content"},{label:"最後編輯者",value:"lastUpdateAdlName"}],wa=Vi.map(t=>t.value),hh=t=>wa.includes(t),xh=()=>{const t=yt(),a=Me(),n=Wt(),{setAlertOpen:s}=_e(),r=i.useMemo(()=>{const A=new URLSearchParams(n.search),p=A.get("subtitle"),x=A.get("content"),h=A.get("lastUpdateAdlName");return{flag:A.get("flag")||En.DRAFT,hasReward:A.get("hasReward")||"全選",mailTargetName:A.get("mailTargetName")||Te.ALL,sentTimeStart:A.get("sentTimeStart")||Ie().subtract(1,"month").format("YYYY-MM-DD 00:00:00"),sentTimeEnd:A.get("sentTimeEnd")||Ie().add(1,"month").format("YYYY-MM-DD 23:59:59"),page:parseInt(A.get("page")||"0",10),type:"NORMAL",removed:!1,...p&&{subtitle:p},...x&&{content:x},...h&&{lastUpdateAdlName:h},size:10}},[n.search]),l=i.useMemo(()=>{const A=Object.keys(r).find(p=>wa.includes(p)&&r[p]!==void 0);return A?{searchText:r[A],currentField:A}:{searchText:"",currentField:wa[0]}},[r]),[c,g]=i.useState(r),[m,E]=i.useState(l),[f,T]=i.useState(),{data:y,isSuccess:D,isLoading:S}=qd(c),{mutate:j}=Kd(Y),w=i.useMemo(()=>D&&!!y,[D,y]),O=i.useCallback(()=>{a("create")},[a]),B=i.useCallback(A=>{a(`update/${A}`)},[a]),k=i.useCallback(A=>p=>{let x,h;if(typeof p=="number"||typeof p=="string"||typeof p=="boolean"?x=p:x=p.target.value,hh(A)){const P={};wa.forEach(F=>{F===A&&x?P[F]=x:delete c[F]}),h={...c,...P}}else h={...c,[A]:x};A!=="page"&&(h.page=0),A==="sentTimeStart"&&(h.sentTimeStart=Ie(h.sentTimeStart).format("YYYY-MM-DD 00:00:00")),A==="sentTimeEnd"&&(h.sentTimeEnd=Ie(h.sentTimeEnd).format("YYYY-MM-DD 23:59:59"));const I=ut(ln(h));g(h),a(`?${I}`)},[a,c]),q=i.useCallback(()=>{f&&g(A=>({...A,page:Number(f)-1}))},[f,g]),H=i.useCallback((A,p)=>{k("page")(p-1),T(p)},[k]),G=A=>{E(p=>({...p,searchText:A}))},N=A=>{E(p=>({...p,currentField:A}))},L=i.useCallback(()=>{const{currentField:A,searchText:p}=m;k(A)(p),T(1)},[k,m]),M=A=>{s({open:!0,title:"提示",message:`信件模板刪除即時生效
請確認是否要刪除`,onOk:()=>j(A)})};function Y(){const A=jt(c);t.invalidateQueries({queryKey:[Pe.MAIL_SEARCH,A]}),s({open:!0,title:"提示",message:"信件刪除成功"})}const U=[{title:"操作",dataField:"id",width:"100px",component:A=>e.jsxs(o,{direction:"row",gap:2,children:[e.jsx(v,{label:"編輯",onClick:()=>B(A.id),btnColor:"TAB_BLUE"}),e.jsx(v,{label:"刪除",onClick:()=>M(A.id),btnColor:"CANCEL_RED"})]})},{title:"主旨",dataField:"subtitle"},{title:"狀態",dataField:"flag",component:A=>e.jsx(z,{sx:{fontWeight:"bold",fontSize:"22px"},children:gi[A.flag]})},{title:"對象",dataField:"mailTargetName"},{title:"信件內容",dataField:"content"},{title:"發送時間",dataField:"sentTime",component:A=>e.jsx(z,{sx:{fontWeight:"bold",fontSize:"22px"},children:Ie(A.sentTime).format("YYYY-MM-DD  HH:mm:ss")})},{title:"最後編輯者",dataField:"lastUpdateAdlName"}];return e.jsxs(o,{flex:1,gap:5,children:[e.jsx(v,{label:"創建信件",onClick:O,sx:{ml:"auto"},btnColor:"BLUE"}),e.jsx(o,{flexDirection:"row",gap:4,alignItems:"center",justifyContent:{xs:"center",sm:"flex-start"},flexWrap:"wrap",px:3,children:e.jsxs(o,{flexDirection:"row",gap:4,flexWrap:"wrap",justifyContent:{xs:"center",sm:"flex-start"},alignItems:"center",children:[e.jsx(mh,{value:c,handleChange:k}),e.jsx(vt,{value:m,options:Vi,selectOnChange:N,inputOnChange:G,searchFuntion:L}),e.jsx(v,{label:"搜尋",onClick:L,btnColor:"BROWN"})]})}),S?e.jsx(Ge,{}):e.jsx(o,{children:y&&e.jsx(lt,{isVisible:w,children:e.jsxs(o,{p:.5,alignItems:"center",gap:5,children:[e.jsx(Tt,{columns:U,rows:y.content}),e.jsx(Yt,{totalPages:y.totalPages,currentPage:y.pageable.pageNumber,inputPage:f??1,setInputPage:T,handlePageChange:H,handlePageSearch:q})]})},JSON.stringify(c))})]})},gh=xh,pr=["高中","國中","國小"],fh=["全體","指定群組","指定玩家"],bh=()=>{const t=yt(),{id:a}=Lt(),n=Me(),{setAlertOpen:s}=_e(),{setFlag:r,flag:l}=at(),{reset:c,control:g,setValue:m,handleSubmit:E}=$e(),f=Be({control:g,name:"mailTargetName"}),T=Be({control:g,name:"playerIdList"}),y=Be({control:g,name:"petId"}),D=Be({control:g,name:"content"}),S=Be({control:g,name:"expBookFieldName"}),[j,w]=i.useState(""),[O,B]=i.useState(""),[k,q]=i.useState(""),[H,G]=i.useState(0),[N,L]=i.useState(0),[M,Y]=i.useState(!1),[U,A]=i.useState(pr.reduce((te,ge)=>({...te,[ge]:!1}),{})),[p,x]=i.useState({educationalSystemName:"高中",schoolName:"",page:0,size:15}),[h,I]=i.useState({schoolName:"",nickName:"",page:0,size:20}),P=Xn(j,350),F=Xn(O,350),u=Xn(k,350),{data:_,isLoading:Z,isError:C}=Vd(a),{data:V}=ns({mailType:ft.NORMAL}),{data:se,isSuccess:X}=Ci(f,{...p,schoolName:P}),{data:R,isSuccess:b}=Si(f,{...h,nickName:u,schoolName:F}),W=i.useMemo(()=>X&&!!se.content.length,[X,se]),le=i.useMemo(()=>b&&!!R.content.length,[b,R]),{data:ne}=ta(),{mutate:Q}=Yd(We,He),pe=i.useMemo(()=>y?ne==null?void 0:ne.find(te=>te.id===y):null,[y,ne]),{fields:ee}=It({control:g,name:"mailGroupDtoList"}),de=(te,ge)=>{x(Oe=>({...Oe,page:ge-1}))},Ce=(te,ge)=>{I(Oe=>({...Oe,page:ge-1}))},ue=te=>{te?m("expBookFieldName",te):(m("expBookFieldName",null),m("expBookCount",null))},Se=te=>{let ge;const Oe=Ie(te.sentTime).format("YYYY-MM-DDTHH")+":"+H.toString().padStart(2,"0")+":00.000+08:00",De={energy:te.energy?Number(te.energy):null,point:te.point?Number(te.point):null},ae={expBookFieldName:te.expBookFieldName??null,expBookCount:te.expBookCount??null};if(te.mailTargetName===Te.ALL){const{mailGroupDtoList:ce,playerIdList:ye,variant:Re,...dt}=te;ge={...dt,sentTime:Oe,...De,...ae}}else if(te.mailTargetName===Te.GROUP){const{playerIdList:ce,mailGroupDtoList:ye,variant:Re,...dt}=te;if(!ye){s({open:!0,title:"提示",message:"請選擇學校"});return}const At=ye.map(({educationalSystemName:bt,schoolName:nt,grade:st})=>({educationalSystemName:bt,schoolName:nt,grade:!st||st&&st.includes(0)?null:st})).flatMap(({educationalSystemName:bt,schoolName:nt,grade:st})=>st?st.map(re=>({educationalSystemName:bt,schoolName:nt,grade:re})):[{educationalSystemName:bt,schoolName:nt,grade:null}]);ge={...dt,mailGroupDtoList:At,sentTime:Oe,...De,...ae}}else{const{mailGroupDtoList:ce,playerIdList:ye,variant:Re,...dt}=te;ge={...dt,playerIdList:ye==null?void 0:ye.map(kt=>kt.playerDataId),sentTime:Oe,...De,...ae}}Q({...ge,petId:ge.petId&&ge.petId>0?ge.petId:null,id:Number(a)})},Ae=te=>{s({open:!0,title:"提示",message:l===me.DRAFT?`信件將會儲存為草稿
請確認是否要送出`:`信件送出即時生效
請確認是否要送出`,onOk:()=>Se(te)})},Ee=te=>{if(!te.schoolName)A(ge=>{const Oe=U[p.educationalSystemName],De=[...ee];if(Oe){const ae=De.filter(ce=>!(ce.educationalSystemName===p.educationalSystemName&&!ce.schoolName));m("mailGroupDtoList",ae)}else{const ae=De.filter(ye=>ye.educationalSystemName!==p.educationalSystemName),ce={educationalSystemName:p.educationalSystemName,schoolName:"",grade:null,gradeList:null};m("mailGroupDtoList",[...ae,ce])}return{...ge,[p.educationalSystemName]:!Oe}});else{const ge=[...ee],Oe=ge.findIndex(De=>De.schoolName===te.schoolName);if(Oe!==-1){const De=ge.filter((ae,ce)=>ce!==Oe);m("mailGroupDtoList",De)}else{const De={educationalSystemName:p.educationalSystemName,schoolName:te.schoolName,grade:[0],gradeList:te.gradeList};m("mailGroupDtoList",[...ge,De])}}};function We(){t.invalidateQueries({queryKey:[Pe.MAIL_ID(a)]}),s({open:!0,title:"提示",message:"信件創建成功"}),n("/edit/mailEdit")}function He(te){s({open:!0,title:"信件創建失敗",message:te})}const Fe=te=>{te===me.DRAFT?(r(me.DRAFT),m("flag",En.DRAFT)):(r(me.PASS),m("flag",En.UNPUBLISH))};i.useEffect(()=>(c(Ba),()=>{c()}),[]);const J=({index:te})=>{const ge=De=>{const ae=ee.findIndex(ce=>ce.schoolName===ee[De].schoolName);ae!==-1&&m("mailGroupDtoList",ee.filter((ce,ye)=>ye!==ae)),U[ee[De].educationalSystemName]&&A(ce=>({...ce,[ee[De].educationalSystemName]:!U[ee[De].educationalSystemName]}))},Oe=i.useMemo(()=>{var De;return((De=ee[te].gradeList)==null?void 0:De.map(ae=>({label:ae.toString(),value:ae})))||[]},[te]);return e.jsxs(Xt,{sx:{padding:"1.5rem",border:"1px solid #ccc",borderRadius:"1rem",minWidth:"525px",gap:2,display:"flex",flexDirection:"column"},children:[e.jsx(ie,{name:`mailGroupDtoList.${te}.educationalSystemName`,label:"學制",variant:"control",disabled:!0}),e.jsx(ie,{name:`mailGroupDtoList.${te}.schoolName`,label:"學校",variant:"control",disabled:!0}),ee[te].schoolName&&e.jsx(je,{name:`mailGroupDtoList.${te}.grade`,label:"年級",options:Oe,type:"ALL",variant:"control",multiple:!0}),e.jsx(v,{btnColor:"CANCEL_RED",label:"刪除",sx:{alignSelf:"flex-end"},onClick:()=>ge(te)})]},te)},oe=({item:te,isShowArea:ge})=>{const Oe=i.useMemo(()=>T&&T.some(ce=>ce.playerDataId===te.playerDataId),[te.playerDataId]),De=i.useMemo(()=>({transition:"all 0.15s ease-in-out",border:"1px solid #aaa","&:hover":{transform:"scale(1.05) translateY(-5px)",boxShadow:"0 0 10px 0 rgba(0, 0, 0, 0.2)"},backgroundColor:!ge&&Oe?"#ccc":"white"}),[Oe,ge]),ae=()=>{T&&Oe?m("playerIdList",T.filter(ce=>ce.playerDataId!==te.playerDataId)):T?m("playerIdList",[...T,te]):m("playerIdList",[te])};return e.jsx(Xt,{sx:De,onClick:ae,children:e.jsxs(Br,{sx:{padding:"1rem"},children:[e.jsxs(o,{flexDirection:"row",gap:1,alignItems:"flex-end",children:[e.jsx(z,{sx:{fontSize:"1rem",color:"gray"},children:"暱稱: "}),e.jsx(z,{sx:{fontSize:"1.2rem",fontWeight:"bold",color:"black"},children:te.nickName})]}),e.jsxs(o,{flexDirection:"row",gap:1,alignItems:"flex-end",children:[e.jsx(z,{sx:{fontSize:"1rem",color:"gray"},children:"學校: "}),e.jsx(z,{sx:{fontSize:"1.2rem",fontWeight:"bold",color:"black"},children:te.schoolName[0]})]})]})},te.playerDataId)},Ne=te=>pe?te.map(ge=>{let Oe="";switch(ge){case"name":Oe="名稱";break;case"race":Oe="種族";break;case"missionHint":Oe="提示";break;case"skillDescription":Oe="描述";break;default:Oe="未知";break}return e.jsxs(o,{flexDirection:ge=="skillDescription"?"column":"row",gap:1,alignItems:ge=="skillDescription"?"flex-start":"center",justifyContent:"center",children:[e.jsxs(z,{sx:{fontSize:"1rem",fontWeight:"bold",color:"#555"},children:[Oe,":"]}),e.jsx(z,{sx:{fontSize:"1.2rem",fontWeight:"bold",color:"black"},children:pe[ge]})]})}):null;if(i.useEffect(()=>()=>{c(Ba)},[]),i.useEffect(()=>{if(_){const{createTime:te,updateTime:ge,removed:Oe,sentTime:De,energy:ae,point:ce,aiChip:ye,petId:Re,petLevelDto:dt,mailTargetName:kt,mailGroupDtoList:At,playerInfoDtoList:bt,schoolGradeList:nt,...st}=_,re=At==null?void 0:At.reduce((fe,ve)=>{var Nt;const Le=ve.schoolName+"_"+ve.educationalSystemName;return fe[Le]?ve.grade!==null&&(fe[Le].grade=fe[Le].grade===null?[ve.grade]:[...fe[Le].grade,ve.grade]):fe[Le]={...ve,grade:ve.grade===null?[0]:[ve.grade],gradeList:((Nt=nt==null?void 0:nt.find(en=>en.schoolName===ve.schoolName))==null?void 0:Nt.grades)||[]},fe},{});c({...st,variant:"update",sentTime:new Date(De),energy:ae?Number(ae):null,point:ce?Number(ce):null,aiChip:ye?Number(ye):null,petId:Re&&Re>0?Re:-1,mailTargetName:kt,mailGroupDtoList:Object.values(re),playerIdList:bt==null?void 0:bt.map(fe=>({...fe,playerDataId:fe.playerDataId}))})}},[_]),C){s({open:!0,title:"提示",message:"信件資料獲取失敗"}),n(-1);return}return Z?e.jsx(Ge,{}):e.jsxs(it,{onSubmit:E(Ae),children:[e.jsx(ie,{name:"subtitle",label:"標題",variant:"control"}),e.jsxs(o,{position:"relative",gap:1,children:[V&&e.jsx(Et,{options:[{label:"無",value:0},...V.map(te=>({label:te.templateName,value:te.id}))],value:N,onChange:te=>{var ge;L(te.target.value),m("content",((ge=V.find(Oe=>Oe.id==te.target.value))==null?void 0:ge.content)||"")},sx:{width:"50%",position:"absolute",top:0,right:0}}),e.jsx(ze,{name:"content",label:"信件內容",rows:10,variant:"control"}),e.jsx(v,{label:"儲存為新模板",btnColor:"GREEN",onClick:()=>Y(!0),sx:{position:"absolute",bottom:5,right:5,zIndex:10}})]}),e.jsxs(o,{flexDirection:"row",gap:3,children:[e.jsxs(o,{flexDirection:"column",flex:1,gap:2,children:[e.jsxs(o,{flexDirection:"row",gap:3,children:[e.jsx(Gt,{name:"sentTime",label:"發送時間",variant:"control",format:"yyyy/MM/dd HH"}),e.jsx(Et,{options:[{label:"0分",value:0},{label:"30分",value:30}],value:H,onChange:te=>G(te.target.value)})]}),e.jsx(je,{name:"mailTargetName",label:"發送對象",options:fh.map(te=>({label:te,value:te})),type:"ONE",variant:"control",labelSx:{width:"100%"}}),e.jsxs(o,{flexDirection:"column",flex:1,gap:1,mt:3,children:[e.jsx(ie,{name:"energy",label:"能量",variant:"control",labelSx:{width:"100%"},type:"number"}),e.jsx(ie,{name:"point",label:"積分",variant:"control",labelSx:{width:"100%"},type:"number"}),e.jsx(ie,{name:"aiChip",label:"AI晶片",variant:"control",labelSx:{width:"100%"},type:"number"}),e.jsx(je,{name:"expBookFieldName",label:"經驗書",options:yi,type:"ONE",variant:"control",labelSx:{width:"100%"},onChange:te=>ue(te.target.value)}),S&&e.jsx(ie,{name:"expBookCount",label:"經驗書數量",variant:"control",labelSx:{width:"100%"},type:"number"}),e.jsx(je,{name:"petId",label:"戰寵",options:[{label:"無",value:-1},...(ne==null?void 0:ne.map(te=>({label:te.name,value:te.id})))||[]],type:"ONE",variant:"control",labelSx:{width:"100%"}}),pe&&e.jsx(lt,{isVisible:!!pe,children:e.jsxs(o,{flexDirection:"row",gap:1,alignItems:"center",mt:2,children:[e.jsx(o,{flexDirection:"column",gap:1,alignItems:"flex-start",justifyContent:"center",flex:1,children:Ne(["name","race","skillDescription"])}),e.jsx("img",{src:pe.petImageSrc,alt:"pet",width:"200px",height:"200px",style:{flex:1,objectFit:"contain",borderRadius:"1rem",border:"1px solid #ccc",padding:"3px",marginLeft:"auto",marginRight:"auto"}})]})},JSON.stringify(pe))]})]}),e.jsx(o,{flexDirection:"column",flex:1.5,children:f!==Te.ALL&&f!==void 0&&e.jsxs(o,{flexDirection:"column",flex:1,gap:5,children:[e.jsx(z,{sx:{fontSize:"1.4rem",fontWeight:"bold",mt:1,mb:2},children:"搜尋條件:"}),e.jsxs(o,{flexDirection:"row",gap:1,flex:1,alignItems:"flex-start",justifyContent:"flex-start",mt:-4,children:[f===Te.GROUP&&e.jsx(Ve,{label:"學制",options:pr.map(te=>({label:te,value:te})),value:p.educationalSystemName,onChange:te=>x(ge=>({...ge,educationalSystemName:te.target.value,page:0})),stackSx:{width:"100%",justifyContent:"flex-start"}}),e.jsx(Jn,{label:"學校名稱",value:f===Te.GROUP?j:O,onChange:te=>f===Te.GROUP?w(te.target.value.trim()):B(te.target.value.trim())}),f===Te.PLAYER&&e.jsx(Jn,{label:"遊戲暱稱",value:k,onChange:te=>q(te.target.value.trim())})]}),e.jsxs(Xt,{sx:{padding:"1rem",height:"200px",overflow:"auto",border:"1px solid #ccc",borderRadius:"1rem",minHeight:"400px"},children:[e.jsxs(z,{sx:{fontSize:"1.4rem",fontWeight:"bold",mt:1,mb:5},children:["搜尋到的",f===Te.GROUP?Te.GROUP:Te.PLAYER,": "]}),e.jsx(lt,{isVisible:f===Te.GROUP?W:le,children:e.jsxs(o,{flexDirection:"column",gap:2,alignItems:"center",justifyContent:"center",children:[e.jsxs(o,{flexDirection:"row",gap:2,flexWrap:"wrap",flex:1,children:[f===Te.GROUP&&e.jsx(v,{label:`${p.educationalSystemName}全部`,sx:U[p.educationalSystemName]?{backgroundColor:"gray"}:{transition:"all 0.15s ease-in-out","&:hover":{transform:"scale(1.05) translateY(-5px)"}},onClick:()=>Ee({id:0,adlSchoolCode:0,schoolName:"",gradeList:[]})}),f===Te.GROUP&&se&&(se==null?void 0:se.content.length)>0?se.content.map((te,ge)=>e.jsx(v,{label:te.schoolName,disabled:!!U[p.educationalSystemName],sx:U[p.educationalSystemName]?{backgroundColor:"gray"}:ee.some(Oe=>Oe.schoolName===te.schoolName)?{backgroundColor:"gray"}:{transition:"all 0.15s ease-in-out","&:hover":{transform:"scale(1.05) translateY(-5px)"}},onClick:()=>Ee(te)},ge)):f===Te.PLAYER&&R&&(R==null?void 0:R.content.length)>0?R.content.map((te,ge)=>e.jsx(oe,{item:te},ge)):null]}),e.jsxs(o,{flexDirection:"row",alignItems:"flex-end",flex:1,children:[f===Te.GROUP&&se&&e.jsx(bn,{count:se.totalPages,page:se.pageable.pageNumber+1,onChange:de,color:"primary"}),f===Te.PLAYER&&R&&e.jsx(bn,{count:R.totalPages,page:R.pageable.pageNumber+1,onChange:Ce,color:"primary"})]})]})},f===Te.GROUP?JSON.stringify(se):JSON.stringify(R))]})]})})]}),f!==Te.ALL&&e.jsxs(Xt,{sx:{padding:"2rem",border:"1px solid #ccc",borderRadius:"1rem",minHeight:"300px"},children:[e.jsxs(z,{sx:{fontSize:"1.4rem",fontWeight:"bold"},children:["已選擇",f===Te.GROUP?Te.GROUP:Te.PLAYER,": "]}),e.jsxs(o,{flexDirection:"row",gap:f===Te.GROUP?8:3,flexWrap:"wrap",mt:2,ml:2,children:[f===Te.GROUP&&ee.length>0&&ee.map((te,ge)=>e.jsx(J,{index:ge},te.id)),f===Te.PLAYER&&T&&T.length>0&&T.map((te,ge)=>e.jsx(oe,{item:te,isShowArea:!0},ge))]})]}),e.jsxs(o,{flexDirection:"row",gap:3,justifyContent:"end",children:[e.jsx(v,{label:"儲存草稿",type:"submit",sx:{alignSelf:"flex-end"},onClick:()=>Fe(me.DRAFT)}),e.jsx(v,{label:"送出",type:"submit",btnColor:"BTN_LATTE_GRAY",sx:{alignSelf:"flex-end"},onClick:()=>Fe(me.PASS)})]}),e.jsx(ss,{request:{content:JSON.stringify(D),mailType:ft.NORMAL},open:M,onClose:()=>Y(!1),setSelectedMailTemplate:L})]})},jh=bh;function yh(){return e.jsx(ch,{children:e.jsxs(Pt,{children:[e.jsx(xe,{index:!0,element:e.jsx(gh,{})}),e.jsx(xe,{path:"/create",element:e.jsx(ph,{})}),e.jsx(xe,{path:"/update/:id",element:e.jsx(jh,{})}),e.jsx(xe,{path:"*",element:e.jsx(_t,{to:"/edit/mailEdit",replace:!0})})]})})}const Ch=()=>d.intersection(d.object({templateName:d.string().min(1,"主旨必填").max(16,"主旨不可超過16字"),mailType:d.nativeEnum(ft)}),d.discriminatedUnion("variant",[d.object({variant:d.literal("create")}),d.object({variant:d.literal("update"),id:d.number().min(1)})])),Us={variant:"create",templateName:"",mailType:ft.NORMAL},Sh=({children:t})=>{const a=Ch(),n=sn({mode:"all",resolver:on(a),defaultValues:Us});return e.jsxs(rn,{...n,children:[t,!1]})},Eh=Sh,Ih=()=>{const t=Me(),{setAlertOpen:a}=_e(),{reset:n,control:s,handleSubmit:r}=$e(),l=Be({control:s,name:"mailType"}),c=i.useRef(null),[g,m]=i.useState(!1),{data:E}=as(),{mutate:f}=Ei(j,w),T=O=>{const B=window.getSelection();if(!B||!B.rangeCount)return;const k=B.getRangeAt(0),q=c.current;if(!q||!q.contains(k.commonAncestorContainer))return;const H=document.createElement("button");H.style.color="#444",H.disabled=!0,H.innerText=O,H.setAttribute("contenteditable","false"),k.insertNode(H),k.setStartAfter(H),k.collapse(!0),B.removeAllRanges(),B.addRange(k)},y=()=>{if(!c.current)return"";const O=document.createElement("div");O.innerHTML=c.current.innerHTML;const B=O.getElementsByTagName("button");return Array.from(B).forEach(q=>{var G;const H=document.createTextNode(q.innerText);(G=q.parentNode)==null||G.replaceChild(H,q)}),O.innerHTML.replace(/<div[^>]*>/gi,"###NEWLINE###").replace(/<\/div>/gi,"").replace(/<br\s*\/?>/gi,"###NEWLINE###").replace(/&nbsp;/g," ").replace(/(<([^>]+)>)/gi,"").replace(/###NEWLINE###/g,`
`).replace(/\n\s*\n/g,`
`).trim()},D=O=>{f({...O,content:y(),isDefault:g})},S=O=>{a({open:!0,title:"提示",message:`信件模板送出即時生效
請確認是否要送出`,onOk:()=>D(O)})};function j(){a({open:!0,title:"提示",message:"信件創建成功"}),t("/edit/mailTemplateEdit")}function w(O){a({open:!0,title:"提示",message:O})}return i.useEffect(()=>{n(Us)},[]),e.jsxs(it,{onSubmit:r(S),children:[e.jsxs(o,{gap:3,flexDirection:"row",children:[e.jsx(o,{flexDirection:"row",gap:1,alignItems:"center",flex:2,children:e.jsx(ie,{name:"templateName",label:"模板名稱",variant:"control"})}),e.jsxs(o,{flexDirection:"row",alignItems:"center",flex:1,children:[e.jsx(z,{children:"預設信件"}),e.jsx(On,{checked:g,onChange:O=>m(O.target.checked),sx:{ml:-1}})]})]}),e.jsx(je,{name:"mailType",label:"模板類型",options:bi,type:"ONE",variant:"control",labelSx:{width:"100%"}}),l===ft.CONTEST_EVENT_REWARD||l===ft.NORMAL_EVENT_REWARD?e.jsxs(o,{my:2,gap:1,width:"100%",flexDirection:"column",children:[e.jsx(o,{gap:1,flexDirection:"row",children:e.jsx(he,{children:"信件內容"})}),e.jsx(o,{gap:1,flexDirection:"row",alignItems:"flex-end",children:e.jsx("div",{ref:c,contentEditable:!0,style:{minHeight:"200px",border:"1px solid #ccc",padding:"8px",marginTop:"8px",width:"100%"}})}),e.jsx(o,{direction:"row",spacing:1,justifyContent:"space-between",width:"80%",children:E&&e.jsx(o,{direction:"row",spacing:1,children:E.map(O=>e.jsx(v,{label:O.name,onClick:()=>T(O.code),sx:{cursor:"pointer","&:hover":{backgroundColor:$.DARK_BLUE}}},O.code))})})]}):e.jsxs(o,{gap:1,flexDirection:"column",children:[e.jsx(he,{children:"信件內容"}),e.jsx("div",{ref:c,contentEditable:!0,style:{minHeight:"200px",border:"1px solid #ccc",padding:"8px",marginTop:"8px",width:"100%"}})]}),e.jsx(o,{flexDirection:"row",gap:3,justifyContent:"end",children:e.jsx(v,{label:"送出",type:"submit",btnColor:"BTN_LATTE_GRAY",sx:{alignSelf:"flex-end"}})})]})},Th=Ih,wh=i.memo(({value:t,handleChange:a})=>e.jsx(i.Fragment,{children:e.jsx(Ve,{label:"模板類型",options:[{label:"全選",value:"全選"},...Object.values(ft).map(n=>({label:fi[n],value:n}))],value:t.mailType,onChange:a("mailType")})})),Ki=[{label:"模板名稱",value:"templateName"},{label:"模板內容",value:"content"}],Da=Ki.map(t=>t.value),Dh=t=>Da.includes(t),vh=()=>{const t=yt(),a=Me(),n=Wt(),{setAlertOpen:s}=_e(),r=i.useMemo(()=>{const A=new URLSearchParams(n.search),p=A.get("templateName"),x=A.get("content"),h=A.get("mailType");return{mailType:h||"全選",page:parseInt(A.get("page")||"0",10),...p&&{templateName:p},...x&&{content:x},size:10}},[n.search]),l=i.useMemo(()=>{const A=Object.keys(r).find(p=>Da.includes(p)&&r[p]!==void 0);return A?{searchText:r[A],currentField:A}:{searchText:"",currentField:Da[0]}},[r]),[c,g]=i.useState(r),[m,E]=i.useState(l),[f,T]=i.useState(),{data:y,isSuccess:D,isLoading:S}=zd(c),{mutate:j}=Xd(Y),w=i.useMemo(()=>D&&!!y,[D,y]),O=i.useCallback(()=>{a("create")},[a]),B=i.useCallback(A=>{a(`update/${A}`)},[a]),k=i.useCallback(A=>p=>{let x,h;if(typeof p=="number"||typeof p=="string"||typeof p=="boolean"?x=p:x=p.target.value,Dh(A)){const P={};Da.forEach(F=>{F===A&&x?P[F]=x:delete c[F]}),h={...c,...P}}else h={...c,[A]:x};A!=="page"&&(h.page=0);const I=ut(ln(h));g(h),a(`?${I}`)},[a,c]),q=i.useCallback((A,p)=>{k("page")(p-1),T(p)},[k]),H=i.useCallback(()=>{f&&g(A=>({...A,page:Number(f)-1}))},[f,g]),G=A=>{E(p=>({...p,searchText:A}))},N=A=>{E(p=>({...p,currentField:A}))},L=()=>{const{currentField:A,searchText:p}=m;k(A)(p),T(1)},M=A=>{s({open:!0,title:"提示",message:`信件模板刪除即時生效
請確認是否要刪除`,onOk:()=>j(A)})};function Y(){const A=jt(c);t.invalidateQueries({queryKey:[Pe.MAIL_TEMPLATE,A]}),s({open:!0,title:"提示",message:"信件模板刪除成功"})}const U=[{title:"操作",dataField:"id",width:"100px",component:A=>e.jsx(v,{label:"編輯",onClick:()=>B(A.id),btnColor:"TAB_BLUE"})},{title:"模板名稱",dataField:"templateName"},{title:"模板類型",dataField:"mailType",component:A=>e.jsxs(z,{sx:{fontSize:"24px"},children:[A.isDefault?"( 預設 ) ":"",fi[A.mailType]]})},{title:"模板內容",dataField:"content",component:A=>e.jsxs(z,{sx:{fontSize:"24px"},children:[A.content.slice(0,15),"..."]})},{title:"最後編輯者",dataField:"lastUpdateAdlName"},{title:"刪除",dataField:"id",component:A=>e.jsx(v,{label:"刪除",onClick:()=>M(A.id),btnColor:"CANCEL_RED"})}];return e.jsxs(o,{flex:1,gap:5,children:[e.jsx(v,{label:"創建信件模板",onClick:O,sx:{ml:"auto"},btnColor:"BLUE"}),e.jsx(o,{flexDirection:"row",gap:4,alignItems:"center",justifyContent:{xs:"center",sm:"flex-start"},flexWrap:"wrap",px:3,children:e.jsxs(o,{flexDirection:"row",gap:4,flexWrap:"wrap",justifyContent:{xs:"center",sm:"flex-start"},alignItems:"center",children:[e.jsx(wh,{value:c,handleChange:k}),e.jsx(vt,{value:m,options:Ki,selectOnChange:N,inputOnChange:G,searchFuntion:L}),e.jsx(v,{label:"搜尋",onClick:L,btnColor:"BROWN"})]})}),S?e.jsx(Ge,{}):e.jsx(o,{children:y&&y.content.length>0&&e.jsx(lt,{isVisible:w,children:e.jsxs(o,{p:.5,alignItems:"center",gap:5,children:[e.jsx(Tt,{columns:U,rows:y.content}),e.jsx(Yt,{totalPages:y.totalPages,currentPage:y.pageable.pageNumber,inputPage:f??1,setInputPage:T,handlePageChange:q,handlePageSearch:H})]})},JSON.stringify(c))})]})},kh=vh,Ah=()=>{const t=yt(),{id:a}=Lt(),n=Me(),{setAlertOpen:s}=_e(),{reset:r,control:l,handleSubmit:c}=$e(),g=Be({control:l,name:"mailType"}),m=i.useRef(null),[E,f]=i.useState(!1),{data:T}=Qd({id:Number(a)}),{data:y}=as(),{mutate:D}=Jd(k,q),S=H=>{const G=window.getSelection();if(!G||!G.rangeCount)return;const N=G.getRangeAt(0),L=m.current;if(!L||!L.contains(N.commonAncestorContainer))return;const M=document.createElement("button");M.style.color="#444",M.disabled=!0,M.innerText=H,M.setAttribute("contenteditable","false"),N.insertNode(M),N.setStartAfter(M),N.collapse(!0),G.removeAllRanges(),G.addRange(N)},j=()=>{if(!m.current)return"";const H=document.createElement("div");H.innerHTML=m.current.innerHTML;const G=H.getElementsByTagName("button");return Array.from(G).forEach(L=>{var Y;const M=document.createTextNode(L.innerText);(Y=L.parentNode)==null||Y.replaceChild(M,L)}),H.innerHTML.replace(/<div[^>]*>/gi,"###NEWLINE###").replace(/<\/div>/gi,"").replace(/<br\s*\/?>/gi,"###NEWLINE###").replace(/&nbsp;/g," ").replace(/(<([^>]+)>)/gi,"").replace(/###NEWLINE###/g,`
`).replace(/\n\s*\n/g,`
`).trim()},w=(H,G=!1)=>{if(m.current){let N;const L=G?JSON.parse(H):H,M=/\$\{\{([^}]+)\}\}/g;N=L.replace(M,Y=>`<button disabled style="color: #444;" contenteditable="false">${Qa(Y)}</button>`),N=N.split(`
`).join("<br>"),m.current.innerHTML=N}},O=H=>{D({...H,id:Number(a),content:j(),isDefault:E})},B=H=>{s({open:!0,title:"提示",message:`信件模板送出即時生效
請確認是否要送出`,onOk:()=>O(H)})};function k(){t.invalidateQueries({queryKey:[Pe.MAIL_TEMPLATE,a]}),s({open:!0,title:"提示",message:"信件創建成功"}),n("/edit/mailTemplateEdit")}function q(H){s({open:!0,title:"提示",message:H})}return i.useEffect(()=>{let H;return T&&(r({...T,variant:"update"}),f(T.isDefault),H=setTimeout(()=>{w(T.content)},0)),()=>{r(Us),clearTimeout(H)}},[T]),e.jsxs(it,{onSubmit:c(B),children:[e.jsxs(o,{gap:3,flexDirection:"row",children:[e.jsx(o,{flexDirection:"row",gap:1,alignItems:"center",flex:2,children:e.jsx(ie,{name:"templateName",label:"模板名稱",variant:"control"})}),e.jsxs(o,{flexDirection:"row",alignItems:"center",flex:1,children:[e.jsx(z,{children:"預設信件"}),e.jsx(On,{checked:E,onChange:H=>f(H.target.checked),sx:{ml:-1}})]})]}),e.jsx(je,{name:"mailType",label:"模板類型",options:bi,type:"ONE",variant:"control",labelSx:{width:"100%"}}),g===ft.CONTEST_EVENT_REWARD||g===ft.NORMAL_EVENT_REWARD?e.jsxs(o,{my:2,gap:1,width:"100%",flexDirection:"column",children:[e.jsx(o,{gap:1,flexDirection:"row",children:e.jsx(he,{children:"信件內容"})}),e.jsx(o,{gap:1,flexDirection:"row",alignItems:"flex-end",children:e.jsx("div",{ref:m,contentEditable:!0,style:{minHeight:"200px",border:"1px solid #ccc",padding:"8px",marginTop:"8px",width:"100%"}})}),e.jsx(o,{direction:"row",spacing:1,justifyContent:"space-between",width:"80%",children:y&&e.jsx(o,{direction:"row",spacing:1,children:y.map(H=>e.jsx(v,{label:H.name,onClick:()=>S(H.code),sx:{cursor:"pointer","&:hover":{backgroundColor:$.DARK_BLUE}}},H.code))})})]}):e.jsxs(o,{gap:1,flexDirection:"column",children:[e.jsx(he,{children:"信件內容"}),e.jsx("div",{ref:m,contentEditable:!0,style:{minHeight:"200px",border:"1px solid #ccc",padding:"8px",marginTop:"8px",width:"100%"}})]}),e.jsx(o,{flexDirection:"row",gap:3,justifyContent:"end",children:e.jsx(v,{label:"送出",type:"submit",btnColor:"BTN_LATTE_GRAY",sx:{alignSelf:"flex-end"}})})]})},Nh=Ah;function Oh(){return e.jsx(Eh,{children:e.jsxs(Pt,{children:[e.jsx(xe,{index:!0,element:e.jsx(kh,{})}),e.jsx(xe,{path:"/create",element:e.jsx(Th,{})}),e.jsx(xe,{path:"/update/:id",element:e.jsx(Nh,{})}),e.jsx(xe,{path:"*",element:e.jsx(_t,{to:"/edit/mailTemplateEdit",replace:!0})})]})})}const Rh=t=>d.intersection(d.object({title:fn(t,1,"主旨必填",16,"主旨不可超過16字"),content:fn(t,1,"文字內容必填"),startDate:d.date(),endDate:d.date(),startTime:d.string(),endTime:d.string(),isDraft:d.boolean()}),d.discriminatedUnion("variant",[d.object({variant:d.literal("create")}),d.object({variant:d.literal("update"),id:d.number().min(1)})])),zi={variant:"create",title:"",content:"",startDate:new Date,endDate:new Date,startTime:"00:00",endTime:"23:59",isDraft:!0},Lh=({children:t})=>{const{flag:a}=at(),n=Rh(a),s=sn({mode:"all",resolver:on(n),defaultValues:zi});return e.jsxs(rn,{...s,children:[t,!1]})},Ph=Lh,Gn=Do.create({baseURL:"https://dtgp-stage-web.aiv.com.tw/broadcaster"});Gn.interceptors.request.use(t=>{const{token:a}=Pn.getState().auth;return t.headers&&a&&(t.headers.Authorization=`Bearer ${a}`),Pn.dispatch(hs.actions.setRequestCount(1)),t},t=>Promise.reject(t));Gn.interceptors.response.use(t=>(setTimeout(()=>{Pn.dispatch(hs.actions.setRequestCount(-1))},200),t),t=>{var n,s;const a=()=>window.location.href="https://adl.edu.tw/twa/";if(((n=t.response)==null?void 0:n.status)===401)return Pn.dispatch(is.actions.setAlert({open:!0,title:"驗證有誤",message:"即將跳轉回登入頁面"})),setTimeout(a,5e3),t;if(setTimeout(()=>{Pn.dispatch(hs.actions.setRequestCount(-1))},500),t.name==="AxiosError"&&t.code==="ERR_NETWORK")return Pn.dispatch(is.actions.setAlert({open:!0,title:"連線錯誤",message:t.message})),t;if(!(t.name==="CanceledError"&&t.code==="ERR_CANCELED"))return Pn.dispatch(is.actions.setAlert({open:!0,title:"錯誤",message:((s=t.response)==null?void 0:s.data).message||t.message})),Promise.reject(t)});const Cn=class Cn{};Cn.BROADCASTER="/newsTicker",Cn.BROADCASTER_SEARCH=`${Cn.BROADCASTER}/search`,Cn.BROADCASTER_ALL=`${Cn.BROADCASTER}/all`,Cn.BROADCASTER_BY_ID=a=>`${Cn.BROADCASTER}/${a}`;let yn=Cn;async function _h(t,a){try{return(await Gn.get(yn.BROADCASTER_SEARCH,{signal:a,params:t})).data.data}catch(n){throw new Error(`getAllBroadcaster, ${n}`)}}async function Mh(t,a){try{return(await Gn.get(yn.BROADCASTER_BY_ID(t),{signal:a})).data.data}catch(n){throw new Error(`getBroadcasterById, ${n}`)}}async function Fh(t){try{return(await Gn.post(yn.BROADCASTER,t)).data.data}catch(a){throw new Error(`postCreateBroadcaster, ${a}`)}}async function Bh(t){try{return(await Gn.put(yn.BROADCASTER_BY_ID(t.id),t)).data.data}catch(a){throw new Error(`putUpdateBroadcaster, ${a}`)}}async function Hh(t){try{return(await Gn.delete(yn.BROADCASTER_BY_ID(t))).data.data}catch(a){throw new Error(`deleteBroadcaster, ${a}`)}}const $h=t=>{const a=jt(t);return Ue({queryKey:[yn.BROADCASTER_SEARCH,a],queryFn:({signal:n})=>_h(t,n)})},Gh=t=>Ue({queryKey:[yn.BROADCASTER_BY_ID(t)],queryFn:({signal:a})=>Mh(t,a),enabled:!!t}),Wh=t=>rt({mutationFn:Fh,onSuccess:t}),Yh=t=>rt({mutationFn:Bh,onSuccess:t}),Uh=t=>rt({mutationFn:Hh,onSuccess:t}),qh=()=>{const t=Me(),{setAlertOpen:a}=_e(),{setFlag:n,flag:s}=at(),{reset:r,setValue:l,handleSubmit:c}=$e(),{mutate:g}=Wh(f),m=y=>{g(y)},E=y=>{a({open:!0,title:"提示",message:s===me.DRAFT?`跑馬燈將會儲存為草稿
請確認是否要送出`:`跑馬燈送出即時生效
請確認是否要送出`,onOk:()=>m(y)})};function f(){a({open:!0,title:"提示",message:"新增跑馬燈成功"}),setTimeout(()=>{t("-1")},500)}const T=y=>{y?(n(me.DRAFT),l("isDraft",!0)):(n(me.PASS),l("isDraft",!1))};return i.useEffect(()=>{r(zi)},[]),e.jsxs(it,{onSubmit:c(E),sx:{gap:6},children:[e.jsx(ie,{name:"title",label:"主旨",variant:"control",alertText:"(僅供編輯器內辨識, 不包括於跑馬燈內文中)",tooltipSx:{width:"200px"}}),e.jsxs(o,{flexDirection:"row",gap:2,flex:1,sx:{gap:3},children:[e.jsx(ze,{name:"content",label:"跑馬燈內容",rows:10,variant:"control",stackSx:{flex:1}}),e.jsxs(o,{flexDirection:"column",gap:2,flex:1,flexWrap:"wrap",mt:4,children:[e.jsxs(o,{flexDirection:"row",gap:2,flex:1,flexWrap:"wrap",children:[e.jsx(Gt,{name:"startDate",label:"開始日期",variant:"control",labelSx:{width:"33.3%"}}),e.jsx(Gt,{name:"endDate",label:"結束日期",variant:"control",labelSx:{width:"33.3%"}})]}),e.jsx("p",{style:{color:"gray",marginTop:"-5px",marginLeft:"10px",marginRight:"auto"},children:"(跑馬燈會持續於這幾天的特定時間斷內進行撥放)"}),e.jsxs(o,{flexDirection:"row",gap:2,flex:1,flexWrap:"wrap",children:[e.jsx(ie,{name:"startTime",label:"開始時間",variant:"control"}),e.jsx(ie,{name:"endTime",label:"結束時間",variant:"control"})]}),e.jsx("p",{style:{color:"gray",marginTop:"-5px",marginLeft:"10px",marginRight:"auto"},children:"(跑馬燈會持續在每天的這個時間內撥放)"})]})]}),e.jsxs(o,{flexDirection:"row",gap:3,justifyContent:"end",children:[e.jsx(v,{label:"儲存草稿",type:"submit",sx:{alignSelf:"flex-end"},onClick:()=>T(!0)}),e.jsx(v,{label:"發佈",type:"submit",btnColor:"BTN_LATTE_GRAY",sx:{alignSelf:"flex-end"},onClick:()=>T(!1)})]})]})},Vh=qh,Kh=i.memo(({value:t,handleChange:a})=>{const n=i.useMemo(()=>[{label:"已發佈",value:!0},{label:"未發佈",value:!1}],[]),s=i.useMemo(()=>[{label:"草稿",value:!0},{label:"非草稿",value:!1}],[]),r=(l,c)=>{a(c)({target:{value:l}})};return console.log(t),e.jsxs(i.Fragment,{children:[!t.isDraft&&e.jsx(Ve,{label:"發送",options:n,value:t.isSent,onChange:a("isSent")}),e.jsx(Ve,{label:"草稿",options:s,value:t.isDraft,onChange:a("isDraft")}),e.jsxs(o,{flexDirection:"row",alignItems:"center",gap:2,children:[e.jsx(es,{label:"活動時間",value:Ie(t.startDate).toDate().getTime(),onChange:l=>r(l,"startDate")}),e.jsx(z,{variant:"h6",children:"至"}),e.jsx(an,{value:Ie(t.endDate).toDate().getTime(),onChange:l=>r(l,"endDate")})]})]})}),Qi=[{label:"主旨",value:"title"},{label:"跑馬燈文字內容",value:"content"}],va=Qi.map(t=>t.value),zh=t=>va.includes(t),Qh=()=>{const t=Me(),a=Wt(),n=yt(),{setAlertOpen:s}=_e(),r=i.useMemo(()=>{const p=new URLSearchParams(a.search),x=p.get("isSent"),h=p.get("isDraft"),I=p.get("title"),P=p.get("content"),F=p.get("startDate"),u=p.get("endDate");return{isSent:x==="true",isDraft:h==="true",page:parseInt(p.get("page")||"0",10),startDate:F?Ie(F).format("YYYY-MM-DD"):Ie(new Date).format("YYYY-MM-DD"),endDate:u?Ie(u).format("YYYY-MM-DD"):Ie(new Date).add(1,"month").format("YYYY-MM-DD"),...I&&{title:I},...P&&{content:P},size:10,sort:"create_time,desc",removed:!1}},[a.search]),l=i.useMemo(()=>{const p=Object.keys(r).find(x=>va.includes(x)&&r[x]!==void 0);return p?{searchText:r[p],currentField:p}:{searchText:"",currentField:va[0]}},[r]),[c,g]=i.useState(r),[m,E]=i.useState(l),[f,T]=i.useState(),{data:y,isSuccess:D,isLoading:S}=$h(c),{mutate:j}=Uh(O),w=i.useMemo(()=>D&&!!y,[D,y]);function O(){const p=jt(c);n.invalidateQueries({queryKey:[yn.BROADCASTER_SEARCH,p]}),q("page")(0),s({open:!0,title:"提示",message:"刪除跑馬燈成功"})}const B=i.useCallback(()=>{t("create")},[t]),k=i.useCallback(p=>{t(`update/${p}`)},[t]),q=i.useCallback(p=>x=>{let h,I;if(typeof x=="number"||typeof x=="string"||typeof x=="boolean"?h=x:h=x.target.value,zh(p)){const F={};va.forEach(u=>{u===p&&h?F[u]=h:delete c[u]}),I={...c,...F}}else I={...c,[p]:h};p!=="page"&&(I.page=0),p==="startDate"&&(I.startDate=Ie(I.startDate).format("YYYY-MM-DD")),p==="endDate"&&(I.endDate=Ie(I.endDate).format("YYYY-MM-DD"));const P=ut(ln(I));g(I),t(`?${P}`)},[t,c]),H=p=>{E(x=>({...x,searchText:p}))},G=p=>{E(x=>({...x,currentField:p}))},N=i.useCallback(()=>{const{currentField:p,searchText:x}=m;q(p)(x),T(1)},[q,m]),L=p=>{j(p)},M=p=>{s({open:!0,title:"提示",message:`確認要刪除主旨: ${p==null?void 0:p.title} 跑馬燈嗎`,onOk:()=>L(p.id)})},Y=i.useCallback((p,x)=>{q("page")(String(x-1)),T(x)},[q]),U=i.useCallback(()=>{f&&g(p=>({...p,page:Number(f)-1}))},[f,g]),A=[{title:"操作",dataField:"id",width:"200px",component:p=>e.jsxs(o,{flexDirection:"row",gap:2,children:[e.jsx(v,{label:"編輯",onClick:()=>k(p.id),btnColor:"TAB_BLUE"}),e.jsx(v,{label:"刪除",btnColor:"CANCEL_RED",onClick:()=>M(p)})]})},{title:"狀態",dataField:"isSent",component:p=>e.jsx(z,{variant:"h5",children:p.isSent?"已發佈":"未發佈"})},{title:"主旨",dataField:"title",width:"250px"},{title:"跑馬燈文字內容",dataField:"content",width:"250px",component:p=>e.jsxs(z,{variant:"h5",children:[p.content.slice(0,10),"..."]})},{title:"創建者",dataField:"creator"},{title:"開始和結束日期",dataField:"startDate",component:p=>e.jsx(z,{variant:"h5",children:Ie(p.startDate).format("YYYY-MM-DD")+" ~ "+Ie(p.endDate).format("YYYY-MM-DD")})},{title:"每日開始時間",dataField:"startTime",component:p=>e.jsx(z,{variant:"h5",children:p.startTime})},{title:"每日結束時間",dataField:"endTime",component:p=>e.jsx(z,{variant:"h5",children:p.endTime})}];return e.jsxs(o,{flex:1,gap:5,children:[e.jsx(v,{label:"創建跑馬燈",onClick:B,sx:{ml:"auto"},btnColor:"BLUE"}),e.jsx(o,{flexDirection:"row",gap:4,alignItems:"center",justifyContent:{xs:"center",sm:"flex-start"},flexWrap:"wrap",px:3,children:e.jsxs(o,{flexDirection:"row",gap:4,flexWrap:"wrap",justifyContent:{xs:"center",sm:"flex-start"},alignItems:"center",children:[e.jsx(Kh,{value:c,handleChange:q}),e.jsx(vt,{value:m,options:Qi,selectOnChange:G,inputOnChange:H,searchFuntion:N}),e.jsx(v,{label:"搜尋",onClick:N,btnColor:"BROWN"})]})}),S?e.jsx(Ge,{}):e.jsx(o,{children:y&&e.jsx(lt,{isVisible:w,children:e.jsxs(o,{p:.5,alignItems:"center",gap:5,children:[e.jsx(Tt,{columns:A,rows:y.content}),e.jsx(Yt,{totalPages:y.totalPages,currentPage:y.pageable.pageNumber,inputPage:f??1,setInputPage:T,handlePageChange:Y,handlePageSearch:U})]})},JSON.stringify(c))})]})},Xh=Qh,Jh=()=>{const t=Lt(),a=Me(),{setAlertOpen:n}=_e(),{setFlag:s}=at(),{data:r,isError:l,isLoading:c}=Gh(parseInt(t.id)),{reset:g,setValue:m,handleSubmit:E,formState:{errors:f}}=$e(),{mutate:T}=Yh(S),y=w=>{T({...w,id:parseInt(t.id)})},D=w=>{n({open:!0,title:"提示",message:`跑馬燈送出即時生效
請確認是否要送出`,onOk:()=>y(w)})};function S(){n({open:!0,title:"提示",message:"更新跑馬燈成功"}),setTimeout(()=>{a("-1")},500)}const j=w=>{w?(s(me.DRAFT),m("isDraft",!0)):(s(me.PASS),m("isDraft",!1))};return i.useEffect(()=>{l&&(n({open:!0,title:"取得跑馬燈失敗"}),a("/edit/marqueeEdit")),r&&g({...r,variant:"update",startDate:new Date(r.startDate),endDate:new Date(r.endDate),startTime:r.startTime,endTime:r.endTime})},[r]),e.jsx(it,{onSubmit:E(D),sx:{gap:6},children:c?e.jsx(Ge,{}):e.jsxs(e.Fragment,{children:[e.jsx(ie,{name:"title",label:"主旨",variant:"control",alertText:"(僅供編輯器內辨識, 不包括於跑馬燈內文中)",tooltipSx:{width:"200px"}}),e.jsxs(o,{flexDirection:"row",gap:2,flex:1,flexWrap:"wrap",sx:{gap:3},children:[e.jsx(ze,{name:"content",label:"跑馬燈內容",rows:10,variant:"control",stackSx:{flex:1}}),e.jsxs(o,{flexDirection:"column",gap:2,flex:1,flexWrap:"wrap",mt:4,children:[e.jsxs(o,{flexDirection:"row",gap:2,flex:1,flexWrap:"wrap",children:[e.jsx(Gt,{name:"startDate",label:"開始日期",variant:"control",labelSx:{width:"33.3%"}}),e.jsx(Gt,{name:"endDate",label:"結束日期",variant:"control",labelSx:{width:"33.3%"}})]}),e.jsx("p",{style:{color:"gray",marginTop:"-5px",marginLeft:"10px",marginRight:"auto"},children:"(跑馬燈會持續於這幾天的特定時間斷內進行撥放)"}),e.jsxs(o,{flexDirection:"row",gap:2,flex:1,flexWrap:"wrap",children:[e.jsx(ie,{name:"startTime",label:"開始時間",variant:"control"}),e.jsx(ie,{name:"endTime",label:"結束時間",variant:"control"})]}),e.jsx("p",{style:{color:"gray",marginTop:"-5px",marginLeft:"10px",marginRight:"auto"},children:"(跑馬燈會持續在每天的這個時間內撥放)"})]})]}),e.jsxs(o,{flexDirection:"row",gap:3,justifyContent:"end",children:[r!=null&&r.isDraft?e.jsx(v,{label:"儲存草稿",type:"submit",sx:{alignSelf:"flex-end"},onClick:()=>j(!0)}):e.jsx(e.Fragment,{}),e.jsx(v,{label:"發佈",type:"submit",btnColor:"BTN_LATTE_GRAY",sx:{alignSelf:"flex-end"},onClick:()=>j(!1)})]})]})})},Zh=Jh;function ex(){return e.jsx(Ph,{children:e.jsxs(Pt,{children:[e.jsx(xe,{index:!0,element:e.jsx(Xh,{})}),e.jsx(xe,{path:"/create",element:e.jsx(Vh,{})}),e.jsx(xe,{path:"/update/:id",element:e.jsx(Zh,{})}),e.jsx(xe,{path:"*",element:e.jsx(_t,{to:"/edit/marqueeEdit",replace:!0})})]})})}const Xi=[{label:"知識卡名稱",value:"name"},{label:"知識卡內容",value:"description"},{label:"外部連結(名稱)",value:"hyperlinkName"}],Cs=Xi.map(t=>t.value),tx=t=>Cs.includes(t),Ji=i.memo(()=>{const{cardList:t,addNewCard:a,removeCard:n,cardSelectDialogOpen:s,setCardSelectDialogOpen:r}=ya(),{userInfo:l}=xt(),[c,g]=i.useState({...cn,subjectId:0,type:0,page:0,flag:5,onlySelf:!1}),[m,E]=i.useState(null),[f,T]=i.useState({searchText:"",currentField:Cs[0]}),[y,D]=i.useState(!1),{data:S,isSuccess:j,isLoading:w}=Nr(c),O=i.useMemo(()=>j&&!!S.content.length,[j,S]),B=i.useCallback(p=>x=>{let h,I;if(typeof x=="number"||typeof x=="string"||typeof x=="boolean"?h=x:h=x.target.value,tx(p)){const P={};Cs.forEach(F=>{F===p&&h?P[F]=h:delete c[F]}),I={...c,...P}}else I={...c,[p]:h};p!=="page"&&(I.page=0),g(I)},[c]),k=i.useCallback((p,x)=>{B("page")(x-1)},[B]),q=i.useCallback(p=>{E(p),D(!0)},[]),H=i.useCallback(()=>{D(!1),E(null)},[]),G=()=>{r(!1)},N=p=>t.some(x=>x.id===p),L=p=>{T(x=>({...x,searchText:p}))},M=p=>{T(x=>({...x,currentField:p}))},Y=p=>{B("onlySelf")(p)},U=()=>{const{currentField:p,searchText:x}=f;B(p)(x)},A=[{title:"",dataField:"id",component:p=>N(p.id)?e.jsx(v,{label:"移除",onClick:()=>n(p.id),btnColor:"CANCEL_RED",disabled:p.teacherData.name!=(l==null?void 0:l.adlName)&&p.flag==me.IN_SCHOOL}):e.jsx(v,{label:"選擇",onClick:()=>a(p),disabled:p.teacherData.name!=(l==null?void 0:l.adlName)&&p.flag==me.IN_SCHOOL})},{title:"卡片名稱",dataField:"name",width:"20%"},{title:"科目",dataField:"subjectId",component:p=>e.jsx(z,{variant:"h5",children:p.subject?p.subject.value:"無"})},{title:"知識卡類別",dataField:"type",component:p=>{var x;return e.jsx(z,{variant:"h5",children:((x=za[p.type-1])==null?void 0:x.label)??"無"})}},{title:"校名",dataField:"schoolId",width:"20%",component:p=>e.jsx(z,{variant:"h5",children:p.school.schoolName})},{title:"出題者",dataField:"id",component:p=>e.jsx(z,{variant:"h5",children:p.teacherData.name})},{title:"狀態",dataField:"flag",component:p=>{var x;return e.jsx(z,{variant:"h5",children:(x=Nn[p.flag-1])==null?void 0:x.label})}},{title:"編輯/檢視",dataField:"id",component:p=>e.jsx(v,{label:"檢視",onClick:()=>q(p),btnColor:"BTN_LATTE_GRAY"})}];return e.jsxs(i.Fragment,{children:[y&&m&&e.jsx(Rr,{cardDetail:m,open:y,onClose:H}),e.jsxs(zt,{open:s,fullScreen:!0,onClose:G,sx:{p:4},PaperProps:{sx:{p:4}},children:[e.jsxs(Qt,{sx:{textAlign:"center",fontSize:36},id:"customized-dialog-title",children:["可選擇卡片列表",e.jsxs(o,{flexDirection:"row",gap:5,alignItems:"center",justifyContent:{xs:"center",sm:"flex-start"},flexWrap:"wrap",px:3,children:[e.jsx(Or,{handleChange:B,value:c,isSchoolAndPass:!0}),e.jsxs(o,{flexDirection:"row",gap:5,flexWrap:"wrap",justifyContent:{xs:"center",sm:"flex-start"},alignItems:"center",children:[e.jsx(vt,{check:c.onlySelf,value:f,options:Xi,selectOnChange:M,inputOnChange:L,checkBoxOnChange:Y,searchFuntion:U}),e.jsx(v,{label:"搜尋",onClick:U,btnColor:"BROWN"})]})]})]}),e.jsx(dn,{dividers:!0,children:w?e.jsx(Ge,{}):e.jsx(o,{children:S&&e.jsx(lt,{isVisible:O,children:e.jsxs(o,{p:.5,alignItems:"center",gap:5,children:[e.jsx(Tt,{columns:A,rows:S.content}),e.jsx(bn,{count:S.totalPages,page:S.pageable.pageNumber+1,onChange:k,color:"primary"})]})},JSON.stringify(c))})}),e.jsx(v,{label:"關閉",color:"error",sx:{position:"absolute",top:5,right:5},onClick:G})]})]})}),Zi=()=>{const{cardDialogOpen:t,setCardDialogOpen:a}=ya(),n=()=>{a(!1)};return e.jsx(Lr,{children:e.jsx(zt,{open:t,fullScreen:!0,onClose:n,sx:{p:6},PaperProps:{sx:{p:6}},children:e.jsx(pi,{isOpenInMission:!0})})})},eo=/\$\[\[([^\]]*)\]\]/g;function nx(t){let a;do a=t,t=t.replace(eo,(n,s)=>s);while(a!==t);return t}function ax(t){return t.replace(eo,(a,n)=>"$[["+nx(n)+"]]")}const sx=()=>{const t=Me(),a=yt(),{setAlertOpen:n}=_e(),{userInfo:s}=xt(),{mutate:r}=cl(Z),{data:l}=ja(),{data:c}=Ds(),{data:g}=_r(),m=i.useRef(null),E=i.useRef(null),f=i.useRef(null),{setFlag:T}=at(),{setCardDialogOpen:y,setCardSelectDialogOpen:D,cardList:S,setCardList:j,removeCard:w}=ya(),{missionSelectedImage:O,setMissionSelectedImage:B,setDeleteMissionImage:k,setSelectedType:q}=Rt(),[H,G]=i.useState(!1),N=i.useRef(null),{reset:L,control:M,setValue:Y,handleSubmit:U,unregister:A,formState:{errors:p},trigger:x}=$e(),h=Be({control:M,name:"description"}),I=Be({control:M,name:"mainSubjectId"}),P=Be({control:M,name:"subjectIds"}),F=ae=>{if(!s)return;const ce={...ae,cardIds:ae.cardIds.map(ye=>ye.id),missionAnswerCardSet:ae.missionAnswerCardSet.map(ye=>({...ye,hint:ye.answerHint})),missionAdditionalHyperlinkSet:ae.missionAdditionalHyperlinkSet.map((ye,Re)=>({...ye,orderNum:Re+1})),picIds:ae.picIds.filter(ye=>ye!=0).map((ye,Re)=>({picId:ye,orderNum:Re+1}))};r(ce)},u=ae=>{T(ae),Y("flag",ae)},_=ae=>{n({open:!0,title:"提示",message:"按下確認表示您已經確認所編輯的任務內容文字與所上傳圖片沒有違反智慧財產權疑慮",onOk:()=>F(ae)})};function Z(ae){a.invalidateQueries({queryKey:[Fr.MISSION_ID(ae.id)]}),ae.flag===me.UNAUDITED?n({open:!0,title:"送審提示",message:"感謝您對於遊戲的貢獻! 任務已經送出至審核，審通過後會將由遊戲教學設計團隊微調後進入遊戲資料庫中供大家挑戰! 若有不完整或審查意見需要調整，將再通知您補充調整，謝謝!"}):n({open:!0,title:"創建提示",message:"創建任務成功"}),t("/edit/missionEdit")}const C=()=>l?l.filter(ae=>ae.value!="全科目").map(ae=>({label:ae.value,value:ae.id})):[],V=()=>l?l.filter(ae=>ae.value!=="全科目"&&ae.id!==I).map(ae=>({label:ae.value,value:ae.id})):[],se=()=>c?c.map(ae=>({label:ae.century,value:ae.id})):[],X=()=>s?s.schoolDtoList.map(ae=>({label:ae.schoolName,value:ae.id})):[],R=()=>g?g.map(ae=>({label:ae,value:ae})):[],b=()=>{G(!0)},W=()=>{Y("subjectIds",[]),G(!1)},le=()=>{y(!0)},ne=()=>{D(!0)},Q=ae=>{He(We(ae)),w(ae)};i.useEffect(()=>{if(O){const ae=O.map(ce=>ce.id);Y("picIds",ae,{shouldValidate:!0})}},[O,Y]),i.useEffect(()=>{const ae=S.map(ce=>({id:ce.id,type:ce.type}));Y("cardIds",ae,{shouldValidate:!0}),Ce.forEach((ce,ye)=>{ae.some(Re=>Re.id===ce.cardId)||He(ye)})},[S,Y]),i.useEffect(()=>(L(xs),q("MISSION"),s&&Y("schoolId",s.schoolDtoList[0].id),()=>{B(null),j([]),L(xs),A("missionAnswerCardSet")}),[]);const pe=()=>e.jsxs(i.Fragment,{children:[e.jsx(v,{label:"增加學科",disabled:H,onClick:b,btnColor:"BTN_LATTE_GRAY"}),H&&e.jsxs(o,{flexDirection:"row",gap:2,alignItems:"center",children:[e.jsx(je,{name:"subjectIds",label:"學科",options:V(),type:"ONE",variant:"control",multiple:!0,alertText:"最多可新增四科其它學科。 (可複選)"}),e.jsx(v,{label:"刪除",onClick:W,btnColor:"CANCEL_RED"})]})]}),ee=()=>{const{fields:ae,append:ce,remove:ye}=It({control:M,name:"missionAdditionalHyperlinkSet"}),Re=()=>{ce({name:"",hyperlink:"",adl:!1})};return e.jsx(et,{name:"missionAdditionalHyperlinkSet",control:M,render:()=>e.jsxs(i.Fragment,{children:[ae.map((dt,kt)=>e.jsxs(o,{flexDirection:"row",alignItems:"flex-start",gap:1,children:[e.jsx(ie,{name:`missionAdditionalHyperlinkSet.${kt}.name`,label:"連結名稱",variant:"control"}),e.jsx(ie,{name:`missionAdditionalHyperlinkSet.${kt}.hyperlink`,label:"連結",variant:"control"}),e.jsx(v,{label:"刪除",onClick:()=>ye(kt),btnColor:"CANCEL_RED"})]},dt.id)),e.jsx(v,{label:"增加資訊",onClick:Re,btnColor:"BTN_LATTE_GRAY",disabled:ae.length>=2})]})})},de=()=>{const ae=()=>{B({src:"",id:0},O?O.length:0)},ce=ye=>{k(ye)};return e.jsxs(o,{gap:2,children:[O==null?void 0:O.map((ye,Re)=>{var dt;return e.jsxs(i.Fragment,{children:[e.jsxs(o,{flexDirection:"row",alignItems:"center",justifyContent:"space-around",width:"100%",gap:1,children:[e.jsx($t,{title:"多媒體圖片",name:"picIds",index:Re}),e.jsx(v,{label:"刪除",btnColor:"CANCEL_RED",onClick:()=>ce(Re)})]}),((dt=O[Re])==null?void 0:dt.src)&&e.jsx(Dt,{styleType:"formImage",src:O[Re].src})]},`${ye.id}_${Re}`)}),e.jsx(v,{label:"增加多媒體圖片",btnColor:"BTN_LATTE_GRAY",onClick:ae,disabled:O?O.length>=3:!1,maxWidth:200})]})},{fields:Ce,append:ue,remove:Se,move:Ae}=It({control:M,name:"missionAnswerCardSet"}),Ee=async ae=>{ue({cardId:ae.id,keyWord:"",answerHint:"",orderNum:Ce.length+1,cardType:ae.type}),await x("cardIds")},We=ae=>Ce.findIndex(ce=>ce.cardId===ae),He=ae=>{ae!==-1&&Se(ae)},Fe=ae=>Ce.some(ce=>ce.cardId===ae),J=ae=>{const ce=S.find(ye=>ye.id===ae.cardId.cardId);return e.jsx(e.Fragment,{children:ce&&e.jsx(pa,{cardDetail:ce})})},oe=ae=>{ae.destination&&Ae(ae.source.index,ae.destination.index)},Ne=()=>{Ce.forEach((ae,ce)=>{Y(`missionAnswerCardSet.${ce}.orderNum`,ce+1,{shouldValidate:!0})})},te=()=>{const ae=N.current;if(!ae)return;const ce=ae.selectionStart,ye=ae.selectionEnd;if(ce===null||ye===null||ce===ye)return;const Re=h.slice(ce,ye);if(Re.includes("$[[")&&Re.trim().endsWith("$[[")||Re.includes("]]")&&Re.trim().startsWith("]]"))return;if(Re.includes("]]")&&Re.includes("$[[")){const nt=Re.indexOf("]]"),st=Re.indexOf("$[[");if(nt<st)return}const dt=h.slice(0,ce),kt=h.slice(ye),At=`${dt}${"$[["+Re+"]]"}${kt}`,bt=ax(At);Y("description",bt),setTimeout(()=>{const nt=ce+4+Re.length;ae.selectionStart=ae.selectionEnd=nt},0)},ge=()=>{const ae=N.current;if(!ae)return;const ce=ae.selectionStart,ye=ae.selectionEnd;if(ce===null||ye===null||ce===ye)return;const Re=h.slice(ce,ye);if(Re.startsWith("$[[")&&Re.endsWith("]]")){const dt=Re.slice(3,-2),kt=h.slice(0,ce),At=h.slice(ye),bt=`${kt}${dt}${At}`;Y("description",bt),setTimeout(()=>{const nt=ce;ae.selectionStart=ae.selectionEnd=nt},0)}};i.useEffect(()=>{if(I){const ae=P.filter(ce=>ce!==I);Y("subjectIds",ae)}},[I]),i.useEffect(()=>{Ne()},[Ce]);const Oe=ae=>{Object.keys(ae).length&&Object.keys(ae).forEach(ce=>{var ye,Re,dt;ce==="answerDescription"?(ye=m.current)==null||ye.scrollIntoView({behavior:"smooth"}):ce==="cardIds"?(Re=E.current)==null||Re.scrollIntoView({behavior:"smooth"}):ce==="missionAnswerCardSet"?(dt=f.current)==null||dt.scrollIntoView({behavior:"smooth"}):window.scrollTo({top:0,behavior:"smooth"})})},De=({type:ae})=>e.jsxs(o,{gap:3,flexDirection:"row",flexWrap:"wrap",sx:{border:`1px solid ${$.TAB_BG_GRAY}`,p:3},children:[e.jsx(z,{variant:"h6",sx:{fontWeight:"bold"},children:`${Mr(ae)}`}),S.map(ce=>ce.type===ae&&e.jsxs(o,{alignItems:"center",children:[e.jsx(On,{disabled:Ce.length>=6&&!Fe(ce.id),checked:Fe(ce.id),onChange:ye=>{ye.target.checked?Ee(ce):He(We(ce.id))}}),e.jsx(pa,{cardDetail:ce,onRemoveClick:()=>Q(ce.id)})]},ce.id))]});return e.jsxs(o,{p:2,justifyContent:"center",alignItems:"center",width:"100%",children:[e.jsxs(it,{onSubmit:U(_,Oe),children:[e.jsxs(K,{container:!0,spacing:6,wrap:"wrap",children:[e.jsx(K,{item:!0,sm:12,lg:6,children:e.jsxs(o,{gap:1,children:[e.jsx(ie,{name:"name",label:"任務名稱",variant:"control",alertText:"字數限制：52字(必填)"}),e.jsx(je,{name:"schoolId",label:"學校",options:X(),type:"ONE",variant:"control",alertText:"必填"}),e.jsx(je,{name:"mainSubjectId",label:"主要學科",options:C(),type:"ONE",variant:"control",alertText:"必填"}),e.jsx(pe,{}),e.jsx(ie,{name:"syllabus",label:"課綱",variant:"control"}),e.jsx(je,{name:"level",label:"等級",options:R(),type:"ONE",variant:"control",alertTextList:["1~12(小一至高三，1=小一，7=國一，10=高一，以此類推。","A：上學期期中考前","B：上學期期中考後","C：下學期期中考前","D：下學期期中考後","(必填)"]}),e.jsx(ie,{name:"area",label:"地點",variant:"control",alertTextList:["1. 請輸入事件發生地點(大可為「臺灣」，小可為「台北市大安區學府里」)。","2. 請一半題目地點為台灣本土，一半為台灣之外的世界地區。","3. 若正確知識卡涉及任務地點，建議此格以較為模糊的方式描述。","(必填)"]}),e.jsx(je,{name:"centuryId",label:"世紀",options:se(),type:"ONE",variant:"control",alertTextList:["1. 西元前：請統一選「西元前」。","2. 西元後：請依照線索文本情境，選擇該世紀。","(必填)"]}),e.jsxs(o,{flexDirection:"row",alignItems:"center",justifyContent:"space-between",children:[e.jsx(Sn,{labelTitle:"線索文本",tooltipSx:{maxWidth:"1000px"},alertTextList:["※字數限制：","中文-300字內，含標點符號。","英文-200字內，含標點符號。","1. 整個線索文本的多張卡片中至少對應到1-2個關鍵字，以 $[[]] 標示。且至少有一張卡片需要對應到2個關鍵字。","2. 情境以第三人稱視角(攝影機視角)呈現，描述眼前看到、聽到的人事物。","3. 情境中不會直接出現人名、地名、建築名稱。起始可以用：'看到一個人在...' 或 '有一座鐵塔...'作為開頭。※若為社會科可酌情放寬使用地名，但請盡量避免直接使用人名。","4. 時間跨度不宜太長，如：那裡的士兵戰鬥了10年，因為情境看到的是當下發生的事情，故不會跨越10年。可調整為：有一個長者正在講述一個關於戰爭的故事，他說：「那裡的士兵戰鬥了10年」。","(必填)"]}),e.jsxs(o,{flexDirection:"row",alignItems:"center",gap:3,children:[e.jsx(v,{label:"新增為關鍵字",onClick:te}),e.jsx(v,{label:"移除關鍵字",btnColor:"CANCEL_RED",onClick:ge})]})]}),e.jsxs(o,{ref:m,gap:3,children:[e.jsx(Tr,{ref:N,name:"description",rows:8}),e.jsx(ze,{name:"answerDescription",label:"解答說明",rows:4,variant:"control",alertText:"包含答案與解說，數學要有運算過程。總字數限定3000字 (必填)"})]})]})}),e.jsx(K,{item:!0,sm:12,lg:6,flexDirection:"column",children:e.jsxs(o,{gap:2,children:[e.jsx(ze,{name:"note",label:"編輯者註解",rows:13,variant:"control"}),e.jsx(Sn,{labelSx:{flex:2},labelTitle:"多媒體補充資訊",alertTextList:["1. 網址或圖片格式，網址最多2個，圖片最多3張。","2. 隨著題目本身補充的資訊內容、圖片、以及說明文字。"]}),e.jsx(ee,{}),e.jsx(de,{}),e.jsx(ie,{name:"missionHintSet.0.hint",label:"整體鷹架提示1",variant:"control",alertTextFlex:5,alertText:"針對整題的情境額外的提示，於發動特定戰寵卡時提供。每個鷹架提示限定25字 (必填)"}),e.jsx(ie,{name:"missionHintSet.1.hint",label:"整體鷹架提示2",variant:"control",alertTextFlex:5,alertText:"針對整題的情境額外的提示，於發動特定戰寵卡時提供。每個鷹架提示限定25字 (必填)"}),e.jsx(ie,{name:"missionHintSet.2.hint",label:"整體鷹架提示3",variant:"control",alertTextFlex:5,alertText:"針對整題的情境額外的提示，於發動特定戰寵卡時提供。每個鷹架提示限定25字 (必填)"}),e.jsx(o,{ref:E})]})})]}),e.jsxs(o,{flexDirection:"row",gap:3,alignItems:"center",children:[e.jsx(Sn,{labelTitle:"已選擇卡牌區",alertTextList:["1. 數量限制：正確知識卡至少3張，最多6張。","2. 卡片總數: 8+(正確知識卡數)張。","(必填)"],placement:"top"}),e.jsx(v,{label:"選擇卡片",type:"button",onClick:ne}),e.jsx(v,{label:"創建卡片",type:"button",btnColor:"BTN_LATTE_GRAY",onClick:le}),e.jsx(un,{title:e.jsx("div",{style:{fontSize:"1rem"},children:["人物卡：特定歷史人物、當代人物、或情境故事中的角色","概念卡：原理、原則概念、包含社會科學與自然科學的各種概念","事件卡：特定歷史事件或故事情境中的事件","地點卡：特定地理位置、或情境故事中的場景與地點","時間卡：特定年代、日期、時間、世紀等時間或時間區間","數字卡：數值","現象卡：特定自然現象或社會現象或趨勢","符號卡：數學符號、單位符號、各種符號、包含語言符號","語文卡：中英語詞、修辭詞彙、成語諺語、詩詞歌賦等","物件卡：物體、工具、物品等具象的實物"].map((ae,ce)=>e.jsx("p",{children:ae},ce))}),componentsProps:{tooltip:{sx:{maxWidth:"1200px"}}},sx:{backgroundColor:$.CURRY,color:$.WHITE,p:1,borderRadius:2,fontWeight:800,letterSpacing:1,cursor:"pointer"},disableInteractive:!0,placement:"top",children:e.jsx(z,{children:"知識卡類別說明"})})]}),!!p.cardIds&&e.jsx(ht,{sx:{textAlign:"center",color:$.CANCEL_RED,fontSize:"1.5rem"},children:p.cardIds.message}),!!p.missionAnswerCardSet&&e.jsx(ht,{sx:{textAlign:"center",color:$.CANCEL_RED,fontSize:"1.5rem"},children:p.missionAnswerCardSet.message}),e.jsx(et,{name:"cardIds",control:M,render:()=>e.jsxs(o,{gap:3,flexWrap:"wrap",sx:{border:`1px solid ${$.TAB_BG_GRAY}`,p:3},children:[e.jsx(De,{type:gt.PEOPLE}),e.jsx(De,{type:gt.EVENT}),e.jsx(De,{type:gt.TIME}),e.jsx(De,{type:gt.AREA}),e.jsx(De,{type:gt.OBJECT}),e.jsx(De,{type:gt.LANGUAGE}),e.jsx(De,{type:gt.NUMBER}),e.jsx(De,{type:gt.SYMBOL}),e.jsx(De,{type:gt.CONCEPT}),e.jsx(De,{type:gt.PHENOMENON})]})}),e.jsx(et,{name:"missionAnswerCardSet",control:M,render:()=>e.jsx(K,{item:!0,sm:12,ref:f,children:e.jsx(o,{gap:3,children:e.jsx(ks,{onDragEnd:oe,children:e.jsx(As,{droppableId:"droppable",children:ae=>e.jsxs(o,{ref:ae.innerRef,...ae.droppableProps,gap:3,children:[Ce.map((ce,ye)=>e.jsx(Ns,{draggableId:ce.id,index:ye,children:Re=>e.jsx(o,{ref:Re.innerRef,...Re.draggableProps,...Re.dragHandleProps,children:e.jsxs(o,{flexDirection:"row",gap:3,sx:{border:"1px solid #aaa",p:3,bgcolor:"white"},children:[e.jsxs(o,{flex:2.5,gap:2,children:[e.jsx(ie,{name:`missionAnswerCardSet.${ye}.keyWord`,label:"卡片線索說明",variant:"control",alertTextFlex:7,alertText:"於置牌區顯示予玩家出牌引導。(必填)"}),e.jsx(o,{flexDirection:"row",gap:2,children:e.jsxs(he,{children:["正確卡片",ye+1]})})]}),e.jsx(o,{flex:1,alignItems:"center",gap:1,children:e.jsx(J,{cardId:ce})}),e.jsx(o,{flex:2.5,gap:1,children:e.jsx(ie,{name:`missionAnswerCardSet.${ye}.answerHint`,label:"答案卡鷹架提示",variant:"control",alertTextFlex:7,alertText:"25字內，含標點符號。(必填)"})})]})})},ce.id)),ae.placeholder]})})})})})}),e.jsxs(o,{flexDirection:"row",gap:3,justifyContent:"end",children:[e.jsx(v,{label:"提交審核",type:"submit",sx:{alignSelf:"flex-end"},onClick:()=>u(me.UNAUDITED)}),e.jsx(v,{label:"校內發佈",type:"submit",sx:{alignSelf:"flex-end"},btnColor:"BTN_LATTE_GRAY",onClick:()=>u(me.IN_SCHOOL)}),e.jsx(v,{label:"儲存草稿",type:"submit",sx:{alignSelf:"flex-end"},btnColor:"DRAWER_GRAY",onClick:()=>u(me.DRAFT)})]})]}),e.jsx(Ji,{}),e.jsx(Zi,{})]})},rx=sx,to=[{label:"關鍵字",value:"keyword"},{label:"線索文本",value:"description"},{label:"任務名稱",value:"name"},{label:"關卡碼",value:"stageCode"},{label:"校名",value:"schoolName"},{label:"命題者",value:"author"}],ka=to.map(t=>t.value),ix=t=>ka.includes(t),ox=()=>{const t=Me(),a=Wt(),{getSubjectLabels:n}=ti(),{userInfo:s,permissions:r,role:l}=xt(),c=i.useMemo(()=>r&&l===tt.ROLE_ADMIN,[r,l]),g=i.useMemo(()=>r&&l===tt.ROLE_MANAGER,[r,l]),m=i.useMemo(()=>{const b=new URLSearchParams(a.search),W=b.get("keyword"),le=b.get("description"),ne=b.get("name"),Q=b.get("stageCode"),pe=b.get("schoolName"),ee=b.get("author"),de=b.get("updateTimeStartTime"),Ce=b.get("updateTimeEndTime");return{subjectId:parseInt(b.get("subjectId")??"0",10),grade:parseInt(b.get("grade")??"0",10),centuryId:parseInt(b.get("centuryId")??"0",10),area:b.get("area")??"全選",flag:parseInt(b.get("flag")??"0",10),page:parseInt(b.get("page")??"0",10),onlySelf:b.get("onlySelf")==="true",...W&&{keyword:W},...le&&{description:le},...ne&&{name:ne},...Q&&{stageCode:Q},...pe&&{schoolName:pe},...ee&&{author:ee},...de&&{updateTimeStartTime:parseInt(de,10)},...Ce&&{updateTimeEndTime:parseInt(Ce,10)},...cn}},[a.search]),E=i.useMemo(()=>{const b=Object.keys(m).find(W=>ka.includes(W)&&m[W]!==void 0);return b?{searchText:m[b],currentField:b}:{searchText:"",currentField:ka[0]}},[m]),[f,T]=i.useState(m),[y,D]=i.useState(E),[S,j]=i.useState(null),[w,O]=i.useState(!1),[B,k]=i.useState(!1),[q,H]=i.useState(!1),[G,N]=i.useState(),{data:L,isSuccess:M,isLoading:Y}=Ar(f),{data:U}=Ka({id:S??0}),A=i.useMemo(()=>M&&!!L.content.length,[M,L]),p=i.useCallback(()=>{t("createMission")},[t]),x=i.useCallback(b=>{t(`updateMission/${b}`)},[t]),h=i.useCallback(b=>{j(b),O(!0)},[]),I=i.useCallback(b=>W=>{let le,ne;if(typeof W=="number"||typeof W=="string"||typeof W=="boolean"?le=W:le=W.target.value,ix(b)){const pe={};ka.forEach(ee=>{ee===b&&le?pe[ee]=le:delete f[ee]}),ne={...f,...pe}}else ne={...f,[b]:le};b!=="page"&&(ne.page=0);const Q=ut(ne);T(ne),t(`?${Q}`)},[t,f]),P=i.useCallback((b,W)=>{I("page")(String(W-1)),N(W)},[I]),F=i.useCallback(()=>{G&&T(b=>({...b,page:Number(G)-1}))},[G,T]),u=i.useCallback(()=>{O(!1)},[]),_=b=>{D(W=>({...W,searchText:b}))},Z=b=>{D(W=>({...W,currentField:b}))},C=b=>{I("onlySelf")(b)},V=i.useCallback(()=>{const{currentField:b,searchText:W}=y;I(b)(W),N(1)},[I,y]),se=()=>{k(!B)},X=(b,W)=>{W&&(b==="updateTimeStartTime"?I(b)(Ie(W).startOf("day").valueOf()):b==="updateTimeEndTime"?I(b)(Ie(W).endOf("day").valueOf()):I(b)(Ie(W).valueOf()))},R=[{title:"編輯/檢視",dataField:"id",width:"150px",component:b=>e.jsxs(o,{gap:2,flexDirection:"row",children:[s&&e.jsx(v,{label:"編輯",onClick:()=>x(b.id),btnColor:"TAB_BLUE",disabled:!c&&(g?!(b.flag===me.PASS||b.teacherData.name===s.adlName):!(b.flag!==me.PASS&&b.teacherData.name===s.adlName))}),e.jsx(v,{label:"檢視",onClick:()=>h(b.id),btnColor:"BTN_LATTE_GRAY"})]})},{title:"任務名稱",dataField:"name",width:"250px",component:b=>e.jsx(z,{variant:"h5",children:b.name?b.name.length>16?b.name.slice(0,16)+"...":b.name:"無"})},{title:"任務內容",dataField:"description",width:"250px",component:b=>{var W;return e.jsx(z,{variant:"h5",children:b!=null&&b.description?((W=b.description)==null?void 0:W.replace(/\${{([^{}]*)}}/g,"$1").slice(0,16))+"...":"無"})}},{title:"關卡碼",dataField:"id",width:"250px",component:b=>{const W=B?b.stageCodeList.join(" , "):b.stageCodeList.slice(0,3).join(" , ")+(b.stageCodeList.length>3?" ...":"");return e.jsxs(o,{flexDirection:"row",alignItems:"center",justifyContent:"center",gap:3,children:[e.jsx(z,{variant:"h5",children:b.stageCodeList.length>0?W:"無"}),b.stageCodeList.length>3&&e.jsx(v,{onClick:se,label:B?"-":"+"})]})}},{title:"等級",dataField:"level",width:"120px"},{title:"世紀",dataField:"century",width:"150px",component:b=>e.jsx(z,{variant:"h5",children:b.century?b.century.century:"無"})},{title:"地點",dataField:"area",width:"150px"},{title:"主要學科",dataField:"mainSubject",width:"180px",component:b=>e.jsx(z,{variant:"h5",children:b.mainSubject?b.mainSubject.value:"無"})},{title:"次要學科",dataField:"subjectIds",width:"200px",component:b=>e.jsx(z,{variant:"h5",children:b.subjectIds.length>0?n(b==null?void 0:b.subjectIds):"無"})},{title:"校名",dataField:"school",width:"300px",component:b=>e.jsx(z,{variant:"h5",children:b.school.schoolName})},{title:"命題者",dataField:"teacherData",width:"120px",component:b=>e.jsx(z,{variant:"h5",children:b.teacherData.name})},{title:"狀態",dataField:"flag",width:"150px",component:b=>e.jsx(z,{variant:"h5",children:Nn[b.flag-1].label})},{title:"建立時間",dataField:"createTime",width:"240px",component:b=>e.jsx(z,{sx:{textWrap:"nowrap"},variant:"h5",children:b.createTime})},{title:"最後修改時間",dataField:"updateTime",width:"240px",component:b=>e.jsx(z,{sx:{textWrap:"nowrap"},variant:"h5",children:b.updateTime})}];return e.jsxs(o,{flex:1,gap:5,children:[e.jsx(v,{label:"創建任務",onClick:p,sx:{ml:"auto"},btnColor:"BLUE"}),e.jsxs(o,{flexDirection:"row",gap:5,alignItems:"center",justifyContent:{xs:"center",sm:"flex-start"},flexWrap:"wrap",px:3,children:[e.jsx(ai,{handleChange:I,value:f}),e.jsxs(ke,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(he,{width:"fit-content",p:"4px 16px",children:"最後修改時間"}),e.jsx(an,{value:f.updateTimeStartTime??null,onChange:b=>X("updateTimeStartTime",b)}),e.jsx(z,{variant:"h5",children:"至"}),e.jsx(an,{value:f.updateTimeEndTime??null,onChange:b=>X("updateTimeEndTime",b)})]}),e.jsxs(o,{flexDirection:"row",gap:5,flexWrap:"wrap",justifyContent:{xs:"center",sm:"flex-start"},alignItems:"center",children:[e.jsx(vt,{check:m.onlySelf,value:y,options:to,selectOnChange:Z,inputOnChange:_,checkBoxOnChange:C,searchFuntion:V}),e.jsx(v,{label:"搜尋",onClick:V,btnColor:"BROWN"}),e.jsx(v,{label:"匯出 EXCEL",onClick:()=>H(!0),btnColor:"EXCEL"})]})]}),Y?e.jsx(Ge,{}):e.jsx(o,{children:L&&e.jsx(lt,{isVisible:A,children:e.jsxs(o,{p:.5,alignItems:"center",gap:5,children:[e.jsx(Tt,{columns:R,rows:L.content}),e.jsx(Yt,{totalPages:L.totalPages,currentPage:L.pageable.pageNumber,inputPage:G??1,setInputPage:N,handlePageChange:P,handlePageSearch:F})]})},JSON.stringify(f))}),w&&e.jsx(ni,{missionDetail:U,open:w,onClose:u}),e.jsx(Xa,{open:q,request:f,totalPages:(L==null?void 0:L.totalPages)??1,type:"MISSION",setOpen:H})]})},lx=ox,cx=({missionId:t,auditOpen:a,onClose:n,updateMissionAndCardFlag:s,flag:r})=>{const{data:l}=dl({type:2,contentId:t});return e.jsx(ul,{children:e.jsx(pl,{open:a,onClose:n,auditData:l,updateMissionAndCardFlag:s,flag:r})})},no=/\$\[\[([^\]]*)\]\]/g;function dx(t){let a;do a=t,t=t.replace(no,(n,s)=>s);while(a!==t);return t}function ux(t){return t.replace(no,(a,n)=>"$[["+dx(n)+"]]")}const px=()=>{const t=Lt(),a=Me(),{setAlertOpen:n}=_e(),{userInfo:s}=xt(),r=yt(),{mutate:l}=ml(ne),{data:c}=ja(),{data:g}=Ds(),{data:m}=_r(),E=i.useRef(null),f=i.useRef(null),T=i.useRef(null),{setFlag:y}=at(),{setCardDialogOpen:D,setCardSelectDialogOpen:S,cardList:j,setCardList:w,removeCard:O}=ya(),{missionSelectedImage:B,setMissionSelectedImage:k,setAllMissionSelectedImage:q,setDeleteMissionImage:H,setSelectedType:G}=Rt(),[N,L]=i.useState(!1),[M,Y]=i.useState(!1),[U,A]=i.useState(!1),p=i.useRef(null),{data:x,isError:h,isLoading:I}=Ka({id:parseInt(t.id||"0",10)}),{reset:P,control:F,setValue:u,trigger:_,handleSubmit:Z,unregister:C,formState:{errors:V}}=$e(),se=Be({control:F,name:"description"}),X=Be({control:F,name:"mainSubjectId"}),R=Be({control:F,name:"subjectIds"});i.useEffect(()=>{if(h&&(n({open:!0,title:"取得任務資料失敗"}),a("/edit/missionEdit")),x){const{missionAnswerCardSet:re,picIds:fe,imagesSrc:ve,mainSubjectId:Le,centuryId:Nt,flag:en}=x;en>me.DELETE&&Y(!0);const aa={...x,description:Qa(x.description),mainSubjectId:Le??0,centuryId:Nt??0,cardIds:x.cardIds.map(tn=>({id:tn,type:0})),missionAnswerCardSet:re.map(({card:tn,id:Tn,...Ca})=>({...Ca,answerHint:Ca.hint,cardType:tn.type}))};w(x.cardSet),q(ve.map((tn,Tn)=>({src:tn,id:fe[Tn].picId}))),P({...aa,picIds:fe.map(tn=>tn.picId),variant:"update"}),x.subjectIds.length>0&&L(!0)}},[x,P,h]);const b=re=>{if(re.variant==="update"&&re.id&&s){const fe={...re,cardIds:re.cardIds.map(ve=>ve.id),missionAnswerCardSet:re.missionAnswerCardSet.map(ve=>({...ve,hint:ve.answerHint})),missionAdditionalHyperlinkSet:re.missionAdditionalHyperlinkSet.map((ve,Le)=>({...ve,orderNum:Le+1})),picIds:re.picIds.map((ve,Le)=>({picId:ve,orderNum:Le+1}))};l(fe)}else n({open:!0,title:"編輯提示",message:"編輯任務缺少ID"})},W=re=>{y(re),u("flag",re)},le=re=>{n({open:!0,title:"提示",message:"按下確認表示您已經確認所編輯的任務內容文字與所上傳圖片沒有違反智慧財產權疑慮",onOk:()=>b(re)})};function ne(re){r.invalidateQueries({queryKey:[Fr.MISSION_ID(re.id)]}),re.flag===me.UNAUDITED?n({open:!0,title:"送審提示",message:"感謝您對於遊戲的貢獻! 任務已經送出至審核，審通過後會將由遊戲教學設計團隊微調後進入遊戲資料庫中供大家挑戰! 若有不完整或審查意見需要調整，將再通知您補充調整，謝謝!"}):n({open:!0,title:"創建提示",message:"創建任務成功"}),a("/edit/missionEdit")}const Q=re=>{W(re),Z(le,nt)()},pe=()=>c?c.filter(re=>re.value!="全科目").map(re=>({label:re.value,value:re.id})):[],ee=()=>c?c.filter(re=>re.value!=="全科目"&&re.id!==X).map(re=>({label:re.value,value:re.id})):[],de=()=>s?s.schoolDtoList.map(re=>({label:re.schoolName,value:re.id})):[],Ce=()=>g?g.map(re=>({label:re.century,value:re.id})):[],ue=()=>m?m.map(re=>({label:re,value:re})):[],Se=()=>{L(!0)},Ae=()=>{u("subjectIds",[]),L(!1)},Ee=()=>{D(!0)},We=()=>{S(!0)},He=re=>{ce(ae(re)),O(re)};i.useEffect(()=>{if(B){const re=B.map(fe=>fe.id);u("picIds",re)}},[B,u]),i.useEffect(()=>{const re=j.map(fe=>({id:fe.id,type:fe.type}));u("cardIds",re),Ne.forEach((fe,ve)=>{re.some(Le=>Le.id===fe.cardId)||ce(ve)})},[j,u]),i.useEffect(()=>(G("MISSION"),s&&u("schoolId",s.schoolDtoList[0].id),()=>{k(null),w([]),P(xs),C("missionAnswerCardSet")}),[]);const Fe=()=>e.jsxs(i.Fragment,{children:[e.jsx(v,{label:"增加學科",disabled:N,onClick:Se,btnColor:"BTN_LATTE_GRAY"}),N&&e.jsxs(o,{flexDirection:"row",gap:2,alignItems:"center",children:[e.jsx(je,{name:"subjectIds",label:"學科",options:ee(),type:"ONE",variant:"control",multiple:!0}),e.jsx(v,{label:"刪除",onClick:Ae,btnColor:"CANCEL_RED"})]})]}),J=()=>{const{fields:re,append:fe,remove:ve}=It({control:F,name:"missionAdditionalHyperlinkSet"}),Le=()=>{fe({name:"",hyperlink:"",adl:!1})};return e.jsx(et,{name:"missionAdditionalHyperlinkSet",control:F,render:()=>e.jsxs(i.Fragment,{children:[re.map((Nt,en)=>e.jsxs(o,{flexDirection:"row",alignItems:"flex-start",gap:1,children:[e.jsx(ie,{name:`missionAdditionalHyperlinkSet.${en}.name`,label:"連結名稱",variant:"control"}),e.jsx(ie,{name:`missionAdditionalHyperlinkSet.${en}.hyperlink`,label:"連結",variant:"control"}),e.jsx(v,{label:"刪除",onClick:()=>ve(en),btnColor:"CANCEL_RED"})]},Nt.id)),e.jsx(v,{label:"增加資訊",onClick:Le,btnColor:"BTN_LATTE_GRAY",disabled:re.length>=2})]})})},oe=()=>{const re=()=>{k({src:"",id:0},B?B.length:0)},fe=ve=>{H(ve)};return e.jsxs(o,{gap:2,children:[B==null?void 0:B.map((ve,Le)=>{var Nt;return e.jsxs(i.Fragment,{children:[e.jsxs(o,{flexDirection:"row",alignItems:"center",justifyContent:"space-around",width:"100%",gap:1,children:[e.jsx($t,{title:"多媒體圖片",name:"picIds",index:Le}),e.jsx(v,{label:"刪除",btnColor:"CANCEL_RED",onClick:()=>fe(Le)})]}),((Nt=B[Le])==null?void 0:Nt.src)&&e.jsx(Dt,{styleType:"formImage",src:B[Le].src})]},`${ve.id}_${Le}`)}),e.jsx(v,{label:"增加多媒體圖片",btnColor:"BTN_LATTE_GRAY",onClick:re,disabled:B?B.length>=3:!1,maxWidth:200})]})},{fields:Ne,append:te,remove:ge,move:Oe}=It({control:F,name:"missionAnswerCardSet"}),De=async re=>{te({cardId:re.id,keyWord:"",answerHint:"",orderNum:Ne.length+1,cardType:re.type}),await _("cardIds")},ae=re=>Ne.findIndex(fe=>fe.cardId===re),ce=re=>{re!==-1&&ge(re)},ye=re=>Ne.some(fe=>fe.cardId===re),Re=re=>{const fe=j.find(ve=>ve.id===re.cardId.cardId);return e.jsx(e.Fragment,{children:fe&&e.jsx(pa,{cardDetail:fe})})},dt=re=>{re.destination&&Oe(re.source.index,re.destination.index)},kt=()=>{Ne.forEach((re,fe)=>{u(`missionAnswerCardSet.${fe}.orderNum`,fe+1)})},At=()=>{const re=p.current;if(!re)return;const fe=re.selectionStart,ve=re.selectionEnd;if(fe===null||ve===null||fe===ve)return;const Le=se.slice(fe,ve);if(Le.includes("$[[")&&Le.trim().endsWith("$[[")||Le.includes("]]")&&Le.trim().startsWith("]]"))return;if(Le.includes("]]")&&Le.includes("$[[")){const Tn=Le.indexOf("]]"),Ca=Le.indexOf("$[[");if(Tn<Ca)return}const Nt=se.slice(0,fe),en=se.slice(ve),aa=`${Nt}${"$[["+Le+"]]"}${en}`,tn=ux(aa);u("description",tn),setTimeout(()=>{const Tn=fe+4+Le.length;re.selectionStart=re.selectionEnd=Tn},0)},bt=()=>{const re=p.current;if(!re)return;const fe=re.selectionStart,ve=re.selectionEnd;if(fe===null||ve===null||fe===ve)return;const Le=se.slice(fe,ve);if(Le.startsWith("$[[")&&Le.endsWith("]]")){const Nt=Le.slice(3,-2),en=se.slice(0,fe),aa=se.slice(ve),tn=`${en}${Nt}${aa}`;u("description",tn),setTimeout(()=>{const Tn=fe;re.selectionStart=re.selectionEnd=Tn},0)}};i.useEffect(()=>{if(X){const re=R.filter(fe=>fe!==X);u("subjectIds",re)}},[X]),i.useEffect(()=>{kt()},[Ne]);const nt=re=>{Object.keys(re).length&&Object.keys(re).forEach(fe=>{var ve,Le,Nt;fe==="answerDescription"?(ve=E.current)==null||ve.scrollIntoView({behavior:"smooth"}):fe==="cardIds"?(Le=f.current)==null||Le.scrollIntoView({behavior:"smooth"}):fe==="missionAnswerCardSet"?(Nt=T.current)==null||Nt.scrollIntoView({behavior:"smooth"}):window.scrollTo({top:0,behavior:"smooth"})})},st=({type:re})=>e.jsxs(o,{gap:3,flexDirection:"row",flexWrap:"wrap",sx:{border:`1px solid ${$.TAB_BG_GRAY}`,p:3},children:[e.jsx(z,{variant:"h6",sx:{fontWeight:"bold"},children:`${Mr(re)}`}),j.map(fe=>fe.type===re&&e.jsxs(o,{alignItems:"center",children:[e.jsx(On,{disabled:Ne.length>=6&&!ye(fe.id),checked:ye(fe.id),onChange:ve=>{ve.target.checked?De(fe):ce(ae(fe.id))}}),e.jsx(pa,{cardDetail:fe,onRemoveClick:()=>He(fe.id)})]},fe.id))]});return e.jsxs(o,{p:2,justifyContent:"center",alignItems:"center",width:"100%",children:[I||!x?e.jsx(Ge,{}):e.jsxs(it,{onSubmit:Z(le,nt),children:[e.jsxs(K,{container:!0,spacing:6,wrap:"wrap",children:[e.jsx(K,{item:!0,sm:12,lg:6,children:e.jsxs(o,{gap:1,children:[e.jsx(ie,{name:"name",label:"任務名稱",variant:"control",alertText:"字數限制：52字(必填)"}),e.jsx(je,{name:"schoolId",label:"學校",options:de(),type:"ONE",variant:"control",alertText:"必填"}),e.jsx(je,{name:"mainSubjectId",label:"主要學科",options:pe(),type:"ONE",variant:"control",alertText:"必填"}),e.jsx(Fe,{}),e.jsx(ie,{name:"syllabus",label:"課綱",variant:"control"}),e.jsx(je,{name:"level",label:"等級",options:ue(),type:"ONE",variant:"control",alertTextList:["1~12(小一至高三，1=小一，7=國一，10=高一，以此類推。","A：上學期期中考前","B：上學期期中考後","C：下學期期中考前","D：下學期期中考後","(必填)"]}),e.jsx(ie,{name:"area",label:"地點",variant:"control",alertTextList:["1. 請輸入事件發生地點(大可為「臺灣」，小可為「台北市大安區學府里」)。","2. 請一半題目地點為台灣本土，一半為台灣之外的世界地區。","3. 若正確知識卡涉及任務地點，建議此格以較為模糊的方式描述。","(必填)"]}),e.jsx(je,{name:"centuryId",label:"世紀",options:Ce(),type:"ONE",variant:"control",alertTextList:["1. 西元前：請統一選「西元前」。","2. 西元後：請依照線索文本情境，選擇該世紀。","(必填)"]}),e.jsxs(o,{flexDirection:"row",alignItems:"center",justifyContent:"space-between",children:[e.jsx(Sn,{labelTitle:"線索文本",tooltipSx:{maxWidth:"1000px"},alertTextList:["※字數限制：","中文-300字內，含標點符號。","英文-200字內，含標點符號。","1. 整個線索文本的多張卡片中至少對應到1-2個關鍵字，以 $[[ ]] 標示。且至少有一張卡片需要對應到2個關鍵字。","2. 情境以第三人稱視角(攝影機視角)呈現，描述眼前看到、聽到的人事物。","3. 情境中不會直接出現人名、地名、建築名稱。起始可以用：'看到一個人在...' 或 '有一座鐵塔...'作為開頭。※若為社會科可酌情放寬使用地名，但請盡量避免直接使用人名。","4. 時間跨度不宜太長，如：那裡的士兵戰鬥了10年，因為情境看到的是當下發生的事情，故不會跨越10年。可調整為：有一個長者正在講述一個關於戰爭的故事，他說：「那裡的士兵戰鬥了10年」。","(必填)"]}),e.jsxs(o,{flexDirection:"row",alignItems:"center",gap:3,children:[e.jsx(v,{label:"新增為關鍵字",onClick:At}),e.jsx(v,{label:"移除關鍵字",btnColor:"CANCEL_RED",onClick:bt})]})]}),e.jsxs(o,{ref:E,gap:3,children:[e.jsx(Tr,{ref:p,name:"description",rows:8}),e.jsx(ze,{name:"answerDescription",label:"解答說明",rows:4,variant:"control",alertText:"包含答案與解說，數學要有運算過程。總字數限定3000字 (必填)"})]})]})}),e.jsx(K,{item:!0,sm:12,lg:6,flexDirection:"column",children:e.jsxs(o,{gap:2,children:[e.jsx(ze,{name:"note",label:"編輯者註解",rows:13,variant:"control"}),e.jsx(Sn,{labelSx:{flex:2},labelTitle:"多媒體補充資訊",alertTextList:["1. 網址或圖片格式，網址最多2個，圖片最多3張。","2. 隨著題目本身補充的資訊內容、圖片、以及說明文字。"]}),e.jsx(J,{}),e.jsx(oe,{}),e.jsx(ie,{name:"missionHintSet.0.hint",label:"整體鷹架提示1",variant:"control",alertTextFlex:5,alertText:"針對整題的情境額外的提示，於發動特定戰寵卡時提供。每個鷹架提示限定25字 (必填)"}),e.jsx(ie,{name:"missionHintSet.1.hint",label:"整體鷹架提示2",variant:"control",alertTextFlex:5,alertText:"針對整題的情境額外的提示，於發動特定戰寵卡時提供。每個鷹架提示限定25字 (必填)"}),e.jsx(ie,{name:"missionHintSet.2.hint",label:"整體鷹架提示3",variant:"control",alertTextFlex:5,alertText:"針對整題的情境額外的提示，於發動特定戰寵卡時提供。每個鷹架提示限定25字 (必填)"}),e.jsx(o,{ref:f})]})})]}),e.jsxs(o,{flexDirection:"row",gap:3,alignItems:"center",children:[e.jsx(Sn,{labelTitle:"已選擇卡牌區",tooltipSx:{maxWidth:"500px"},alertTextList:["1. 數量限制：正確知識卡至少3張，最多6張。","2. 卡片總數: 8+(正確知識卡數)張。","(必填)"],placement:"top"}),e.jsx(v,{label:"選擇卡片",type:"button",onClick:We}),e.jsx(v,{label:"創建卡片",type:"button",btnColor:"BTN_LATTE_GRAY",onClick:Ee}),e.jsx(un,{title:e.jsx("div",{style:{fontSize:"1rem"},children:["人物卡：特定歷史人物、當代人物、或情境故事中的角色","概念卡：原理、原則概念、包含社會科學與自然科學的各種概念","事件卡：特定歷史事件或故事情境中的事件","地點卡：特定地理位置、或情境故事中的場景與地點","時間卡：特定年代、日期、時間、世紀等時間或時間區間","數字卡：數值","現象卡：特定自然現象或社會現象或趨勢","符號卡：數學符號、單位符號、各種符號、包含語言符號","語文卡：中英語詞、修辭詞彙、成語諺語、詩詞歌賦等","物件卡：物體、工具、物品等具象的實物"].map((re,fe)=>e.jsx("p",{children:re},fe))}),componentsProps:{tooltip:{sx:{maxWidth:"1200px"}}},sx:{backgroundColor:$.CURRY,color:$.WHITE,p:1,borderRadius:2,fontWeight:800,letterSpacing:1,cursor:"pointer"},disableInteractive:!0,placement:"top",children:e.jsx(z,{children:"知識卡類別說明"})})]}),!!V.cardIds&&e.jsx(ht,{sx:{textAlign:"center",color:$.CANCEL_RED,fontSize:"1.5rem"},children:V.cardIds.message}),!!V.missionAnswerCardSet&&e.jsx(ht,{sx:{textAlign:"center",color:$.CANCEL_RED,fontSize:"1.5rem"},children:V.missionAnswerCardSet.message}),e.jsx(et,{name:"cardIds",control:F,render:()=>e.jsxs(o,{gap:3,flexWrap:"wrap",sx:{border:`1px solid ${$.TAB_BG_GRAY}`,p:3},children:[e.jsx(st,{type:gt.PEOPLE}),e.jsx(st,{type:gt.EVENT}),e.jsx(st,{type:gt.TIME}),e.jsx(st,{type:gt.AREA}),e.jsx(st,{type:gt.OBJECT}),e.jsx(st,{type:gt.LANGUAGE}),e.jsx(st,{type:gt.NUMBER}),e.jsx(st,{type:gt.SYMBOL}),e.jsx(st,{type:gt.CONCEPT}),e.jsx(st,{type:gt.PHENOMENON})]})}),e.jsx(et,{name:"missionAnswerCardSet",control:F,render:()=>e.jsx(K,{item:!0,sm:12,ref:T,children:e.jsx(o,{gap:3,children:e.jsx(ks,{onDragEnd:dt,children:e.jsx(As,{droppableId:"droppable",children:re=>e.jsxs(o,{ref:re.innerRef,...re.droppableProps,gap:3,children:[Ne.map((fe,ve)=>e.jsx(Ns,{draggableId:fe.id,index:ve,children:Le=>e.jsx(o,{ref:Le.innerRef,...Le.draggableProps,...Le.dragHandleProps,children:e.jsxs(o,{flexDirection:"row",gap:3,sx:{border:"1px solid #aaa",p:3,bgcolor:"white"},children:[e.jsxs(o,{flex:2.5,gap:2,children:[e.jsx(ie,{name:`missionAnswerCardSet.${ve}.keyWord`,label:"線索關鍵詞",variant:"control",alertText:"於置牌區顯示予玩家出牌引導。(必填)"}),e.jsx(o,{flexDirection:"row",gap:2,children:e.jsxs(he,{children:["正確卡片",ve+1]})})]}),e.jsx(o,{flex:1,alignItems:"center",gap:1,children:e.jsx(Re,{cardId:fe})}),e.jsx(o,{flex:2.5,gap:1,children:e.jsx(ie,{name:`missionAnswerCardSet.${ve}.answerHint`,label:"鷹架提示",variant:"control",alertText:"25字內，含標點符號。(必填)"})})]})})},fe.id)),re.placeholder]})})})})})}),e.jsx(o,{flexDirection:"row",gap:3,justifyContent:"end",children:M?e.jsxs(e.Fragment,{children:[e.jsx(v,{label:"儲存",type:"submit",sx:{alignSelf:"flex-end"},btnColor:"BROWN",onClick:()=>W(x.flag)}),e.jsx(v,{label:"審查意見與建議",maxWidth:140,sx:{alignSelf:"flex-end"},onClick:()=>{A(!0),W(me.MODIFY_FINISH)}})]}):e.jsxs(e.Fragment,{children:[e.jsx(v,{label:"提交審核",type:"submit",sx:{alignSelf:"flex-end"},onClick:()=>W(me.UNAUDITED)}),e.jsx(v,{label:"校內發佈",type:"submit",sx:{alignSelf:"flex-end"},btnColor:"BTN_LATTE_GRAY",onClick:()=>W(me.IN_SCHOOL)}),x.flag===me.DRAFT&&e.jsx(v,{label:"儲存草稿",type:"submit",sx:{alignSelf:"flex-end"},btnColor:"DRAWER_GRAY",onClick:()=>W(me.DRAFT)})]})})]}),e.jsx(Ji,{}),e.jsx(Zi,{}),M&&x&&e.jsx(cx,{auditOpen:U,onClose:()=>A(!1),missionId:x.id,updateMissionAndCardFlag:Q,flag:x.flag})]})},mx=px;function hx(){return e.jsx(hl,{children:e.jsxs(Pt,{children:[e.jsx(xe,{index:!0,element:e.jsx(lx,{})}),e.jsx(xe,{path:"/createMission",element:e.jsx(rx,{})}),e.jsx(xe,{path:"/updateMission/:id",element:e.jsx(mx,{})}),e.jsx(xe,{path:"*",element:e.jsx(_t,{to:"/edit/missionEdit",replace:!0})})]})})}const xx=Va(zt)(({theme:t})=>({"& .MuiDialogContent-root":{padding:t.spacing(2)},"& .MuiDialogActions-root":{padding:t.spacing(1)},maxWidth:960,maxHeight:600,margin:"auto"})),gx=({name:t,value:a,onChange:n,open:s,onClose:r,onConfirm:l})=>e.jsxs(xx,{onClose:r,"aria-labelledby":"customized-dialog-title",fullScreen:!0,open:s,sx:{padding:20},PaperProps:{sx:{borderRadius:10,px:5,flexDirection:"column",justifyContent:"space-between",height:"100%",py:2}},children:[e.jsx(Qt,{sx:{textAlign:"center",fontSize:30,fontWeight:"bold"},id:"customized-dialog-title",children:"編輯參數值"}),e.jsxs(o,{gap:2,children:[e.jsx(fs,{label:"參數名稱",value:t,disabled:!0}),e.jsx(fs,{label:"參數值",value:a,onChange:n})]}),e.jsx(o,{sx:{mt:3,ml:"auto",display:"flex",flexDirection:"row",gap:2},children:e.jsx(v,{label:"確定",onClick:l})})]}),ao=[{label:"參數名稱",value:"note"},{label:"最後編輯者",value:"adlName"}],Aa=ao.map(t=>t.value),fx=t=>Aa.includes(t),bx=()=>{const t=Wt(),a=Me(),n=yt(),{setAlertOpen:s}=_e(),r=i.useMemo(()=>{const u=new URLSearchParams(t.search),_=u.get("category"),Z=u.get("adlName"),C=u.get("variable"),V=u.get("onlySelf");return{category:_||"全選",onlySelf:V==="true",page:parseInt(u.get("page")||"0",10),size:10,...Z&&{adlName:Z},...C&&{variable:C}}},[t.search]),l=i.useMemo(()=>{const u=Object.keys(r).find(_=>Aa.includes(_)&&r[_]!==void 0);return u?{searchText:r[u],currentField:u}:{searchText:"",currentField:Aa[0]}},[r]),[c,g]=i.useState(r),[m,E]=i.useState(l),[f,T]=i.useState(!1),[y,D]=i.useState(null),[S,j]=i.useState(""),[w,O]=i.useState(),{data:B}=Vl(),{data:k,isLoading:q,isSuccess:H}=Rs(c),{mutate:G}=Kl(()=>P("update")),{mutate:N}=zl(()=>P("default")),L=i.useMemo(()=>H&&!!k.content.length,[H,k]),M=i.useCallback(u=>_=>{let Z,C;if(typeof _=="number"||typeof _=="string"||typeof _=="boolean"?Z=_:Z=_.target.value,fx(u)){const se={};Aa.forEach(X=>{X===u&&Z?se[X]=Z:delete c[X]}),C={...c,...se,page:0}}else C={...c,[u]:Z};const V=ut(ln(C));g(C),a(`?${V}`)},[a,c]),Y=u=>{E(_=>({..._,searchText:u}))},U=u=>{E(_=>({..._,currentField:u}))},A=i.useCallback(()=>{const{currentField:u,searchText:_}=m;M(u)(_),O(1)},[M,m]),p=u=>{M("onlySelf")(u)},x=i.useCallback((u,_)=>{M("page")(String(_-1)),O(_)},[M]),h=i.useCallback(()=>{w&&g(u=>({...u,page:Number(w)-1}))},[w,g]),I=(u,_)=>{if(!_.display){s({open:!0,message:"此參數無法編輯"});return}T(u),_&&(D(_),j(_.value))};function P(u){s({open:!0,message:u==="update"?"更新成功":"設定為預設值成功"}),u==="update"&&(D(null),j(""),T(!1));const _=jt(c);n.invalidateQueries({queryKey:[Ql.SYS_OPTION_SEARCH,_]})}const F=[{title:"編號",dataField:"id"},{title:"分類",dataField:"category",width:"300px"},{title:"參數名稱",dataField:"note",width:"300px"},{title:"參數數值",dataField:"value",component:u=>e.jsx(z,{onClick:()=>I(!0,u),sx:{backgroundColor:"#f0f0f0",padding:"10px",borderRadius:"10px",margin:"2px",cursor:"pointer",width:"100%",border:"1px solid #aaa",textAlign:"center",transition:"all 0.3s ease",boxShadow:"2px 3px 3px 0 rgba(0, 0, 0, 0.5)","&:hover":{backgroundColor:"#e0e0e0",border:"1px solid #e0e0e0",transform:"scale(1.2) translate(0, -5px)",cursor:u.display?"pointer":"not-allowed"}},children:u.value})},{title:"最後編輯者",dataField:"lastUpdateAdlName"},{title:"編輯次數",dataField:"updateTime",component:u=>e.jsx(e.Fragment,{children:u.updateTime})},{title:"預設值",dataField:"defaultValue"},{title:"",dataField:"isDefault",component:u=>e.jsx(v,{label:"預設",disabled:!u.display,onClick:()=>{s({open:!0,message:"確定要設定為預設值嗎？",onOk:()=>{N(u.id)}})}})}];return e.jsx(o,{flex:1,gap:5,children:q?e.jsx(Ge,{}):e.jsxs(e.Fragment,{children:[e.jsxs(o,{flex:1,gap:5,flexDirection:"row",ml:3,children:[B&&e.jsx(Ve,{label:"分類",options:[{label:"全選",value:"全選"},...B.filter(u=>u!=="後台相關").map(u=>({label:u,value:u}))],value:c.category||"全選",onChange:M("category")}),e.jsx(vt,{check:c.onlySelf,checkAndLockInput:c.onlySelf,value:m,options:ao,selectOnChange:U,inputOnChange:Y,searchFuntion:A,checkBoxOnChange:p}),e.jsx(v,{label:"搜尋",onClick:A,btnColor:"BROWN"})]}),k&&e.jsx(lt,{isVisible:L,children:e.jsxs(o,{p:.5,alignItems:"center",gap:5,children:[e.jsx(Tt,{columns:F,rows:k.content.filter(u=>u.category!=="後台相關")}),e.jsx(Yt,{totalPages:k==null?void 0:k.totalPages,currentPage:k==null?void 0:k.pageable.pageNumber,inputPage:w??1,setInputPage:O,handlePageChange:x,handlePageSearch:h})]})},JSON.stringify(c)),f&&y&&e.jsx(gx,{name:y.note,value:S,onChange:u=>j(u.target.value),open:f,onClose:()=>T(!1),onConfirm:()=>{G({id:y.id,variable:y.variable,value:S,note:y.note})}})]})})},jx=bx;function yx(){return e.jsxs(Pt,{children:[e.jsx(xe,{index:!0,element:e.jsx(jx,{})}),e.jsx(xe,{path:"*",element:e.jsx(_t,{to:"/edit/paramsEdit",replace:!0})})]})}const Cx=t=>d.intersection(d.object({name:fn(t,1,"關卡名稱必填",52,"關卡名稱最多52個字"),description:d.union([d.string(),d.null()]),note:d.union([d.string(),d.null()]),schoolId:d.number().min(1,{message:"學校ID必填"}),flag:d.nativeEnum(me),gameId:d.number().min(1,{message:"篇章必填"}),missionEnemySet:d.array(d.object({missionId:d.number().min(1,{message:"任務必選"}),enemyId:d.number().min(1,{message:"敵人必選"})})).min(1,{message:"任務必填"}),isStagePic:d.number().nonnegative({message:"必選一個代表魔王"}),isPublish:d.boolean().nullable()}),d.discriminatedUnion("variant",[d.object({variant:d.literal("create")}),d.object({variant:d.literal("update"),id:d.number().min(1)})])),so={variant:"create",name:"",description:"",note:"",schoolId:0,flag:me.IN_SCHOOL,gameId:2,missionEnemySet:[{missionId:0,enemyId:0}],isStagePic:0,isPublish:null},Sx=({children:t})=>{const{flag:a}=at(),n=Cx(a),s=sn({mode:"all",resolver:on(n),defaultValues:so});return e.jsxs(rn,{...s,children:[t,!1]})},Ex=Sx,Ix=()=>{const t=Me(),{setAlertOpen:a}=_e(),{userInfo:n}=xt(),{setEnemyDialogOpen:s,setMissionDialogOpen:r,selectedMission:l,setSelectMission:c,selectedEnemy:g,setDeleteMission:m,setDeleteEnemy:E,setSelectEnemy:f}=Hn(),{setFlag:T}=at(),{data:y}=Ws(),{mutate:D}=$m(U),[S,j]=i.useState(0),{reset:w,control:O,setValue:B,register:k,handleSubmit:q,formState:{errors:H}}=$e(),G=i.useMemo(()=>y?y.map(I=>({label:I.name,value:I.id})):[],[y]),N=I=>{if(!n)return;const P=I.missionEnemySet.map((Z,C)=>C===I.isStagePic?{...Z,isStagePic:!0,orderNum:C+1}:{...Z,isStagePic:!1,orderNum:C+1}),{isStagePic:F,variant:u,..._}={...I,missionEnemySet:P};D(_)},L=I=>{I===me.PASS?B("isPublish",!0):B("isPublish",null),T(I),B("flag",I)},M=I=>{a({open:!0,title:"提示",message:"按下確認表示您已經確認所編輯的關卡內容文字與所上傳圖片沒有違反智慧財產權疑慮",onOk:()=>N(I)})},Y=()=>n?n.schoolDtoList.map(I=>({label:I.schoolName,value:I.id})):[];function U(){a({open:!0,title:"創建提示",message:"創建關卡成功"}),t("/edit/stageEdit")}const A=I=>{r(!0,I)},p=I=>{s(!0,I)},x=I=>{j(I===S?null:I),I===S?B("isStagePic",-1,{shouldValidate:!0}):B("isStagePic",I,{shouldValidate:!0})};i.useEffect(()=>{l&&l.map((I,P)=>{I!=null&&I.id&&B(`missionEnemySet.${P}.missionId`,I.id)})},[l,B]),i.useEffect(()=>{g&&g.map((I,P)=>{I!=null&&I.id&&B(`missionEnemySet.${P}.enemyId`,I.id)})},[g,B]),i.useEffect(()=>(w(so),k("isStagePic"),n&&B("schoolId",n.schoolDtoList[0].id),()=>{w(),c(null),f(null)}),[]);const h=()=>{const{fields:I,append:P,remove:F}=It({control:O,name:"missionEnemySet"}),u=()=>{P({missionId:0,enemyId:0})},_=Z=>{F(Z),m(Z),E(Z),(Z===S||S&&I.length-1<=S)&&(j(null),B("isStagePic",-1,{shouldValidate:!0}))};return e.jsxs(o,{gap:5,children:[I.map((Z,C)=>e.jsx(et,{name:`missionEnemySet.${C}`,control:O,render:({field:V,fieldState:{error:se}})=>e.jsxs(o,{sx:{borderTop:C!=0?"1px solid #000":"",pt:3},gap:2,children:[e.jsx(kr,{control:e.jsx(On,{checked:S===C,onChange:()=>x(C)}),label:"以此魔王作為關卡展示魔王圖片"}),e.jsxs(o,{gap:2,flexDirection:"row",alignItems:"flex-start",children:[e.jsx(ts,{...V,error:se,onOpenEnemyDialog:()=>p(C),onOpenMissionDialog:()=>A(C),index:C}),I.length>1&&e.jsx(v,{label:"刪除",onClick:()=>_(C),btnColor:"CANCEL_RED"})]})]})},Z.id)),e.jsx(v,{label:"增加任務",onClick:u,btnColor:"BTN_LATTE_GRAY",disabled:I.length>=3})]})};return e.jsx(o,{p:2,justifyContent:"center",alignItems:"center",width:"100%",children:e.jsxs(it,{onSubmit:q(M),children:[e.jsxs(K,{container:!0,spacing:6,wrap:"wrap",children:[e.jsx(K,{item:!0,sm:12,lg:6,children:e.jsxs(o,{gap:2.5,children:[e.jsx(ie,{name:"name",label:"關卡名稱",variant:"control",alertText:"字數限制：52字(必填)"}),e.jsx(je,{name:"schoolId",label:"學校",options:Y(),type:"ONE",variant:"control",alertText:"必填"}),e.jsx(je,{name:"gameId",label:"所屬篇章",options:G,type:"ONE",variant:"control",alertText:"必填"})]})}),e.jsx(K,{item:!0,sm:12,lg:6,children:e.jsx(o,{gap:2,children:e.jsx(ze,{name:"description",label:"說明文字",rows:4,variant:"control"})})})]}),!!H&&H.isStagePic&&e.jsx(ht,{sx:{color:$.CANCEL_RED,fontSize:"1rem",alignSelf:"flex-start"},children:H.isStagePic.message}),e.jsx(h,{}),e.jsx(ze,{name:"note",label:"編輯者註解",rows:2,variant:"control",stackSx:{mt:4.5,width:"50%"}}),e.jsxs(o,{flexDirection:"row",gap:3,justifyContent:"end",children:[(St(tt.ROLE_MANAGER)||St(tt.ROLE_ADMIN))&&e.jsx(v,{label:"全國發佈",type:"submit",sx:{alignSelf:"flex-end"},onClick:()=>L(me.PASS)}),e.jsx(v,{label:"校內發佈",type:"submit",sx:{alignSelf:"flex-end"},btnColor:"BTN_LATTE_GRAY",onClick:()=>L(me.IN_SCHOOL)}),e.jsx(v,{label:"儲存草稿",type:"submit",sx:{alignSelf:"flex-end"},btnColor:"DRAWER_GRAY",onClick:()=>L(me.DRAFT)})]})]})})},Tx=Ix,ro=[{label:"關卡名稱",value:"stageName"},{label:"關卡碼",value:"stageCode"},{label:"任務名稱",value:"missionName"},{label:"命關者",value:"author"}],Na=ro.map(t=>t.value),wx=t=>Na.includes(t),Dx=()=>{const t=Me(),a=Wt(),{userInfo:n,permissions:s,role:r}=xt(),l=yt(),{setAlertOpen:c}=_e(),g=i.useMemo(()=>s&&r===tt.ROLE_ADMIN,[s,r]),m=i.useMemo(()=>s&&r===tt.ROLE_MANAGER,[s,r]),E=i.useMemo(()=>{const b=new URLSearchParams(a.search),W=b.get("stageName"),le=b.get("stageCode"),ne=b.get("missionName"),Q=b.get("updateTimeStartTime"),pe=b.get("updateTimeEndTime");return{gameId:parseInt(b.get("gameId")||"0",10),flag:parseInt(b.get("flag")||"0",10),page:parseInt(b.get("page")||"0",10),onlySelf:b.get("onlySelf")==="true",...W&&{name:W},...le&&{stageCode:le},...ne&&{missionName:ne},...Q&&{updateTimeStartTime:parseInt(Q,10)},...pe&&{updateTimeEndTime:parseInt(pe,10)},...cn}},[a.search]),f=i.useMemo(()=>{const b=Object.keys(E).find(W=>Na.includes(W)&&E[W]!==void 0);return b?{searchText:E[b],currentField:b}:{searchText:"",currentField:Na[0]}},[E]),{mutate:T}=Wm(y);function y(b){const W=jt(S);l.invalidateQueries({queryKey:[vs.STAGE_SEARCH,W]}),c({open:!0,title:"更新提示",message:b.isPublish?"已成功上架":"已成功下架"})}const D=(b,W)=>{T({id:b,isPublish:W})},[S,j]=i.useState(E),[w,O]=i.useState(f),[B,k]=i.useState(null),[q,H]=i.useState(!1),[G,N]=i.useState(!1),[L,M]=i.useState(),{data:Y,isSuccess:U,isLoading:A}=$i(S),p=i.useMemo(()=>U&&!!Y.content.length,[U,Y]),x=i.useCallback(b=>W=>{let le,ne;if(typeof W=="number"||typeof W=="string"||typeof W=="boolean"?le=W:le=W.target.value,wx(b)){const pe={};Na.forEach(ee=>{ee===b&&le?pe[ee]=le:delete S[ee]}),ne={...S,...pe}}else ne={...S,[b]:le};b!=="page"&&(ne.page=0);const Q=ut(ne);j(ne),t(`?${Q}`)},[t,S]),h=i.useCallback((b,W)=>{x("page")(String(W-1)),M(W)},[x]),I=i.useCallback(()=>{L&&j(b=>({...b,page:Number(L)-1}))},[L,j]),P=()=>{t("createStage")},F=i.useCallback(b=>{t(`updateStage/${b}`)},[t]),u=i.useCallback(b=>{k(b),H(!0)},[]),_=i.useCallback(()=>{H(!1)},[]),Z=b=>{O(W=>({...W,searchText:b}))},C=b=>{O(W=>({...W,currentField:b}))},V=b=>{x("onlySelf")(b)},se=(b,W)=>{W&&(b==="updateTimeStartTime"?x(b)(Ie(W).startOf("day").valueOf()):b==="updateTimeEndTime"?x(b)(Ie(W).endOf("day").valueOf()):x(b)(Ie(W).valueOf()))},X=i.useCallback(()=>{const{currentField:b,searchText:W}=w;x(b)(W),M(1)},[x,w]),R=[{title:"編輯/檢視",dataField:"id",width:"160px",component:b=>e.jsxs(o,{gap:2,flexDirection:"row",children:[n&&e.jsx(v,{label:"編輯",onClick:()=>F(b.id),btnColor:"TAB_BLUE",disabled:!g&&(m?!(b.flag===me.PASS||b.teacherData.name===n.adlName):!(b.flag!==me.PASS&&b.teacherData.name===n.adlName))}),e.jsx(v,{label:"檢視",onClick:()=>u(b),btnColor:"BTN_LATTE_GRAY"})]})},...g||m?[{title:"上架/下架",dataField:"isPublish",width:"150px",component:b=>e.jsx(o,{gap:2,flexDirection:"row",justifyContent:"center",children:n&&b.isPublish!==null&&e.jsx(v,{label:b.isPublish?"下架":"上架",onClick:()=>D(b.id,!b.isPublish),btnColor:b.isPublish?"CANCEL_RED":"GREEN"})})}]:[],{title:"關卡名稱",dataField:"name",width:"350px",component:b=>e.jsx(z,{variant:"h5",children:b.name?b.name.length>16?b.name.slice(0,16)+"...":b.name:"無"})},{title:"篇章",dataField:"game",width:"140px",component:b=>{var W;return e.jsx(z,{variant:"h5",children:((W=b.game)==null?void 0:W.name)??"無"})}},{title:"關卡碼",dataField:"stageCode",width:"120px"},{title:"任務名稱",dataField:"missionEnemySet",width:"300px",component:b=>e.jsx(z,{variant:"h5",children:b.missionEnemySet.length>0?b.missionEnemySet.map(W=>W.mission.name).join(","):"無"})},{title:"校名",dataField:"school",width:"300px",component:b=>e.jsx(z,{variant:"h5",children:b.school.schoolName})},{title:"命關者",dataField:"teacherData",width:"120px",component:b=>e.jsx(z,{variant:"h5",children:b.teacherData.name})},{title:"狀態",dataField:"flag",width:"150px",component:b=>e.jsx(z,{variant:"h5",children:Nn[b.flag-1].label})},{title:"建立時間",dataField:"createTime",width:"240px",component:b=>e.jsx(z,{sx:{textWrap:"nowrap"},variant:"h5",children:b.createTime})},{title:"最後修改時間",dataField:"updateTime",width:"240px",component:b=>e.jsx(z,{sx:{textWrap:"nowrap"},variant:"h5",children:b.updateTime})}];return e.jsxs(o,{flex:1,gap:5,children:[e.jsx(v,{label:"創建關卡",onClick:P,sx:{ml:"auto"},btnColor:"BLUE"}),e.jsxs(o,{flexDirection:"row",gap:5,alignItems:"center",justifyContent:{xs:"center",sm:"flex-start"},flexWrap:"wrap",px:3,children:[e.jsx(Wi,{handleChange:x,value:S}),e.jsxs(ke,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(he,{width:"fit-content",p:"4px 16px",children:"最後修改時間"}),e.jsx(an,{value:S.updateTimeStartTime??null,onChange:b=>se("updateTimeStartTime",b)}),e.jsx(z,{variant:"h5",children:"至"}),e.jsx(an,{value:S.updateTimeEndTime??null,onChange:b=>se("updateTimeEndTime",b)})]}),e.jsxs(o,{flexDirection:"row",gap:5,flexWrap:"wrap",justifyContent:{xs:"center",sm:"flex-start"},alignItems:"center",children:[e.jsx(vt,{check:E.onlySelf,value:w,options:ro,selectOnChange:C,inputOnChange:Z,checkBoxOnChange:V,searchFuntion:X}),e.jsx(v,{label:"搜尋",onClick:X,btnColor:"BROWN"}),e.jsx(v,{label:"匯出 Excel",onClick:()=>N(!0),btnColor:"EXCEL"})]})]}),A?e.jsx(Ge,{}):e.jsx(o,{children:Y&&e.jsx(lt,{isVisible:p,children:e.jsxs(o,{p:.5,alignItems:"center",gap:5,children:[e.jsx(Tt,{columns:R,rows:Y.content}),e.jsx(Yt,{totalPages:Y.totalPages,currentPage:Y.pageable.pageNumber,inputPage:L??1,setInputPage:M,handlePageChange:h,handlePageSearch:I})]})},JSON.stringify(S))}),q&&B&&e.jsx(Gi,{open:q,onClose:_,stage:B}),e.jsx(Xa,{open:G,request:S,totalPages:(Y==null?void 0:Y.totalPages)??1,type:"STAGE",setOpen:N})]})},vx=Dx,kx=()=>{const t=Lt(),a=Me(),{userInfo:n}=xt(),{setAlertOpen:s}=_e(),{setEnemyDialogOpen:r,setMissionDialogOpen:l,selectedMission:c,setSelectMission:g,selectedEnemy:m,setDeleteMission:E,setDeleteEnemy:f,setSelectEnemy:T,setAllEnemy:y,setAllMission:D}=Hn(),{setFlag:S}=at(),{data:j}=Ws(),{mutate:w}=Gm(P),[O,B]=i.useState(null),{data:k,isError:q,isLoading:H}=Hm({id:parseInt(t.id||"0",10)}),{reset:G,control:N,setValue:L,register:M,handleSubmit:Y,formState:{errors:U}}=$e(),A=i.useMemo(()=>j?j.map(C=>({label:C.name,value:C.id})):[],[j]),p=()=>n?n.schoolDtoList.map(C=>({label:C.schoolName,value:C.id})):[],x=C=>{const V=C.missionEnemySet.map((se,X)=>X===C.isStagePic?{...se,isStagePic:!0,orderNum:X+1}:{...se,isStagePic:!1,orderNum:X+1});if(C.variant==="update"&&C.id&&n){const{isStagePic:se,variant:X,...R}={...C,missionEnemySet:V};w({...R})}else s({open:!0,title:"編輯提示",message:"編輯關卡缺少ID"})},h=C=>{C===me.PASS?L("isPublish",!0):L("isPublish",null),S(C),L("flag",C)},I=C=>{s({open:!0,title:"提示",message:"按下確認表示您已經確認所編輯的關卡內容文字與所上傳圖片沒有違反智慧財產權疑慮",onOk:()=>x(C)})};function P(){s({open:!0,title:"編輯提示",message:"編輯關卡成功"}),a("/edit/stageEdit")}const F=C=>{l(!0,C)},u=C=>{r(!0,C)},_=C=>{B(C===O?null:C),C===O?L("isStagePic",-1,{shouldValidate:!0}):L("isStagePic",C,{shouldValidate:!0})};i.useEffect(()=>{c&&c.map((C,V)=>{C!=null&&C.id&&L(`missionEnemySet.${V}.missionId`,C.id)})},[c,L]),i.useEffect(()=>{m&&m.map((C,V)=>{C!=null&&C.id&&L(`missionEnemySet.${V}.enemyId`,C.id)})},[m,L]),i.useEffect(()=>{if(q&&(s({open:!0,title:"取得關卡資料失敗"}),a("/edit/cardEdit")),k){const{missionEnemySet:C,...V}=k;let se=0;const X=C.map((R,b)=>(R.isStagePic&&(se=b,B(b)),{missionId:R.missionId,enemyId:R.enemyId}));G({...V,isStagePic:se,missionEnemySet:[...X],variant:"update"}),M("isStagePic"),D(C.map(R=>R.mission)),y(C.map(R=>R.enemy))}},[k,G,q]),i.useEffect(()=>(n&&L("schoolId",n.schoolDtoList[0].id),()=>{G(),g(null),T(null)}),[]);const Z=()=>{const{fields:C,append:V,remove:se}=It({control:N,name:"missionEnemySet"}),X=()=>{V({missionId:0,enemyId:0})},R=b=>{se(b),E(b),f(b),(b===O||O&&C.length-1<=O)&&(B(null),L("isStagePic",-1,{shouldValidate:!0}))};return e.jsxs(o,{gap:5,children:[C.map((b,W)=>e.jsx(et,{name:`missionEnemySet.${W}`,control:N,render:({field:le,fieldState:{error:ne}})=>e.jsxs(o,{sx:{borderTop:W!=0?"1px solid #000":"",pt:3},gap:2,children:[e.jsx(kr,{control:e.jsx(On,{checked:O===W,onChange:()=>_(W)}),label:"以此魔王作為關卡展示魔王圖片"}),e.jsxs(o,{gap:2,flexDirection:"row",alignItems:"flex-start",children:[e.jsx(ts,{...le,error:ne,onOpenEnemyDialog:()=>u(W),onOpenMissionDialog:()=>F(W),index:W}),C.length>1&&e.jsx(v,{label:"刪除",onClick:()=>R(W),btnColor:"CANCEL_RED"})]})]})},b.id)),e.jsx(v,{label:"增加任務",onClick:X,btnColor:"BTN_LATTE_GRAY",disabled:C.length>=3})]})};return e.jsx(o,{p:2,justifyContent:"center",alignItems:"center",width:"100%",children:H||!k?e.jsx(Ge,{}):e.jsxs(it,{onSubmit:Y(I),children:[e.jsxs(K,{container:!0,spacing:6,wrap:"wrap",children:[e.jsx(K,{item:!0,sm:12,lg:6,children:e.jsxs(o,{gap:1,children:[e.jsx(ie,{name:"name",label:"關卡名稱",variant:"control",alertText:"字數限制：52字(必填)"}),e.jsx(je,{name:"schoolId",label:"學校",options:p(),type:"ONE",variant:"control",alertText:"必填"}),e.jsx(je,{name:"gameId",label:"所屬篇章",options:A,type:"ONE",variant:"control",alertText:"必填"}),e.jsx(ze,{name:"note",label:"編輯者註解",rows:2,variant:"control",stackSx:{mt:4.5}})]})}),e.jsx(K,{item:!0,sm:12,lg:6,children:e.jsx(o,{gap:2,children:e.jsx(ze,{name:"description",label:"說明文字",rows:8,variant:"control"})})})]}),!!U&&U.isStagePic&&e.jsx(ht,{sx:{color:$.CANCEL_RED,fontSize:"1rem",alignSelf:"flex-start"},children:U.isStagePic.message}),e.jsx(Z,{}),e.jsxs(o,{flexDirection:"row",gap:3,justifyContent:"end",children:[(St(tt.ROLE_MANAGER)||St(tt.ROLE_ADMIN))&&e.jsx(v,{label:"全國發佈",type:"submit",sx:{alignSelf:"flex-end"},onClick:()=>h(me.PASS)}),k.flag===me.IN_SCHOOL&&e.jsx(v,{label:"校內發佈",type:"submit",sx:{alignSelf:"flex-end"},btnColor:"BTN_LATTE_GRAY",onClick:()=>h(me.IN_SCHOOL)}),k.flag===me.DRAFT&&e.jsx(v,{label:"儲存草稿",type:"submit",sx:{alignSelf:"flex-end"},btnColor:"DRAWER_GRAY",onClick:()=>h(me.DRAFT)})]})]})})},Ax=kx;function Nx(){return e.jsxs(Ex,{children:[e.jsxs(Pt,{children:[e.jsx(xe,{index:!0,element:e.jsx(vx,{})}),e.jsx(xe,{path:"/createStage",element:e.jsx(Tx,{})}),e.jsx(xe,{path:"/updateStage/:id",element:e.jsx(Ax,{})}),e.jsx(xe,{path:"*",element:e.jsx(_t,{to:"/edit/stageEdit",replace:!0})})]}),e.jsx(ri,{}),e.jsx(oi,{})]})}const Ox=Va(o)(()=>({padding:"16px 0",backgroundColor:$.WHITE,borderRadius:"2px",outline:`1px solid ${$.GRAY}`,"&:hover":{backgroundColor:$.LIGHT_GRAY},"&.Mui-dragging":{backgroundColor:$.SELECT_YELLOW}})),Bn=i.memo(({items:t,onDragEnd:a,renderItem:n,sx:s})=>{const r=l=>{l.destination&&a(l)};return e.jsx(ks,{onDragEnd:r,children:e.jsx(As,{droppableId:"drop-list",children:l=>e.jsxs(o,{ref:l.innerRef,...l.droppableProps,children:[t.map((c,g)=>e.jsx(Ns,{draggableId:`item-${g}`,index:g,children:(m,E)=>e.jsxs(Ox,{ref:m.innerRef,...m.draggableProps,...m.dragHandleProps,sx:{userSelect:"none",cursor:"move",transform:E.isDragging?"scale(1.02)":"none",boxShadow:E.isDragging?"0 5px 10px rgba(0,0,0,0.2)":"none",opacity:E.isDragging?.8:1,backgroundColor:E.isDragging?$.LIGHT_GRAY:"inherit",...s},children:[n(c,g)," "]})},g)),l.placeholder]})})})}),us=(t,a)=>t.some(n=>{const s=a==null?void 0:a.find(r=>r.id===n.id);return s&&s.orderNum!==n.newOrderNum}),Rx=i.memo(({open:t,onClose:a})=>{const{setAlertOpen:n}=_e(),s=yt(),[r,l]=i.useState(Tl.MAIN),{data:c,refetch:g,isLoading:m}=wl(r),{mutate:E}=Dl(()=>{n({open:!0,message:"更新章節排序成功"}),g()}),[f,T]=i.useState((c==null?void 0:c.map((G,N)=>({...G,newOrderNum:N+1})))||[]),[y,D]=i.useState([]),S=i.useCallback(G=>{us(f.filter(L=>L.newOrderNum!==void 0),y)?n({open:!0,message:"有尚未儲存的變更，確定要切換章節類型嗎？",onOk:()=>{l(G.target.value),g()}}):(l(G.target.value),g())},[g,f,y,n]),j=i.useCallback((G,N)=>{T(L=>{const M=[...L],[Y]=M.splice(G,1);return M.splice(N,0,Y),console.log(M),M.map((U,A)=>({...U,newOrderNum:A+1}))})},[]),w=i.useCallback(G=>{const{source:N,destination:L}=G;!L||N.index===L.index||j(N.index,L.index)},[j]),O=i.useMemo(()=>[{title:"新排序",dataField:"newOrderNum"},{title:"章節名稱",dataField:"chapterName"},{title:"關卡數量",dataField:"stageNum"},{title:"原排序",dataField:"orderNum"}],[]),B=i.useCallback(()=>{us(f.filter(N=>N.newOrderNum!==void 0),y)?n({open:!0,message:"有尚未儲存的變更，確定要關閉嗎？",onOk:()=>{T([...y]),a()},onCancel:()=>{}}):a()},[f,y,n,a]),k=i.useCallback(()=>{n({open:!0,message:"確定要更新章節排序嗎？",onOk:()=>{if(!us(f.filter(L=>L.newOrderNum!==void 0),y)){n({open:!0,message:"排序未變更"});return}const N=f.map(L=>({id:L.id,orderNum:L.newOrderNum}));s.invalidateQueries({queryKey:[Za.BLACK_HOLE_CHAPTER_TYPE(r)]}),E({chapterType:r,orderData:N.filter(L=>L.orderNum!==void 0)})}})},[n,f,r,y,E,s]),q=i.memo(({columns:G})=>e.jsx(o,{sx:{backgroundColor:$.DARK_GRAY,color:$.WHITE,outline:`1px solid ${$.GRAY}`,flexDirection:"row",justifyContent:"space-between",py:"12px",position:"sticky",top:0,zIndex:1},children:G.map(N=>e.jsx(z,{variant:"h5",sx:{flex:1,textAlign:"center"},children:N.title},N.dataField))})),H=i.useCallback(G=>e.jsx(o,{direction:"row",justifyContent:"space-between",children:O.map(N=>{const L=G[N.dataField],M=Array.isArray(L)?L.length.toString():L;return e.jsx(z,{variant:"h6",sx:{flex:1,textAlign:"center"},children:M},N.dataField)})}),[O]);return i.useEffect(()=>{const G=(c==null?void 0:c.map((N,L)=>({...N,newOrderNum:L+1})))||[];T(G),D([...G])},[c]),e.jsxs(zt,{open:t,onClose:B,fullWidth:!0,maxWidth:"lg",PaperProps:{sx:{p:"12px"}},children:[e.jsxs(Qt,{sx:{fontWeight:"bold",display:"flex",justifyContent:"space-between",alignItems:"center",mb:"24px"},children:[e.jsxs(ke,{sx:{display:"flex",alignItems:"center",gap:"24px"},children:[e.jsx(Ve,{label:"章節類型",options:vl,value:r,onChange:S}),c&&c.length>0&&e.jsx(z,{sx:{color:$.GREEN,fontSize:"14px"},children:"* 提示：透過拖曳來調整章節的排序 *"})]}),e.jsxs(ke,{sx:{display:"flex",alignItems:"center",gap:"24px"},children:[e.jsx(v,{label:"儲存",variant:"contained",onClick:k}),e.jsx(Ze,{onClick:B,children:e.jsx(Vt,{})})]})]}),m?e.jsx(Ge,{}):e.jsxs(dn,{children:[e.jsx(q,{columns:O}),e.jsx(Bn,{items:f,onDragEnd:w,renderItem:H})]})]})}),io=[{label:"章節名稱",value:"chapterName"}],Oa=io.map(t=>t.value),Lx=t=>Oa.includes(t),Px=()=>{const t=yt(),{setAlertOpen:a}=_e(),n=Me(),s=Wt(),[r,l]=i.useState(!1),c=i.useMemo(()=>{const P=new URLSearchParams(s.search),F=P.get("chapterName"),u=P.get("chapterType"),_=P.get("weekDay"),Z=P.get("blackHoleMapId"),C=P.get("stageNodeCount"),V=P.get("characterName");return{page:parseInt(P.get("page")||"0",10),size:parseInt(P.get("size")||"10",10),sort:"orderNum,asc",removed:!1,...F&&{chapterName:F},...u&&{chapterType:parseInt(u,10)},..._&&{weekDay:parseInt(_,10)},...Z&&{blackHoleMapId:parseInt(Z,10)},...C&&{stageNodeCount:parseInt(C,10)},...V&&{characterName:V}}},[s.search]),g=i.useMemo(()=>{const P=Object.keys(c).find(F=>Oa.includes(F)&&c[F]!==void 0);return P?{searchText:String(c[P]),currentField:P}:{searchText:"",currentField:Oa[0]}},[c]),[m,E]=i.useState(c),[f,T]=i.useState(g),[y,D]=i.useState(c.page+1),[S,j]=i.useState(c.chapterType),w=i.useCallback(P=>F=>{let u,_;if(typeof F=="number"||typeof F=="string"||typeof F=="boolean"?u=F:u=F.target.value,Lx(P)){const C={};Oa.forEach(V=>{V===P&&u?C[V]=u:delete m[V]}),_={...m,...C}}else if(P==="chapterType"&&u===0){const{chapterType:C,...V}=m;_=V}else _={...m,[P]:u};P!=="page"&&(_.page=0,D(1));const Z=ut(_);E(_),n(`?${Z}`)},[n,m]),O=i.useCallback((P,F)=>{w("page")(String(F-1)),D(F)},[w]),B=i.useCallback(()=>{if(y){const P={...m,page:y-1},F=ut(P);E(P),n(`?${F}`)}},[y,m,n]),k=i.useCallback(P=>{T(F=>({...F,searchText:P}))},[T]),q=i.useCallback(P=>{T(F=>({...F,currentField:P}))},[]),H=i.useCallback(()=>{const{currentField:P,searchText:F}=f;w(P)(F)},[w,f]),G=i.useCallback(P=>{j(P),w("chapterType")(P)},[w]),{mutate:N}=kl(()=>{t.invalidateQueries({queryKey:[Za.BLACK_HOLE_CHAPTER_SEARCH]}),a({open:!0,message:"刪除成功！"})}),L=i.useCallback(P=>{N({id:P,permanent:!1})},[N]),M=i.useCallback((P,F)=>{a({open:!0,message:`確定要刪除黑洞章節「${F}」嗎？`,onOk:()=>L(P),onCancel:()=>a({open:!1})})},[a,L]),{data:Y,isSuccess:U,isLoading:A}=Al(m),p=i.useMemo(()=>{var P;return U&&!!((P=Y==null?void 0:Y.content)!=null&&P.length)},[U,Y]),x=[{title:"編輯",dataField:"edit",component:P=>e.jsx(v,{label:"編輯",onClick:()=>h(String(P.id)),btnColor:"TAB_BLUE"})},{title:"章節名稱",dataField:"chapterName"},{title:"關卡數量",dataField:"stageNum"},{title:"排序編號",dataField:"orderNum"},{title:"章節類型",dataField:"chapterType",component:P=>e.jsx(z,{variant:"h5",children:Kn(P.chapterType,gs)})},{title:"星期",dataField:"weekDay",width:"fit-content",component:P=>e.jsx(z,{variant:"h5",children:Kn(P.weekDay,Os)})},{title:"狀態",dataField:"flag",component:P=>e.jsx(z,{variant:"h5",children:Kn(P.flag,Hr)})},{title:"更新時間",dataField:"updateTime",component:P=>e.jsx(z,{variant:"h5",children:P.updateTime})},{title:"刪除",dataField:"delete",component:P=>e.jsx(v,{label:"刪除",onClick:()=>M(P.id,P.chapterName),btnColor:"RED"})}],h=i.useCallback(P=>{n(`/edit/blackHoleChapterEdit/update/${P}`)},[n]),I=i.useCallback(()=>{n("/edit/blackHoleChapterEdit/create")},[n]);return e.jsxs(o,{flex:1,px:3,gap:5,children:[e.jsxs(o,{direction:"row",justifyContent:"flex-end",gap:2,children:[e.jsx(v,{label:"編輯排序",onClick:()=>l(!0),btnColor:"SUN_ORANGE"}),e.jsx(v,{label:"創建黑洞章節",onClick:I,btnColor:"BLUE"})]}),e.jsxs(o,{direction:"row",alignItems:"center",gap:3,children:[e.jsx(Ve,{label:"章節類型",options:gs,value:S||0,onChange:P=>G(P.target.value)}),e.jsx(vt,{value:f,options:io,selectOnChange:q,inputOnChange:k,searchFuntion:H}),e.jsx(v,{label:"搜尋",onClick:H,btnColor:"BROWN"})]}),A?e.jsx(Ge,{}):Y&&e.jsx(lt,{isVisible:p,children:e.jsxs(o,{gap:3,alignItems:"center",children:[e.jsx(Tt,{columns:x,rows:Y.content}),e.jsx(Yt,{totalPages:Y.totalPages,currentPage:Y.pageable.pageNumber,inputPage:y,setInputPage:D,handlePageChange:O,handlePageSearch:B})]})},JSON.stringify(m)),r&&e.jsx(Rx,{open:r,onClose:()=>l(!1)})]})},_x=Px,Mx=Va(zt)(({theme:t})=>({"& .MuiDialogContent-root":{padding:t.spacing(2)},"& .MuiDialogActions-root":{padding:t.spacing(1)},maxWidth:850,maxHeight:750,margin:"auto"})),Ss=(t,a)=>{var s;const n=t==null?void 0:t.find(r=>{var l;return((l=r.data)==null?void 0:l.id)===a});return((s=n==null?void 0:n.data)==null?void 0:s.src)||""},Fx=({itemData:t,handleSelectItem:a,selectedItemId:n,itemImages:s})=>e.jsx(o,{spacing:2,sx:{p:2},children:e.jsx(K,{container:!0,children:t.map(r=>e.jsx(K,{item:!0,xs:12,md:6,lg:4,direction:"row",alignItems:"center",spacing:2,onClick:()=>a==null?void 0:a(r),sx:{p:2,border:`2px solid ${n===r.id?$.TAB_BLUE:"transparent"}`,borderRadius:1,cursor:"pointer","&:hover":{backgroundColor:$.LIGHT_GRAY}},children:e.jsx(o,{direction:"row",spacing:2,children:e.jsxs(o,{alignItems:"center",justifyContent:"center",gap:2,children:[r.dropItemPicId&&Ss(s||[],r.dropItemPicId)?e.jsx("img",{src:Ss(s||[],r.dropItemPicId),loading:"lazy",style:{width:"100%",borderRadius:1}}):e.jsx(Mn,{variant:"rectangular",width:100,height:100,sx:{borderRadius:1}}),e.jsx(Kt,{label:r.dropItemName,color:n===r.id?"primary":"default"})]})})},r.id))})});function oo({open:t,setOpen:a,onSelectItem:n,disabledSearch:s,title:r="搜尋圖片"}){var H;const l=i.useMemo(()=>({name:"",page:0,...cn}),[]),[c,g]=i.useState(""),[m,E]=i.useState(l),[f,T]=i.useState(null),{data:y,isLoading:D}=$r(m),S=Es(((H=y==null?void 0:y.content)==null?void 0:H.map(G=>({id:G.dropItemPicId})))??[]),j=(G,N)=>{E(L=>({...L,page:N-1}))},w=()=>{a(!1),T(null),g(""),E(l)},O=()=>{if(!f)return;const G=Ss(S,f.dropItemPicId);n==null||n(f,G),a(!1),T(null)},B=G=>{T(G)},k=i.useCallback(G=>{g(G.target.value.trim())},[]),q=i.useCallback(()=>{E(G=>({...G,name:c,page:0}))},[c]);return e.jsxs(Mx,{onClose:w,"aria-labelledby":"customized-dialog-title",fullScreen:!0,open:t,children:[e.jsxs(Qt,{id:"customized-dialog-title",children:[e.jsx(z,{sx:{textAlign:"center",fontSize:"2rem",fontWeight:"bold"},children:r}),!s&&e.jsxs(o,{direction:"row",justifyContent:"center",alignItems:"center",gap:3,my:2,children:[e.jsx(Jn,{placeholder:"輸入圖片名稱...",value:c,onChange:k,onKeyDown:G=>Is(G,q)}),e.jsx(v,{label:"搜尋",btnColor:"BTN_LATTE_GRAY",onClick:q})]})]}),e.jsx(Ze,{"aria-label":"close",onClick:w,sx:{position:"absolute",right:8,top:8,color:G=>G.palette.grey[500]},children:e.jsx(Vt,{})}),e.jsx(dn,{dividers:!0,children:D?e.jsx(o,{flex:1,children:e.jsx(Ge,{})}):y!=null&&y.content?e.jsxs(o,{flex:1,children:[e.jsx(Fx,{itemData:y.content,handleSelectItem:B,selectedItemId:f==null?void 0:f.id,itemImages:S}),e.jsx(bn,{count:y.totalPages,page:y.pageable.pageNumber+1,onChange:j,color:"primary",sx:{mx:"auto",mt:2}})]}):e.jsx(o,{justifyContent:"center",alignItems:"center",sx:{minHeight:200},children:e.jsx(z,{children:"無搜尋結果"})})}),e.jsxs(Ts,{sx:{my:1},children:[e.jsx(v,{label:"取消",onClick:w,btnColor:"CANCEL_RED"}),e.jsx(v,{label:"選擇",onClick:O,disabled:!f})]})]})}const da=class da{static MENTOR(a){return`/ws/static/mentor/${a}`}};da.MENTOR_SELECTED="/ws/static/mentor/selected",da.MENTOR_PIC="/mentor/pic",da.MENTOR_HALFPIC="/mentor/halfPic";let An=da;async function Bx(t){try{return(await Ye.get(An.MENTOR_PIC,{params:t})).data.data}catch(a){throw new Error(`${An.MENTOR_PIC}, ${a}`)}}async function Hx(t){try{return(await Ye.get(An.MENTOR_HALFPIC,{params:t})).data.data}catch(a){throw new Error(`${An.MENTOR_HALFPIC}, ${a}`)}}function $x(t){return Ue({queryKey:[An.MENTOR_PIC,t],queryFn:()=>Bx(t)})}function Gx(t){return Ue({queryKey:[An.MENTOR_HALFPIC,t],queryFn:()=>Hx(t)})}const ua=class ua{};ua.PET_ALL="/ws/static/pet/all",ua.PET_PARTY="/ws/static/pet/party",ua.PET_PIC="/pet/pic";let Ha=ua;async function Wx(t){try{return(await Ye.get(Ha.PET_PIC,{params:t})).data.data}catch(a){throw new Error(`getPetPic, ${a}`)}}function lo(t){return Ue({queryKey:[`${Ha.PET_PIC}`,t],queryFn:()=>Wx(t)})}const Yx={MENTOR:$x,MENTOR_HALFPIC:Gx,PET:lo,FILE:vo,ENEMY:$c},Ux=({type:t,request:a})=>t==="PET"?lo(a):Yx[t](a),qx=({item:t,handleSelect:a,selectedId:n})=>{const{data:s}=qt({id:t.id}),r=()=>{a==null||a(t)};return e.jsx(K,{item:!0,xs:12,md:6,direction:"row",alignItems:"center",spacing:2,onClick:r,sx:{p:2,border:`2px solid ${n===t.id?$.TAB_BLUE:"transparent"}`,borderRadius:1,cursor:"pointer","&:hover":{backgroundColor:$.LIGHT_GRAY}},children:e.jsx(o,{direction:"row",justifyContent:"center",spacing:2,children:e.jsxs(o,{alignItems:"center",gap:2,flex:1,children:[s?e.jsx("img",{loading:"lazy",style:{width:"100%",objectFit:"contain"},src:s.src,alt:t.name}):e.jsx(Mn,{variant:"rectangular",width:"100%",height:"200px",sx:{borderRadius:1}}),e.jsx(Kt,{label:t.name,color:n===t.id?"primary":"default"})]})})},t.id)},Vx=({data:t,handleSelect:a,selectedId:n})=>e.jsx(o,{spacing:2,sx:{p:2},children:e.jsx(K,{container:!0,children:t.map(s=>e.jsx(qx,{item:s,handleSelect:a,selectedId:n},s.id))})});function na({open:t,setOpen:a,type:n,onSelect:s,disabledSearch:r,title:l="搜尋圖片",filterTypeOptions:c}){const[g,m]=i.useState(n),[E,f]=i.useState(null),[T,y]=i.useState(null),[D,S]=i.useState(""),j=i.useCallback(U=>{S(U.target.value)},[]),[w,O]=i.useState(null),[B,k]=i.useState({page:0,size:10,name:D.trim(),...T?{type:T}:{}}),q=i.useCallback(()=>{k(U=>({...U,name:D.trim(),page:0}))},[D]),{data:H,isLoading:G}=Ux({type:g,request:B}),N=U=>{const A=c==null?void 0:c[U],p=A==null?void 0:A.fileApiType,x=A==null?void 0:A.petApiType;m((A==null?void 0:A.type)||n),f(p||null),y(x||null),k(h=>({...h,page:0,...x?{type:x}:{}}))},L=U=>{O(U)},M=()=>{w&&(s==null||s(w),a(!1),O(null))},Y=(U,A)=>{k(p=>({...p,page:A-1}))};return i.useEffect(()=>{m(n),y(null)},[n]),i.useEffect(()=>{c&&c.length>0&&N(0)},[c]),e.jsxs(wr,{onClose:()=>a(!1),"aria-labelledby":"customized-dialog-title",fullScreen:!0,open:t,children:[e.jsxs(Qt,{id:"customized-dialog-title",children:[e.jsx(z,{sx:{textAlign:"center",fontSize:"2rem",fontWeight:"bold"},children:l}),!r&&e.jsxs(o,{direction:"row",justifyContent:"center",alignItems:"center",gap:3,my:2,children:[e.jsx(Jn,{placeholder:"輸入名稱...",value:D,onChange:j,onKeyDown:U=>Is(U,q)}),e.jsx(v,{label:"搜尋",btnColor:"BTN_LATTE_GRAY",onClick:q})]})]}),e.jsx(Ze,{"aria-label":"close",onClick:()=>a(!1),sx:{position:"absolute",right:8,top:8,color:U=>U.palette.grey[500]},children:e.jsx(Vt,{})}),e.jsx(dn,{dividers:!0,sx:{height:"calc(100vh - 200px)",overflow:"hidden",p:0},children:e.jsxs(o,{flexDirection:"row",sx:{height:"100%",position:"relative"},children:[c&&e.jsx(o,{sx:{flexShrink:0,position:"sticky",top:0,alignSelf:"flex-start",zIndex:100,backgroundColor:"white",maxHeight:"100%",overflowY:"auto"},children:c.map((U,A)=>e.jsx(ko,{label:U.label,onClick:()=>N(A),sx:{fontWeight:800,backgroundColor:g==U.type&&E==U.fileApiType?$.BLACK:"none",color:g==U.type&&E==U.fileApiType?$.WHITE:"none"}},U.value))}),e.jsx(o,{sx:{flex:1,height:"100%",overflowY:"auto",p:2},children:G?e.jsx(o,{alignItems:"center",justifyContent:"center",sx:{height:"100%"},children:e.jsx(Ge,{})}):H&&H.content.length>0?e.jsxs(e.Fragment,{children:[e.jsx(Vx,{data:H.content,handleSelect:L,selectedId:w==null?void 0:w.id}),e.jsx(bn,{count:H.totalPages,page:H.pageable.pageNumber+1,onChange:Y,color:"primary",sx:{mx:"auto",mt:2}})]}):e.jsx(o,{alignItems:"center",justifyContent:"center",sx:{height:"100%"},children:e.jsx(z,{variant:"h6",children:"查無資料"})})})]})}),e.jsxs(Ts,{sx:{my:1},children:[e.jsx(v,{label:"取消",onClick:()=>a(!1),btnColor:"CANCEL_RED"}),e.jsx(v,{label:"選擇",disabled:!w,onClick:M})]})]})}const Kx=({map:t,isSelected:a,onSelect:n})=>{const{data:s,isLoading:r}=qt({id:t.picId});return e.jsx(K,{item:!0,xs:12,md:6,onClick:()=>n(t),sx:{p:2,border:`2px solid ${a?$.TAB_BLUE:"transparent"}`,borderRadius:1,cursor:"pointer","&:hover":{backgroundColor:"#f5f5f5"}},children:e.jsxs(o,{spacing:2,justifyContent:"flex-start",alignItems:"center",children:[r?e.jsx(Mn,{variant:"rectangular",width:"100%",height:"200px",sx:{borderRadius:1}}):s!=null&&s.src?e.jsx("img",{src:s.src,alt:t.mapName,loading:"lazy",style:{width:"100%",objectFit:"contain",borderRadius:1}}):e.jsx(Mn,{variant:"rectangular",width:"100%",sx:{borderRadius:1}}),e.jsx(Kt,{label:t.mapName,color:a?"primary":"default"})]})},t.id)},zx=({mapData:t,handleSelectMap:a,selectedMapId:n})=>e.jsx(o,{spacing:2,sx:{p:2},children:e.jsx(K,{container:!0,spacing:2,children:t.map(s=>e.jsx(Kx,{map:s,isSelected:n===s.id,onSelect:a},s.id))})});function co({open:t,setOpen:a,onSelectMap:n,title:s="選擇黑洞地圖節點"}){const{data:r,isLoading:l}=Nl(!1),[c,g]=i.useState(null),{data:m}=qt({id:(c==null?void 0:c.picId)||0}),E=()=>{a(!1),g(null)},f=()=>{if(!c)return;const y=(m==null?void 0:m.src)||"";n==null||n(c,y),a(!1),g(null)},T=y=>{g(y)};return e.jsxs(wr,{onClose:E,"aria-labelledby":"customized-dialog-title",fullScreen:!0,open:t,children:[e.jsx(Qt,{id:"customized-dialog-title",children:e.jsx(z,{sx:{textAlign:"center",fontSize:"2rem",fontWeight:"bold"},children:s})}),e.jsx(Ze,{"aria-label":"close",onClick:E,sx:{position:"absolute",right:8,top:8,color:y=>y.palette.grey[500]},children:e.jsx(Vt,{})}),e.jsx(dn,{dividers:!0,children:l?e.jsx(o,{flex:1,children:e.jsx(Ge,{})}):r&&r.length>0?e.jsx(o,{flex:1,children:e.jsx(zx,{mapData:r,handleSelectMap:T,selectedMapId:c==null?void 0:c.id})}):e.jsx(o,{flex:1,alignItems:"center",justifyContent:"center",children:e.jsx(z,{children:"無資料"})})}),e.jsxs(Ts,{sx:{my:1},children:[e.jsx(v,{label:"取消",onClick:E,btnColor:"CANCEL_RED"}),e.jsx(v,{label:"選擇",onClick:f,disabled:!c})]})]})}const ps=[{label:"黑洞背景",value:"FILE",type:"FILE",fileApiType:"BLACK_HOLE_CHAPTER_BG"},{label:"對話背景",value:"FILE",type:"FILE",fileApiType:"BLACK_HOLE_DIALOGUE_BG"}],Qx=({nodeIndex:t,dialogueMinInfoOptions:a})=>{const{control:n,setValue:s}=$e(),{fields:r,append:l,remove:c}=It({control:n,name:`blackHoleStages.${t}.blackHoleStageDropItems`}),g=Be({control:n,name:`blackHoleStages.${t}.stagePicId`}),{data:m,isLoading:E}=qt({id:g||void 0}),[f,T]=i.useState(0),[y,D]=i.useState(!1),[S,j]=i.useState(!1),w=i.useCallback(()=>{if(r.length>=5)return;l({id:0,blackHoleStageId:0,dropItemId:0,dropItemName:"",dropItemPicId:0,rewardCount:1})},[l,r.length]),O=i.useCallback(N=>{T(N),D(!0)},[]),B=i.useCallback(N=>{const L=`blackHoleStages.${t}.blackHoleStageDropItems.${f}`;s(`${L}.dropItemId`,N.id,{shouldValidate:!0}),s(`${L}.dropItemName`,N.dropItemName,{shouldValidate:!0}),s(`${L}.dropItemPicId`,N.dropItemPicId,{shouldValidate:!0}),s(`${L}.rewardCount`,1,{shouldValidate:!0}),D(!1)},[t,f,s]),k=({itemIndex:N})=>{const L=Be({control:n,name:`blackHoleStages.${t}.blackHoleStageDropItems.${N}.dropItemPicId`}),{data:M}=qt({id:L??0});return!L||!(M!=null&&M.src)?e.jsx(o,{justifyContent:"center",alignItems:"center",gap:1,sx:{background:"#f8f9fa",borderRadius:1,p:3,minHeight:"120px"},children:e.jsx(z,{color:"text.secondary",children:"請選擇掉落物"})}):e.jsx(o,{justifyContent:"center",alignItems:"center",gap:1,sx:{background:"#f8f9fa",borderRadius:1,p:1},children:e.jsx(Dt,{src:M.src,width:120})})},q=({itemIndex:N})=>{const L=Be({control:n,name:`blackHoleStages.${t}.blackHoleStageDropItems.${N}.dropItemName`});return e.jsx(z,{sx:{fontWeight:"bold",fontSize:"1rem",color:$.DRAWER_GRAY},children:`掉落物 ${N+1}${L?` - ${L}`:""}`})},H=()=>{j(!0)},G=N=>{s(`blackHoleStages.${t}.stageId`,N.id,{shouldValidate:!0}),s(`blackHoleStages.${t}.stagePicId`,N.picId,{shouldValidate:!0}),s(`blackHoleStages.${t}.stageName`,N.name,{shouldValidate:!0}),j(!1)};return e.jsxs(o,{gap:3,border:"1px solid #ccc",p:3,borderRadius:2,children:[e.jsxs(z,{fontSize:"1.5rem",fontWeight:"bold",children:["黑洞節點 ",t+1]}),e.jsxs(K,{container:!0,spacing:3,children:[e.jsx(K,{item:!0,xs:12,md:6,lg:4,children:e.jsx(ie,{name:`blackHoleStages.${t}.blackHoleStageName`,label:"節點名稱",variant:"control",alertText:"必填"})}),e.jsx(K,{item:!0,xs:12,md:6,lg:4,children:e.jsx(je,{name:`blackHoleStages.${t}.dialogueGroupId`,label:"對話群組",variant:"control",type:"ONE",alertText:"必填",options:a})}),e.jsx(K,{item:!0,xs:12,md:6,lg:4,children:e.jsx(je,{name:`blackHoleStages.${t}.blackHoleStageType`,label:"節點類型",variant:"control",type:"ONE",alertText:"必填",options:Ur})}),e.jsx(K,{item:!0,xs:12,md:6,lg:4,children:e.jsx(ie,{name:`blackHoleStages.${t}.oil`,label:"需求油料",variant:"control",alertText:"必填",type:"number"})}),e.jsx(K,{item:!0,xs:12,md:6,lg:4,children:e.jsx(ie,{name:`blackHoleStages.${t}.extraPoint`,label:"首通積分",variant:"control",alertText:"必填",type:"number"})}),e.jsx(K,{item:!0,xs:12,md:6,lg:4,children:e.jsx(je,{name:`blackHoleStages.${t}.pointMultiplier`,label:"積分倍率",variant:"control",type:"ONE",alertText:"必填",options:Pa})}),e.jsx(K,{item:!0,xs:12,md:6,lg:4,children:e.jsx(ie,{name:`blackHoleStages.${t}.extraEnergy`,label:"首通能量",variant:"control",alertText:"必填",type:"number"})}),e.jsx(K,{item:!0,xs:12,md:6,lg:4,children:e.jsx(je,{name:`blackHoleStages.${t}.energyMultiplier`,label:"能量倍率",variant:"control",type:"ONE",alertText:"必填",options:Pa})}),e.jsx(K,{item:!0,xs:12,md:6,lg:4,children:e.jsx(ie,{name:`blackHoleStages.${t}.expAmount`,label:"經驗書",variant:"control",alertText:"必填",type:"number"})}),e.jsx(K,{item:!0,xs:12,md:6,lg:4,children:e.jsx(ie,{name:`blackHoleStages.${t}.aiChip`,label:"AI 晶片",variant:"control",alertText:"必填",type:"number"})}),e.jsx(K,{item:!0,xs:12,md:6,lg:8}),e.jsx(K,{item:!0,xs:12,md:4,children:e.jsx(et,{name:`blackHoleStages.${t}.stageName`,control:n,render:({field:N,fieldState:{error:L}})=>e.jsxs(o,{gap:2,children:[e.jsxs(o,{gap:2,flexDirection:"row",alignItems:"center",children:[e.jsx(he,{width:"192px",children:"關卡名稱"}),e.jsx(o,{gap:1,children:e.jsx(Kt,{label:N.value||"請選擇關卡 !",fontSize:"1.125rem",color:"default"})}),e.jsx(v,{label:"選擇關卡",btnColor:"TAB_BLUE",onClick:H})]}),E?e.jsx(Mn,{variant:"rectangular",sx:{borderRadius:3,width:"280px",height:"280px",margin:"16px auto"}}):e.jsx("img",{loading:"lazy",src:(m==null?void 0:m.src)||"",width:280,style:{margin:"16px auto"}}),!!L&&e.jsx(o,{sx:{border:`1px solid ${$.CANCEL_RED}`,p:3},children:e.jsx(ht,{sx:{textAlign:"center",color:"red"},children:L.message})})]})})}),e.jsx(K,{item:!0,xs:12,md:8,children:e.jsxs(K,{container:!0,spacing:3,children:[e.jsx(K,{item:!0,xs:12,children:e.jsxs(o,{gap:2,flexDirection:"row",children:[e.jsx(he,{width:"240px",children:"黑洞掉落物列表"}),e.jsx(v,{label:"新增掉落物",btnColor:"BROWN",onClick:w,sx:{borderRadius:99,padding:"0 24px"}})]})}),r.map((N,L)=>e.jsx(K,{item:!0,xs:12,md:6,lg:4,children:e.jsx(Dr,{elevation:2,sx:{p:3,borderRadius:2,background:$.WHITE},children:e.jsxs(o,{spacing:3,children:[e.jsxs(o,{direction:"row",justifyContent:"space-between",alignItems:"center",children:[e.jsx(q,{itemIndex:L}),e.jsxs(o,{direction:"row",spacing:1,children:[e.jsx(v,{label:"選擇物品",btnColor:"TAB_BLUE",onClick:()=>O(L),sx:{borderRadius:2,minWidth:"auto",px:2}}),e.jsx(v,{label:"移除",btnColor:"CANCEL_RED",onClick:()=>c(L),sx:{borderRadius:2,minWidth:"auto",px:2}})]})]}),e.jsx(k,{itemIndex:L}),e.jsx(ie,{name:`blackHoleStages.${t}.blackHoleStageDropItems.${L}.rewardCount`,label:"數量",variant:"control",alertText:"必填，黑洞掉落物數量",type:"number"})]})})},N.id))]})})]}),e.jsx(Ys,{open:S,closeFn:()=>j(!1),selectFn:G,stageList:[],range:!1,deleteFn:()=>{},missionCount:1}),e.jsx(oo,{open:y,setOpen:D,onSelectItem:B})]})},Xx=()=>{const t=Me(),{setAlertOpen:a}=_e(),{setValue:n,handleSubmit:s,reset:r,watch:l}=$e(),{setUploadDialogOpen:c,characterSelectedImage:g,setCharacterSelectedImage:m,setSelectedType:E,blackHoleChapterBgSelectedImage:f,setBlackHoleChapterBgSelectedImage:T,blackHoleMapSelectedImage:y,setBlackHoleMapSelectedImage:D}=Rt(),{control:S}=$e(),j=Be({control:S,name:"chapterType"}),{setFlag:w}=at();function O(){a({open:!0,title:"提示",message:"創建成功!"}),r(),m(null),D(null),T(null),t("/edit/blackHoleChapterEdit")}const{mutate:B}=Ol(O),{data:k}=Gr((f==null?void 0:f.id)??0),q=i.useCallback(X=>{E(X),c(!0)},[c,E]),H=i.useCallback((X,R)=>{X==="mapId"&&p(0),X==="characterPicId"&&n("characterName","",{shouldValidate:!0}),R(null),n(X,0,{shouldValidate:!0})},[n]),{data:G}=Wr(1),N=(G==null?void 0:G.map(X=>({label:X.groupName,value:X.id})))||[],[L,M]=i.useState(!1),[Y,U]=i.useState(!1),[A,p]=i.useState(0),[x,h]=i.useState("MENTOR_HALFPIC"),[I,P]=i.useState(ps),F=(X,R)=>{const b=Array.from({length:X.stageNodeCount}).map((W,le)=>({blackHoleStageName:"",dialogueGroupId:0,blackHoleStageType:0,oil:0,extraPoint:0,pointMultiplier:0,extraEnergy:0,energyMultiplier:0,expAmount:0,aiChip:0,stageId:0,stagePicId:0,showStageName:"",orderNum:le+1,chapterId:0,blackHoleStageDropItems:[]}));n("blackHoleStages",b),n("mapId",X.id,{shouldValidate:!0}),n("stageNum",X.stageNodeCount,{shouldValidate:!0}),p(X.stageNodeCount),D({id:X.picId,src:R||""}),M(!1)},u=async X=>{const R=await Jt({id:X.id});X.type==="BLACK_HOLE_CHAPTER_BG"||X.type==="BLACK_HOLE_DIALOGUE_BG"?(n("backgroundPicId",X.id,{shouldValidate:!0}),T({id:X.id,src:(R==null?void 0:R.src)||""})):(X.type==="MENTOR"||X.type==="PET")&&(n("characterPicId",X.id,{shouldValidate:!0}),n("characterName",X.name,{shouldValidate:!0}),m({id:X.id,src:(R==null?void 0:R.src)||""}))},_=i.useCallback(X=>{if(X==="FILE"){P(ps),U(!0);return}j===0||j===1||j===4?(P([{label:"時空導師",value:"MENTOR",type:"MENTOR_HALFPIC",fileApiType:"MENTOR"}]),X!=="MENTOR_HALFPIC"&&(n("characterPicId",0,{shouldValidate:!0}),H("characterPicId",m)),h("MENTOR_HALFPIC"),E("MENTOR")):j===2||j===3?(P([{label:"戰寵",value:"PET",type:"PET",fileApiType:"PET"}]),X!=="PET"&&(n("characterPicId",0,{shouldValidate:!0}),H("characterPicId",m)),h("PET"),E("PET")):(h(X),P(ps)),U(!0)},[U,j,h,E,P]),Z=X=>{w(X),n("flag",X)},C=X=>{B(X)},V=X=>{X.flag===qe.PUBLISHED?a({open:!0,title:"提示",message:"確定要發佈黑洞章節嗎？",onOk:()=>C(X)}):X.flag===qe.DRAFT&&a({open:!0,title:"提示",message:"確定要儲存為草稿嗎？",onOk:()=>C(X)})};i.useEffect(()=>{j!=null&&(n("characterPicId",0,{shouldValidate:!0}),n("characterName","",{shouldValidate:!0}),m(null))},[j]),i.useEffect(()=>{f?n("backgroundPicId",f.id,{shouldValidate:!0}):n("backgroundPicId",0,{shouldValidate:!0}),g?n("characterPicId",g.id,{shouldValidate:!0}):n("characterPicId",0,{shouldValidate:!0})},[n,f,g]);const se=()=>{const{setValue:X}=$e();return j!==3?(X("weekDay",null,{shouldValidate:!0}),null):e.jsx(je,{name:"weekDay",label:"星期設定",variant:"control",type:"ONE",alertText:"章節類型選擇每日時，必需填入星期",options:Os})};return i.useEffect(()=>(r(),m(null),D(null),T(null),p(0),w(qe.PUBLISHED),()=>{r(),m(null),D(null),T(null)}),[]),e.jsxs(it,{onSubmit:s(V),children:[e.jsxs(o,{gap:5,children:[e.jsxs(K,{container:!0,spacing:4,children:[e.jsx(K,{item:!0,xs:12,children:e.jsxs(K,{container:!0,spacing:2,children:[e.jsx(K,{item:!0,xs:12,md:6,children:e.jsx(ie,{name:"chapterName",label:"章節名稱",variant:"control",alertText:"必填"})}),e.jsx(K,{item:!0,xs:12,md:6,children:e.jsx(ie,{name:"oilStageNum",label:"油料關卡數量",variant:"control",alertText:"必填",type:"number"})}),e.jsx(K,{item:!0,xs:12,md:6,children:e.jsx(je,{name:"chapterType",label:"章節類型",variant:"control",type:"ONE",alertText:"必填，當章節類型切換時，會自動移除已選擇的角色圖片",options:Yr})}),e.jsx(K,{item:!0,xs:12,md:6,children:e.jsx(je,{name:"dialogueGroupId",label:"對話群組",variant:"control",type:"ONE",alertText:"必填",options:N})}),e.jsx(K,{item:!0,xs:12,md:6,children:e.jsx(se,{})})]})}),e.jsxs(K,{item:!0,xs:12,md:6,children:[e.jsx(et,{name:"characterPicId",control:S,render:({field:X,fieldState:{error:R}})=>e.jsxs(o,{gap:2,...X,children:[e.jsxs(o,{gap:2,flexDirection:"row",children:[e.jsx(he,{children:"角色圖片"}),e.jsx(v,{label:"上傳圖片",btnColor:"BROWN",onClick:()=>q("CHARACTER"),sx:{borderRadius:99,padding:"0 24px"}}),e.jsx(v,{label:"搜尋圖片",btnColor:"BROWN",onClick:()=>_(x),sx:{borderRadius:99,padding:"0 24px"}}),(g==null?void 0:g.src)&&e.jsx(v,{label:"移除",btnColor:"CANCEL_RED",onClick:()=>H("characterPicId",m)})]}),!!R&&e.jsx(o,{sx:{border:`1px solid ${$.CANCEL_RED}`,p:3},children:e.jsx(ht,{sx:{textAlign:"center",color:"red"},children:R.message})})]})}),e.jsxs(o,{justifyContent:"center",alignItems:"center",gap:2,children:[e.jsx("img",{src:g==null?void 0:g.src,width:"400px"}),l("characterName")&&e.jsx(Kt,{label:l("characterName")})]})]}),e.jsx(K,{item:!0,xs:12,md:6,children:e.jsxs(o,{gap:2,children:[e.jsx(et,{control:S,name:"backgroundPicId",render:({field:X,fieldState:{error:R}})=>e.jsxs(o,{gap:2,...X,children:[e.jsxs(o,{gap:2,flexDirection:"row",justifyContent:"flex-start",alignItems:"stretch",children:[e.jsx(he,{children:"黑洞章節背景"}),e.jsx(v,{label:"上傳圖片",btnColor:"BROWN",onClick:()=>q("BLACK_HOLE_CHAPTER_BG"),sx:{borderRadius:99,padding:"0 24px"}}),e.jsx(v,{label:"搜尋圖片",btnColor:"BROWN",onClick:()=>_("FILE"),sx:{borderRadius:99,padding:"0 24px"}}),(f==null?void 0:f.src)&&e.jsx(v,{label:"移除",btnColor:"CANCEL_RED",onClick:()=>H("backgroundPicId",T)})]}),!!R&&e.jsx(o,{sx:{border:`1px solid ${$.CANCEL_RED}`,p:3},children:e.jsx(ht,{sx:{textAlign:"center",color:"red"},children:R.message})})]})}),e.jsxs(o,{gap:3,children:[e.jsx(et,{control:S,name:"mapId",render:({field:X,fieldState:{error:R}})=>e.jsxs(o,{gap:2,...X,children:[e.jsxs(o,{gap:2,flexDirection:"row",justifyContent:"flex-start",alignItems:"stretch",children:[e.jsx(he,{children:"黑洞地圖節點"}),e.jsx(v,{label:"選擇地圖",btnColor:"BROWN",onClick:()=>M(!0),sx:{borderRadius:99,padding:"0 24px"}}),(y==null?void 0:y.src)&&e.jsx(v,{label:"移除",btnColor:"CANCEL_RED",onClick:()=>H("mapId",D)})]}),!!R&&e.jsx(o,{sx:{border:`1px solid ${$.CANCEL_RED}`,p:3},children:e.jsx(ht,{sx:{textAlign:"center",color:"red"},children:R.message})})]})}),e.jsxs(o,{justifyContent:"center",alignItems:"center",gap:2,children:[e.jsx(ke,{sx:{width:"480px",height:f!=null&&f.src?"270px":"100%",backgroundImage:`url(${f==null?void 0:f.src})`,backgroundSize:"contain",backgroundPosition:"center",backgroundRepeat:"no-repeat",display:"flex",justifyContent:"center",alignItems:"center"},children:(y==null?void 0:y.src)&&e.jsx(Dt,{src:y==null?void 0:y.src,width:480,height:270})}),(k==null?void 0:k.name)&&e.jsx(Kt,{label:k.name})]})]})]})})]}),Array.from({length:A||0}).map((X,R)=>e.jsx(Qx,{nodeIndex:R,dialogueMinInfoOptions:N},R)),e.jsxs(o,{flexDirection:"row",justifyContent:"flex-end",alignItems:"center",gap:2,children:[e.jsx(v,{label:"儲存草稿",btnColor:"DRAWER_GRAY",type:"submit",onClick:()=>Z(qe.DRAFT)}),e.jsx(v,{label:"發佈",btnColor:"TAB_BLUE",type:"submit",onClick:()=>Z(qe.PUBLISHED)})]})]}),e.jsx(co,{open:L,setOpen:M,onSelectMap:F}),e.jsx(na,{open:Y,setOpen:U,onSelect:u,type:x,filterTypeOptions:I})]})},Jx=Xx,Zx=t=>t===qe.DRAFT?d.object({blackHoleStageName:d.string(),blackHoleStageType:d.union([d.number(),d.null()]),oil:d.union([d.number(),d.null()]),aiChip:d.union([d.number(),d.null()]),expAmount:d.union([d.number(),d.null()]),extraEnergy:d.union([d.number(),d.null()]),energyMultiplier:d.union([d.number(),d.null()]),extraPoint:d.union([d.number(),d.null()]),pointMultiplier:d.union([d.number(),d.null()]),orderNum:d.union([d.number(),d.null()]),dialogueGroupId:d.union([d.number(),d.null()]),chapterId:d.union([d.number(),d.null()]),stageId:d.union([d.number(),d.null()]),stagePicId:d.union([d.number(),d.null()]),stageName:d.union([d.string(),d.null()]),blackHoleStageDropItems:d.array(d.object({id:d.union([d.number(),d.null()]),blackHoleStageId:d.union([d.number(),d.null()]),dropItemId:d.union([d.number(),d.null()]),rewardCount:d.union([d.number(),d.null()])}))}):d.object({blackHoleStageName:d.string().min(1,"節點名稱必填"),blackHoleStageType:d.number().min(1,"關卡類型必選"),oil:d.number().min(1,"需求油料必需大於0"),aiChip:d.number().min(1,"AI 晶片必需大於0"),expAmount:d.number().min(1,"經驗書必需大於0"),extraEnergy:d.number().min(1,"首通能量必需大於0"),energyMultiplier:d.number().min(1,"請選擇能量倍率"),extraPoint:d.number().min(1,"首通積分必需大於0"),pointMultiplier:d.number().min(1,"請選擇積分倍率"),orderNum:d.number(),dialogueGroupId:d.number().min(1,"對話群組必選"),chapterId:d.number(),stageId:d.number(),stagePicId:d.number(),stageName:d.string().min(1,"關卡必選"),blackHoleStageDropItems:d.array(d.object({id:d.number(),blackHoleStageId:d.number(),dropItemId:d.number(),rewardCount:d.number().min(1,"掉落物數量必需大於0").max(12,"掉落物數量不能大於12")}))}),eg=t=>d.intersection(d.object({chapterName:d.string().min(1,"章節名稱必填"),chapterType:t===qe.DRAFT?d.number():d.number().min(1,"章節類型必填"),weekDay:d.union([d.number(),d.null()]),characterName:d.string(),characterPicId:t===qe.DRAFT?d.union([d.number(),d.null()]):d.number().min(1,"角色圖片必選"),dialogueGroupId:t===qe.DRAFT?d.union([d.number(),d.null()]):d.number().min(1,"對話群組必選"),backgroundPicId:t===qe.DRAFT?d.union([d.number(),d.null()]):d.number().min(1,"背景圖片必選"),mapId:t===qe.DRAFT?d.union([d.number(),d.null()]):d.number().min(1,"地圖節點必選"),stageNum:d.number(),blackHoleStages:d.array(Zx(t)),oilStageNum:t===qe.DRAFT?d.number():d.number().min(3,"油料關卡數量必需大於2").max(8,"油料關卡數量不能大於8"),flag:d.number(),stageId:d.number()}),d.discriminatedUnion("variant",[d.object({variant:d.literal("create")}),d.object({variant:d.literal("update"),id:d.number().min(1)})])).refine(a=>!(a.chapterType===3&&!a.weekDay),{message:"章節類型為每日時，星期必填",path:["weekDay"]}),uo={variant:"create",chapterName:"",chapterType:0,weekDay:null,characterName:"",characterPicId:null,dialogueGroupId:null,backgroundPicId:null,mapId:null,stageNum:0,blackHoleStages:[],oilStageNum:0,flag:qe.PUBLISHED,stageId:0},ms=[{label:"黑洞背景",value:"FILE",type:"FILE",fileApiType:"BLACK_HOLE_CHAPTER_BG"},{label:"對話背景",value:"FILE",type:"FILE",fileApiType:"BLACK_HOLE_DIALOGUE_BG"}],tg=({nodeIndex:t,dialogueMinInfoOptions:a})=>{const{control:n,setValue:s}=$e(),{fields:r,append:l,remove:c}=It({control:n,name:`blackHoleStages.${t}.blackHoleStageDropItems`}),g=Be({control:n,name:`blackHoleStages.${t}.stagePicId`}),{data:m,isLoading:E}=qt({id:g??0}),[f,T]=i.useState(0),[y,D]=i.useState(!1),[S,j]=i.useState(!1),w=i.useCallback(()=>{if(r.length>=5)return;l({id:0,blackHoleStageId:0,dropItemId:0,dropItemName:"",dropItemPicId:0,rewardCount:1})},[l,r.length]),O=i.useCallback(N=>{T(N),D(!0)},[]),B=i.useCallback(N=>{const L=`blackHoleStages.${t}.blackHoleStageDropItems.${f}`;s(`${L}.dropItemId`,N.id,{shouldValidate:!0}),s(`${L}.dropItemName`,N.dropItemName,{shouldValidate:!0}),s(`${L}.dropItemPicId`,N.dropItemPicId,{shouldValidate:!0}),s(`${L}.rewardCount`,1,{shouldValidate:!0}),D(!1)},[t,f,s]),k=({itemIndex:N})=>{const L=Be({control:n,name:`blackHoleStages.${t}.blackHoleStageDropItems.${N}.dropItemPicId`}),{data:M}=qt({id:L??0});return!L||L===0?e.jsx(o,{justifyContent:"center",alignItems:"center",gap:1,sx:{background:"#f8f9fa",borderRadius:1,p:3,minHeight:"120px"},children:e.jsx(z,{color:"text.secondary",children:"請選擇掉落物"})}):e.jsx(o,{justifyContent:"center",alignItems:"center",gap:1,sx:{background:"#f8f9fa",borderRadius:1,p:1},children:e.jsx(Dt,{src:M==null?void 0:M.src,width:120})})},q=({itemIndex:N})=>{const L=Be({control:n,name:`blackHoleStages.${t}.blackHoleStageDropItems.${N}.dropItemName`});return e.jsx(z,{sx:{fontWeight:"bold",fontSize:"1rem",color:$.DRAWER_GRAY},children:`掉落物 ${N+1}${L?` - ${L}`:""}`})},H=()=>{j(!0)},G=N=>{s(`blackHoleStages.${t}.stageId`,N.id),s(`blackHoleStages.${t}.stagePicId`,N.picId),s(`blackHoleStages.${t}.stageName`,N.name),j(!1)};return e.jsxs(o,{gap:3,border:"1px solid #ccc",p:3,borderRadius:2,children:[e.jsxs(z,{fontSize:"1.5rem",fontWeight:"bold",children:["黑洞節點 ",t+1]}),e.jsxs(K,{container:!0,spacing:3,children:[e.jsx(K,{item:!0,xs:12,md:6,lg:4,children:e.jsx(ie,{name:`blackHoleStages.${t}.blackHoleStageName`,label:"節點名稱",variant:"control",alertText:"必填"})}),e.jsx(K,{item:!0,xs:12,md:6,lg:4,children:e.jsx(je,{name:`blackHoleStages.${t}.dialogueGroupId`,label:"對話群組",variant:"control",type:"ONE",alertText:"必填",options:a})}),e.jsx(K,{item:!0,xs:12,md:6,lg:4,children:e.jsx(je,{name:`blackHoleStages.${t}.blackHoleStageType`,label:"節點類型",variant:"control",type:"ONE",alertText:"必填",options:Ur})}),e.jsx(K,{item:!0,xs:12,md:6,lg:4,children:e.jsx(ie,{name:`blackHoleStages.${t}.oil`,label:"需求油料",variant:"control",alertText:"必填",type:"number"})}),e.jsx(K,{item:!0,xs:12,md:6,lg:4,children:e.jsx(ie,{name:`blackHoleStages.${t}.extraPoint`,label:"首通積分",variant:"control",alertText:"必填",type:"number"})}),e.jsx(K,{item:!0,xs:12,md:6,lg:4,children:e.jsx(je,{name:`blackHoleStages.${t}.pointMultiplier`,label:"積分倍率",variant:"control",type:"ONE",alertText:"必填",options:Pa})}),e.jsx(K,{item:!0,xs:12,md:6,lg:4,children:e.jsx(ie,{name:`blackHoleStages.${t}.extraEnergy`,label:"首通能量",variant:"control",alertText:"必填",type:"number"})}),e.jsx(K,{item:!0,xs:12,md:6,lg:4,children:e.jsx(je,{name:`blackHoleStages.${t}.energyMultiplier`,label:"能量倍率",variant:"control",type:"ONE",alertText:"必填",options:Pa})}),e.jsx(K,{item:!0,xs:12,md:6,lg:4,children:e.jsx(ie,{name:`blackHoleStages.${t}.expAmount`,label:"經驗書",variant:"control",alertText:"必填",type:"number"})}),e.jsx(K,{item:!0,xs:12,md:6,lg:4,children:e.jsx(ie,{name:`blackHoleStages.${t}.aiChip`,label:"AI 晶片",variant:"control",alertText:"必填",type:"number"})}),e.jsx(K,{item:!0,xs:12,md:6,lg:8}),e.jsx(K,{item:!0,xs:12,md:4,children:e.jsx(et,{name:`blackHoleStages.${t}.stageName`,control:n,render:({field:N,fieldState:{error:L}})=>e.jsxs(o,{gap:2,children:[e.jsxs(o,{gap:2,flexDirection:"row",alignItems:"center",children:[e.jsx(he,{width:"192px",children:"關卡名稱"}),e.jsx(o,{gap:1,children:e.jsx(Kt,{label:N.value||"請選擇關卡 !",fontSize:"1.125rem",color:"default"})}),e.jsx(v,{label:"選擇關卡",btnColor:"TAB_BLUE",onClick:H})]}),E?e.jsx(Mn,{variant:"rectangular",sx:{borderRadius:3,width:"280px",height:"280px",margin:"16px auto"}}):e.jsx("img",{loading:"lazy",src:(m==null?void 0:m.src)||"",width:280,style:{margin:"16px auto"}}),!!L&&e.jsx(o,{sx:{border:`1px solid ${$.CANCEL_RED}`,p:3},children:e.jsx(ht,{sx:{textAlign:"center",color:"red"},children:L.message})})]})})}),e.jsx(K,{item:!0,xs:12,md:8,children:e.jsxs(K,{container:!0,spacing:3,children:[e.jsx(K,{item:!0,xs:12,children:e.jsxs(o,{gap:2,flexDirection:"row",children:[e.jsx(he,{width:"240px",children:"黑洞掉落物列表"}),e.jsx(v,{label:"新增掉落物",btnColor:"BROWN",onClick:w,sx:{borderRadius:99,padding:"0 24px"}})]})}),r.map((N,L)=>e.jsx(K,{item:!0,xs:12,md:6,lg:4,children:e.jsx(Dr,{elevation:2,sx:{p:3,borderRadius:2,background:$.WHITE},children:e.jsxs(o,{spacing:3,children:[e.jsxs(o,{direction:"row",justifyContent:"space-between",alignItems:"center",children:[e.jsx(q,{itemIndex:L}),e.jsxs(o,{direction:"row",spacing:1,children:[e.jsx(v,{label:"選擇物品",btnColor:"TAB_BLUE",onClick:()=>O(L),sx:{borderRadius:2,minWidth:"auto",px:2}}),e.jsx(v,{label:"移除",btnColor:"CANCEL_RED",onClick:()=>c(L),sx:{borderRadius:2,minWidth:"auto",px:2}})]})]}),e.jsx(k,{itemIndex:L}),e.jsx(ie,{name:`blackHoleStages.${t}.blackHoleStageDropItems.${L}.rewardCount`,label:"數量",variant:"control",alertText:"必填，黑洞掉落物數量",type:"number"})]})})},N.id))]})})]}),e.jsx(Ys,{open:S,closeFn:()=>j(!1),selectFn:G,stageList:[],range:!1,deleteFn:()=>{},missionCount:1}),e.jsx(oo,{open:y,setOpen:D,onSelectItem:B})]})},ng=()=>{const{id:t}=Lt(),{data:a,isLoading:n}=Rl(Number(t)),s=Me(),{setAlertOpen:r}=_e(),{setValue:l,handleSubmit:c,getValues:g,watch:m,reset:E}=$e(),{setUploadDialogOpen:f,characterSelectedImage:T,setCharacterSelectedImage:y,setSelectedType:D,blackHoleChapterBgSelectedImage:S,setBlackHoleChapterBgSelectedImage:j,blackHoleMapSelectedImage:w,setBlackHoleMapSelectedImage:O}=Rt(),{control:B}=$e(),k=Be({control:B,name:"chapterType"}),{setFlag:q}=at();function H(){r({open:!0,title:"提示",message:"更新成功!"}),s("/edit/blackHoleChapterEdit")}const{mutate:G}=Ll(Number(t),H),{data:N}=Gr((S==null?void 0:S.id)??0),L=i.useCallback(ne=>{D(ne),f(!0)},[f,D]),M=i.useCallback((ne,Q)=>{ne==="mapId"&&P(0),ne==="characterPicId"&&l("characterName","",{shouldValidate:!0}),Q(null),l(ne,0,{shouldValidate:!0})},[l]),{data:Y}=Wr(1),U=(Y==null?void 0:Y.map(ne=>({label:ne.groupName,value:ne.id})))||[],[A,p]=i.useState(!1),[x,h]=i.useState(!1),[I,P]=i.useState(0),[F,u]=i.useState("MENTOR_HALFPIC"),[_,Z]=i.useState(ms),C=(ne,Q)=>{const pe=Array.from({length:ne.stageNodeCount}).map((ee,de)=>({blackHoleStageName:"",dialogueGroupId:0,blackHoleStageType:0,oil:0,extraPoint:0,pointMultiplier:0,extraEnergy:0,energyMultiplier:0,expAmount:0,aiChip:0,stageId:0,stagePicId:0,stageName:"",orderNum:de+1,chapterId:0,blackHoleStageDropItems:[]}));l("blackHoleStages",pe),l("mapId",ne.id),l("stageNum",ne.stageNodeCount),P(ne.stageNodeCount),O({id:ne.picId,src:Q||""}),p(!1)},V=async ne=>{const Q=await Jt({id:ne.id});ne.type==="BLACK_HOLE_CHAPTER_BG"||ne.type==="BLACK_HOLE_DIALOGUE_BG"?(l("backgroundPicId",ne.id,{shouldValidate:!0}),j({id:ne.id,src:(Q==null?void 0:Q.src)||""})):(ne.type==="MENTOR"||ne.type==="PET")&&(l("characterPicId",ne.id,{shouldValidate:!0}),l("characterName",ne.name,{shouldValidate:!0}),y({id:ne.id,src:(Q==null?void 0:Q.src)||""}))},se=i.useCallback(ne=>{if(ne==="FILE"){Z(ms),h(!0);return}k===0||k===1||k===4?(Z([{label:"時空導師",value:"MENTOR",type:"MENTOR_HALFPIC",fileApiType:"MENTOR"}]),ne!=="MENTOR_HALFPIC"&&(l("characterPicId",0,{shouldValidate:!0}),M("characterPicId",y)),u("MENTOR_HALFPIC"),D("MENTOR")):k===2||k===3?(Z([{label:"戰寵",value:"PET",type:"PET",fileApiType:"PET"}]),ne!=="PET"&&(l("characterPicId",0,{shouldValidate:!0}),M("characterPicId",y)),u("PET"),D("PET")):(u(ne),Z(ms)),h(!0)},[h,k,u,D,Z]),X=ne=>{q(ne),l("flag",ne)},R=ne=>{const Q={...ne,id:Number(t)};G(Q)},b=ne=>{ne.flag===qe.PUBLISHED?r({open:!0,title:"提示",message:"確定要更新黑洞章節嗎？",onOk:()=>R(ne)}):ne.flag===qe.DRAFT&&r({open:!0,title:"提示",message:"確定要儲存為草稿嗎？",onOk:()=>R(ne)})},W=()=>{const{setValue:ne}=$e();return k!==3?(ne("weekDay",null,{shouldValidate:!0}),null):e.jsx(je,{name:"weekDay",label:"星期設定",variant:"control",type:"ONE",alertText:"章節類型選擇每日時，必需填入星期",options:Os})},le=i.useCallback(ne=>{l("chapterType",ne.target.value,{shouldValidate:!0}),ne.target.value&&(l("characterPicId",0,{shouldValidate:!0}),l("characterName","",{shouldValidate:!0}),y(null))},[l,y]);return i.useEffect(()=>{if(a){const ne=(Q,pe="")=>{Object.entries(Q).forEach(([ee,de])=>{const Ce=pe?`${pe}.${ee}`:ee;Array.isArray(de)?de.forEach((ue,Se)=>{typeof ue=="object"&&ue!==null?ne(ue,`${Ce}.${Se}`):l(`${Ce}.${Se}`,ue,{shouldValidate:!0,shouldDirty:!0,shouldTouch:!0})}):typeof de=="object"&&de!==null?ne(de,Ce):l(Ce,de,{shouldValidate:!0,shouldDirty:!0,shouldTouch:!0})})};ne({...a}),q(a.flag||qe.DRAFT),P(a.stageNum||0)}},[a]),i.useEffect(()=>{S?l("backgroundPicId",S.id,{shouldValidate:!0}):l("backgroundPicId",0,{shouldValidate:!0}),T?l("characterPicId",T.id,{shouldValidate:!0}):l("characterPicId",0,{shouldValidate:!0})},[l,S,T]),i.useEffect(()=>()=>{E(uo),y(null),O(null),j(null)},[]),n||!a?e.jsx(Ge,{}):e.jsxs(it,{onSubmit:c(b),children:[e.jsxs(o,{gap:5,children:[e.jsxs(K,{container:!0,spacing:4,children:[e.jsx(K,{item:!0,xs:12,children:e.jsxs(K,{container:!0,spacing:2,children:[e.jsx(K,{item:!0,xs:12,md:6,children:e.jsx(ie,{name:"chapterName",label:"章節名稱",variant:"control",alertText:"必填"})}),e.jsx(K,{item:!0,xs:12,md:6,children:e.jsx(ie,{name:"oilStageNum",label:"油料關卡數量",variant:"control",alertText:"必填",type:"number"})}),e.jsx(K,{item:!0,xs:12,md:6,children:e.jsx(je,{name:"chapterType",label:"章節類型",variant:"control",type:"ONE",alertText:"必填，當章節類型切換時，會自動移除已選擇的角色圖片",options:Yr,onChange:le})}),e.jsx(K,{item:!0,xs:12,md:6,children:e.jsx(je,{name:"dialogueGroupId",label:"對話群組",variant:"control",type:"ONE",alertText:"必填",options:U})}),e.jsx(K,{item:!0,xs:12,md:6,children:e.jsx(W,{})})]})}),e.jsxs(K,{item:!0,xs:12,md:6,children:[e.jsx(et,{name:"characterPicId",control:B,render:({field:ne,fieldState:{error:Q}})=>e.jsxs(o,{gap:2,flexDirection:"row",...ne,children:[e.jsx(he,{children:"角色圖片"}),e.jsx(v,{label:"上傳圖片",btnColor:"BROWN",onClick:()=>L("CHARACTER"),sx:{borderRadius:99,padding:"0 24px"}}),e.jsx(v,{label:"搜尋圖片",btnColor:"BROWN",onClick:()=>se(F),sx:{borderRadius:99,padding:"0 24px"}}),(T==null?void 0:T.src)&&e.jsx(v,{label:"移除",btnColor:"CANCEL_RED",onClick:()=>M("characterPicId",y)}),!!Q&&e.jsx(ht,{error:!0,children:Q.message})]})}),e.jsxs(o,{justifyContent:"center",alignItems:"center",gap:2,children:[e.jsx("img",{src:T==null?void 0:T.src,width:"400px"}),m("characterName")&&e.jsx(Kt,{label:m("characterName")})]})]}),e.jsx(K,{item:!0,xs:12,md:6,children:e.jsxs(o,{gap:2,children:[e.jsx(et,{control:B,name:"backgroundPicId",render:({field:ne,fieldState:{error:Q}})=>e.jsxs(o,{gap:2,...ne,children:[e.jsxs(o,{gap:2,flexDirection:"row",justifyContent:"flex-start",alignItems:"stretch",children:[e.jsx(he,{children:"黑洞章節背景"}),e.jsx(v,{label:"上傳圖片",btnColor:"BROWN",onClick:()=>L("BLACK_HOLE_CHAPTER_BG"),sx:{borderRadius:99,padding:"0 24px"}}),e.jsx(v,{label:"搜尋圖片",btnColor:"BROWN",onClick:()=>se("FILE"),sx:{borderRadius:99,padding:"0 24px"}}),(S==null?void 0:S.src)&&e.jsx(v,{label:"移除",btnColor:"CANCEL_RED",onClick:()=>M("backgroundPicId",j)})]}),!!Q&&e.jsx(o,{sx:{border:`1px solid ${$.CANCEL_RED}`,p:3},children:e.jsx(ht,{sx:{textAlign:"center",color:"red"},children:Q.message})})]})}),e.jsxs(o,{gap:3,children:[e.jsx(et,{control:B,name:"mapId",render:({field:ne,fieldState:{error:Q}})=>e.jsxs(o,{gap:2,...ne,children:[e.jsxs(o,{gap:2,flexDirection:"row",justifyContent:"flex-start",alignItems:"stretch",children:[e.jsx(he,{children:"黑洞地圖節點"}),e.jsx(v,{label:"選擇地圖",btnColor:"BROWN",onClick:()=>p(!0),sx:{borderRadius:99,padding:"0 24px"}}),(w==null?void 0:w.src)&&e.jsx(v,{label:"移除",btnColor:"CANCEL_RED",onClick:()=>M("mapId",O)})]}),!!Q&&e.jsx(o,{sx:{border:`1px solid ${$.CANCEL_RED}`,p:3},children:e.jsx(ht,{sx:{textAlign:"center",color:"red"},children:Q.message})})]})}),e.jsxs(o,{justifyContent:"center",alignItems:"center",gap:2,children:[e.jsx(ke,{sx:{width:"480px",height:S!=null&&S.src?"270px":"100%",backgroundImage:`url(${S==null?void 0:S.src})`,backgroundSize:"contain",backgroundPosition:"center",backgroundRepeat:"no-repeat",display:"flex",justifyContent:"center",alignItems:"center"},children:(w==null?void 0:w.src)&&e.jsx(Dt,{src:w==null?void 0:w.src,width:480,height:270})}),(N==null?void 0:N.name)&&e.jsx(Kt,{label:N.name})]})]})]})})]}),Array.from({length:I||0}).map((ne,Q)=>e.jsx(tg,{nodeIndex:Q,dialogueMinInfoOptions:U},Q)),e.jsxs(o,{flexDirection:"row",justifyContent:"flex-end",alignItems:"center",gap:2,children:[g("flag")===qe.DRAFT&&e.jsx(v,{label:"儲存草稿",btnColor:"DRAWER_GRAY",type:"submit",onClick:()=>X(qe.DRAFT)}),e.jsx(v,{label:"更新",btnColor:"TAB_BLUE",type:"submit",onClick:()=>X(qe.PUBLISHED)})]})]}),e.jsx(co,{open:A,setOpen:p,onSelectMap:C}),e.jsx(na,{open:x,setOpen:h,onSelect:V,type:F,filterTypeOptions:_})]})},ag=ng,sg=({children:t})=>{const{flag:a}=at(),n=sn({mode:"all",resolver:on(eg(a)),defaultValues:uo});return e.jsxs(rn,{...n,children:[t,!1]})},rg=sg;function ig(){return e.jsx(rg,{children:e.jsxs(Pt,{children:[e.jsx(xe,{index:!0,element:e.jsx(_x,{})}),e.jsx(xe,{path:"create",element:e.jsx(Jx,{})}),e.jsx(xe,{path:"update/:id",element:e.jsx(ag,{})}),e.jsx(xe,{path:"*",element:e.jsx(_t,{to:"/edit/blackHoleChapterEdit",replace:!0})})]})})}const po=[{label:"掉落物名稱",value:"name"}],oa=po.map(t=>t.value),og=t=>oa.includes(t),lg=()=>{var p;const t=Wt(),a=Me(),{setAlertOpen:n}=_e(),s=yt(),r=i.useMemo(()=>{const x=new URLSearchParams(t.search),h=x.get("name");return{page:parseInt(x.get("page")||"0",10),size:parseInt(x.get("size")||"10",10),sort:x.get("sort")||"updateTime,desc",removed:!1,...h&&{name:h}}},[t.search]),[l,c]=i.useState(r),[g,m]=i.useState({searchText:"",currentField:oa[0]}),[E,f]=i.useState(r.page+1),T=i.useMemo(()=>{const x=Object.keys(r).find(h=>oa.includes(h)&&r[h]!==void 0);return x?{searchText:String(r[x]),currentField:x}:{searchText:"",currentField:oa[0]}},[r]),{data:y,isLoading:D,isSuccess:S}=$r(r),j=Es(((p=y==null?void 0:y.content)==null?void 0:p.map(x=>({id:x.dropItemPicId})))??[]),{mutate:w}=Pl(()=>{s.invalidateQueries({queryKey:[Za.BLACK_HOLE_DROP_ITEM_SEARCH]}),n({open:!0,message:"刪除掉落物成功"})}),O=i.useCallback(x=>{w({id:x,permanent:!1})},[w]),B=i.useCallback((x,h)=>{n({open:!0,message:`確定要刪除掉落物「${h}」嗎？`,onOk:()=>O(x),onCancel:()=>n({open:!1})})},[n,O]),k=x=>{a(`update/${x.id}`)},q=()=>{a("create")},H=[{title:"編輯",dataField:"edit",width:"200px",component:x=>e.jsx(v,{label:"編輯",onClick:()=>k(x)})},{title:"掉落物名稱",dataField:"dropItemName"},{title:"掉落物圖片",dataField:"dropItemImage",component:x=>{const h=j.find(P=>{var F;return((F=P.data)==null?void 0:F.id)===x.dropItemPicId}),I=h==null?void 0:h.data;return I!=null&&I.src?e.jsx("img",{src:I.src,alt:`${x.dropItemName}_${x.dropItemPicId}`,width:120}):e.jsx(Mn,{animation:"wave",variant:"rectangular",width:120,height:120,sx:{margin:"auto",borderRadius:"12px"}})}},{title:"更新時間",dataField:"updateTime",component:x=>e.jsx(z,{variant:"h5",children:x.updateTime})},{title:"刪除",dataField:"delete",component:x=>e.jsx(v,{label:"刪除",btnColor:"RED",onClick:()=>B(x.id,x.dropItemName)})}],G=i.useCallback(x=>h=>{let I,P;if(typeof h=="number"||typeof h=="string"||typeof h=="boolean"?I=h:I=h.target.value,og(x)){const u={};oa.forEach(_=>{_===x&&I?u[_]=I:delete l[_]}),P={...l,...u}}else P={...l,[x]:I};x!=="page"&&(P.page=0,f(1));const F=ut(P);c(P),a(`?${F}`)},[a,l]),N=i.useCallback(x=>{m(h=>({...h,searchText:x}))},[m]),L=i.useCallback(x=>{m(h=>({...h,currentField:x}))},[]),M=i.useCallback(()=>{const{currentField:x,searchText:h}=g;G(x)(h)},[G,g]),Y=i.useCallback((x,h)=>{G("page")(String(h-1)),f(h)},[G]),U=i.useCallback(()=>{if(E){const x={...l,page:E-1},h=ut(x);c(x),a(`?${h}`)}},[E,l,a]),A=i.useMemo(()=>{var x;return S&&!!((x=y==null?void 0:y.content)!=null&&x.length)},[S,y]);return e.jsxs(o,{flex:1,gap:5,px:3,children:[e.jsx(o,{direction:"row",justifyContent:"flex-end",children:e.jsx(v,{label:"創建掉落物",onClick:q})}),e.jsxs(o,{direction:"row",alignItems:"center",gap:3,children:[e.jsx(vt,{value:T,options:po,selectOnChange:L,inputOnChange:N,searchFuntion:M}),e.jsx(v,{label:"搜尋",btnColor:"BROWN",onClick:M})]}),D?e.jsx(Ge,{}):e.jsx(lt,{isVisible:A,children:e.jsxs(o,{gap:3,alignItems:"center",children:[e.jsx(Tt,{columns:H,rows:(y==null?void 0:y.content)??[],stickyHeader:!0}),e.jsx(Yt,{totalPages:(y==null?void 0:y.totalPages)??0,currentPage:(y==null?void 0:y.pageable.pageNumber)??0,inputPage:E,setInputPage:f,handlePageChange:Y,handlePageSearch:U})]})},JSON.stringify(l))]})},cg=lg,dg=()=>{const t=Me(),{setAlertOpen:a}=_e(),{setUploadDialogOpen:n,dropItemSelectedImage:s,setDropItemSelectedImage:r,setSelectedType:l,setSearchDialogOpen:c}=Rt(),{handleSubmit:g,setValue:m,reset:E}=$e(),{mutate:f}=_l(T);function T(){a({open:!0,title:"創建提示",message:"創建掉落物成功"}),E(),r(null),t("/edit/blackHoleDropItemEdit")}const y=O=>{f(O)},D=O=>{a({open:!0,title:"提示",message:"按下確認表示您已經確認所編輯的內容文字與所上傳圖片沒有違反智慧財產權疑慮",onOk:()=>y(O)})},S=i.useCallback(()=>{r(null),m("dropItemPicId",0,{shouldValidate:!0})},[r,m]),j=()=>{l("BLACK_HOLE_DROP_ITEM"),n(!0)},w=()=>{l("BLACK_HOLE_DROP_ITEM"),c(!0)};return i.useEffect(()=>{s&&m("dropItemPicId",s.id,{shouldValidate:!0})},[s,m]),i.useEffect(()=>()=>{E(),r(null)},[]),e.jsx(it,{onSubmit:g(D),children:e.jsx(K,{container:!0,spacing:6,wrap:"wrap",children:e.jsx(K,{item:!0,sm:12,md:6,lg:5,margin:"auto",children:e.jsxs(o,{gap:3,children:[e.jsx(ie,{name:"dropItemName",label:"掉落物名稱",variant:"control",alertText:"必填"}),e.jsxs(o,{gap:2,flexDirection:"row",alignItems:"center",children:[e.jsx($t,{title:"掉落物圖片",name:"dropItemPicId",handleOpenUploadDialog:j,handleOpenSearchDialog:w}),(s==null?void 0:s.src)&&e.jsx(v,{label:"移除",btnColor:"CANCEL_RED",onClick:S})]}),(s==null?void 0:s.src)&&e.jsx(Dt,{styleType:"formImage",src:s.src}),e.jsx(ze,{name:"description",label:"掉落物描述",variant:"control",rows:6}),e.jsx(o,{direction:"row",justifyContent:"flex-end",children:e.jsx(v,{label:"儲存送出",type:"submit",btnColor:"BTN_LATTE_GRAY"})})]})})})})},ug=dg,pg=()=>{const{id:t}=Lt(),a=Me(),{setAlertOpen:n}=_e(),{setValue:s,handleSubmit:r,reset:l}=$e(),{setUploadDialogOpen:c,dropItemSelectedImage:g,setDropItemSelectedImage:m,setSelectedType:E,setSearchDialogOpen:f}=Rt(),[T,y]=i.useState(!1),{data:D,isLoading:S}=Ml(Number(t)),{data:j}=qt({id:(D==null?void 0:D.dropItemPicId)||0});function w(N){N&&(n({open:!0,title:"提示",message:"更新黑洞掉落物成功"}),l(),m(null),y(!1),a("/edit/blackHoleDropItemEdit"))}const{mutate:O}=Fl(Number(t),w),B=i.useCallback(()=>{m(null),s("dropItemPicId",0,{shouldValidate:!0}),y(!0)},[m,s]),k=()=>{E("BLACK_HOLE_DROP_ITEM"),c(!0)},q=()=>{E("BLACK_HOLE_DROP_ITEM"),f(!0)};i.useEffect(()=>{g&&(s("dropItemPicId",g.id,{shouldValidate:!0}),y(!1))},[g,s]);const H=N=>{O(N)},G=N=>{n({open:!0,title:"提示",message:"按下確認表示您已經確認所編輯的內容文字與所上傳圖片沒有違反智慧財產權疑慮",onOk:()=>H(N)})};return i.useEffect(()=>{if(D){const{dropItemName:N,dropItemPicId:L,description:M}=D;s("dropItemName",N),s("dropItemPicId",L),s("description",M),m({id:L,src:(j==null?void 0:j.src)||""})}},[D,s,j]),i.useEffect(()=>{j&&D&&!g&&!T&&m({id:D.dropItemPicId,src:j.src})},[j,D,g,m,T]),i.useEffect(()=>()=>{l(),y(!1),m(null)},[]),S?e.jsx(Ge,{}):e.jsxs(it,{onSubmit:r(G),children:[e.jsx(K,{container:!0,spacing:6,wrap:"wrap",children:e.jsx(K,{item:!0,sm:12,md:6,lg:5,margin:"auto",children:e.jsxs(o,{gap:3,children:[e.jsx(ie,{name:"dropItemName",label:"掉落物名稱",variant:"control",alertText:"必填"}),e.jsxs(o,{gap:2,flexDirection:"row",alignItems:"center",children:[e.jsx($t,{title:"掉落物圖片",name:"dropItemPicId",handleOpenUploadDialog:k,handleOpenSearchDialog:q}),(g==null?void 0:g.src)&&e.jsx(v,{label:"移除",btnColor:"CANCEL_RED",onClick:B})]}),g&&(g==null?void 0:g.src)&&e.jsx(Dt,{styleType:"formImage",src:g==null?void 0:g.src}),e.jsx(ze,{name:"description",label:"掉落物描述",variant:"control",rows:6}),e.jsx(o,{direction:"row",justifyContent:"flex-end",children:e.jsx(v,{label:"儲存送出",type:"submit",btnColor:"BTN_LATTE_GRAY"})})]})})}),e.jsx(Ao,{})]})},mg=pg,hg=d.intersection(d.object({dropItemName:d.string().min(1,"掉落物名稱必填"),dropItemPicId:d.number().min(1,"必需上傳圖片"),description:d.string().max(256,"描述最多256字")}),d.discriminatedUnion("variant",[d.object({variant:d.literal("create")}),d.object({variant:d.literal("update"),id:d.number().min(1)})])),xg={variant:"create",dropItemName:"",dropItemPicId:0,description:""},gg=({children:t})=>{const a=sn({mode:"all",resolver:on(hg),defaultValues:xg});return e.jsxs(rn,{...a,children:[t,!1]})},fg=gg;function bg(){return e.jsx(fg,{children:e.jsxs(Pt,{children:[e.jsx(xe,{index:!0,element:e.jsx(cg,{})}),e.jsx(xe,{path:"create",element:e.jsx(ug,{})}),e.jsx(xe,{path:"update/:id",element:e.jsx(mg,{})}),e.jsx(xe,{path:"*",element:e.jsx(_t,{to:"/edit/blackHoleDropItemEdit",replace:!0})})]})})}const mo=[{label:"群組名稱",value:"blackHoleDialogueGroupName"},{label:"章節名稱",value:"blackHoleChapterName"},{label:"節點名稱",value:"blackHoleStageName"},{label:"編輯者",value:"lastUpdateAdlName"},{label:"對話關鍵字",value:"dialogueText"}],Ra=mo.map(t=>t.value),jg=t=>Ra.includes(t),yg=()=>{const t=yt(),{setAlertOpen:a}=_e(),n=Me(),s=Wt(),r=i.useMemo(()=>{const p=new URLSearchParams(s.search),x=p.get("blackHoleChapterType"),h=p.get("blackHoleStageType"),I=p.get("groupPositionType"),P=p.get("updateTimeStart"),F=p.get("updateTimeEnd"),u=p.get("blackHoleChapterName"),_=p.get("blackHoleStageName"),Z=p.get("lastUpdateAdlName"),C=p.get("blackHoleDialogueGroupName"),V=p.get("dialogueText");return{page:parseInt(p.get("page")||"0",10),size:parseInt(p.get("size")||"10",10),flag:parseInt(p.get("flag")||"1",10),sort:"id,desc",...x&&{blackHoleChapterType:parseInt(x,10)},...h&&{blackHoleStageType:parseInt(h,10)},...I&&{groupPositionType:parseInt(I,10)},...P&&{updateTimeStart:parseInt(P,10)},...F&&{updateTimeEnd:parseInt(F,10)},...u&&{blackHoleChapterName:u},..._&&{blackHoleStageName:_},...Z&&{lastUpdateAdlName:Z},...C&&{blackHoleDialogueGroupName:C},...V&&{dialogueText:V}}},[s.search]),l=i.useMemo(()=>{const p=Object.keys(r).find(x=>Ra.includes(x)&&r[x]!==void 0);return p?{searchText:String(r[p]),currentField:p}:{searchText:"",currentField:Ra[0]}},[r]),[c,g]=i.useState(r),[m,E]=i.useState(l),[f,T]=i.useState(r.page+1),y=i.useCallback(p=>x=>{let h,I;if(typeof x=="number"||typeof x=="string"||typeof x=="boolean"?h=x:h=x.target.value,jg(p)){const F={};Ra.forEach(u=>{u===p&&h?F[u]=h:delete c[u]}),I={...c,...F}}else if(["blackHoleChapterType","blackHoleStageType","groupPositionType"].includes(p)&&h===0){const{[p]:_,...Z}=c;I=Z}else I={...c,[p]:h};p!=="page"&&(I.page=0,T(1));const P=ut(I);g(I),n(`?${P}`)},[n,c]),D=i.useCallback((p,x)=>{y("page")(String(x-1)),T(x)},[y]),S=i.useCallback(()=>{if(f){const p={...c,page:f-1},x=ut(p);g(p),n(`?${x}`)}},[f,c,n]),j=i.useCallback(p=>{E(x=>({...x,searchText:p}))},[E]),w=i.useCallback(p=>{E(x=>({...x,currentField:p}))},[]),O=(p,x)=>{x&&(p==="updateTimeStartTime"?y(p)(Ie(x).startOf("day").valueOf()):p==="updateTimeEndTime"?y(p)(Ie(x).endOf("day").valueOf()):y(p)(Ie(x).valueOf()))},B=i.useCallback(()=>{const{currentField:p,searchText:x}=m;y(p)(x)},[y,m]),{data:k,isLoading:q,isSuccess:H}=Bl(c),G=i.useMemo(()=>{var p;return H&&!!((p=k==null?void 0:k.content)!=null&&p.length)},[H,k]),{mutate:N}=Hl(()=>{t.invalidateQueries({queryKey:[Za.BLACK_HOLE_DIALOGUE_SEARCH]}),a({open:!0,message:"刪除成功！"})}),L=i.useCallback(p=>{N({id:p,permanent:!1})},[N]),M=i.useCallback((p,x)=>{a({open:!0,message:`確定要刪除黑洞對話「${x}」嗎？`,onOk:()=>L(p),onCancel:()=>a({open:!1})})},[a,L]),Y=i.useCallback(p=>{n(`/edit/blackHoleDialogueEdit/update/${p}`)},[n]),U=i.useCallback(()=>{n("/edit/blackHoleDialogueEdit/create")},[n]),A=[{title:"編輯",dataField:"edit",width:"120px",component:p=>e.jsx(v,{label:"編輯",onClick:()=>Y(String(p.id)),btnColor:"TAB_BLUE"})},{title:"群組名稱",dataField:"groupName",component:p=>e.jsx(z,{variant:"h5",noWrap:!0,children:p.groupName})},{title:"對話位置",dataField:"groupPositionType",component:p=>e.jsx(z,{variant:"h5",noWrap:!0,children:Kn(p.groupPositionType,ar)})},{title:"對話數量",dataField:"dialoguesCount"},{title:"章節名稱",dataField:"blackHoleChapterName"},{title:"節點名稱",dataField:"blackHoleStageName",component:p=>e.jsx(z,{variant:"h5",noWrap:!0,children:p.blackHoleStageName})},{title:"節點類型",dataField:"blackHoleStageType",component:p=>e.jsx(z,{variant:"h5",noWrap:!0,children:Kn(p.blackHoleStageType,nr)})},{title:"狀態",dataField:"flag",component:p=>e.jsx(z,{variant:"h5",noWrap:!0,children:Kn(p.flag,Hr)})},{title:"最後修改時間",dataField:"updateTime",component:p=>e.jsx(z,{variant:"h5",noWrap:!0,children:p.updateTime?Ie(p.updateTime).format("YYYY-MM-DD HH:mm:ss"):""})},{title:"編輯者",dataField:"lastUpdateAdlName"},{title:"刪除",dataField:"delete",component:p=>e.jsx(v,{label:"刪除",onClick:()=>M(p.id,p.groupName),btnColor:"RED"})}];return e.jsxs(o,{flex:1,px:3,gap:5,children:[e.jsx(o,{direction:"row",justifyContent:"flex-end",gap:2,children:e.jsx(v,{label:"創建黑洞對話",onClick:U,btnColor:"BLUE"})}),e.jsxs(o,{direction:"row",alignItems:"center",gap:3,children:[e.jsx(Ve,{label:"章節類型",value:c.blackHoleChapterType||0,options:gs,onChange:p=>y("blackHoleChapterType")(p.target.value)}),e.jsx(Ve,{label:"節點類型",value:c.blackHoleStageType||0,options:nr,onChange:p=>y("blackHoleStageType")(p.target.value)}),e.jsx(Ve,{label:"對話位置",value:c.groupPositionType||0,options:ar,onChange:p=>y("groupPositionType")(p.target.value)}),e.jsx(Ve,{label:"狀態",value:c.flag||0,options:$l,onChange:p=>y("flag")(p.target.value)})]}),e.jsxs(o,{direction:"row",alignItems:"center",gap:3,children:[e.jsxs(ke,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(he,{width:"fit-content",p:"4px 16px",children:"最後修改時間"}),e.jsx(an,{value:c.updateTimeStart??null,onChange:p=>O("updateTimeStart",p),width:"220px"}),e.jsx(z,{variant:"h5",children:"至"}),e.jsx(an,{value:c.updateTimeEnd??null,onChange:p=>O("updateTimeEnd",p),width:"220px"})]}),e.jsx(vt,{value:m,options:mo,selectOnChange:w,inputOnChange:j,searchFuntion:B}),e.jsx(v,{label:"搜尋",onClick:B,btnColor:"BROWN"})]}),q?e.jsx(Ge,{}):k&&e.jsx(lt,{isVisible:G,children:e.jsxs(o,{gap:3,alignItems:"center",children:[e.jsx(Tt,{columns:A,rows:k.content}),e.jsx(Yt,{totalPages:k.totalPages,currentPage:k.pageable.pageNumber,inputPage:f,setInputPage:T,handlePageChange:D,handlePageSearch:S})]})},JSON.stringify(c))]})},Cg=yg;var qs={},Sg=ba;Object.defineProperty(qs,"__esModule",{value:!0});var nn=qs.default=void 0,Eg=Sg(fa()),Ig=e;nn=qs.default=(0,Eg.default)((0,Ig.jsx)("path",{d:"M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6z"}),"Add");var Vs={},Tg=ba;Object.defineProperty(Vs,"__esModule",{value:!0});var Ks=Vs.default=void 0,wg=Tg(fa()),Dg=e;Ks=Vs.default=(0,wg.default)((0,Dg.jsx)("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2m1 15h-2v-6h2zm0-8h-2V7h2z"}),"Info");var zs={},vg=ba;Object.defineProperty(zs,"__esModule",{value:!0});var Qs=zs.default=void 0,kg=vg(fa()),Ag=e;Qs=zs.default=(0,kg.default)((0,Ag.jsx)("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2m4 14H8V8h8z"}),"StopCircle");const hn=class hn{};hn.AUDIO="/audio",hn.AUDIO_UPLOAD_AND_BIND=a=>`/audio/uploadAudioAndBind/${a}`,hn.AUDIO_CREATE_WITH_NO_FILE="/audio/createWithNoFile",hn.AUDIO_FILE=a=>`/audio/${a}`,hn.AUDIO_VARIANTS="/audio/variants",hn.AUDIO_TYPE="/audio/type",hn.AUDIO_INFO=a=>`/audio/info/${a}`,hn.AUDIO_INFO_IDS="/audio/info/ids";let $a=hn;async function Ng(t){try{return(await No.get($a.AUDIO_TYPE,{params:{type:t}})).data.data}catch(a){Mt(a,"getAudioByType")}}function ea(t){return Ue({queryKey:[$a.AUDIO_TYPE,t],queryFn:()=>Ng(t),enabled:!!t})}const mr=[{label:"時空導師",value:"MENTOR",type:"MENTOR"},{label:"戰寵",value:"PET",type:"PET"},{label:"魔王",value:"ENEMY",type:"ENEMY"},{label:"黑洞角色",value:"FILE",type:"FILE",fileApiType:"BLACK_HOLE_CHARACTER"},{label:"黑洞道具",value:"FILE",type:"FILE",fileApiType:"BLACK_HOLE_ITEM"}],Og=[{label:"黑洞背景",value:"FILE",type:"FILE",fileApiType:"BLACK_HOLE_CHAPTER_BG"},{label:"對話背景",value:"FILE",type:"FILE",fileApiType:"BLACK_HOLE_DIALOGUE_BG"}],hr=i.memo(({item:t,index:a,setDataFn:n,picWidth:s="220px"})=>{const r=a===0,l=i.useCallback(()=>{n(c=>c.filter((g,m)=>m!==a))},[n,a]);return e.jsx(i.Fragment,{children:e.jsxs(o,{sx:{justifyContent:"center",alignItems:"center",gap:"4px"},children:[e.jsxs(ke,{sx:{position:"relative"},children:[e.jsx("img",{src:t.src,alt:t.name,width:s,loading:"lazy",style:{border:`2px solid ${a===0?$.ACCRODION_BLUE:$.GRAY}`}}),r&&e.jsx(z,{sx:{position:"absolute",top:0,left:0,backgroundColor:$.ACCRODION_BLUE,color:$.WHITE,padding:"4px 8px",borderRadius:"2px",fontWeight:"bold"},children:"主要"}),e.jsx(un,{title:"移除",placement:"top",children:e.jsx(Ze,{onClick:()=>l(),sx:{position:"absolute",top:2,right:2,backgroundColor:$.WHITE,opacity:.5,width:"28px",height:"28px",transition:"all 0.1s","&:hover":{backgroundColor:$.WHITE,opacity:1}},children:e.jsx(Vt,{sx:{fontSize:"1.5rem","&:hover":{color:$.RED}}})})})]}),e.jsx(Kt,{label:t.name,color:r?"primary":"default"})]},`${t.id}_${a}`)})}),xr=i.memo(({title:t,width:a,textAlign:n="center",sx:s})=>e.jsx(z,{variant:"h6",sx:{textWrap:"nowrap",fontWeight:"500",minWidth:a,textAlign:n,...s},children:t})),gr=i.memo(({index:t,data:a,charactersAndItems:n,backgrounds:s,setDataFn:r,beforeBattleDataLength:l,isIntroDialogue:c,soundEffects:g})=>{var M,Y,U,A,p;const m=i.useMemo(()=>{var x;return((x=n.find(h=>h.id===a.characterPicId))==null?void 0:x.type)==="BLACK_HOLE_ITEM"},[n,a.characterPicId]),[E,f]=i.useState(m?zn:Qn),T=i.useRef(null),[y,D]=i.useState(!1),S=i.useMemo(()=>c?0+t+1:l+t+1,[c,l,t]),j=n==null?void 0:n.map(x=>({label:x.name,value:x.id})),w=s==null?void 0:s.map(x=>({label:x.name,value:x.id})),O=i.useMemo(()=>[...[{label:"無音效",value:0}],...(g||[]).map(h=>({label:h.name,value:h.id}))],[g]),B=i.useCallback(x=>{var h,I;if(y){(h=x.current)==null||h.pause(),D(!1);return}(I=x.current)==null||I.play(),D(!0)},[y]),k=i.useCallback((x,h)=>{if(h==="characterAndItem")return n.find(I=>I.id===x);if(h==="background")return s.find(I=>I.id===x)},[n,s]),q=i.useCallback((x,h)=>{r(I=>I.map(P=>P.id===a.id?{...P,[x]:h}:P))},[r,a.id]),H=i.useCallback(x=>{q("audioId",x),D(!1)},[q]),G=i.useCallback(x=>{const h=k(x,"characterAndItem"),I=(h==null?void 0:h.type)==="BLACK_HOLE_ITEM",P=I?2:1,F=I?zn:Qn;a.displayPosition=P,q("characterPicId",h.id),q("displayPosition",P),f(F)},[k,a,q]),N=i.useCallback(()=>{r(x=>x.filter(h=>h.id!==a.id))},[r,a.id]),L=i.useCallback(()=>{r(x=>x.map(h=>h.id===a.id?{...h,characterPicId:0}:h))},[r,a.id]);return i.useEffect(()=>{f(m?zn:Qn)},[m]),e.jsxs(o,{sx:{flexDirection:"row",justifyContent:"space-between",p:"12px",border:`1px solid ${$.GRAY}`},children:[e.jsx(ke,{sx:{display:"flex",flexDirection:"row",alignItems:"center",justifyContent:"center",width:"50px"},children:e.jsx(z,{variant:"h6",sx:{textAlign:"center"},children:S})}),e.jsx(ke,{sx:{display:"flex",flexDirection:"row",alignItems:"center",justifyContent:"center",width:"200px",outline:`1px solid ${$.GRAY}`,position:"relative","&:hover .delete-icon":{opacity:1}},children:a.characterPicId>0&&e.jsxs(i.Fragment,{children:[e.jsx("img",{src:(M=k(a.characterPicId,"characterAndItem"))==null?void 0:M.src,alt:(Y=k(a.characterPicId,"characterAndItem"))==null?void 0:Y.name,width:"200px"}),e.jsx(un,{title:"移除圖片",placement:"top",children:e.jsx(Ze,{onClick:L,className:"delete-icon",sx:{position:"absolute",top:0,right:0,opacity:0,transition:"opacity 0.2s",width:"28px",height:"28px"},children:e.jsx(Vt,{sx:{fontSize:"1.5rem",color:$.RED}})})})]})}),e.jsx(ke,{sx:{display:"flex",flexDirection:"row",alignItems:"center",justifyContent:"center",width:"200px"},children:e.jsx(Et,{options:j,value:a.characterPicId,onChange:x=>G(x.target.value)})}),e.jsx(ke,{sx:{display:"flex",flexDirection:"row",alignItems:"center",justifyContent:"center",width:"100px"},children:e.jsx(Et,{options:E,value:a.displayPosition,onChange:x=>q("displayPosition",x.target.value),sx:{width:"72px",margin:"auto"}})}),e.jsx(ke,{sx:{display:"flex",flexDirection:"row",alignItems:"center",justifyContent:"center",width:"350px"},children:e.jsx(qa,{rows:5,multiline:!0,name:"dialogueText",placeholder:"請輸入對話，上限 100 字",value:a.dialogueText,onChange:x=>q("dialogueText",x.target.value),sx:{width:"100%"}})}),e.jsxs(ke,{sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",width:"150px"},children:[e.jsxs(o,{gap:1,flexDirection:"row",flexWrap:"wrap",alignItems:"center",sx:{display:a!=null&&a.audioId&&(a==null?void 0:a.audioId)>0?"flex":"none"},children:[y?e.jsx(Qs,{sx:{width:"30px",height:"30px",cursor:"pointer",transition:"all 0.15s","&:hover":{color:"gray"}},onClick:()=>B(T)}):e.jsx(Fn,{sx:{width:"30px",height:"30px",cursor:"pointer",transition:"all 0.15s","&:hover":{color:"gray"}},onClick:()=>B(T)}),e.jsx("audio",{ref:T,id:"audio",src:(U=g.find(x=>x.id===a.audioId))==null?void 0:U.audioSrc,controls:!0,style:{display:"none"},onEnded:()=>D(!1)}),e.jsx("p",{style:{color:"gray"},children:"試聽"})]}),e.jsx(Et,{options:O,value:(a==null?void 0:a.audioId)||"",onChange:x=>H(x.target.value),sx:{width:"100%"}})]}),e.jsx(ke,{sx:{display:"flex",flexDirection:"row",alignItems:"center",justifyContent:"center",width:"200px"},children:e.jsx("img",{src:(A=k(a.bgPicId,"background"))==null?void 0:A.src,alt:(p=k(a.bgPicId,"background"))==null?void 0:p.name,width:"200px"})}),e.jsx(ke,{sx:{display:"flex",flexDirection:"row",alignItems:"center",justifyContent:"center",width:"150px"},children:e.jsx(Et,{options:w,value:a.bgPicId,onChange:x=>q("bgPicId",x.target.value)})}),e.jsx(ke,{sx:{display:"flex",flexDirection:"row",alignItems:"center",justifyContent:"center",width:"50px"},children:e.jsx(Ze,{onClick:N,sx:{width:"40px",height:"40px",backgroundColor:$.RED,color:$.WHITE,borderRadius:"6px",transition:"all 0.2s",border:`2px solid ${$.RED}`,"&:hover":{backgroundColor:$.WHITE,color:$.RED}},children:e.jsx(Vt,{sx:{fontSize:"1.75rem"}})})})]})}),Rg=()=>{const{setAlertOpen:t}=_e(),{setFlag:a}=at(),n=Me(),{reset:s,setValue:r,getValues:l,watch:c,control:g}=$e(),[m,E]=i.useState(!1),{setUploadDialogOpen:f,setSelectedType:T}=Rt(),[y,D]=i.useState([]),[S,j]=i.useState([]),w=i.useMemo(()=>y==null?void 0:y.map(Q=>({label:Q.name,value:Q.id})),[y]),{data:O}=ea("BGM"),{data:B}=ea("SFX"),[k,q]=i.useState([]),[H,G]=i.useState([]),[N,L]=i.useState(mr),[M,Y]=i.useState([]),[U,A]=i.useState([]),p=i.useMemo(()=>[{title:"No.",width:"50px"},{title:"預覽圖",width:"200px"},{title:"角色 / 道具",width:"200px"},{title:"位置",width:"100px"},{title:"對話",width:"350px"},{title:"音效",width:"150px"},{title:"場景圖",width:"200px"},{title:"場景",width:"150px"},{title:"刪除",width:"50px"}],[]),x=i.useMemo(()=>{const Q=k.length>0,pe=H.length>0;return{id:new Date().getTime(),characterPicId:Q?k[0].id:0,displayPosition:1,dialogueText:"",bgPicId:pe?H[0].id:0,groupName:"",characterName:Q?k[0].name:"",isIntroDialogue:!1,orderNum:0,audioId:0,audioSrc:"",audioName:""}},[k,H]);function h(){t({open:!0,title:"提示",message:"創建成功!"}),s(),q([]),G([]),n("/edit/blackHoleDialogueEdit")}const{mutate:I}=Gl(h),P=i.useCallback(Q=>{const pe={...x,id:new Date().getTime()+Math.random()};Q(ee=>[...ee,pe])},[x]),F=i.useCallback(()=>{f(!0),T("BLACK_HOLE_DIALOGUE_OPTION")},[f,T]),u=i.useCallback(async Q=>{const{src:pe}=await Jt({id:Q.id}),ee={...Q,src:pe};Q.type==="BLACK_HOLE_CHAPTER_BG"||Q.type==="BLACK_HOLE_DIALOGUE_BG"?G(de=>[...de||[],ee]):q(de=>[...de||[],ee])},[G,q]),_=i.useCallback(Q=>{L(Q)},[L]),Z=i.useCallback(Q=>{_(Q),E(!0)},[_]),C=i.useCallback(Q=>{if(!Q.destination)return;const{source:pe,destination:ee}=Q;Y(de=>{const Ce=Array.from(de),[ue]=Ce.splice(pe.index,1);return Ce.splice(ee.index,0,ue),Ce})},[]),V=i.useCallback(Q=>{if(!Q.destination)return;const{source:pe,destination:ee}=Q;A(de=>{const Ce=Array.from(de),[ue]=Ce.splice(pe.index,1);return Ce.splice(ee.index,0,ue),Ce})},[]),se=i.useCallback((Q,pe)=>e.jsx(gr,{index:pe,data:Q,charactersAndItems:k,backgrounds:H,soundEffects:S,isIntroDialogue:!0,beforeBattleDataLength:M.length,setDataFn:Y},`${Q.id}_${pe}`),[M,k,H,S]),X=i.useCallback((Q,pe)=>e.jsx(gr,{index:pe,data:Q,charactersAndItems:k,backgrounds:H,soundEffects:S,isIntroDialogue:!1,beforeBattleDataLength:M.length,setDataFn:A},`${Q.id}_${pe}`),[U,k,H,M.length,S]),R=Q=>{const pe=c("groupName",Q.groupName),ee={...Q,dialogues:[...M.map((de,Ce)=>{var ue,Se,Ae;return{...de,id:0,characterPicId:de.characterPicId?de.characterPicId:null,characterName:de.characterPicId?(ue=k.find(Ee=>Ee.id===de.characterPicId))==null?void 0:ue.name:null,groupName:pe,isIntroDialogue:!0,orderNum:Ce+1,audioSrc:(Se=S.find(Ee=>Ee.id===Q.audioId))==null?void 0:Se.audioSrc,audioName:(Ae=S.find(Ee=>Ee.id===Q.audioId))==null?void 0:Ae.name}}),...U.map((de,Ce)=>{var ue,Se,Ae;return{...de,id:0,characterPicId:de.characterPicId?de.characterPicId:null,characterName:de.characterPicId?(ue=k.find(Ee=>Ee.id===de.characterPicId))==null?void 0:ue.name:null,groupName:pe,isIntroDialogue:!1,orderNum:M.length+Ce+1,audioSrc:(Se=S.find(Ee=>Ee.id===Q.audioId))==null?void 0:Se.audioSrc,audioName:(Ae=S.find(Ee=>Ee.id===Q.audioId))==null?void 0:Ae.name}})]};I(ee)},b=Q=>{const pe=[...M,...U],ee=pe.length>0,de=pe.some(Se=>!Se.bgPicId),Ce=l("audioId")===0;if(l("groupName").trim().length===0)return t({open:!0,title:"提示",message:"請輸入群組名稱"}),!1;if(Q===qe.PUBLISHED){const Ae=[{condition:!ee,message:"請至少新增一個對話"},{condition:de,message:"請確保每個對話都有選擇場景"},{condition:Ce,message:"請選擇 BGM 音樂"}].find(Ee=>Ee.condition);if(Ae)return t({open:!0,title:"提示",message:Ae.message}),!1}return!0},W=Q=>{b(Q.flag)&&(Q.flag===qe.PUBLISHED?t({open:!0,title:"提示",message:"確定要發佈黑洞對話嗎？",onOk:()=>R(Q)}):Q.flag===qe.DRAFT&&t({open:!0,title:"提示",message:"確定要儲存為草稿嗎？",onOk:()=>R(Q)}))},le=Q=>{a(Q),r("flag",Q),W(l())},ne=i.useCallback(Q=>{if(!Q)return;const pe=y.find(ee=>ee.id===Q);r("audioId",pe==null?void 0:pe.id,{shouldValidate:!0})},[y,r]);return i.useEffect(()=>{O&&D(O),B&&j(B)},[O,B]),i.useEffect(()=>()=>{s(),q([]),G([])},[]),e.jsxs(o,{flex:1,px:3,gap:5,children:[e.jsxs(Yn,{defaultExpanded:!0,children:[e.jsx(Un,{expandIcon:e.jsx(qn,{sx:{color:$.WHITE,fontSize:"2rem"}}),sx:{backgroundColor:$.ACCRODION_BLUE,color:"white",fontSize:"1.25rem",fontWeight:"bold",borderRadius:"4px 4px 0 0"},children:"對話群組編輯"}),e.jsx(Vn,{sx:{p:"24px"},children:e.jsxs(K,{container:!0,spacing:4,children:[e.jsx(K,{item:!0,sm:12,md:6,lg:5,children:e.jsx(o,{gap:2,children:e.jsx(ie,{label:"群組名稱",name:"groupName",variant:"control",alertText:"必填"})})}),e.jsx(K,{item:!0,sm:12,md:5,lg:5,children:e.jsxs(ke,{sx:{display:"flex",gap:2},children:[e.jsx(je,{label:"BGM",name:"audioId",type:"ONE",options:w,variant:"control",onChange:Q=>ne(Q.target.value)}),e.jsx(et,{name:"audioId",control:g,render:({field:Q})=>{var pe;return e.jsx("audio",{src:(pe=y.find(ee=>ee.id===Q.value))==null?void 0:pe.audioSrc,style:{width:"100%",height:"40px"},controls:!0})}})]})}),e.jsx(K,{item:!0,sm:12,md:1,lg:2,children:e.jsx(o,{flexDirection:"row",justifyContent:"flex-end",children:e.jsx(v,{label:"上傳圖片",btnColor:"BROWN",onClick:F,sx:{borderRadius:99,padding:"8px 24px"}})})}),e.jsx(K,{item:!0,sm:12,children:e.jsxs(o,{gap:4,flexDirection:"row",alignItems:"center",children:[e.jsxs(ke,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",width:"160px",height:"40px"},children:[e.jsx(z,{variant:"h5",sx:{textWrap:"nowrap",fontWeight:"500"},children:"角色 / 道具"}),e.jsx(un,{title:e.jsx(z,{fontSize:"1rem",children:"角色可選左、右位置，道具固定置中"}),children:e.jsx(Ze,{children:e.jsx(Ks,{sx:{fontSize:"1.5rem"}})})})]}),e.jsxs(o,{gap:4,flexDirection:"row",alignItems:"center",flexWrap:"wrap",children:[k==null?void 0:k.map((Q,pe)=>e.jsx(hr,{item:Q,index:pe,setDataFn:q})),e.jsx(ke,{sx:{display:"flex",alignItems:"center",justifyContent:"center",width:"220px",height:"220px"},children:e.jsx(Ze,{onClick:()=>Z(mr),sx:{width:"40px",height:"40px",backgroundColor:$.TAB_BLUE,color:$.WHITE,borderRadius:"6px",transition:"all 0.2s",border:`2px solid ${$.TAB_BLUE}`,"&:hover":{backgroundColor:$.WHITE,color:$.TAB_BLUE}},children:e.jsx(nn,{sx:{fontSize:"2rem"}})})})]})]})}),e.jsx(K,{item:!0,sm:12,children:e.jsxs(o,{gap:4,flexDirection:"row",alignItems:"center",children:[e.jsx(z,{variant:"h5",sx:{textWrap:"nowrap",fontWeight:"500",minWidth:"160px"},children:"場景"}),e.jsxs(o,{gap:4,flexDirection:"row",alignItems:"center",flexWrap:"wrap",children:[H==null?void 0:H.map((Q,pe)=>e.jsx(hr,{item:Q,index:pe,setDataFn:G,picWidth:"320px"})),e.jsx(ke,{sx:{display:"flex",alignItems:"center",justifyContent:"center",width:"220px",height:"220px"},children:e.jsx(Ze,{onClick:()=>Z(Og),sx:{width:"40px",height:"40px",backgroundColor:$.TAB_BLUE,color:$.WHITE,borderRadius:"6px",transition:"all 0.2s",border:`2px solid ${$.TAB_BLUE}`,"&:hover":{backgroundColor:$.WHITE,color:$.TAB_BLUE}},children:e.jsx(nn,{sx:{fontSize:"2rem"}})})})]})]})})]})})]}),e.jsxs(Yn,{children:[e.jsx(Un,{expandIcon:e.jsx(qn,{sx:{color:$.WHITE,fontSize:"2rem"}}),sx:{backgroundColor:$.ACCRODION_BLUE,color:"white",fontSize:"1.25rem",fontWeight:"bold",borderRadius:"4px 4px 0 0"},children:"戰鬥前"}),e.jsx(Vn,{sx:{p:"24px"},children:e.jsx(K,{container:!0,spacing:6,wrap:"wrap",children:e.jsx(K,{item:!0,sm:12,children:e.jsxs(o,{children:[e.jsx(o,{sx:{display:M.length>0?"flex":"none",flexDirection:"row",alignItems:"center",justifyContent:"space-between",backgroundColor:$.DARK_GRAY,color:$.WHITE,p:"12px",fontSize:"1.25rem",fontWeight:"bold"},children:p.map((Q,pe)=>e.jsx(xr,{title:Q.title,width:Q.width},`${Q.title}_${pe}`))}),M.length>0&&e.jsx(Bn,{items:M,onDragEnd:C,renderItem:se,sx:{padding:0,margin:0,backgroundColor:"transparent",outline:"none","&:hover":{backgroundColor:"transparent"}}}),e.jsx(ke,{sx:{display:"flex",alignItems:"center",justifyContent:"center",width:"100px",height:"100px"},children:e.jsx(Ze,{onClick:()=>P(Y),sx:{width:"40px",height:"40px",backgroundColor:$.TAB_BLUE,color:$.WHITE,borderRadius:"6px",transition:"all 0.2s",border:`2px solid ${$.TAB_BLUE}`,"&:hover":{backgroundColor:$.WHITE,color:$.TAB_BLUE}},children:e.jsx(nn,{sx:{fontSize:"2rem"}})})})]})})})})]}),e.jsxs(Yn,{children:[e.jsx(Un,{expandIcon:e.jsx(qn,{sx:{color:$.WHITE,fontSize:"2rem"}}),sx:{backgroundColor:$.ACCRODION_BLUE,color:"white",fontSize:"1.25rem",fontWeight:"bold",borderRadius:"4px 4px 0 0"},children:"戰鬥後"}),e.jsx(Vn,{sx:{p:"24px"},children:e.jsx(K,{container:!0,spacing:6,wrap:"wrap",children:e.jsx(K,{item:!0,sm:12,children:e.jsxs(o,{children:[e.jsx(o,{sx:{display:U.length>0?"flex":"none",flexDirection:"row",alignItems:"center",justifyContent:"space-between",backgroundColor:$.DARK_GRAY,color:$.WHITE,p:"12px",fontSize:"1.25rem",fontWeight:"bold"},children:p.map((Q,pe)=>e.jsx(xr,{title:Q.title,width:Q.width},`${Q.title}_${pe}`))}),U.length>0&&e.jsx(Bn,{items:U,onDragEnd:V,renderItem:X,sx:{padding:0,margin:0,backgroundColor:"transparent",outline:"none","&:hover":{backgroundColor:"transparent"}}}),e.jsx(ke,{sx:{display:"flex",alignItems:"center",justifyContent:"center",width:"100px",height:"100px"},children:e.jsx(Ze,{onClick:()=>P(A),sx:{width:"40px",height:"40px",backgroundColor:$.TAB_BLUE,color:$.WHITE,borderRadius:"6px",transition:"all 0.2s",border:`2px solid ${$.TAB_BLUE}`,"&:hover":{backgroundColor:$.WHITE,color:$.TAB_BLUE}},children:e.jsx(nn,{sx:{fontSize:"2rem"}})})})]})})})})]}),e.jsxs(o,{flexDirection:"row",justifyContent:"flex-end",alignItems:"center",gap:2,children:[e.jsx(v,{label:"儲存草稿",btnColor:"DRAWER_GRAY",type:"submit",onClick:()=>le(qe.DRAFT)}),e.jsx(v,{label:"發佈",btnColor:"TAB_BLUE",type:"submit",onClick:()=>le(qe.PUBLISHED)})]}),e.jsx(na,{open:m,setOpen:E,onSelect:u,type:N[0].type,filterTypeOptions:N})]})},Lg=Rg,fr=[{label:"時空導師",value:"MENTOR",type:"MENTOR"},{label:"戰寵",value:"PET",type:"PET"},{label:"魔王",value:"ENEMY",type:"ENEMY"},{label:"黑洞角色",value:"FILE",type:"FILE",fileApiType:"BLACK_HOLE_CHARACTER"},{label:"黑洞道具",value:"FILE",type:"FILE",fileApiType:"BLACK_HOLE_ITEM"}],Pg=[{label:"黑洞背景",value:"FILE",type:"FILE",fileApiType:"BLACK_HOLE_CHAPTER_BG"},{label:"對話背景",value:"FILE",type:"FILE",fileApiType:"BLACK_HOLE_DIALOGUE_BG"}],br=i.memo(({item:t,index:a,setDataFn:n,picWidth:s="220px"})=>{const r=a===0,l=i.useCallback(()=>{n(c=>c.filter((g,m)=>m!==a))},[n,a]);return e.jsx(i.Fragment,{children:e.jsxs(o,{sx:{justifyContent:"center",alignItems:"center",gap:"4px"},children:[e.jsxs(ke,{sx:{position:"relative"},children:[e.jsx("img",{src:t.src,alt:t.name,width:s,loading:"lazy",style:{border:`2px solid ${a===0?$.ACCRODION_BLUE:$.GRAY}`}}),r&&e.jsx(z,{sx:{position:"absolute",top:0,left:0,backgroundColor:$.ACCRODION_BLUE,color:$.WHITE,padding:"4px 8px",borderRadius:"2px",fontWeight:"bold"},children:"主要"}),e.jsx(un,{title:"移除",placement:"top",children:e.jsx(Ze,{onClick:()=>l(),sx:{position:"absolute",top:2,right:2,backgroundColor:$.WHITE,opacity:.5,width:"28px",height:"28px",transition:"all 0.1s","&:hover":{backgroundColor:$.WHITE,opacity:1}},children:e.jsx(Vt,{sx:{fontSize:"1.5rem","&:hover":{color:$.RED}}})})})]}),e.jsx(Kt,{label:t.name,color:r?"primary":"default"})]},`${t.id}_${a}`)})}),jr=i.memo(({title:t,width:a,textAlign:n="center",sx:s})=>e.jsx(z,{variant:"h6",sx:{textWrap:"nowrap",fontWeight:"500",minWidth:a,textAlign:n,...s},children:t})),yr=i.memo(({index:t,data:a,charactersAndItems:n,backgrounds:s,setDataFn:r,beforeBattleDataLength:l,isIntroDialogue:c,soundEffects:g})=>{var M,Y,U,A,p;const m=i.useMemo(()=>{var x;return((x=n.find(h=>h.id===a.characterPicId))==null?void 0:x.type)==="BLACK_HOLE_ITEM"},[n,a.characterPicId]),[E,f]=i.useState(m?zn:Qn),T=i.useRef(null),[y,D]=i.useState(!1),S=i.useMemo(()=>c?0+t+1:l+t+1,[c,l,t]),j=n==null?void 0:n.map(x=>({label:x.name,value:x.id})),w=s==null?void 0:s.map(x=>({label:x.name,value:x.id})),O=i.useMemo(()=>[...[{label:"無音效",value:0}],...(g||[]).map(h=>({label:h.name,value:h.id}))],[g]),B=i.useCallback(x=>{var h,I;if(y){(h=x.current)==null||h.pause(),D(!1);return}(I=x.current)==null||I.play(),D(!0)},[y]),k=i.useCallback((x,h)=>{if(h==="characterAndItem")return n.find(I=>I.id===x);if(h==="background")return s.find(I=>I.id===x)},[n,s]),q=i.useCallback((x,h)=>{r(I=>I.map(P=>P.id===a.id?{...P,[x]:h}:P))},[r,a.id]),H=i.useCallback(x=>{q("audioId",x),D(!1)},[q]),G=i.useCallback(x=>{const h=k(x,"characterAndItem"),I=(h==null?void 0:h.type)==="BLACK_HOLE_ITEM",P=I?2:1,F=I?zn:Qn;a.displayPosition=P,q("characterPicId",h.id),q("displayPosition",P),f(F)},[k,a,q]),N=i.useCallback(()=>{r(x=>x.filter(h=>h.id!==a.id))},[r,a.id]),L=i.useCallback(()=>{r(x=>x.map(h=>h.id===a.id?{...h,characterPicId:0}:h))},[r,a.id]);return i.useEffect(()=>{f(m?zn:Qn)},[m]),e.jsxs(o,{sx:{flexDirection:"row",justifyContent:"space-between",p:"12px",border:`1px solid ${$.GRAY}`},children:[e.jsx(ke,{sx:{display:"flex",flexDirection:"row",alignItems:"center",justifyContent:"center",width:"50px"},children:e.jsx(z,{variant:"h6",sx:{textAlign:"center"},children:S})}),e.jsx(ke,{sx:{display:"flex",flexDirection:"row",alignItems:"center",justifyContent:"center",width:"200px",outline:`1px solid ${$.GRAY}`,position:"relative","&:hover .delete-icon":{opacity:1}},children:a.characterPicId>0&&e.jsxs(i.Fragment,{children:[e.jsx("img",{src:(M=k(a.characterPicId,"characterAndItem"))==null?void 0:M.src,alt:(Y=k(a.characterPicId,"characterAndItem"))==null?void 0:Y.name,width:"200px"}),e.jsx(un,{title:"移除圖片",placement:"top",children:e.jsx(Ze,{onClick:L,className:"delete-icon",sx:{position:"absolute",top:0,right:0,opacity:0,transition:"opacity 0.2s",width:"28px",height:"28px"},children:e.jsx(Vt,{sx:{fontSize:"1.5rem",color:$.RED}})})})]})}),e.jsx(ke,{sx:{display:"flex",flexDirection:"row",alignItems:"center",justifyContent:"center",width:"200px"},children:e.jsx(Et,{options:j,value:a.characterPicId,onChange:x=>G(x.target.value)})}),e.jsx(ke,{sx:{display:"flex",flexDirection:"row",alignItems:"center",justifyContent:"center",width:"100px"},children:e.jsx(Et,{options:E,value:a.displayPosition,onChange:x=>q("displayPosition",x.target.value),sx:{width:"72px",margin:"auto"}})}),e.jsx(ke,{sx:{display:"flex",flexDirection:"row",alignItems:"center",justifyContent:"center",width:"350px"},children:e.jsx(qa,{rows:5,multiline:!0,name:"dialogueText",placeholder:"請輸入對話，上限 100 字",value:a.dialogueText,onChange:x=>q("dialogueText",x.target.value),sx:{width:"100%"}})}),e.jsxs(ke,{sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",width:"150px"},children:[e.jsxs(o,{gap:1,flexDirection:"row",flexWrap:"wrap",alignItems:"center",sx:{display:a!=null&&a.audioId&&(a==null?void 0:a.audioId)>0?"flex":"none"},children:[y?e.jsx(Qs,{sx:{width:"30px",height:"30px",cursor:"pointer",transition:"all 0.15s","&:hover":{color:"gray"}},onClick:()=>B(T)}):e.jsx(Fn,{sx:{width:"30px",height:"30px",cursor:"pointer",transition:"all 0.15s","&:hover":{color:"gray"}},onClick:()=>B(T)}),e.jsx("audio",{ref:T,id:"audio",src:(U=g.find(x=>x.id===a.audioId))==null?void 0:U.audioSrc,controls:!0,style:{display:"none"},onEnded:()=>D(!1)}),e.jsx("p",{style:{color:"gray"},children:"試聽"})]}),e.jsx(Et,{options:O,value:(a==null?void 0:a.audioId)||"",onChange:x=>H(x.target.value),sx:{width:"100%"}})]}),e.jsx(ke,{sx:{display:"flex",flexDirection:"row",alignItems:"center",justifyContent:"center",width:"200px"},children:e.jsx("img",{src:(A=k(a.bgPicId,"background"))==null?void 0:A.src,alt:(p=k(a.bgPicId,"background"))==null?void 0:p.name,width:"200px"})}),e.jsx(ke,{sx:{display:"flex",flexDirection:"row",alignItems:"center",justifyContent:"center",width:"150px"},children:e.jsx(Et,{options:w,value:a.bgPicId,onChange:x=>q("bgPicId",x.target.value)})}),e.jsx(ke,{sx:{display:"flex",flexDirection:"row",alignItems:"center",justifyContent:"center",width:"50px"},children:e.jsx(Ze,{onClick:N,sx:{width:"40px",height:"40px",backgroundColor:$.RED,color:$.WHITE,borderRadius:"6px",transition:"all 0.2s",border:`2px solid ${$.RED}`,"&:hover":{backgroundColor:$.WHITE,color:$.RED}},children:e.jsx(Vt,{sx:{fontSize:"1.75rem"}})})})]})}),_g=()=>{const{id:t}=Lt(),{setAlertOpen:a}=_e(),{setFlag:n}=at(),s=Me(),{data:r}=Wl(Number(t)),{reset:l,setValue:c,getValues:g,watch:m,control:E}=$e(),[f,T]=i.useState(!1),{setUploadDialogOpen:y,setSelectedType:D}=Rt(),[S,j]=i.useState([]),[w,O]=i.useState([]),B=i.useMemo(()=>S==null?void 0:S.map(ee=>({label:ee.name,value:ee.id})),[S]),{data:k}=ea("BGM"),{data:q}=ea("SFX"),[H,G]=i.useState([]),[N,L]=i.useState([]),[M,Y]=i.useState(fr),[U,A]=i.useState([]),[p,x]=i.useState([]),h=i.useMemo(()=>[{title:"No.",width:"50px"},{title:"預覽圖",width:"200px"},{title:"角色 / 道具",width:"200px"},{title:"位置",width:"100px"},{title:"對話",width:"350px"},{title:"音效",width:"150px"},{title:"場景圖",width:"200px"},{title:"場景",width:"150px"},{title:"刪除",width:"50px"}],[]),I=i.useMemo(()=>{const ee=H.length>0,de=N.length>0;return{id:new Date().getTime(),characterPicId:ee?H[0].id:0,displayPosition:1,dialogueText:"",bgPicId:de?N[0].id:0,groupName:"",characterName:ee?H[0].name:"",isIntroDialogue:!1,orderNum:0,audioId:0,audioSrc:"",audioName:""}},[H,N]);function P(){a({open:!0,title:"提示",message:"更新成功!"}),l(),G([]),L([]),s("/edit/blackHoleDialogueEdit")}const{mutate:F}=Yl(Number(t),P),u=i.useCallback(ee=>{const de={...I,id:new Date().getTime()+Math.random()};ee(Ce=>[...Ce,de])},[I]),_=i.useCallback(()=>{y(!0),D("BLACK_HOLE_DIALOGUE_OPTION")},[y,D]),Z=i.useCallback(async ee=>{const{src:de}=await Jt({id:ee.id}),Ce={...ee,src:de};ee.type==="BLACK_HOLE_CHAPTER_BG"||ee.type==="BLACK_HOLE_DIALOGUE_BG"?L(ue=>[...ue||[],Ce]):G(ue=>[...ue||[],Ce])},[L,G]),C=i.useCallback(ee=>{Y(ee)},[Y]),V=i.useCallback(ee=>{C(ee),T(!0)},[C]),se=i.useCallback(ee=>{if(!ee.destination)return;const{source:de,destination:Ce}=ee;A(ue=>{const Se=Array.from(ue),[Ae]=Se.splice(de.index,1);return Se.splice(Ce.index,0,Ae),Se})},[]),X=i.useCallback(ee=>{if(!ee.destination)return;const{source:de,destination:Ce}=ee;x(ue=>{const Se=Array.from(ue),[Ae]=Se.splice(de.index,1);return Se.splice(Ce.index,0,Ae),Se})},[]),R=i.useCallback((ee,de)=>e.jsx(yr,{index:de,data:ee,charactersAndItems:H,backgrounds:N,soundEffects:w,isIntroDialogue:!0,beforeBattleDataLength:U.length,setDataFn:A},`${ee.id}_${de}`),[U,H,N,w]),b=i.useCallback((ee,de)=>e.jsx(yr,{index:de,data:ee,charactersAndItems:H,backgrounds:N,soundEffects:w,isIntroDialogue:!1,beforeBattleDataLength:U.length,setDataFn:x},`${ee.id}_${de}`),[p,H,N,U.length,w]),W=ee=>{var Se,Ae;const de=m("groupName",r==null?void 0:r.groupName),Ce=m("audioId",r==null?void 0:r.audioId),ue={...ee,groupName:de,audioId:Ce,audioSrc:(Se=w.find(Ee=>Ee.id===Ce))==null?void 0:Se.audioSrc,audioName:(Ae=w.find(Ee=>Ee.id===Ce))==null?void 0:Ae.name,dialogues:[...U.map((Ee,We)=>{var He,Fe,J;return{...Ee,id:0,characterPicId:Ee.characterPicId?Ee.characterPicId:null,characterName:Ee.characterPicId?(He=H.find(oe=>oe.id===Ee.characterPicId))==null?void 0:He.name:null,groupName:de,isIntroDialogue:!0,orderNum:We+1,audioSrc:(Fe=w.find(oe=>oe.id===ee.audioId))==null?void 0:Fe.audioSrc,audioName:(J=w.find(oe=>oe.id===ee.audioId))==null?void 0:J.name}}),...p.map((Ee,We)=>{var He,Fe,J;return{...Ee,id:0,characterPicId:Ee.characterPicId?Ee.characterPicId:null,characterName:Ee.characterPicId?(He=H.find(oe=>oe.id===Ee.characterPicId))==null?void 0:He.name:null,groupName:de,isIntroDialogue:!1,orderNum:U.length+We+1,audioSrc:(Fe=w.find(oe=>oe.id===ee.audioId))==null?void 0:Fe.audioSrc,audioName:(J=w.find(oe=>oe.id===ee.audioId))==null?void 0:J.name}})]};F(ue)},le=ee=>{const de=[...U,...p],Ce=de.length>0,ue=de.some(Ee=>!Ee.bgPicId),Se=(r==null?void 0:r.audioId)===0;if((r==null?void 0:r.groupName.trim().length)===0)return a({open:!0,title:"提示",message:"請輸入群組名稱"}),!1;if(ee===qe.PUBLISHED){const We=[{condition:!Ce,message:"請至少新增一個對話"},{condition:ue,message:"請確保每個對話都有選擇場景"},{condition:Se,message:"請選擇 BGM 音樂"}].find(He=>He.condition);if(We)return a({open:!0,title:"提示",message:We.message}),!1}return!0},ne=ee=>{le(ee.flag)&&(ee.flag===qe.PUBLISHED?a({open:!0,title:"提示",message:"確定要更新並發佈黑洞對話嗎？",onOk:()=>W(ee)}):ee.flag===qe.DRAFT&&a({open:!0,title:"提示",message:"確定要更新草稿嗎？",onOk:()=>W(ee)}))},Q=ee=>{n(ee),c("flag",ee);const de={...g(),flag:ee};ne(de)},pe=i.useCallback(ee=>{if(!ee)return;const de=S.find(Ce=>Ce.id===ee);c("audioId",de==null?void 0:de.id,{shouldValidate:!0})},[S,c]);return i.useEffect(()=>{if(r){const{mainCharacter:ee,charactersAndItems:de,mainBackGround:Ce,backGrounds:ue,groupName:Se,audioId:Ae,dialogues:Ee}=r;k&&j(k),q&&O(q),c("groupName",Se,{shouldValidate:!0}),c("audioId",Ae,{shouldValidate:!0});const We=[ee,...de],He=[Ce,...ue];Promise.all(We.map(async Fe=>{try{const{src:J}=await Jt({id:Fe.id});return{...Fe,src:J}}catch(J){return console.error(`Failed to load image for item ${Fe.id}:`,J),{...Fe,src:""}}})).then(Fe=>{G(Fe)}),Promise.all(He.map(async Fe=>{try{const{src:J}=await Jt({id:Fe.id});return{...Fe,src:J}}catch(J){return console.error(`Failed to load image for background ${Fe.id}:`,J),{...Fe,src:""}}})).then(Fe=>{L(Fe)}),A(Ee.filter(Fe=>Fe.isIntroDialogue===!0)),x(Ee.filter(Fe=>Fe.isIntroDialogue===!1))}},[r]),i.useEffect(()=>()=>{l(),G([]),L([])},[]),e.jsxs(o,{flex:1,px:3,gap:5,children:[e.jsxs(Yn,{defaultExpanded:!0,children:[e.jsx(Un,{expandIcon:e.jsx(qn,{sx:{color:$.WHITE,fontSize:"2rem"}}),sx:{backgroundColor:$.ACCRODION_BLUE,color:"white",fontSize:"1.25rem",fontWeight:"bold",borderRadius:"4px 4px 0 0"},children:"對話群組編輯"}),e.jsx(Vn,{sx:{p:"24px"},children:e.jsxs(K,{container:!0,spacing:4,children:[e.jsx(K,{item:!0,sm:12,md:6,lg:5,children:e.jsx(o,{gap:2,children:e.jsx(ie,{label:"群組名稱",name:"groupName",variant:"control",alertText:"必填"})})}),e.jsx(K,{item:!0,sm:12,md:5,lg:5,children:e.jsxs(ke,{sx:{display:"flex",gap:2},children:[e.jsx(je,{label:"BGM",name:"audioId",type:"ONE",options:B,variant:"control",onChange:ee=>pe(ee.target.value)}),e.jsx(et,{name:"audioId",control:E,render:({field:ee})=>{var de;return e.jsx("audio",{src:(de=S.find(Ce=>Ce.id===ee.value))==null?void 0:de.audioSrc,style:{width:"100%",height:"40px"},controls:!0})}})]})}),e.jsx(K,{item:!0,sm:12,md:1,lg:2,children:e.jsx(o,{flexDirection:"row",justifyContent:"flex-end",children:e.jsx(v,{label:"上傳圖片",btnColor:"BROWN",onClick:_,sx:{borderRadius:99,padding:"8px 24px"}})})}),e.jsx(K,{item:!0,sm:12,children:e.jsxs(o,{gap:4,flexDirection:"row",alignItems:"center",children:[e.jsxs(ke,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",width:"160px",height:"40px"},children:[e.jsx(z,{variant:"h5",sx:{textWrap:"nowrap",fontWeight:"500"},children:"角色 / 道具"}),e.jsx(un,{title:e.jsx(z,{fontSize:"1rem",children:"角色可選左、右位置，道具固定置中"}),children:e.jsx(Ze,{children:e.jsx(Ks,{sx:{fontSize:"1.5rem"}})})})]}),e.jsxs(o,{gap:4,flexDirection:"row",alignItems:"center",flexWrap:"wrap",children:[H==null?void 0:H.map((ee,de)=>e.jsx(br,{item:ee,index:de,setDataFn:G})),e.jsx(ke,{sx:{display:"flex",alignItems:"center",justifyContent:"center",width:"220px",height:"220px"},children:e.jsx(Ze,{onClick:()=>V(fr),sx:{width:"40px",height:"40px",backgroundColor:$.TAB_BLUE,color:$.WHITE,borderRadius:"6px",transition:"all 0.2s",border:`2px solid ${$.TAB_BLUE}`,"&:hover":{backgroundColor:$.WHITE,color:$.TAB_BLUE}},children:e.jsx(nn,{sx:{fontSize:"2rem"}})})})]})]})}),e.jsx(K,{item:!0,sm:12,children:e.jsxs(o,{gap:4,flexDirection:"row",alignItems:"center",children:[e.jsx(z,{variant:"h5",sx:{textWrap:"nowrap",fontWeight:"500",minWidth:"160px"},children:"場景"}),e.jsxs(o,{gap:4,flexDirection:"row",alignItems:"center",flexWrap:"wrap",children:[N==null?void 0:N.map((ee,de)=>e.jsx(br,{item:ee,index:de,setDataFn:L,picWidth:"320px"})),e.jsx(ke,{sx:{display:"flex",alignItems:"center",justifyContent:"center",width:"220px",height:"220px"},children:e.jsx(Ze,{onClick:()=>V(Pg),sx:{width:"40px",height:"40px",backgroundColor:$.TAB_BLUE,color:$.WHITE,borderRadius:"6px",transition:"all 0.2s",border:`2px solid ${$.TAB_BLUE}`,"&:hover":{backgroundColor:$.WHITE,color:$.TAB_BLUE}},children:e.jsx(nn,{sx:{fontSize:"2rem"}})})})]})]})})]})})]}),e.jsxs(Yn,{children:[e.jsx(Un,{expandIcon:e.jsx(qn,{sx:{color:$.WHITE,fontSize:"2rem"}}),sx:{backgroundColor:$.ACCRODION_BLUE,color:"white",fontSize:"1.25rem",fontWeight:"bold",borderRadius:"4px 4px 0 0"},children:"戰鬥前"}),e.jsx(Vn,{sx:{p:"24px"},children:e.jsx(K,{container:!0,spacing:6,wrap:"wrap",children:e.jsx(K,{item:!0,sm:12,children:e.jsxs(o,{children:[e.jsx(o,{sx:{display:U.length>0?"flex":"none",flexDirection:"row",alignItems:"center",justifyContent:"space-between",backgroundColor:$.DARK_GRAY,color:$.WHITE,p:"12px",fontSize:"1.25rem",fontWeight:"bold"},children:h.map((ee,de)=>e.jsx(jr,{title:ee.title,width:ee.width},`${ee.title}_${de}`))}),U.length>0&&e.jsx(Bn,{items:U,onDragEnd:se,renderItem:R,sx:{padding:0,margin:0,backgroundColor:"transparent",outline:"none","&:hover":{backgroundColor:"transparent"}}}),e.jsx(ke,{sx:{display:"flex",alignItems:"center",justifyContent:"center",width:"100px",height:"100px"},children:e.jsx(Ze,{onClick:()=>u(A),sx:{width:"40px",height:"40px",backgroundColor:$.TAB_BLUE,color:$.WHITE,borderRadius:"6px",transition:"all 0.2s",border:`2px solid ${$.TAB_BLUE}`,"&:hover":{backgroundColor:$.WHITE,color:$.TAB_BLUE}},children:e.jsx(nn,{sx:{fontSize:"2rem"}})})})]})})})})]}),e.jsxs(Yn,{children:[e.jsx(Un,{expandIcon:e.jsx(qn,{sx:{color:$.WHITE,fontSize:"2rem"}}),sx:{backgroundColor:$.ACCRODION_BLUE,color:"white",fontSize:"1.25rem",fontWeight:"bold",borderRadius:"4px 4px 0 0"},children:"戰鬥後"}),e.jsx(Vn,{sx:{p:"24px"},children:e.jsx(K,{container:!0,spacing:6,wrap:"wrap",children:e.jsx(K,{item:!0,sm:12,children:e.jsxs(o,{children:[e.jsx(o,{sx:{display:p.length>0?"flex":"none",flexDirection:"row",alignItems:"center",justifyContent:"space-between",backgroundColor:$.DARK_GRAY,color:$.WHITE,p:"12px",fontSize:"1.25rem",fontWeight:"bold"},children:h.map((ee,de)=>e.jsx(jr,{title:ee.title,width:ee.width},`${ee.title}_${de}`))}),p.length>0&&e.jsx(Bn,{items:p,onDragEnd:X,renderItem:b,sx:{padding:0,margin:0,backgroundColor:"transparent",outline:"none","&:hover":{backgroundColor:"transparent"}}}),e.jsx(ke,{sx:{display:"flex",alignItems:"center",justifyContent:"center",width:"100px",height:"100px"},children:e.jsx(Ze,{onClick:()=>u(x),sx:{width:"40px",height:"40px",backgroundColor:$.TAB_BLUE,color:$.WHITE,borderRadius:"6px",transition:"all 0.2s",border:`2px solid ${$.TAB_BLUE}`,"&:hover":{backgroundColor:$.WHITE,color:$.TAB_BLUE}},children:e.jsx(nn,{sx:{fontSize:"2rem"}})})})]})})})})]}),e.jsxs(o,{flexDirection:"row",justifyContent:"flex-end",alignItems:"center",gap:2,children:[(r==null?void 0:r.flag)===qe.DRAFT&&e.jsx(v,{label:"儲存草稿",btnColor:"DRAWER_GRAY",type:"submit",onClick:()=>Q(qe.DRAFT)}),e.jsx(v,{label:"更新發佈",btnColor:"TAB_BLUE",type:"submit",onClick:()=>Q(qe.PUBLISHED)})]}),e.jsx(na,{open:f,setOpen:T,onSelect:Z,type:M[0].type,filterTypeOptions:M})]})},Mg=_g,Fg=t=>t===qe.DRAFT?d.object({groupName:d.string().min(1,"對話群組名稱必填"),flag:d.number(),dialogues:d.array(d.object({characterName:d.string(),characterPicId:d.union([d.number(),d.null()]),displayPosition:d.union([d.number(),d.null()]),isIntroDialogue:d.boolean(),dialogueText:d.string(),orderNum:d.number(),bgPicId:d.union([d.number(),d.null()]),audioId:d.number(),audioSrc:d.string().optional(),audioName:d.string().optional()})),audioId:d.number().optional(),audioSrc:d.string().optional(),audioName:d.string().optional()}):d.object({groupName:d.string().min(1,"對話群組名稱必填"),flag:d.nativeEnum(qe,{errorMap:()=>({message:"狀態必選"})}),dialoguePosition:d.nativeEnum(Ul,{errorMap:()=>({message:"對話位置必選"})}),dialogues:d.array(d.object({characterName:d.string().min(1,"角色名稱必填"),characterPicId:d.union([d.number(),d.null()]),displayPosition:d.union([d.number(),d.null()]),isIntroDialogue:d.boolean(),dialogueText:d.string().min(1,"對話內容必填"),orderNum:d.number(),bgPicId:d.union([d.number(),d.null()]),audioId:d.number(),audioSrc:d.string().optional(),audioName:d.string().optional()})),audioId:d.number().min(1,"請選擇背景音樂"),audioSrc:d.string().optional(),audioName:d.string().optional()}),Bg={groupName:"",flag:0,dialogues:[],audioId:0,audioSrc:"",audioName:""},Hg=({children:t})=>{const{flag:a}=at(),n=sn({mode:"all",resolver:on(Fg(a)),defaultValues:Bg});return e.jsxs(rn,{...n,children:[t,!1]})},$g=Hg;function Gg(){return e.jsx($g,{children:e.jsxs(Pt,{children:[e.jsx(xe,{path:"/",element:e.jsx(Cg,{})}),e.jsx(xe,{path:"/create",element:e.jsx(Lg,{})}),e.jsx(xe,{path:"/update/:id",element:e.jsx(Mg,{})}),e.jsx(xe,{path:"*",element:e.jsx(_t,{to:"/edit/blackHoleDialogueEdit",replace:!0})})]})})}const Wg=({onClick:t,title:a="移除",className:n="delete-icon",iconBtnSx:s,closeIconSx:r})=>e.jsx(un,{title:a,placement:"top",children:e.jsx(Ze,{onClick:t,className:n,sx:{position:"absolute",top:6,right:6,backgroundColor:$.WHITE,opacity:0,width:"32px",height:"32px",transition:"all 0.2s","&:hover":{backgroundColor:$.WHITE,opacity:1},...s},children:e.jsx(Vt,{sx:{fontSize:"1.5rem",color:$.RED,...r}})})}),rs=i.memo(Wg);function Yg(t){return Ue({queryKey:[Ja.SIGN_IN_EVENT_ID(t)],queryFn:()=>xl(t)})}function Ug(t,a){return rt({mutationFn:n=>bl(t,n),onSuccess:n=>n&&a(n)})}function qg(t){return rt({mutationFn:a=>jl(a),onSuccess:a=>a&&t(a)})}function Vg(t){return rt({mutationFn:yl,onSuccess:t})}function Kg(t){return Ue({queryKey:[Ja.SIGN_IN_EVENT_SEARCH,t],queryFn:()=>gl(t)})}function ho(t){return Ue({queryKey:[Ja.SIGN_IN_EVENT_REWARD_DAYS_COUNT_LIST,t],queryFn:()=>fl(t)})}function Xs(){const t=Wa();return{status:Ya(s=>s.status.status),setStatus:s=>{t(Oo.actions.setStatus(s))}}}const zg=[{label:"戰寵",value:"PET",type:"PET",petApiType:2}],Qg=i.memo(({index:t,onDeleteItem:a,onMoveItem:n,setValue:s,control:r,rewardTypeOptions:l,petListOptions:c,dropItemListOptions:g})=>{const[m,E]=i.useState(!1),[f,T]=i.useState({}),{watch:y}=$e(),D=y(`signInEventDailyContentDtoList.${t}.blessingsPetId`),S=y(`signInEventDailyContentDtoList.${t}.blessingsPetInfoDto`),j=y(`signInEventDailyContentDtoList.${t}.signInEventDailyContentRewardDtoList`)||[],{fields:w,append:O,remove:B,update:k}=It({control:r,name:`signInEventDailyContentDtoList.${t}.signInEventDailyContentRewardDtoList`}),q=i.useCallback(h=>{var P;const I=(P=j[h])==null?void 0:P.rewardType;return l.filter(F=>F.value===I?!0:!j.some(u=>u.rewardType===F.value))},[l,j]),H=i.useCallback(async h=>{if(f[h])return f[h];try{const I=await Jt({id:h}),P=(I==null?void 0:I.src)||"";return T(F=>({...F,[h]:P})),P}catch(I){return console.error("載入圖片失敗:",I),""}},[f]),G=i.useCallback(async h=>{h.petId&&h.type==="PET"&&(s(`signInEventDailyContentDtoList.${t}.blessingsPetId`,h.petId||null,{shouldValidate:!0}),s(`signInEventDailyContentDtoList.${t}.blessingsPetInfoDto`,{id:h.petId,name:h.name,picId:h.id},{shouldValidate:!0}),await H(h.id))},[t,s,H]),N=i.useCallback(()=>{s(`signInEventDailyContentDtoList.${t}.blessingsPetId`,-1,{shouldValidate:!0}),s(`signInEventDailyContentDtoList.${t}.blessingsPetInfoDto`,{id:0,name:"",picId:0},{shouldValidate:!0})},[t,s]),L=i.useCallback(()=>{a(t)},[t,a]),M=i.useCallback(h=>{n(t,h)},[t,n]),Y=i.useCallback(()=>{const h=l.filter(I=>!j.some(P=>P.rewardType===I.value));h.length!==0&&O({id:null,rewardType:h[0].value,orderNum:j.length+1,rewardedPetId:null,dropItemId:null,rewardAmount:1})},[O,j,l]),U=i.useCallback((h,I)=>{const P=w[h];switch(P.rewardType){case Ht.PET:k(h,{...P,rewardType:I,rewardedPetId:null});break;case Ht.DROP_ITEM:k(h,{...P,rewardType:I,dropItemId:null});break;default:k(h,{...P,rewardType:I})}},[k,w]),A=i.useCallback(h=>{B(h)},[B]),p=()=>{if(!(S!=null&&S.picId))return null;const h=f[S==null?void 0:S.picId];if(h)return e.jsx("img",{src:h,width:"200px",alt:"祝福戰寵"});H(S==null?void 0:S.picId)},x=i.useCallback(h=>{if(!h.destination)return;const{source:I,destination:P}=h,F=[...j],[u]=F.splice(I.index,1);F.splice(P.index,0,u),s(`signInEventDailyContentDtoList.${t}.signInEventDailyContentRewardDtoList`,F,{shouldValidate:!0})},[j,t,s]);return e.jsxs(o,{sx:{gap:4,position:"relative",outline:`1px solid ${$.DARK_GRAY}`,p:"20px",borderRadius:"4px",boxShadow:"0 2px 4px rgba(0,0,0,0.1)",transition:"all 0.2s ease","&:hover":{boxShadow:"0 4px 8px rgba(0,0,0,0.15)"},"&:hover .delete-icon":{opacity:1}},children:[e.jsxs(o,{flexDirection:"row",mb:2,children:[e.jsxs(ke,{sx:{display:"flex",alignItems:"center",gap:2,padding:"12px 24px",borderRadius:"8px",backgroundColor:$.WHITE,border:`1px solid ${$.DARK_GRAY}`,boxShadow:"0 2px 8px rgba(0,0,0,0.1)",transition:"all 0.3s ease","&:hover":{boxShadow:"0 4px 12px rgba(0,0,0,0.15)"}},children:[e.jsx(z,{variant:"h5",sx:{fontWeight:700,letterSpacing:"1.2px",color:$.BLACK,textShadow:"1px 1px 2px rgba(0,0,0,0.1)"},children:"簽到次序"}),e.jsx(Ze,{onClick:()=>M("up"),sx:{transition:"all 0.2s",borderRadius:"50%",padding:"8px","&:hover":{backgroundColor:$.LIGHT_GRAY}},children:e.jsx(qr,{sx:{color:$.DARK_GRAY,fontSize:"1.5rem"}})}),e.jsx(Kt,{label:t+1,color:"default",sx:{fontSize:"1.25rem",fontWeight:700,backgroundColor:$.WHITE,border:`2px solid ${$.DARK_GRAY}`,boxShadow:"0 2px 4px rgba(0,0,0,0.1)"}}),e.jsx(Ze,{onClick:()=>M("down"),sx:{transition:"all 0.2s",borderRadius:"50%",padding:"8px","&:hover":{backgroundColor:$.LIGHT_GRAY}},children:e.jsx(Vr,{sx:{color:$.DARK_GRAY,fontSize:"1.5rem"}})})]}),t!==0&&e.jsx(rs,{onClick:L})]}),e.jsxs(K,{container:!0,spacing:6,children:[e.jsx(K,{item:!0,xs:12,md:4,children:e.jsxs(o,{gap:2,children:[e.jsx(et,{name:`signInEventDailyContentDtoList.${t}.blessingsPetId`,control:r,render:({field:h,fieldState:{error:I}})=>e.jsxs(o,{gap:2,...h,children:[e.jsxs(o,{gap:2,flexDirection:"row",children:[e.jsx(he,{children:"祝福戰寵"}),e.jsx(v,{label:"搜尋圖片",btnColor:"BROWN",onClick:()=>E(!0),sx:{borderRadius:99,padding:"0 24px"}}),D&&D>0&&e.jsx(v,{label:"移除",btnColor:"CANCEL_RED",onClick:N,sx:{borderRadius:99,padding:"0 24px"}})]}),!!I&&e.jsx(o,{sx:{border:`1px solid ${$.CANCEL_RED}`,p:3},children:e.jsx(ht,{sx:{textAlign:"center",color:"red"},children:I.message})})]})}),e.jsx(o,{justifyContent:"center",alignItems:"center",gap:2,children:e.jsx("figure",{style:{width:"200px",height:"200px",border:`2px dashed ${$.GRAY}`,borderRadius:"12px",backgroundColor:$.LIGHT_GRAY},children:p()})}),e.jsx(ze,{label:"戰寵祝福文字",name:`signInEventDailyContentDtoList.${t}.blessings`,variant:"control",rows:4,labelSx:{width:"100%"},stackSx:{gap:0}})]})}),e.jsxs(K,{item:!0,xs:12,md:7,children:[e.jsx(he,{sx:{width:"100%"},children:"簽到獎勵列表"}),e.jsxs(o,{gap:4,py:4,children:[e.jsx(Bn,{items:w,onDragEnd:x,sx:{backgroundColor:"transparent",outline:"none",p:0,my:2,boxShadow:"none","&:hover":{backgroundColor:"transparent"}},renderItem:(h,I)=>e.jsx(o,{gap:2,position:"relative",children:e.jsxs(K,{container:!0,spacing:2,alignItems:"flex-start",children:[e.jsx(K,{item:!0,xs:12,md:4,children:e.jsx(je,{label:"獎勵類型",name:`signInEventDailyContentDtoList.${t}.signInEventDailyContentRewardDtoList.${I}.rewardType`,variant:"control",type:"ONE",alertText:"類型為戰寵或掉落物時，請選擇名稱",labelSx:{width:"100%"},stackSx:{flexDirection:"column",gap:0},options:q(I),onChange:P=>U(I,P.target.value)})}),h.rewardType===Ht.PET&&e.jsx(K,{item:!0,xs:12,md:4,children:e.jsx(je,{label:"戰寵名稱",name:`signInEventDailyContentDtoList.${t}.signInEventDailyContentRewardDtoList.${I}.rewardedPetId`,variant:"control",type:"ONE",alertText:"戰寵名稱",labelSx:{width:"100%"},stackSx:{flexDirection:"column",gap:0},options:c,onChange:P=>{s(`signInEventDailyContentDtoList.${t}.signInEventDailyContentRewardDtoList.${I}.rewardedPetId`,P.target.value,{shouldValidate:!0})}})}),h.rewardType===Ht.DROP_ITEM&&e.jsx(K,{item:!0,xs:12,md:4,children:e.jsx(je,{label:"掉落物名稱",name:`signInEventDailyContentDtoList.${t}.signInEventDailyContentRewardDtoList.${I}.dropItemId`,variant:"control",type:"ONE",alertText:"掉落物名稱",labelSx:{width:"100%"},stackSx:{flexDirection:"column",gap:0},options:g,onChange:P=>{s(`signInEventDailyContentDtoList.${t}.signInEventDailyContentRewardDtoList.${I}.dropItemId`,P.target.value,{shouldValidate:!0})}})}),e.jsx(K,{item:!0,xs:12,md:h.rewardType===Ht.PET||h.rewardType===Ht.DROP_ITEM?4:8,children:e.jsx(ie,{label:"數量",name:`signInEventDailyContentDtoList.${t}.signInEventDailyContentRewardDtoList.${I}.rewardAmount`,variant:"control",type:"number",textAlign:"center",labelSx:{width:"100%"},stackSx:{flexDirection:"column",gap:0},disabled:h.rewardType===Ht.PET})}),e.jsx(un,{title:"移除獎勵",placement:"top",children:e.jsx(Ze,{onClick:()=>A(I),sx:{position:"absolute",right:-60,top:24,backgroundColor:$.CANCEL_RED,"&:hover":{backgroundColor:$.CANCEL_RED}},children:e.jsx(Vt,{sx:{color:$.WHITE}})})})]})},h.id)}),w.length<3&&l.some(h=>!j.some(I=>I.rewardType===h.value))&&e.jsx(v,{label:"",btnColor:"TAB_BLUE",onClick:Y,sx:{width:"fit-content",py:"10px"},icon:e.jsx(nn,{})})]})]})]}),e.jsx(na,{open:m,setOpen:E,type:"PET",title:"選擇戰寵",filterTypeOptions:zg,onSelect:G})]})}),Xg=()=>{const{setAlertOpen:t}=_e(),a=Me(),{reset:n,control:s,setValue:r,watch:l,handleSubmit:c}=$e(),g=Be({control:s,name:"signInEventDailyContentDtoList"}),{signInBgSelectedImage:m,setSignInBgSelectedImage:E,setSelectedType:f,setPetSelectedImage:T}=Rt(),{setStatus:y}=Xs(),{data:D}=ta(),S=i.useMemo(()=>(D==null?void 0:D.map(u=>({label:u.name,value:u.id})))||[],[D]),{data:j}=Kr(),w=i.useMemo(()=>(j==null?void 0:j.map(u=>({label:u.dropItemName,value:u.id})))||[],[j]),[O,B]=i.useState([]),{data:k}=ea("BGM"),q=i.useMemo(()=>(k==null?void 0:k.map(u=>({label:u.name,value:u.id})))||[],[k]),H=i.useCallback(u=>{if(!u)return;const _=k==null?void 0:k.find(Z=>Z.id===u);r("audioId",(_==null?void 0:_.id)||null,{shouldValidate:!0})},[k,r]),G=i.useCallback((u,_)=>{_==="startTime"&&r("startTime",Ie(u).set("hour",0).set("minute",0).set("second",0).valueOf(),{shouldValidate:!0}),_==="endTime"&&r("endTime",Ie(u).set("hour",23).set("minute",59).set("second",59).valueOf(),{shouldValidate:!0})},[r]),N=i.useCallback((u,_)=>{const Z=[...g],C=Z[u];if(_==="up"){if(u===0)return;Z[u]=Z[u-1],Z[u-1]=C}if(_==="down"){if(u===Z.length-1)return;Z[u]=Z[u+1],Z[u+1]=C}r("signInEventDailyContentDtoList",Z,{shouldValidate:!0})},[g,r]),{fields:L,append:M,remove:Y}=It({control:s,name:"signInEventDailyContentDtoList"}),U=i.useCallback(()=>{var u;(g==null?void 0:g.length)>=30||M({id:null,blessingsPetId:-1,blessingsPetInfoDto:{id:0,name:"",picId:0},blessings:"",orderNum:((u=l("signInEventDailyContentDtoList"))==null?void 0:u.length)||0,signInEventDailyContentRewardDtoList:[]})},[M,g,l]),A=i.useCallback(u=>{Y(u)},[Y]);function p(){t({open:!0,title:"提示",message:"創建成功!"}),n(),T(null),E(null),a("/edit/signInEventEdit")}const{mutate:x}=Vg(p),h=u=>{y(u),r("status",u)},I=u=>({...u,startTime:Ie(u.startTime).set("hour",0).set("minute",0).set("second",0).valueOf(),endTime:Ie(u.endTime).set("hour",23).set("minute",59).set("second",59).valueOf(),signInEventDailyContentDtoList:u.signInEventDailyContentDtoList.map((_,Z)=>({..._,id:_.id||null,orderNum:Z+1,blessingsPetId:_.blessingsPetId&&_.blessingsPetId>0?_.blessingsPetId:null,signInEventDailyContentRewardDtoList:_.signInEventDailyContentRewardDtoList.map((C,V)=>({id:C.id||null,rewardType:C.rewardType,rewardAmount:C.rewardAmount,rewardedPetId:C.rewardedPetId,dropItemId:C.dropItemId,orderNum:V+1}))}))}),P=u=>{const _=I(u);x(_)},F=u=>{u.status===wt.COMPLETE?t({open:!0,title:"提示",message:"確定要發佈簽到活動嗎？",onOk:()=>P(u)}):u.status===wt.DRAFT&&t({open:!0,title:"提示",message:"確定要儲存為草稿嗎？",onOk:()=>P(u)})};return i.useEffect(()=>{k&&B(k),f("SIGN_IN_BG")},[k]),i.useEffect(()=>{m&&r("picId",m.id,{shouldValidate:!0})},[m]),i.useEffect(()=>()=>{n(),T(null),E(null)},[]),e.jsx(it,{onSubmit:c(F),children:e.jsxs(o,{gap:5,children:[e.jsxs(K,{container:!0,spacing:5,children:[e.jsx(K,{item:!0,xs:12,md:6,children:e.jsxs(o,{spacing:2,children:[e.jsx(ie,{label:"活動名稱",name:"name",variant:"control"}),e.jsx(Gt,{label:"開始時間",name:"startTime",variant:"control",labelSx:{width:"300px"},onChange:u=>G(u,"startTime")}),e.jsx(Gt,{label:"結束時間",name:"endTime",variant:"control",labelSx:{width:"300px"},onChange:u=>G(u,"endTime")}),e.jsx(ke,{display:"flex",gap:2,children:e.jsx($t,{title:"主視覺圖",name:"picId",selectBtnSx:{justifyContent:"flex-start",gap:3},labelSx:{flex:1}})}),e.jsx(je,{label:"BGM",name:"audioId",variant:"control",type:"ONE",options:q,onChange:u=>H(u.target.value)}),e.jsx(et,{name:"audioId",control:s,render:({field:u})=>{var _;return e.jsx("audio",{src:(_=O.find(Z=>Z.id===u.value))==null?void 0:_.audioSrc,style:{width:"100%"},controls:!0})}})]})}),e.jsx(K,{item:!0,xs:12,md:6,children:m?e.jsxs(ke,{sx:{position:"relative",display:"flex",justifyContent:"center",alignItems:"center",transition:"all 0.2s","&:hover .delete-icon":{opacity:1}},children:[e.jsx("img",{src:m==null?void 0:m.src,alt:"主視覺圖",width:"100%"}),e.jsx(rs,{onClick:()=>E(null)})]}):e.jsx(ke,{sx:{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"200px",height:"100%",backgroundColor:$.LIGHT_GRAY,borderRadius:"10px",border:`2px dashed ${$.GRAY}`},children:e.jsx(z,{variant:"h5",color:$.BLACK,sx:{opacity:.6,fontWeight:500,letterSpacing:"0.5px"},children:"主視覺圖預覽"})})})]}),e.jsx(ze,{label:"簽到活動描述",name:"description",variant:"control",rows:6,labelSx:{width:"300px"},stackSx:{gap:0}}),e.jsxs(o,{gap:3,children:[L.map((u,_)=>e.jsx(Qg,{index:_,onDeleteItem:A,onMoveItem:N,setValue:r,control:s,rewardTypeOptions:vr,petListOptions:S,dropItemListOptions:w},u.id)),(g==null?void 0:g.length)<30&&e.jsx(v,{label:"新增簽到次序",btnColor:"TAB_BLUE",onClick:U,sx:{width:"fit-content",py:1}})]}),e.jsxs(o,{flexDirection:"row",gap:3,justifyContent:"flex-end",children:[e.jsx(v,{label:"儲存草稿",type:"submit",btnColor:"DRAWER_GRAY",onClick:()=>h(wt.DRAFT)}),e.jsx(v,{label:"發佈簽到活動",type:"submit",btnColor:"TAB_BLUE",onClick:()=>h(wt.COMPLETE)})]})]})})},Jg=Xg,Cr=t=>{const a={id:d.union([d.number(),d.null()]),rewardType:t===wt.DRAFT?d.union([d.number(),d.null()]):d.number().min(1,"獎勵類型必選"),orderNum:t===wt.DRAFT?d.union([d.number(),d.null()]):d.number(),rewardedPetId:d.union([d.number(),d.null()]),dropItemId:d.union([d.number(),d.null()]),rewardAmount:d.number().min(1,"獎勵數量必需大於0")},n=d.object(a);return t===wt.DRAFT?n:n.refine(s=>s.rewardType===5?s.rewardedPetId!==null&&s.rewardedPetId!==void 0:s.rewardType===6?s.dropItemId!==null&&s.dropItemId!==void 0:!0).refine(s=>!(s.rewardType===5&&!s.rewardedPetId),{message:"選擇戰寵獎勵時，必須選擇戰寵",path:["rewardedPetId"]}).refine(s=>!(s.rewardType===6&&!s.dropItemId),{message:"選擇道具獎勵時，必須選擇道具",path:["dropItemId"]})},Zg=t=>t===wt.DRAFT?d.object({id:d.union([d.number(),d.null()]),blessingsPetId:d.union([d.number(),d.null()]),blessingsPetInfoDto:d.object({id:d.union([d.number(),d.null()]),name:d.union([d.string(),d.null()]),picId:d.union([d.number(),d.null()])}),blessings:d.string(),orderNum:d.union([d.number(),d.null()]),signInEventDailyContentRewardDtoList:d.array(Cr(t))}):d.object({id:d.union([d.number(),d.null()]),blessingsPetId:d.number().min(1,"祝福戰寵必選"),blessingsPetInfoDto:d.object({id:d.union([d.number(),d.null()]),name:d.union([d.string(),d.null()]),picId:d.union([d.number(),d.null()])}),blessings:d.string().min(1,"祝福語必填"),orderNum:d.number(),signInEventDailyContentRewardDtoList:d.array(Cr(t))}),ef=t=>d.object({name:d.string().min(1,"簽到活動名稱必填"),description:d.string(),picId:t===wt.DRAFT?d.union([d.number(),d.null()]):d.number().min(1,"活動圖片必選"),audioId:t===wt.DRAFT?d.union([d.number(),d.null()]):d.number().min(1,"音效必選"),startTime:d.number(),endTime:d.number(),signInEventDailyContentDtoList:d.array(Zg(t)),status:d.nativeEnum(wt)}),xo={name:"",description:"",picId:0,audioId:0,startTime:Ie().toDate().getTime(),endTime:Ie().add(1,"day").toDate().getTime(),signInEventDailyContentDtoList:[],status:wt.DRAFT},tf=[{label:"戰寵",value:"PET",type:"PET",petApiType:2}],nf=i.memo(({index:t,onDeleteItem:a,onMoveItem:n,setValue:s,control:r,rewardTypeOptions:l,petListOptions:c,dropItemListOptions:g})=>{const[m,E]=i.useState(!1),[f,T]=i.useState({}),{watch:y}=$e(),D=y(`signInEventDailyContentDtoList.${t}.blessingsPetId`),S=y(`signInEventDailyContentDtoList.${t}.blessingsPetInfoDto`),j=y(`signInEventDailyContentDtoList.${t}.signInEventDailyContentRewardDtoList`)||[],{fields:w,append:O,remove:B,update:k}=It({control:r,name:`signInEventDailyContentDtoList.${t}.signInEventDailyContentRewardDtoList`}),q=i.useCallback(h=>{var P;const I=(P=j[h])==null?void 0:P.rewardType;return l.filter(F=>F.value===I?!0:!j.some(u=>u.rewardType===F.value))},[l,j]),H=i.useCallback(async h=>{if(f[h])return f[h];try{const I=await Jt({id:h}),P=(I==null?void 0:I.src)||"";return T(F=>({...F,[h]:P})),P}catch(I){return console.error("載入圖片失敗:",I),""}},[f]),G=i.useCallback(async h=>{h.petId&&h.type==="PET"&&(s(`signInEventDailyContentDtoList.${t}.blessingsPetId`,h.petId||null,{shouldValidate:!0}),s(`signInEventDailyContentDtoList.${t}.blessingsPetInfoDto`,{id:h.petId,name:h.name,picId:h.id},{shouldValidate:!0}),await H(h.id))},[t,s,H]),N=i.useCallback(()=>{s(`signInEventDailyContentDtoList.${t}.blessingsPetId`,-1,{shouldValidate:!0}),s(`signInEventDailyContentDtoList.${t}.blessingsPetInfoDto`,{id:0,name:"",picId:0},{shouldValidate:!0})},[t,s]),L=i.useCallback(()=>{a(t)},[t,a]),M=i.useCallback(h=>{n(t,h)},[t,n]),Y=i.useCallback(()=>{const h=l.filter(I=>!j.some(P=>P.rewardType===I.value));h.length!==0&&O({id:null,rewardType:h[0].value,orderNum:j.length+1,rewardedPetId:null,dropItemId:null,rewardAmount:1})},[O,j,l]),U=i.useCallback((h,I)=>{const P=w[h];switch(P.rewardType){case Ht.PET:k(h,{...P,rewardType:I,rewardedPetId:null});break;case Ht.DROP_ITEM:k(h,{...P,rewardType:I,dropItemId:null});break;default:k(h,{...P,rewardType:I})}},[k,w]),A=i.useCallback(h=>{B(h)},[B]),p=()=>{if(!(S!=null&&S.picId))return null;const h=f[S==null?void 0:S.picId];if(h)return e.jsx("img",{src:h,width:"200px",alt:"祝福戰寵"});H(S==null?void 0:S.picId)},x=i.useCallback(h=>{if(!h.destination)return;const{source:I,destination:P}=h,F=[...j],[u]=F.splice(I.index,1);F.splice(P.index,0,u),s(`signInEventDailyContentDtoList.${t}.signInEventDailyContentRewardDtoList`,F,{shouldValidate:!0})},[j,t,s]);return e.jsxs(o,{sx:{gap:4,position:"relative",outline:`1px solid ${$.DARK_GRAY}`,p:"20px",borderRadius:"4px",boxShadow:"0 2px 4px rgba(0,0,0,0.1)",transition:"all 0.2s ease","&:hover":{boxShadow:"0 4px 8px rgba(0,0,0,0.15)"},"&:hover .delete-icon":{opacity:1}},children:[e.jsxs(o,{flexDirection:"row",mb:2,children:[e.jsxs(ke,{sx:{display:"flex",alignItems:"center",gap:2,padding:"12px 24px",borderRadius:"8px",backgroundColor:$.WHITE,border:`1px solid ${$.DARK_GRAY}`,boxShadow:"0 2px 8px rgba(0,0,0,0.1)",transition:"all 0.3s ease","&:hover":{boxShadow:"0 4px 12px rgba(0,0,0,0.15)"}},children:[e.jsx(z,{variant:"h5",sx:{fontWeight:700,letterSpacing:"1.2px",color:$.BLACK,textShadow:"1px 1px 2px rgba(0,0,0,0.1)"},children:"簽到次序"}),e.jsx(Ze,{onClick:()=>M("up"),sx:{transition:"all 0.2s",borderRadius:"50%",padding:"8px","&:hover":{backgroundColor:$.LIGHT_GRAY}},children:e.jsx(qr,{sx:{color:$.DARK_GRAY,fontSize:"1.5rem"}})}),e.jsx(Kt,{label:t+1,color:"default",sx:{fontSize:"1.25rem",fontWeight:700,backgroundColor:$.WHITE,border:`2px solid ${$.DARK_GRAY}`,boxShadow:"0 2px 4px rgba(0,0,0,0.1)"}}),e.jsx(Ze,{onClick:()=>M("down"),sx:{transition:"all 0.2s",borderRadius:"50%",padding:"8px","&:hover":{backgroundColor:$.LIGHT_GRAY}},children:e.jsx(Vr,{sx:{color:$.DARK_GRAY,fontSize:"1.5rem"}})})]}),t!==0&&e.jsx(rs,{onClick:L})]}),e.jsxs(K,{container:!0,spacing:6,children:[e.jsx(K,{item:!0,xs:12,md:4,children:e.jsxs(o,{gap:2,children:[e.jsx(et,{name:`signInEventDailyContentDtoList.${t}.blessingsPetId`,control:r,render:({field:h,fieldState:{error:I}})=>e.jsxs(o,{gap:2,...h,children:[e.jsxs(o,{gap:2,flexDirection:"row",children:[e.jsx(he,{children:"祝福戰寵"}),e.jsx(v,{label:"搜尋圖片",btnColor:"BROWN",onClick:()=>E(!0),sx:{borderRadius:99,padding:"0 24px"}}),D&&D>0&&e.jsx(v,{label:"移除",btnColor:"CANCEL_RED",onClick:N,sx:{borderRadius:99,padding:"0 24px"}})]}),!!I&&e.jsx(o,{sx:{border:`1px solid ${$.CANCEL_RED}`,p:3},children:e.jsx(ht,{sx:{textAlign:"center",color:"red"},children:I.message})})]})}),e.jsx(o,{justifyContent:"center",alignItems:"center",gap:2,children:e.jsx("figure",{style:{width:"200px",height:"200px",border:`2px dashed ${$.GRAY}`,borderRadius:"12px",backgroundColor:$.LIGHT_GRAY},children:p()})}),e.jsx(ze,{label:"戰寵祝福文字",name:`signInEventDailyContentDtoList.${t}.blessings`,variant:"control",rows:4,labelSx:{width:"100%"},stackSx:{gap:0}})]})}),e.jsxs(K,{item:!0,xs:12,md:7,children:[e.jsx(he,{sx:{width:"100%"},children:"簽到獎勵列表"}),e.jsxs(o,{gap:4,py:4,children:[e.jsx(Bn,{items:w,onDragEnd:x,sx:{backgroundColor:"transparent",outline:"none",p:0,my:2,boxShadow:"none","&:hover":{backgroundColor:"transparent"}},renderItem:(h,I)=>e.jsx(o,{gap:2,position:"relative",children:e.jsxs(K,{container:!0,spacing:2,alignItems:"flex-start",children:[e.jsx(K,{item:!0,xs:12,md:4,children:e.jsx(je,{label:"獎勵類型",name:`signInEventDailyContentDtoList.${t}.signInEventDailyContentRewardDtoList.${I}.rewardType`,variant:"control",type:"ONE",alertText:"類型為戰寵或掉落物時，請選擇名稱",labelSx:{width:"100%"},stackSx:{flexDirection:"column",gap:0},options:q(I),onChange:P=>U(I,P.target.value)})}),h.rewardType===Ht.PET&&e.jsx(K,{item:!0,xs:12,md:4,children:e.jsx(je,{label:"戰寵名稱",name:`signInEventDailyContentDtoList.${t}.signInEventDailyContentRewardDtoList.${I}.rewardedPetId`,variant:"control",type:"ONE",alertText:"戰寵名稱",labelSx:{width:"100%"},stackSx:{flexDirection:"column",gap:0},options:c,onChange:P=>{s(`signInEventDailyContentDtoList.${t}.signInEventDailyContentRewardDtoList.${I}.rewardedPetId`,P.target.value,{shouldValidate:!0})}})}),h.rewardType===Ht.DROP_ITEM&&e.jsx(K,{item:!0,xs:12,md:4,children:e.jsx(je,{label:"掉落物名稱",name:`signInEventDailyContentDtoList.${t}.signInEventDailyContentRewardDtoList.${I}.dropItemId`,variant:"control",type:"ONE",alertText:"掉落物名稱",labelSx:{width:"100%"},stackSx:{flexDirection:"column",gap:0},options:g,onChange:P=>{s(`signInEventDailyContentDtoList.${t}.signInEventDailyContentRewardDtoList.${I}.dropItemId`,P.target.value,{shouldValidate:!0})}})}),e.jsx(K,{item:!0,xs:12,md:h.rewardType===Ht.PET||h.rewardType===Ht.DROP_ITEM?4:8,children:e.jsx(ie,{label:"數量",name:`signInEventDailyContentDtoList.${t}.signInEventDailyContentRewardDtoList.${I}.rewardAmount`,variant:"control",type:"number",textAlign:"center",labelSx:{width:"100%"},stackSx:{flexDirection:"column",gap:0},disabled:h.rewardType===Ht.PET})}),e.jsx(un,{title:"移除獎勵",placement:"top",children:e.jsx(Ze,{onClick:()=>A(I),sx:{position:"absolute",right:-60,top:24,backgroundColor:$.CANCEL_RED,"&:hover":{backgroundColor:$.CANCEL_RED}},children:e.jsx(Vt,{sx:{color:$.WHITE}})})})]})},h.id)}),w.length<3&&l.some(h=>!j.some(I=>I.rewardType===h.value))&&e.jsx(v,{label:"",btnColor:"TAB_BLUE",onClick:Y,sx:{width:"fit-content",py:"10px"},icon:e.jsx(nn,{})})]})]})]}),e.jsx(na,{open:m,setOpen:E,type:"PET",title:"選擇戰寵",filterTypeOptions:tf,onSelect:G})]})}),af=()=>{const{setAlertOpen:t}=_e(),a=Me(),{reset:n,control:s,setValue:r,watch:l,handleSubmit:c}=$e(),g=Be({control:s,name:"signInEventDailyContentDtoList"}),{signInBgSelectedImage:m,setSignInBgSelectedImage:E,setSelectedType:f,setPetSelectedImage:T}=Rt(),{setStatus:y}=Xs(),{id:D}=Lt(),{data:S,isLoading:j}=Yg(Number(D)),{data:w}=ta(),O=i.useMemo(()=>(w==null?void 0:w.map(C=>({label:C.name,value:C.id})))||[],[w]),{data:B}=Kr(),k=i.useMemo(()=>(B==null?void 0:B.map(C=>({label:C.dropItemName,value:C.id})))||[],[B]),[q,H]=i.useState([]),{data:G}=ea("BGM"),N=i.useMemo(()=>(G==null?void 0:G.map(C=>({label:C.name,value:C.id})))||[],[G]),L=i.useCallback(C=>{if(!C)return;const V=G==null?void 0:G.find(se=>se.id===C);r("audioId",(V==null?void 0:V.id)||null,{shouldValidate:!0})},[G,r]),M=i.useCallback((C,V)=>{V==="startTime"&&r("startTime",Ie(C).set("hour",0).set("minute",0).set("second",0).valueOf(),{shouldValidate:!0}),V==="endTime"&&r("endTime",Ie(C).set("hour",23).set("minute",59).set("second",59).valueOf(),{shouldValidate:!0})},[r]),Y=i.useCallback((C,V)=>{const se=[...g],X=se[C];if(V==="up"){if(C===0)return;se[C]=se[C-1],se[C-1]=X}if(V==="down"){if(C===se.length-1)return;se[C]=se[C+1],se[C+1]=X}r("signInEventDailyContentDtoList",se,{shouldValidate:!0})},[g,r]),{fields:U,append:A,remove:p}=It({control:s,name:"signInEventDailyContentDtoList"}),x=i.useCallback(()=>{var C;(g==null?void 0:g.length)>=30||A({id:null,blessingsPetId:-1,blessingsPetInfoDto:{id:0,name:"",picId:0},blessings:"",orderNum:((C=l("signInEventDailyContentDtoList"))==null?void 0:C.length)||0,signInEventDailyContentRewardDtoList:[]})},[A,g,l]),h=i.useCallback(C=>{p(C)},[p]);function I(){t({open:!0,title:"提示",message:"創建成功!"}),n(),T(null),E(null),a("/edit/signInEventEdit")}const{mutate:P}=Ug(Number(D),I),F=C=>{y(C),r("status",C)},u=C=>({...C,startTime:Ie(C.startTime).set("hour",0).set("minute",0).set("second",0).valueOf(),endTime:Ie(C.endTime).set("hour",23).set("minute",59).set("second",59).valueOf(),signInEventDailyContentDtoList:C.signInEventDailyContentDtoList.map((V,se)=>({...V,id:V.id||null,orderNum:se+1,blessingsPetId:V.blessingsPetId&&V.blessingsPetId>0?V.blessingsPetId:null,signInEventDailyContentRewardDtoList:V.signInEventDailyContentRewardDtoList.map((X,R)=>({id:X.id||null,rewardType:X.rewardType,rewardAmount:X.rewardAmount,rewardedPetId:X.rewardedPetId,dropItemId:X.dropItemId,orderNum:R+1}))}))}),_=C=>{const V=u(C);P(V)},Z=C=>{C.status===wt.COMPLETE?t({open:!0,title:"提示",message:"確定要更新簽到活動嗎？",onOk:()=>_(C)}):C.status===wt.DRAFT&&t({open:!0,title:"提示",message:"確定要儲存為草稿嗎？",onOk:()=>_(C)})};return i.useEffect(()=>{G&&H(G),f("SIGN_IN_BG")},[G]),i.useEffect(()=>{(async()=>{if(S&&(n(S),y(S.status),S.picId)){const V=await Jt({id:S.picId});E({id:S.picId,src:(V==null?void 0:V.src)||""})}})()},[S]),i.useEffect(()=>{m?r("picId",m.id,{shouldValidate:!0}):r("picId",0)},[m,r]),i.useEffect(()=>()=>{n(xo),T(null),E(null)},[]),j?e.jsx(Ge,{}):e.jsx(it,{onSubmit:c(Z),children:e.jsxs(o,{gap:5,children:[e.jsxs(K,{container:!0,spacing:5,children:[e.jsx(K,{item:!0,xs:12,md:6,children:e.jsxs(o,{spacing:2,children:[e.jsx(ie,{label:"活動名稱",name:"name",variant:"control"}),e.jsx(Gt,{label:"開始時間",name:"startTime",variant:"control",labelSx:{width:"300px"},onChange:C=>M(C,"startTime")}),e.jsx(Gt,{label:"結束時間",name:"endTime",variant:"control",labelSx:{width:"300px"},onChange:C=>M(C,"endTime")}),e.jsx(ke,{display:"flex",gap:2,children:e.jsx($t,{title:"主視覺圖",name:"picId",selectBtnSx:{justifyContent:"flex-start",gap:3},labelSx:{flex:1}})}),e.jsx(je,{label:"BGM",name:"audioId",variant:"control",type:"ONE",options:N,onChange:C=>L(C.target.value)}),e.jsx(et,{name:"audioId",control:s,render:({field:C})=>{var V;return e.jsx("audio",{src:(V=q.find(se=>se.id===C.value))==null?void 0:V.audioSrc,style:{width:"100%"},controls:!0})}})]})}),e.jsx(K,{item:!0,xs:12,md:6,children:m?e.jsxs(ke,{sx:{position:"relative",display:"flex",justifyContent:"center",alignItems:"center",transition:"all 0.2s","&:hover .delete-icon":{opacity:1}},children:[e.jsx("img",{src:m==null?void 0:m.src,alt:"主視覺圖",width:"100%"}),e.jsx(rs,{onClick:()=>E(null)})]}):e.jsx(ke,{sx:{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"200px",height:"100%",backgroundColor:$.LIGHT_GRAY,borderRadius:"10px",border:`2px dashed ${$.GRAY}`},children:e.jsx(z,{variant:"h5",color:$.BLACK,sx:{opacity:.6,fontWeight:500,letterSpacing:"0.5px"},children:"主視覺圖預覽"})})})]}),e.jsx(ze,{label:"簽到活動描述",name:"description",variant:"control",rows:6,labelSx:{width:"300px"},stackSx:{gap:0}}),e.jsxs(o,{gap:3,children:[U.map((C,V)=>e.jsx(nf,{index:V,onDeleteItem:h,onMoveItem:Y,setValue:r,control:s,rewardTypeOptions:vr,petListOptions:O,dropItemListOptions:k},C.id)),(g==null?void 0:g.length)<30&&e.jsx(v,{label:"新增簽到次序",btnColor:"TAB_BLUE",onClick:x,sx:{width:"fit-content",py:1}})]}),e.jsxs(o,{flexDirection:"row",gap:3,justifyContent:"flex-end",children:[(S==null?void 0:S.status)===wt.DRAFT&&e.jsx(v,{label:"儲存草稿",type:"submit",btnColor:"DRAWER_GRAY",onClick:()=>F(wt.DRAFT)}),e.jsx(v,{label:"更新簽到活動",type:"submit",btnColor:"TAB_BLUE",onClick:()=>F(wt.COMPLETE)})]})]})})},sf=af;function rf({sx:t,options:a,value:n,onChange:s,disabled:r=!1,minWidth:l="150px"}){return e.jsx(Ro,{sx:{minWidth:l,...t},children:e.jsx(Lo,{multiple:!0,value:n,onChange:s,input:e.jsx(Po,{}),disabled:r,renderValue:c=>c.length===0?"全選":c.sort((g,m)=>g-m).join(", "),sx:{"& fieldset":{borderColor:"#aaa !important"},"&:hover fieldset":{borderColor:"#aaa !important"},"&.Mui-focused fieldset":{borderColor:"#aaa !important"},"& .MuiSelect-icon":{color:"black",fontSize:"42px",position:"absolute",right:"0",top:"0"},"& .MuiSelect-select":{padding:"12px 0 10px 12px"},...t},children:a.map((c,g)=>e.jsxs(_o,{value:c.value,sx:{padding:"0 12px"},children:[e.jsx(On,{checked:n.includes(c.value)}),e.jsx(Mo,{primary:c.label})]},`${c.value}_${g}`))})})}const of=i.memo(rf),go=({label:t,labelSx:a,stackSx:n,...s})=>e.jsxs(o,{flexDirection:"row",sx:{gap:.5,alignItems:"center",justifyContent:"center",...n},children:[e.jsx(he,{sx:{paddingRight:"1.5rem",paddingLeft:"1.5rem",...a},children:t}),e.jsx(of,{...s})]}),fo=[{label:"簽到活動名稱",value:"eventName"}],bo=fo.map(t=>t.value),lf=t=>bo.includes(t),cf=()=>{const t=Me(),a=Wt(),{setAlertOpen:n}=_e(),s=yt(),r=i.useMemo(()=>{const u=new URLSearchParams(a.search),_=u.get("rewardDaysCountList"),Z=u.get("status"),C=u.get("startTime"),V=u.get("endTime"),se=u.get("eventName");return{page:parseInt(u.get("page")||"0",10),size:parseInt(u.get("size")||"10",10),sort:"period,desc",status:Z||"全選",removed:!1,..._&&{rewardDaysCountList:_.split(",").map(Number).filter(X=>!isNaN(X))},...C&&{startTime:Ie(C).valueOf()},...V&&{endTime:Ie(V).valueOf()},...se&&{eventName:se}}},[a.search]),l={searchText:"",currentField:"eventName"},[c,g]=i.useState(r),[m,E]=i.useState(l),[f,T]=i.useState(r.page+1),[y,D]=i.useState(!1),{data:S,isSuccess:j}=ho(),{data:w,isLoading:O,isSuccess:B}=Kg(c),{mutate:k}=qg(()=>{s.invalidateQueries({queryKey:[Ja.SIGN_IN_EVENT_SEARCH]}),n({open:!0,message:"刪除成功！"})}),q=i.useCallback(u=>{k({id:u,permanently:!1})},[k]),H=i.useMemo(()=>{var u;return B&&!!((u=w==null?void 0:w.content)!=null&&u.length)},[B,w]),G=i.useMemo(()=>{const u=[{label:"全部清除",value:0}],_=S==null?void 0:S.map(Z=>({label:String(Z),value:Z}));return j?[...u,..._||[]]:u},[j,S]),N=i.useCallback((u,_)=>{n({open:!0,message:`確定要刪除簽到活動「${_}」嗎？`,onOk:()=>q(u)})},[n,q]),L=i.useCallback(u=>{const _=u.target.value;if(_.includes(0)){const{rewardDaysCountList:C,...V}=c,se={...V,page:0},X=ut(se);g(se),T(1),t(`?${X}`);return}const Z=_.filter(C=>C!==0).sort((C,V)=>C-V);if(Z.length===0){const{rewardDaysCountList:C,...V}=c,se={...V,page:0},X=ut(se);g(se),T(1),t(`?${X}`)}else{const C={...c,rewardDaysCountList:Z,page:0},V=ut(C);g(C),T(1),t(`?${V}`)}},[c,t]),M=[{title:"編輯 / 檢視",dataField:"viewAndEdit",width:"280px",component:u=>e.jsxs(ke,{sx:{display:"flex",gap:1,justifyContent:"space-between"},children:[e.jsx(v,{label:"編輯",onClick:()=>F(`update/${u.id}`),btnColor:"TAB_BLUE"}),e.jsx(v,{label:"刪除",onClick:()=>N(u.id,u.eventName),btnColor:"RED"}),e.jsx(v,{label:"檢視分析",onClick:()=>F(`analyze/${u.id}`),btnColor:"GREEN"})]})},{title:"簽到活動名稱",dataField:"eventName"},{title:"狀態",dataField:"status",component:u=>e.jsx(z,{variant:"h5",noWrap:!0,children:Bo[u.status]})},{title:"起訖時間",dataField:"period",component:u=>e.jsx(z,{variant:"h6",noWrap:!0,children:u.period})},{title:"獎勵天數",dataField:"rewardDaysCount"},{title:"最後修改時間",dataField:"lastUpdateTime",component:u=>e.jsx(z,{variant:"h6",noWrap:!0,children:Ie(u.lastUpdateTime).format("YYYY/MM/DD HH:mm:ss")})},{title:"完成率",dataField:"completionRate"},{title:"參加人數",dataField:"participantCount"}],Y=i.useCallback(u=>_=>{let Z,C;if(typeof _=="number"||typeof _=="string"||typeof _=="boolean"?Z=_:Z=_.target.value,lf(u)){const se={};bo.forEach(X=>{X===u&&Z?se[X]=Z:delete c[X]}),C={...c,...se}}else if(["rewardDaysCount"].includes(u)&&Z===0){const{[u]:R,...b}=c;C=b}else C={...c,[u]:Z};u!=="page"&&(C.page=0,T(1));const V=ut(C);g(C),t(`?${V}`)},[t,c]),U=i.useCallback((u,_)=>{Y("page")(String(_-1)),T(_)},[Y]),A=i.useCallback(()=>{if(f){const u={...c,page:f-1},_=ut(u);g(u),t(`?${_}`)}},[f,c,t]),p=i.useCallback(u=>{E(_=>({..._,searchText:u}))},[E]),x=i.useCallback(u=>{E(_=>({..._,currentField:u}))},[]),h=(u,_)=>{_&&(u==="startTime"?Y(u)(Ie(_).startOf("day").valueOf()):u==="endTime"?Y(u)(Ie(_).endOf("day").valueOf()):Y(u)(Ie(_).valueOf()))},I=i.useCallback(()=>{const{currentField:u,searchText:_}=m;Y(u)(_)},[Y,m]),P=i.useCallback(()=>{D(!0)},[D]),F=u=>{t(`/edit/signInEventEdit/${u}`)};return O?e.jsx(Ge,{}):e.jsxs(o,{flex:1,px:3,gap:5,children:[e.jsx(o,{direction:"row",justifyContent:"flex-end",children:e.jsx(v,{label:"創建簽到活動",onClick:()=>F("create"),btnColor:"BLUE"})}),e.jsxs(o,{direction:"row",alignItems:"center",gap:3,children:[e.jsx(go,{label:"獎勵天數",options:G,value:c.rewardDaysCountList||[],onChange:L}),e.jsx(Ve,{label:"狀態",value:c.status||0,options:Fo,onChange:u=>Y("status")(u.target.value)}),e.jsxs(ke,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(he,{width:"fit-content",p:"4px 16px",children:"活動時間"}),e.jsx(an,{value:c.startTime??null,onChange:u=>h("startTime",u),width:"220px"}),e.jsx(z,{variant:"h5",children:"至"}),e.jsx(an,{value:c.endTime??null,onChange:u=>h("endTime",u),width:"220px"})]})]}),e.jsxs(o,{direction:"row",alignItems:"center",gap:3,children:[e.jsx(vt,{value:m,options:fo,selectOnChange:x,inputOnChange:p,searchFuntion:I}),e.jsx(v,{label:"搜尋",onClick:I,btnColor:"BROWN"}),e.jsx(v,{label:"匯出 EXCEL",onClick:P,btnColor:"EXCEL"})]}),e.jsx(lt,{isVisible:H,children:e.jsxs(o,{gap:3,alignItems:"center",children:[e.jsx(Tt,{columns:M,rows:(w==null?void 0:w.content)||[]}),e.jsx(Yt,{totalPages:(w==null?void 0:w.totalPages)||0,currentPage:(w==null?void 0:w.pageable.pageNumber)||0,inputPage:f,setInputPage:T,handlePageChange:U,handlePageSearch:A})]})},JSON.stringify(c)),e.jsx(Xa,{open:y,setOpen:D,request:c,totalPages:(w==null?void 0:w.totalPages)||0,type:"SIGN_IN_EVENT"})]})},df=cf,uf=(t,a)=>{const n="sign_in_event_id",s=`sign_in_event_id=${a}`;return`${t}${s}#hide_parameters=${n}&titled=false`},pf=()=>{const{id:t}=Lt(),a=Me(),[n,s]=i.useState(""),{data:r}=Rs({variable:"SIGN_IN_EVENT_DASHBOARD",page:0,size:10,onlySelf:!1}),l=c=>{a(`${c}`)};return i.useEffect(()=>{r!=null&&r.content[0]&&s(uf(r.content[0].value+"?",t))},[r,t]),e.jsxs(o,{flex:1,px:3,gap:3,height:"100vh",children:[e.jsx(o,{direction:"row",justifyContent:"flex-end",children:e.jsx(v,{label:"詳細記錄",onClick:()=>l("detail"),btnColor:"TAB_BLUE"})}),e.jsx("iframe",{height:"100%",width:"100%",style:{border:"none"},src:n},n)]})},mf=pf,Sr=(t,a)=>{const n={...a};Ie(n.last_sign_in_time).isValid()&&(n.last_sign_in_time=Ie(n.last_sign_in_time).startOf("day").format("YYYY-MM-DD"));const s=Object.keys(n).join(","),r=Object.entries(n).filter(([l,c])=>c!==void 0&&c!=="").map(([l,c])=>`${l}=${c}`).join("&");return`${t}${r}#hide_parameters=${s}&titled=false`},hf=()=>{const{role:t}=xt(),{id:a}=Lt(),[n,s]=i.useState(""),[r,l]=i.useState(""),[c,g]=i.useState({sign_in_event_id:Number(a),is_admin:t===tt.ROLE_ADMIN?1:0,reward_days_count_list:[],last_sign_in_time:"",nick_name:""}),{data:m}=Rs({page:0,size:10,onlySelf:!1,variable:"SIGN_IN_EVENT_LOG_DASHBOARD"}),{data:E,isSuccess:f}=ho(Number(a)),T=i.useMemo(()=>{const j=[{label:"全部清除",value:0}],w=E==null?void 0:E.map(O=>({label:String(O),value:O}));return f?[...j,...w||[]]:j},[f,E]),y=(j,w)=>{g(O=>({...O,[j]:w}))},D=i.useCallback(j=>{const w=j.target.value,O=()=>{const{reward_days_count_list:k,...q}=c;return{...q,reward_days_count_list:[]}};if(w.includes(0)||w.length===0){g(O());return}const B=w.filter(k=>k!==0).sort((k,q)=>k-q);g({...c,reward_days_count_list:B})},[c]),S=i.useCallback(()=>{s(Sr(r,c))},[r,c]);return i.useEffect(()=>{m!=null&&m.content[0]&&(l(m.content[0].value+"?"),s(Sr(m.content[0].value+"?",c)))},[m]),e.jsxs(o,{flex:1,px:3,gap:5,height:"100vh",children:[e.jsxs(o,{direction:"row",alignItems:"center",gap:3,children:[e.jsx(go,{label:"獎勵天數",options:T,value:c.reward_days_count_list||[],onChange:D}),e.jsx(es,{label:"最後簽到時間",value:c.last_sign_in_time?Number(c.last_sign_in_time):null,onChange:j=>y("last_sign_in_time",j)}),e.jsx(fs,{label:"玩家暱稱",value:c.nick_name,onChange:j=>y("nick_name",j.target.value),sx:{width:"200px"},onKeyDown:j=>Is(j,S)}),e.jsx(v,{label:"搜尋",onClick:S,btnColor:"BROWN"})]}),e.jsx("iframe",{height:"100%",width:"100%",style:{border:"none"},src:n},n)]})},xf=hf,gf=({children:t})=>{const{status:a}=Xs(),n=sn({mode:"all",resolver:on(ef(a)),defaultValues:xo});return e.jsxs(rn,{...n,children:[t,!1]})},ff=gf;function bf(){return e.jsx(ff,{children:e.jsxs(Pt,{children:[e.jsx(xe,{index:!0,element:e.jsx(df,{})}),e.jsx(xe,{path:"/create",element:e.jsx(Jg,{})}),e.jsx(xe,{path:"/update/:id",element:e.jsx(sf,{})}),e.jsx(xe,{path:"/analyze/:id",element:e.jsx(mf,{})}),e.jsx(xe,{path:"/analyze/:id/detail",element:e.jsx(xf,{})}),e.jsx(xe,{path:"*",element:e.jsx(_t,{to:"/edit/signInEventEdit",replace:!0})})]})})}function Af(){return e.jsxs(Pt,{children:[e.jsx(xe,{path:"/stageEdit/*",element:e.jsx(Ft,{element:e.jsx(Nx,{}),permissionKey:"ROLE_PERMISSIONS_STAGE"})}),e.jsx(xe,{path:"/campStageEdit/*",element:e.jsx(Ft,{element:e.jsx(xd,{}),permissionKey:"ROLE_PERMISSIONS_STAGE"})}),e.jsx(xe,{path:"/missionEdit/*",element:e.jsx(Ft,{element:e.jsx(hx,{}),permissionKey:"ROLE_PERMISSIONS_MISSION"})}),e.jsx(xe,{path:"/cardEdit/*",element:e.jsx(Ft,{element:e.jsx(Sd,{}),permissionKey:"ROLE_PERMISSIONS_CARD"})}),e.jsx(xe,{path:"/eventEdit/*",element:e.jsx(Ft,{element:e.jsx(ih,{}),permissionKey:"ROLE_PERMISSIONS_IN_SCHOOL_EVENT"})}),e.jsx(xe,{path:"/mailEdit/*",element:e.jsx(Ft,{element:e.jsx(yh,{}),permissionKey:"ROLE_PERMISSIONS_STAGE"})}),e.jsx(xe,{path:"/mailTemplateEdit/*",element:e.jsx(Ft,{element:e.jsx(Oh,{}),permissionKey:"ROLE_PERMISSIONS_STAGE"})}),e.jsx(xe,{path:"/marqueeEdit/*",element:e.jsx(Ft,{element:e.jsx(ex,{}),permissionKey:"ROLE_PERMISSIONS_STAGE"})}),e.jsx(xe,{path:"/bossEdit/*",element:e.jsx(Ft,{element:e.jsx(Ic,{}),permissionKey:"ROLE_PERMISSIONS_STAGE"})}),e.jsx(xe,{path:"/paramsEdit/*",element:e.jsx(Ft,{element:e.jsx(yx,{}),permissionKey:"ROLE_PERMISSIONS_STAGE"})}),e.jsx(xe,{path:"/blackHoleChapterEdit/*",element:e.jsx(Ft,{element:e.jsx(ig,{}),permissionKey:"ROLE_PERMISSIONS_STAGE"})}),e.jsx(xe,{path:"/blackHoleDialogueEdit/*",element:e.jsx(Ft,{element:e.jsx(Gg,{}),permissionKey:"ROLE_PERMISSIONS_STAGE"})}),e.jsx(xe,{path:"/blackHoleDropItemEdit/*",element:e.jsx(Ft,{element:e.jsx(bg,{}),permissionKey:"ROLE_PERMISSIONS_STAGE"})}),e.jsx(xe,{path:"/signInEventEdit/*",element:e.jsx(Ft,{element:e.jsx(bf,{}),permissionKey:"ROLE_PERMISSIONS_STAGE"})}),e.jsx(xe,{path:"*",element:e.jsx(_t,{to:"/",replace:!0})})]})}export{Af as default};
